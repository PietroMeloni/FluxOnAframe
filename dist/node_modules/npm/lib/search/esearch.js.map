{"version":3,"sources":["../../../../../node_modules/npm/lib/search/esearch.js"],"names":["npm","require","log","mapToRegistry","jsonstream","ms","gunzip","module","exports","esearch","opts","stream","through","obj","config","er","uri","auth","emit","createResultStream","err","resultStream","pipeline","cb","verbose","params","timeout","follow","staleOk","streaming","q","buildQuery","registry","request","encodeURIComponent","limit","res","silly","statusCode","entryStream","chunk","enc","parse","data","name","description","maintainers","keywords","version","date","Date","include","join"],"mappings":"AAAA;;AAEA,IAAIA,MAAMC,QAAQ,WAAR,CAAV;AACA,IAAIC,MAAMD,QAAQ,QAAR,CAAV;AACA,IAAIE,gBAAgBF,QAAQ,6BAAR,CAApB;AACA,IAAIG,aAAaH,QAAQ,YAAR,CAAjB;AACA,IAAII,KAAKJ,QAAQ,aAAR,CAAT;AACA,IAAIK,SAASL,QAAQ,uBAAR,CAAb;;AAEAM,OAAOC,OAAP,GAAiBC,OAAjB;;AAEA,SAASA,OAAT,CAAkBC,IAAlB,EAAwB;AACtB,MAAIC,SAASN,GAAGO,OAAH,CAAWC,GAAX,EAAb;;AAEAV,gBAAc,aAAd,EAA6BH,IAAIc,MAAjC,EAAyC,UAAUC,EAAV,EAAcC,GAAd,EAAmBC,IAAnB,EAAyB;AAChE,QAAIF,EAAJ,EAAQ,OAAOJ,OAAOO,IAAP,CAAY,OAAZ,EAAqBH,EAArB,CAAP;AACRI,uBAAmBH,GAAnB,EAAwBC,IAAxB,EAA8BP,IAA9B,EAAoC,UAAUU,GAAV,EAAeC,YAAf,EAA6B;AAC/D,UAAID,GAAJ,EAAS,OAAOT,OAAOO,IAAP,CAAY,OAAZ,EAAqBE,GAArB,CAAP;AACTf,SAAGiB,QAAH,CAAYT,GAAZ,CAAgBQ,YAAhB,EAA8BV,MAA9B;AACD,KAHD;AAID,GAND;AAOA,SAAOA,MAAP;AACD;;AAED,SAASQ,kBAAT,CAA6BH,GAA7B,EAAkCC,IAAlC,EAAwCP,IAAxC,EAA8Ca,EAA9C,EAAkD;AAChDrB,MAAIsB,OAAJ,CAAY,SAAZ,EAAuB,8BAAvB;AACA,MAAIC,SAAS;AACXC,aAAS,GADE;AAEXC,YAAQ,IAFG;AAGXC,aAAS,IAHE;AAIXX,UAAMA,IAJK;AAKXY,eAAW;AALA,GAAb;AAOA,MAAIC,IAAIC,WAAWrB,IAAX,CAAR;AACAV,MAAIgC,QAAJ,CAAaC,OAAb,CAAqBjB,MAAM,QAAN,GAAiBkB,mBAAmBJ,CAAnB,CAAjB,GAAyC,QAAzC,GAAoDpB,KAAKyB,KAA9E,EAAqFV,MAArF,EAA6F,UAAUL,GAAV,EAAegB,GAAf,EAAoB;AAC/G,QAAIhB,GAAJ,EAAS,OAAOG,GAAGH,GAAH,CAAP;AACTlB,QAAImC,KAAJ,CAAU,SAAV,EAAqB,8BAArB,EAAqDD,IAAIE,UAAzD;AACA;AACA;AACA;AACA,QAAIC,cAAclC,GAAGiB,QAAH,CAAYT,GAAZ,CAChBuB,GADgB,EAEhB/B,GAAGO,OAAH,CAAW,UAAU4B,KAAV,EAAiBC,GAAjB,EAAsBlB,EAAtB,EAA0B;AACnCA,SAAG,IAAH,EAASiB,KAAT;AACD,KAFD,CAFgB,EAKhBlC,QALgB,EAMhBF,WAAWsC,KAAX,CAAiB,mBAAjB,EAAsC,UAAUC,IAAV,EAAgB;AACpD,aAAO;AACLC,cAAMD,KAAKC,IADN;AAELC,qBAAaF,KAAKE,WAFb;AAGLC,qBAAaH,KAAKG,WAHb;AAILC,kBAAUJ,KAAKI,QAJV;AAKLC,iBAASL,KAAKK,OALT;AAMLC,cAAMN,KAAKM,IAAL,GAAY,IAAIC,IAAJ,CAASP,KAAKM,IAAd,CAAZ,GAAkC;AANnC,OAAP;AAQD,KATD,CANgB,CAAlB;AAiBA,WAAO1B,GAAG,IAAH,EAASgB,WAAT,CAAP;AACD,GAxBD;AAyBD;;AAED,SAASR,UAAT,CAAqBrB,IAArB,EAA2B;AACzB,SAAOA,KAAKyC,OAAL,CAAaC,IAAb,CAAkB,GAAlB,CAAP;AACD","file":"esearch.js","sourcesContent":["'use strict'\n\nvar npm = require('../npm.js')\nvar log = require('npmlog')\nvar mapToRegistry = require('../utils/map-to-registry.js')\nvar jsonstream = require('JSONStream')\nvar ms = require('mississippi')\nvar gunzip = require('../utils/gunzip-maybe')\n\nmodule.exports = esearch\n\nfunction esearch (opts) {\n  var stream = ms.through.obj()\n\n  mapToRegistry('-/v1/search', npm.config, function (er, uri, auth) {\n    if (er) return stream.emit('error', er)\n    createResultStream(uri, auth, opts, function (err, resultStream) {\n      if (err) return stream.emit('error', err)\n      ms.pipeline.obj(resultStream, stream)\n    })\n  })\n  return stream\n}\n\nfunction createResultStream (uri, auth, opts, cb) {\n  log.verbose('esearch', 'creating remote entry stream')\n  var params = {\n    timeout: 600,\n    follow: true,\n    staleOk: true,\n    auth: auth,\n    streaming: true\n  }\n  var q = buildQuery(opts)\n  npm.registry.request(uri + '?text=' + encodeURIComponent(q) + '&size=' + opts.limit, params, function (err, res) {\n    if (err) return cb(err)\n    log.silly('esearch', 'request stream opened, code:', res.statusCode)\n    // NOTE - The stream returned by `request` seems to be very persnickety\n    //        and this is almost a magic incantation to get it to work.\n    //        Modify how `res` is used here at your own risk.\n    var entryStream = ms.pipeline.obj(\n      res,\n      ms.through(function (chunk, enc, cb) {\n        cb(null, chunk)\n      }),\n      gunzip(),\n      jsonstream.parse('objects.*.package', function (data) {\n        return {\n          name: data.name,\n          description: data.description,\n          maintainers: data.maintainers,\n          keywords: data.keywords,\n          version: data.version,\n          date: data.date ? new Date(data.date) : null\n        }\n      })\n    )\n    return cb(null, entryStream)\n  })\n}\n\nfunction buildQuery (opts) {\n  return opts.include.join(' ')\n}\n"]}
{"version":3,"sources":["../../../../node_modules/npm/lib/build.js"],"names":["npm","require","log","chain","path","fs","lifecycle","readJson","binLinks","binLinksConfig","ini","writeFile","module","exports","build","usage","_didBuild","_noLC","args","global","didPre","didRB","cb","config","get","length","resolve","localPrefix","er","pkg","scripts","warn","builder","build_","map","arg","folder","info","linkStuff","rebuildBundles","writeBuiltinConf","parent","dirname","dir","globalDir","name","usingBuiltin","data","stringify","sources","builtin","deps","Object","keys","dependencies","concat","devDependencies","bundles","bundleDependencies","bundledDependencies","readdir","files","verbose","filter","file","match","indexOf","lstat"],"mappings":"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","file":"build.js","sourcesContent":["// npm build command\n\n// everything about the installation after the creation of\n// the .npm/{name}/{version}/package folder.\n// linking the modules into the npm.root,\n// resolving dependencies, etc.\n\n// This runs AFTER install or link are completed.\n\nvar npm = require('./npm.js')\nvar log = require('npmlog')\nvar chain = require('slide').chain\nvar path = require('path')\nvar fs = require('graceful-fs')\nvar lifecycle = require('./utils/lifecycle.js')\nvar readJson = require('read-package-json')\nvar binLinks = require('bin-links')\nvar binLinksConfig = require('./config/bin-links.js')\nvar ini = require('ini')\nvar writeFile = require('write-file-atomic')\n\nmodule.exports = build\nbuild.usage = 'npm build [<folder>]'\n\nbuild._didBuild = {}\nbuild._noLC = {}\nfunction build (args, global, didPre, didRB, cb) {\n  if (typeof cb !== 'function') {\n    cb = didRB\n    didRB = false\n  }\n  if (typeof cb !== 'function') {\n    cb = didPre\n    didPre = false\n  }\n  if (typeof cb !== 'function') {\n    cb = global\n    global = npm.config.get('global')\n  }\n\n  if (!args.length) {\n    readJson(path.resolve(npm.localPrefix, 'package.json'), function (er, pkg) {\n      if (!args.length && pkg && pkg.scripts && pkg.scripts.build) {\n        log.warn('build', '`npm build` called with no arguments. Did you mean to `npm run-script build`?')\n      }\n      cb()\n    })\n  } else {\n    // it'd be nice to asyncMap these, but actually, doing them\n    // in parallel generally munges up the output from node-waf\n    var builder = build_(global, didPre, didRB)\n    chain(args.map(function (arg) {\n      return function (cb) {\n        builder(arg, cb)\n      }\n    }), cb)\n  }\n}\n\nfunction build_ (global, didPre, didRB) {\n  return function (folder, cb) {\n    folder = path.resolve(folder)\n    if (build._didBuild[folder]) log.info('build', 'already built', folder)\n    build._didBuild[folder] = true\n    log.info('build', folder)\n    readJson(path.resolve(folder, 'package.json'), function (er, pkg) {\n      if (er) return cb(er)\n      chain([\n        !didPre && [lifecycle, pkg, 'preinstall', folder],\n        [linkStuff, pkg, folder, global],\n        !didRB && [rebuildBundles, pkg, folder],\n        [writeBuiltinConf, pkg, folder],\n        didPre !== build._noLC && [lifecycle, pkg, 'install', folder],\n        didPre !== build._noLC && [lifecycle, pkg, 'postinstall', folder]\n      ],\n      cb)\n    })\n  }\n}\n\nvar writeBuiltinConf = build.writeBuiltinConf = function (pkg, folder, cb) {\n  // the builtin config is \"sticky\". Any time npm installs\n  // itself globally, it puts its builtin config file there\n  var parent = path.dirname(folder)\n  var dir = npm.globalDir\n\n  // Make this count for canary, too\n  if ((pkg.name !== 'npm' && pkg.name !== 'npmc') ||\n      !npm.config.get('global') ||\n      !npm.config.usingBuiltin ||\n      dir !== parent) {\n    return cb()\n  }\n\n  var data = ini.stringify(npm.config.sources.builtin.data)\n  writeFile(path.resolve(folder, 'npmrc'), data, cb)\n}\n\nvar linkStuff = build.linkStuff = function (pkg, folder, global, cb) {\n  // allow to opt out of linking binaries.\n  if (npm.config.get('bin-links') === false) return cb()\n  return binLinks(pkg, folder, global, binLinksConfig(pkg), cb)\n}\n\nfunction rebuildBundles (pkg, folder, cb) {\n  if (!npm.config.get('rebuild-bundle')) return cb()\n\n  var deps = Object.keys(pkg.dependencies || {})\n    .concat(Object.keys(pkg.devDependencies || {}))\n  var bundles = pkg.bundleDependencies || pkg.bundledDependencies || []\n\n  fs.readdir(path.resolve(folder, 'node_modules'), function (er, files) {\n    // error means no bundles\n    if (er) return cb()\n\n    log.verbose('rebuildBundles', files)\n    // don't asyncMap these, because otherwise build script output\n    // gets interleaved and is impossible to read\n    chain(files.filter(function (file) {\n      // rebuild if:\n      // not a .folder, like .bin or .hooks\n      return !file.match(/^[._-]/) &&\n          // not some old 0.x style bundle\n          file.indexOf('@') === -1 &&\n          // either not a dep, or explicitly bundled\n          (deps.indexOf(file) === -1 || bundles.indexOf(file) !== -1)\n    }).map(function (file) {\n      file = path.resolve(folder, 'node_modules', file)\n      return function (cb) {\n        if (build._didBuild[file]) return cb()\n        log.verbose('rebuild bundle', file)\n        // if file is not a package dir, then don't do it.\n        fs.lstat(path.resolve(file, 'package.json'), function (er) {\n          if (er) return cb()\n          build_(false)(file, cb)\n        })\n      }\n    }), cb)\n  })\n}\n"]}
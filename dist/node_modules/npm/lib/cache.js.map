{"version":3,"sources":["../../../../node_modules/npm/lib/cache.js"],"names":["BB","require","assert","cacache","finished","promisify","log","npa","npm","output","pacote","pacoteOpts","path","rm","unbuild","commands","cache","usage","completion","opts","cb","argv","conf","remain","length","exports","module","args","cmd","shift","result","clean","add","prefix","verify","then","Error","reject","cachePath","join","config","get","pkg","ver","where","scrub","spec","silly","undefined","verbose","tarball","stream","resume","indexOf","process","env","HOME","substr","stats","verifiedContent","keptSize","badContentCount","reclaimedCount","reclaimedSize","missingContent","totalEntries","runTime","total","unpack","unpackTarget","dmode","fmode","uid","gid","offline","extract","resolve"],"mappings":"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","file":"cache.js","sourcesContent":["'use strict'\n/* eslint-disable standard/no-callback-literal */\n\nconst BB = require('bluebird')\n\nconst assert = require('assert')\nconst cacache = require('cacache')\nconst finished = BB.promisify(require('mississippi').finished)\nconst log = require('npmlog')\nconst npa = require('npm-package-arg')\nconst npm = require('./npm.js')\nconst output = require('./utils/output.js')\nconst pacote = require('pacote')\nconst pacoteOpts = require('./config/pacote')\nconst path = require('path')\nconst rm = BB.promisify(require('./utils/gently-rm.js'))\nconst unbuild = BB.promisify(npm.commands.unbuild)\n\ncache.usage = 'npm cache add <tarball file>' +\n              '\\nnpm cache add <folder>' +\n              '\\nnpm cache add <tarball url>' +\n              '\\nnpm cache add <git url>' +\n              '\\nnpm cache add <name>@<version>' +\n              '\\nnpm cache clean' +\n              '\\nnpm cache verify'\n\ncache.completion = function (opts, cb) {\n  var argv = opts.conf.argv.remain\n  if (argv.length === 2) {\n    return cb(null, ['add', 'clean'])\n  }\n\n  // TODO - eventually...\n  switch (argv[2]) {\n    case 'clean':\n    case 'add':\n      return cb(null, [])\n  }\n}\n\nexports = module.exports = cache\nfunction cache (args, cb) {\n  const cmd = args.shift()\n  let result\n  switch (cmd) {\n    case 'rm': case 'clear': case 'clean':\n      result = clean(args)\n      break\n    case 'add':\n      result = add(args, npm.prefix)\n      break\n    case 'verify': case 'check':\n      result = verify()\n      break\n    default: return cb('Usage: ' + cache.usage)\n  }\n  if (!result || !result.then) {\n    throw new Error(`npm cache ${cmd} handler did not return a Promise`)\n  }\n  result.then(() => cb(), cb)\n}\n\n// npm cache clean [pkg]*\ncache.clean = clean\nfunction clean (args) {\n  if (!args) args = []\n  if (args.length) {\n    return BB.reject(new Error('npm cache clear does not accept arguments'))\n  }\n  const cachePath = path.join(npm.cache, '_cacache')\n  if (!npm.config.get('force')) {\n    return BB.reject(new Error(\"As of npm@5, the npm cache self-heals from corruption issues and data extracted from the cache is guaranteed to be valid. If you want to make sure everything is consistent, use 'npm cache verify' instead. On the other hand, if you're debugging an issue with the installer, you can use `npm install --cache /tmp/empty-cache` to use a temporary cache instead of nuking the actual one.\\n\\nIf you're sure you want to delete the entire cache, rerun this command with --force.\"))\n  }\n  // TODO - remove specific packages or package versions\n  return rm(cachePath)\n}\n\n// npm cache add <tarball-url>\n// npm cache add <pkg> <ver>\n// npm cache add <tarball>\n// npm cache add <folder>\ncache.add = function (pkg, ver, where, scrub) {\n  assert(typeof pkg === 'string', 'must include name of package to install')\n  if (scrub) {\n    return clean([]).then(() => {\n      return add([pkg, ver], where)\n    })\n  }\n  return add([pkg, ver], where)\n}\n\nfunction add (args, where) {\n  var usage = 'Usage:\\n' +\n              '    npm cache add <tarball-url>\\n' +\n              '    npm cache add <pkg>@<ver>\\n' +\n              '    npm cache add <tarball>\\n' +\n              '    npm cache add <folder>\\n'\n  var spec\n  log.silly('cache add', 'args', args)\n  if (args[1] === undefined) args[1] = null\n  // at this point the args length must ==2\n  if (args[1] !== null) {\n    spec = args[0] + '@' + args[1]\n  } else if (args.length === 2) {\n    spec = args[0]\n  }\n  log.verbose('cache add', 'spec', spec)\n  if (!spec) return BB.reject(new Error(usage))\n  log.silly('cache add', 'parsed spec', spec)\n  return finished(pacote.tarball.stream(spec, pacoteOpts({where})).resume())\n}\n\ncache.verify = verify\nfunction verify () {\n  const cache = path.join(npm.config.get('cache'), '_cacache')\n  let prefix = cache\n  if (prefix.indexOf(process.env.HOME) === 0) {\n    prefix = '~' + prefix.substr(process.env.HOME.length)\n  }\n  return cacache.verify(cache).then((stats) => {\n    output(`Cache verified and compressed (${prefix}):`)\n    output(`Content verified: ${stats.verifiedContent} (${stats.keptSize} bytes)`)\n    stats.badContentCount && output(`Corrupted content removed: ${stats.badContentCount}`)\n    stats.reclaimedCount && output(`Content garbage-collected: ${stats.reclaimedCount} (${stats.reclaimedSize} bytes)`)\n    stats.missingContent && output(`Missing content: ${stats.missingContent}`)\n    output(`Index entries: ${stats.totalEntries}`)\n    output(`Finished in ${stats.runTime.total / 1000}s`)\n  })\n}\n\ncache.unpack = unpack\nfunction unpack (pkg, ver, unpackTarget, dmode, fmode, uid, gid) {\n  return unbuild([unpackTarget], true).then(() => {\n    const opts = pacoteOpts({dmode, fmode, uid, gid, offline: true})\n    return pacote.extract(npa.resolve(pkg, ver), unpackTarget, opts)\n  })\n}\n"]}
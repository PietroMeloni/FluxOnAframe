{"version":3,"sources":["../../../../node_modules/npm/lib/search.js"],"names":["module","exports","search","npm","require","allPackageSearch","esearch","formatPackageStream","usage","output","log","ms","completion","opts","cb","args","searchOpts","description","config","get","exclude","prepareExcludes","include","prepareIncludes","limit","staleness","unicode","length","Error","anyOutput","entriesStream","through","obj","esearchWritten","on","pkg","write","e","emit","warn","end","outputStream","long","json","parseable","color","chunk","toString","silly","pipe","er","map","JSON","stringify","join","clearProgress","searchopts","split","concat","s","toLowerCase","filter","searchexclude"],"mappings":"AAAA;;AAEAA,OAAOC,OAAP,GAAiBA,UAAUC,MAA3B;;AAEA,IAAIC,MAAMC,QAAQ,UAAR,CAAV;AACA,IAAIC,mBAAmBD,QAAQ,6BAAR,CAAvB;AACA,IAAIE,UAAUF,QAAQ,qBAAR,CAAd;AACA,IAAIG,sBAAsBH,QAAQ,mCAAR,CAA1B;AACA,IAAII,QAAQJ,QAAQ,eAAR,CAAZ;AACA,IAAIK,SAASL,QAAQ,mBAAR,CAAb;AACA,IAAIM,MAAMN,QAAQ,QAAR,CAAV;AACA,IAAIO,KAAKP,QAAQ,aAAR,CAAT;;AAEAF,OAAOM,KAAP,GAAeA,MACb,QADa,EAEb,wCAFa,CAAf;;AAKAN,OAAOU,UAAP,GAAoB,UAAUC,IAAV,EAAgBC,EAAhB,EAAoB;AACtCA,KAAG,IAAH,EAAS,EAAT;AACD,CAFD;;AAIA,SAASZ,MAAT,CAAiBa,IAAjB,EAAuBD,EAAvB,EAA2B;AACzB,MAAIE,aAAa;AACfC,iBAAad,IAAIe,MAAJ,CAAWC,GAAX,CAAe,aAAf,CADE;AAEfC,aAASC,gBAAgBlB,IAAIe,MAAJ,CAAWC,GAAX,CAAe,eAAf,CAAhB,CAFM;AAGfG,aAASC,gBAAgBR,IAAhB,EAAsBZ,IAAIe,MAAJ,CAAWC,GAAX,CAAe,YAAf,CAAtB,CAHM;AAIfK,WAAOrB,IAAIe,MAAJ,CAAWC,GAAX,CAAe,aAAf,CAJQ;AAKfT,SAAKA,GALU;AAMfe,eAAWtB,IAAIe,MAAJ,CAAWC,GAAX,CAAe,iBAAf,CANI;AAOfO,aAASvB,IAAIe,MAAJ,CAAWC,GAAX,CAAe,SAAf;AAPM,GAAjB;;AAUA,MAAIH,WAAWM,OAAX,CAAmBK,MAAnB,KAA8B,CAAlC,EAAqC;AACnC,WAAOb,GAAG,IAAIc,KAAJ,CAAU,sCAAV,CAAH,CAAP;AACD;;AAED;AACA,MAAIC,YAAY,KAAhB;;AAEA,MAAIC,gBAAgBnB,GAAGoB,OAAH,CAAWC,GAAX,EAApB;;AAEA,MAAIC,iBAAiB,KAArB;AACA3B,UAAQU,UAAR,EAAoBkB,EAApB,CAAuB,MAAvB,EAA+B,UAAUC,GAAV,EAAe;AAC5CL,kBAAcM,KAAd,CAAoBD,GAApB;AACA,KAACF,cAAD,KAAoBA,iBAAiB,IAArC;AACD,GAHD,EAGGC,EAHH,CAGM,OAHN,EAGe,UAAUG,CAAV,EAAa;AAC1B,QAAIJ,cAAJ,EAAoB;AAClB;AACA,aAAOH,cAAcQ,IAAd,CAAmB,OAAnB,EAA4BD,CAA5B,CAAP;AACD;AACD3B,QAAI6B,IAAJ,CAAS,QAAT,EAAmB,iDAAnB;AACAlC,qBAAiBW,UAAjB,EAA6BkB,EAA7B,CAAgC,MAAhC,EAAwC,UAAUC,GAAV,EAAe;AACrDL,oBAAcM,KAAd,CAAoBD,GAApB;AACD,KAFD,EAEGD,EAFH,CAEM,OAFN,EAEe,UAAUG,CAAV,EAAa;AAC1BP,oBAAcQ,IAAd,CAAmB,OAAnB,EAA4BD,CAA5B;AACD,KAJD,EAIGH,EAJH,CAIM,KAJN,EAIa,YAAY;AACvBJ,oBAAcU,GAAd;AACD,KAND;AAOD,GAhBD,EAgBGN,EAhBH,CAgBM,KAhBN,EAgBa,YAAY;AACvBJ,kBAAcU,GAAd;AACD,GAlBD;;AAoBA;AACA;AACA,MAAIC,eAAelC,oBAAoB;AACrCQ,UAAMA,IAD+B,EACzB;AACZ2B,UAAMvC,IAAIe,MAAJ,CAAWC,GAAX,CAAe,MAAf,CAF+B;AAGrCF,iBAAad,IAAIe,MAAJ,CAAWC,GAAX,CAAe,aAAf,CAHwB;AAIrCwB,UAAMxC,IAAIe,MAAJ,CAAWC,GAAX,CAAe,MAAf,CAJ+B;AAKrCyB,eAAWzC,IAAIe,MAAJ,CAAWC,GAAX,CAAe,WAAf,CAL0B;AAMrC0B,WAAO1C,IAAI0C;AAN0B,GAApB,CAAnB;AAQAJ,eAAaP,EAAb,CAAgB,MAAhB,EAAwB,UAAUY,KAAV,EAAiB;AACvC,QAAI,CAACjB,SAAL,EAAgB;AAAEA,kBAAY,IAAZ;AAAkB;AACpCpB,WAAOqC,MAAMC,QAAN,CAAe,MAAf,CAAP;AACD,GAHD;;AAKArC,MAAIsC,KAAJ,CAAU,QAAV,EAAoB,oBAApB;AACArC,KAAGsC,IAAH,CAAQnB,aAAR,EAAuBW,YAAvB,EAAqC,UAAUS,EAAV,EAAc;AACjD,QAAIA,EAAJ,EAAQ,OAAOpC,GAAGoC,EAAH,CAAP;AACR,QAAI,CAACrB,SAAD,IAAc,CAAC1B,IAAIe,MAAJ,CAAWC,GAAX,CAAe,MAAf,CAAf,IAAyC,CAAChB,IAAIe,MAAJ,CAAWC,GAAX,CAAe,WAAf,CAA9C,EAA2E;AACzEV,aAAO,0BAA2BM,KAAKoC,GAAL,CAASC,KAAKC,SAAd,EAAyBC,IAAzB,CAA8B,GAA9B,CAAlC;AACD;AACD5C,QAAIsC,KAAJ,CAAU,QAAV,EAAoB,kBAApB;AACAtC,QAAI6C,aAAJ;AACAzC,OAAG,IAAH,EAAS,EAAT;AACD,GARD;AASD;;AAED,SAASS,eAAT,CAA0BR,IAA1B,EAAgCyC,UAAhC,EAA4C;AAC1C,MAAI,OAAOA,UAAP,KAAsB,QAA1B,EAAoCA,aAAa,EAAb;AACpC,SAAOA,WAAWC,KAAX,CAAiB,KAAjB,EAAwBC,MAAxB,CAA+B3C,IAA/B,EAAqCoC,GAArC,CAAyC,UAAUQ,CAAV,EAAa;AAC3D,WAAOA,EAAEC,WAAF,EAAP;AACD,GAFM,EAEJC,MAFI,CAEG,UAAUF,CAAV,EAAa;AAAE,WAAOA,CAAP;AAAU,GAF5B,CAAP;AAGD;;AAED,SAAStC,eAAT,CAA0ByC,aAA1B,EAAyC;AACvC,MAAI1C,OAAJ;AACA,MAAI,OAAO0C,aAAP,KAAyB,QAA7B,EAAuC;AACrC1C,cAAU0C,cAAcL,KAAd,CAAoB,KAApB,CAAV;AACD,GAFD,MAEO;AACLrC,cAAU,EAAV;AACD;AACD,SAAOA,QAAQ+B,GAAR,CAAY,UAAUQ,CAAV,EAAa;AAC9B,WAAOA,EAAEC,WAAF,EAAP;AACD,GAFM,CAAP;AAGD","file":"search.js","sourcesContent":["'use strict'\n\nmodule.exports = exports = search\n\nvar npm = require('./npm.js')\nvar allPackageSearch = require('./search/all-package-search')\nvar esearch = require('./search/esearch.js')\nvar formatPackageStream = require('./search/format-package-stream.js')\nvar usage = require('./utils/usage')\nvar output = require('./utils/output.js')\nvar log = require('npmlog')\nvar ms = require('mississippi')\n\nsearch.usage = usage(\n  'search',\n  'npm search [--long] [search terms ...]'\n)\n\nsearch.completion = function (opts, cb) {\n  cb(null, [])\n}\n\nfunction search (args, cb) {\n  var searchOpts = {\n    description: npm.config.get('description'),\n    exclude: prepareExcludes(npm.config.get('searchexclude')),\n    include: prepareIncludes(args, npm.config.get('searchopts')),\n    limit: npm.config.get('searchlimit'),\n    log: log,\n    staleness: npm.config.get('searchstaleness'),\n    unicode: npm.config.get('unicode')\n  }\n\n  if (searchOpts.include.length === 0) {\n    return cb(new Error('search must be called with arguments'))\n  }\n\n  // Used later to figure out whether we had any packages go out\n  var anyOutput = false\n\n  var entriesStream = ms.through.obj()\n\n  var esearchWritten = false\n  esearch(searchOpts).on('data', function (pkg) {\n    entriesStream.write(pkg)\n    !esearchWritten && (esearchWritten = true)\n  }).on('error', function (e) {\n    if (esearchWritten) {\n      // If esearch errored after already starting output, we can't fall back.\n      return entriesStream.emit('error', e)\n    }\n    log.warn('search', 'fast search endpoint errored. Using old search.')\n    allPackageSearch(searchOpts).on('data', function (pkg) {\n      entriesStream.write(pkg)\n    }).on('error', function (e) {\n      entriesStream.emit('error', e)\n    }).on('end', function () {\n      entriesStream.end()\n    })\n  }).on('end', function () {\n    entriesStream.end()\n  })\n\n  // Grab a configured output stream that will spit out packages in the\n  // desired format.\n  var outputStream = formatPackageStream({\n    args: args, // --searchinclude options are not highlighted\n    long: npm.config.get('long'),\n    description: npm.config.get('description'),\n    json: npm.config.get('json'),\n    parseable: npm.config.get('parseable'),\n    color: npm.color\n  })\n  outputStream.on('data', function (chunk) {\n    if (!anyOutput) { anyOutput = true }\n    output(chunk.toString('utf8'))\n  })\n\n  log.silly('search', 'searching packages')\n  ms.pipe(entriesStream, outputStream, function (er) {\n    if (er) return cb(er)\n    if (!anyOutput && !npm.config.get('json') && !npm.config.get('parseable')) {\n      output('No matches found for ' + (args.map(JSON.stringify).join(' ')))\n    }\n    log.silly('search', 'search completed')\n    log.clearProgress()\n    cb(null, {})\n  })\n}\n\nfunction prepareIncludes (args, searchopts) {\n  if (typeof searchopts !== 'string') searchopts = ''\n  return searchopts.split(/\\s+/).concat(args).map(function (s) {\n    return s.toLowerCase()\n  }).filter(function (s) { return s })\n}\n\nfunction prepareExcludes (searchexclude) {\n  var exclude\n  if (typeof searchexclude === 'string') {\n    exclude = searchexclude.split(/\\s+/)\n  } else {\n    exclude = []\n  }\n  return exclude.map(function (s) {\n    return s.toLowerCase()\n  })\n}\n"]}
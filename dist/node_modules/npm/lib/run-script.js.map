{"version":3,"sources":["../../../../node_modules/npm/lib/run-script.js"],"names":["module","exports","runScript","lifecycle","require","npm","path","readJson","log","chain","usage","output","didYouMean","isWindowsShell","completion","opts","cb","argv","conf","remain","length","json","join","localPrefix","er","d","code","scripts","Object","keys","console","error","indexOf","pref","config","get","pkgDir","resolve","args","list","pkgdir","cmd","shift","run","cmdList","reduce","l","p","concat","allScripts","runScripts","forEach","script","push","level","JSON","stringify","s","prefix","name","pkg","wd","cmds","restart","test","verbose","suggestions","Error","match","map","c","joinArgs","unsafePerm","joinedArgs","arg","replace"],"mappings":"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","file":"run-script.js","sourcesContent":["module.exports = runScript\n\nvar lifecycle = require('./utils/lifecycle.js')\nvar npm = require('./npm.js')\nvar path = require('path')\nvar readJson = require('read-package-json')\nvar log = require('npmlog')\nvar chain = require('slide').chain\nvar usage = require('./utils/usage')\nvar output = require('./utils/output.js')\nvar didYouMean = require('./utils/did-you-mean')\nvar isWindowsShell = require('./utils/is-windows-shell.js')\n\nrunScript.usage = usage(\n  'run-script',\n  'npm run-script <command> [-- <args>...]'\n)\n\nrunScript.completion = function (opts, cb) {\n  // see if there's already a package specified.\n  var argv = opts.conf.argv.remain\n\n  if (argv.length >= 4) return cb()\n\n  if (argv.length === 3) {\n    // either specified a script locally, in which case, done,\n    // or a package, in which case, complete against its scripts\n    var json = path.join(npm.localPrefix, 'package.json')\n    return readJson(json, function (er, d) {\n      if (er && er.code !== 'ENOENT' && er.code !== 'ENOTDIR') return cb(er)\n      if (er) d = {}\n      var scripts = Object.keys(d.scripts || {})\n      console.error('local scripts', scripts)\n      if (scripts.indexOf(argv[2]) !== -1) return cb()\n      // ok, try to find out which package it was, then\n      var pref = npm.config.get('global') ? npm.config.get('prefix')\n        : npm.localPrefix\n      var pkgDir = path.resolve(pref, 'node_modules', argv[2], 'package.json')\n      readJson(pkgDir, function (er, d) {\n        if (er && er.code !== 'ENOENT' && er.code !== 'ENOTDIR') return cb(er)\n        if (er) d = {}\n        var scripts = Object.keys(d.scripts || {})\n        return cb(null, scripts)\n      })\n    })\n  }\n\n  readJson(path.join(npm.localPrefix, 'package.json'), function (er, d) {\n    if (er && er.code !== 'ENOENT' && er.code !== 'ENOTDIR') return cb(er)\n    d = d || {}\n    cb(null, Object.keys(d.scripts || {}))\n  })\n}\n\nfunction runScript (args, cb) {\n  if (!args.length) return list(cb)\n\n  var pkgdir = npm.localPrefix\n  var cmd = args.shift()\n\n  readJson(path.resolve(pkgdir, 'package.json'), function (er, d) {\n    if (er) return cb(er)\n    run(d, pkgdir, cmd, args, cb)\n  })\n}\n\nfunction list (cb) {\n  var json = path.join(npm.localPrefix, 'package.json')\n  var cmdList = [\n    'publish',\n    'install',\n    'uninstall',\n    'test',\n    'stop',\n    'start',\n    'restart',\n    'version'\n  ].reduce(function (l, p) {\n    return l.concat(['pre' + p, p, 'post' + p])\n  }, [])\n  return readJson(json, function (er, d) {\n    if (er && er.code !== 'ENOENT' && er.code !== 'ENOTDIR') return cb(er)\n    if (er) d = {}\n    var allScripts = Object.keys(d.scripts || {})\n    var scripts = []\n    var runScripts = []\n    allScripts.forEach(function (script) {\n      if (cmdList.indexOf(script) !== -1) scripts.push(script)\n      else runScripts.push(script)\n    })\n\n    if (log.level === 'silent') {\n      return cb(null, allScripts)\n    }\n\n    if (npm.config.get('json')) {\n      output(JSON.stringify(d.scripts || {}, null, 2))\n      return cb(null, allScripts)\n    }\n\n    if (npm.config.get('parseable')) {\n      allScripts.forEach(function (script) {\n        output(script + ':' + d.scripts[script])\n      })\n      return cb(null, allScripts)\n    }\n\n    var s = '\\n    '\n    var prefix = '  '\n    if (scripts.length) {\n      output('Lifecycle scripts included in %s:', d.name)\n    }\n    scripts.forEach(function (script) {\n      output(prefix + script + s + d.scripts[script])\n    })\n    if (!scripts.length && runScripts.length) {\n      output('Scripts available in %s via `npm run-script`:', d.name)\n    } else if (runScripts.length) {\n      output('\\navailable via `npm run-script`:')\n    }\n    runScripts.forEach(function (script) {\n      output(prefix + script + s + d.scripts[script])\n    })\n    return cb(null, allScripts)\n  })\n}\n\nfunction run (pkg, wd, cmd, args, cb) {\n  if (!pkg.scripts) pkg.scripts = {}\n\n  var cmds\n  if (cmd === 'restart' && !pkg.scripts.restart) {\n    cmds = [\n      'prestop', 'stop', 'poststop',\n      'restart',\n      'prestart', 'start', 'poststart'\n    ]\n  } else {\n    if (!pkg.scripts[cmd]) {\n      if (cmd === 'test') {\n        pkg.scripts.test = 'echo \\'Error: no test specified\\''\n      } else if (cmd === 'env') {\n        if (isWindowsShell) {\n          log.verbose('run-script using default platform env: SET (Windows)')\n          pkg.scripts[cmd] = 'SET'\n        } else {\n          log.verbose('run-script using default platform env: env (Unix)')\n          pkg.scripts[cmd] = 'env'\n        }\n      } else if (npm.config.get('if-present')) {\n        return cb(null)\n      } else {\n        let suggestions = didYouMean(cmd, Object.keys(pkg.scripts))\n        suggestions = suggestions ? '\\n' + suggestions : ''\n        return cb(new Error('missing script: ' + cmd + suggestions))\n      }\n    }\n    cmds = [cmd]\n  }\n\n  if (!cmd.match(/^(pre|post)/)) {\n    cmds = ['pre' + cmd].concat(cmds).concat('post' + cmd)\n  }\n\n  log.verbose('run-script', cmds)\n  chain(cmds.map(function (c) {\n    // pass cli arguments after -- to script.\n    if (pkg.scripts[c] && c === cmd) {\n      pkg.scripts[c] = pkg.scripts[c] + joinArgs(args)\n    }\n\n    // when running scripts explicitly, assume that they're trusted.\n    return [lifecycle, pkg, c, wd, { unsafePerm: true }]\n  }), cb)\n}\n\n// join arguments after '--' and pass them to script,\n// handle special characters such as ', \", ' '.\nfunction joinArgs (args) {\n  var joinedArgs = ''\n  args.forEach(function (arg) {\n    joinedArgs += ' \"' + arg.replace(/\"/g, '\\\\\"') + '\"'\n  })\n  return joinedArgs\n}\n"]}
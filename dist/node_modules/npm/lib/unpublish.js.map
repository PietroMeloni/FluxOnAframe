{"version":3,"sources":["../../../../node_modules/npm/lib/unpublish.js"],"names":["module","exports","unpublish","log","require","npm","readJson","path","mapToRegistry","npa","getPublishConfig","output","usage","completion","opts","cb","conf","argv","remain","length","commands","whoami","er","username","un","encodeURIComponent","byUser","config","uri","auth","registry","get","pkgs","pp","partialWord","name","filter","p","indexOf","d","vers","Object","keys","versions","map","v","args","thing","project","version","rawSpec","silly","resolve","localPrefix","cwdJson","join","data","code","verbose","gotProject","publishConfig","cb_","mappedConfig","client","params"],"mappings":";;AAAA;;AAEAA,OAAOC,OAAP,GAAiBC,SAAjB;;AAEA,IAAIC,MAAMC,QAAQ,QAAR,CAAV;AACA,IAAIC,MAAMD,QAAQ,UAAR,CAAV;AACA,IAAIE,WAAWF,QAAQ,mBAAR,CAAf;AACA,IAAIG,OAAOH,QAAQ,MAAR,CAAX;AACA,IAAII,gBAAgBJ,QAAQ,4BAAR,CAApB;AACA,IAAIK,MAAML,QAAQ,iBAAR,CAAV;AACA,IAAIM,mBAAmBN,QAAQ,+BAAR,CAAvB;AACA,IAAIO,SAASP,QAAQ,mBAAR,CAAb;;AAEAF,UAAUU,KAAV,GAAkB,4CAAlB;;AAEAV,UAAUW,UAAV,GAAuB,UAAUC,IAAV,EAAgBC,EAAhB,EAAoB;AACzC,MAAID,KAAKE,IAAL,CAAUC,IAAV,CAAeC,MAAf,CAAsBC,MAAtB,IAAgC,CAApC,EAAuC,OAAOJ,IAAP;AACvCV,MAAIe,QAAJ,CAAaC,MAAb,CAAoB,EAApB,EAAwB,IAAxB,EAA8B,UAAUC,EAAV,EAAcC,QAAd,EAAwB;AACpD,QAAID,EAAJ,EAAQ,OAAOP,IAAP;;AAER,QAAIS,KAAKC,mBAAmBF,QAAnB,CAAT;AACA,QAAI,CAACC,EAAL,EAAS,OAAOT,IAAP;AACT,QAAIW,SAAS,eAAeF,EAA5B;AACAhB,kBAAckB,MAAd,EAAsBrB,IAAIsB,MAA1B,EAAkC,UAAUL,EAAV,EAAcM,GAAd,EAAmBC,IAAnB,EAAyB;AACzD,UAAIP,EAAJ,EAAQ,OAAOP,GAAGO,EAAH,CAAP;;AAERjB,UAAIyB,QAAJ,CAAaC,GAAb,CAAiBH,GAAjB,EAAsB,EAAEC,MAAMA,IAAR,EAAtB,EAAsC,UAAUP,EAAV,EAAcU,IAAd,EAAoB;AACxD;AACA;AACA;AACAA,eAAOA,KAAKR,EAAL,CAAP;AACA,YAAI,CAACQ,IAAD,IAAS,CAACA,KAAKb,MAAnB,EAA2B,OAAOJ,IAAP;AAC3B,YAAIkB,KAAKxB,IAAIK,KAAKoB,WAAT,EAAsBC,IAA/B;AACAH,eAAOA,KAAKI,MAAL,CAAY,UAAUC,CAAV,EAAa;AAC9B,iBAAOA,EAAEC,OAAF,CAAUL,EAAV,MAAkB,CAAzB;AACD,SAFM,CAAP;AAGA,YAAID,KAAKb,MAAL,GAAc,CAAlB,EAAqB,OAAOJ,GAAG,IAAH,EAASiB,IAAT,CAAP;AACrBxB,sBAAcwB,KAAK,CAAL,CAAd,EAAuB3B,IAAIsB,MAA3B,EAAmC,UAAUL,EAAV,EAAcM,GAAd,EAAmBC,IAAnB,EAAyB;AAC1D,cAAIP,EAAJ,EAAQ,OAAOP,GAAGO,EAAH,CAAP;;AAERjB,cAAIyB,QAAJ,CAAaC,GAAb,CAAiBH,GAAjB,EAAsB,EAAEC,MAAMA,IAAR,EAAtB,EAAsC,UAAUP,EAAV,EAAciB,CAAd,EAAiB;AACrD,gBAAIjB,EAAJ,EAAQ,OAAOP,GAAGO,EAAH,CAAP;AACR,gBAAIkB,OAAOC,OAAOC,IAAP,CAAYH,EAAEI,QAAd,CAAX;AACA,gBAAI,CAACH,KAAKrB,MAAV,EAAkB,OAAOJ,GAAG,IAAH,EAASiB,IAAT,CAAP;AAClB,mBAAOjB,GAAG,IAAH,EAASyB,KAAKI,GAAL,CAAS,UAAUC,CAAV,EAAa;AACpC,qBAAOb,KAAK,CAAL,IAAU,GAAV,GAAgBa,CAAvB;AACD,aAFe,CAAT,CAAP;AAGD,WAPD;AAQD,SAXD;AAYD,OAvBD;AAwBD,KA3BD;AA4BD,GAlCD;AAmCD,CArCD;;AAuCA,SAAS3C,SAAT,CAAoB4C,IAApB,EAA0B/B,EAA1B,EAA8B;AAC5B,MAAI+B,KAAK3B,MAAL,GAAc,CAAlB,EAAqB,OAAOJ,GAAGb,UAAUU,KAAb,CAAP;;AAErB,MAAImC,QAAQD,KAAK3B,MAAL,GAAcV,IAAIqC,KAAK,CAAL,CAAJ,CAAd,GAA6B,EAAzC;AACA,MAAIE,UAAUD,MAAMZ,IAApB;AACA,MAAIc,UAAUF,MAAMG,OAApB;;AAEA/C,MAAIgD,KAAJ,CAAU,WAAV,EAAuB,SAAvB,EAAkCL,KAAK,CAAL,CAAlC;AACA3C,MAAIgD,KAAJ,CAAU,WAAV,EAAuB,OAAvB,EAAgCJ,KAAhC;AACA,MAAI,CAACE,OAAD,IAAY,CAAC5C,IAAIsB,MAAJ,CAAWI,GAAX,CAAe,OAAf,CAAjB,EAA0C;AACxC,WAAOhB,GACL,yCACA,gCADA,GAEAb,UAAUU,KAHL,CAAP;AAKD;;AAED,MAAI,CAACoC,OAAD,IAAYzC,KAAK6C,OAAL,CAAaJ,OAAb,MAA0B3C,IAAIgD,WAA9C,EAA2D;AACzD;AACA;AACA,QAAIC,UAAU/C,KAAKgD,IAAL,CAAUlD,IAAIgD,WAAd,EAA2B,cAA3B,CAAd;AACA,WAAO/C,SAASgD,OAAT,EAAkB,UAAUhC,EAAV,EAAckC,IAAd,EAAoB;AAC3C,UAAIlC,MAAMA,GAAGmC,IAAH,KAAY,QAAlB,IAA8BnC,GAAGmC,IAAH,KAAY,SAA9C,EAAyD,OAAO1C,GAAGO,EAAH,CAAP;AACzD,UAAIA,EAAJ,EAAQ,OAAOP,GAAG,aAAab,UAAUU,KAA1B,CAAP;AACRT,UAAIuD,OAAJ,CAAY,WAAZ,EAAyBF,IAAzB;AACAG,iBAAWH,KAAKrB,IAAhB,EAAsBqB,KAAKP,OAA3B,EAAoCO,KAAKI,aAAzC,EAAwD7C,EAAxD;AACD,KALM,CAAP;AAMD;AACD,SAAO4C,WAAWX,OAAX,EAAoBC,OAApB,EAA6BlC,EAA7B,CAAP;AACD;;AAED,SAAS4C,UAAT,CAAqBX,OAArB,EAA8BC,OAA9B,EAAuCW,aAAvC,EAAsDC,GAAtD,EAA2D;AACzD,MAAI,OAAOA,GAAP,KAAe,UAAnB,EAA+B;AAC7BA,UAAMD,aAAN;AACAA,oBAAgB,IAAhB;AACD;;AAED,WAAS7C,EAAT,CAAaO,EAAb,EAAiB;AACf,QAAIA,EAAJ,EAAQ,OAAOuC,IAAIvC,EAAJ,CAAP;AACRX,WAAO,OAAOqC,OAAP,IAAkBC,UAAU,MAAMA,OAAhB,GAA0B,EAA5C,CAAP;AACAY;AACD;;AAED,MAAIC,eAAepD,iBAAiBkD,aAAjB,EAAgCvD,IAAIsB,MAApC,EAA4CtB,IAAIyB,QAAhD,CAAnB;AACA,MAAIH,SAASmC,aAAanC,MAA1B;AACA,MAAIG,WAAWgC,aAAaC,MAA5B;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEAvD,gBAAcwC,OAAd,EAAuBrB,MAAvB,EAA+B,UAAUL,EAAV,EAAcM,GAAd,EAAmBC,IAAnB,EAAyB;AACtD,QAAIP,EAAJ,EAAQ,OAAOP,GAAGO,EAAH,CAAP;;AAER,QAAI0C,SAAS;AACXf,eAASA,OADE;AAEXpB,YAAMA;AAFK,KAAb;AAIAC,aAAS5B,SAAT,CAAmB0B,GAAnB,EAAwBoC,MAAxB,EAAgCjD,EAAhC;AACD,GARD;AASA;AACD","file":"unpublish.js","sourcesContent":["/* eslint-disable standard/no-callback-literal */\n\nmodule.exports = unpublish\n\nvar log = require('npmlog')\nvar npm = require('./npm.js')\nvar readJson = require('read-package-json')\nvar path = require('path')\nvar mapToRegistry = require('./utils/map-to-registry.js')\nvar npa = require('npm-package-arg')\nvar getPublishConfig = require('./utils/get-publish-config.js')\nvar output = require('./utils/output.js')\n\nunpublish.usage = 'npm unpublish [<@scope>/]<pkg>[@<version>]'\n\nunpublish.completion = function (opts, cb) {\n  if (opts.conf.argv.remain.length >= 3) return cb()\n  npm.commands.whoami([], true, function (er, username) {\n    if (er) return cb()\n\n    var un = encodeURIComponent(username)\n    if (!un) return cb()\n    var byUser = '-/by-user/' + un\n    mapToRegistry(byUser, npm.config, function (er, uri, auth) {\n      if (er) return cb(er)\n\n      npm.registry.get(uri, { auth: auth }, function (er, pkgs) {\n        // do a bit of filtering at this point, so that we don't need\n        // to fetch versions for more than one thing, but also don't\n        // accidentally a whole project.\n        pkgs = pkgs[un]\n        if (!pkgs || !pkgs.length) return cb()\n        var pp = npa(opts.partialWord).name\n        pkgs = pkgs.filter(function (p) {\n          return p.indexOf(pp) === 0\n        })\n        if (pkgs.length > 1) return cb(null, pkgs)\n        mapToRegistry(pkgs[0], npm.config, function (er, uri, auth) {\n          if (er) return cb(er)\n\n          npm.registry.get(uri, { auth: auth }, function (er, d) {\n            if (er) return cb(er)\n            var vers = Object.keys(d.versions)\n            if (!vers.length) return cb(null, pkgs)\n            return cb(null, vers.map(function (v) {\n              return pkgs[0] + '@' + v\n            }))\n          })\n        })\n      })\n    })\n  })\n}\n\nfunction unpublish (args, cb) {\n  if (args.length > 1) return cb(unpublish.usage)\n\n  var thing = args.length ? npa(args[0]) : {}\n  var project = thing.name\n  var version = thing.rawSpec\n\n  log.silly('unpublish', 'args[0]', args[0])\n  log.silly('unpublish', 'thing', thing)\n  if (!version && !npm.config.get('force')) {\n    return cb(\n      'Refusing to delete entire project.\\n' +\n      'Run with --force to do this.\\n' +\n      unpublish.usage\n    )\n  }\n\n  if (!project || path.resolve(project) === npm.localPrefix) {\n    // if there's a package.json in the current folder, then\n    // read the package name and version out of that.\n    var cwdJson = path.join(npm.localPrefix, 'package.json')\n    return readJson(cwdJson, function (er, data) {\n      if (er && er.code !== 'ENOENT' && er.code !== 'ENOTDIR') return cb(er)\n      if (er) return cb('Usage:\\n' + unpublish.usage)\n      log.verbose('unpublish', data)\n      gotProject(data.name, data.version, data.publishConfig, cb)\n    })\n  }\n  return gotProject(project, version, cb)\n}\n\nfunction gotProject (project, version, publishConfig, cb_) {\n  if (typeof cb_ !== 'function') {\n    cb_ = publishConfig\n    publishConfig = null\n  }\n\n  function cb (er) {\n    if (er) return cb_(er)\n    output('- ' + project + (version ? '@' + version : ''))\n    cb_()\n  }\n\n  var mappedConfig = getPublishConfig(publishConfig, npm.config, npm.registry)\n  var config = mappedConfig.config\n  var registry = mappedConfig.client\n\n  // remove from the cache first\n  // npm.commands.cache(['clean', project, version], function (er) {\n  // if (er) {\n  //   log.error('unpublish', 'Failed to clean cache')\n  //   return cb(er)\n  // }\n\n  mapToRegistry(project, config, function (er, uri, auth) {\n    if (er) return cb(er)\n\n    var params = {\n      version: version,\n      auth: auth\n    }\n    registry.unpublish(uri, params, cb)\n  })\n  // })\n}\n"]}
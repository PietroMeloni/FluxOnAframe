{"version":3,"sources":["../../../../node_modules/npm/lib/help-search.js"],"names":["module","exports","helpSearch","fs","require","path","asyncMap","npm","glob","color","output","usage","args","silent","cb","length","docPath","resolve","__dirname","er","files","readFiles","data","searchFiles","results","formatResults","res","file","readFile","Object","keys","forEach","match","a","l","toLowerCase","indexOf","lines","split","i","line","nextLine","ll","reduce","r","push","pop","shift","found","totalHits","arg","hit","cmd","basename","dirname","replace","hits","commands","help","map","JSON","stringify","join","sort","b","cols","Math","min","process","stdout","columns","Infinity","out","k","Array","max","config","get","finder","newOut","p","f","substr","hilit","bgBlack","red","trim"],"mappings":"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","file":"help-search.js","sourcesContent":["\nmodule.exports = helpSearch\n\nvar fs = require('graceful-fs')\nvar path = require('path')\nvar asyncMap = require('slide').asyncMap\nvar npm = require('./npm.js')\nvar glob = require('glob')\nvar color = require('ansicolors')\nvar output = require('./utils/output.js')\n\nhelpSearch.usage = 'npm help-search <text>'\n\nfunction helpSearch (args, silent, cb) {\n  if (typeof cb !== 'function') {\n    cb = silent\n    silent = false\n  }\n  if (!args.length) return cb(helpSearch.usage)\n\n  var docPath = path.resolve(__dirname, '..', 'doc')\n  return glob(docPath + '/*/*.md', function (er, files) {\n    if (er) return cb(er)\n    readFiles(files, function (er, data) {\n      if (er) return cb(er)\n      searchFiles(args, data, function (er, results) {\n        if (er) return cb(er)\n        formatResults(args, results, cb)\n      })\n    })\n  })\n}\n\nfunction readFiles (files, cb) {\n  var res = {}\n  asyncMap(files, function (file, cb) {\n    fs.readFile(file, 'utf8', function (er, data) {\n      res[file] = data\n      return cb(er)\n    })\n  }, function (er) {\n    return cb(er, res)\n  })\n}\n\nfunction searchFiles (args, files, cb) {\n  var results = []\n  Object.keys(files).forEach(function (file) {\n    var data = files[file]\n\n    // skip if no matches at all\n    var match\n    for (var a = 0, l = args.length; a < l && !match; a++) {\n      match = data.toLowerCase().indexOf(args[a].toLowerCase()) !== -1\n    }\n    if (!match) return\n\n    var lines = data.split(/\\n+/)\n\n    // if a line has a search term, then skip it and the next line.\n    // if the next line has a search term, then skip all 3\n    // otherwise, set the line to null.  then remove the nulls.\n    l = lines.length\n    for (var i = 0; i < l; i++) {\n      var line = lines[i]\n      var nextLine = lines[i + 1]\n      var ll\n\n      match = false\n      if (nextLine) {\n        for (a = 0, ll = args.length; a < ll && !match; a++) {\n          match = nextLine.toLowerCase()\n            .indexOf(args[a].toLowerCase()) !== -1\n        }\n        if (match) {\n          // skip over the next line, and the line after it.\n          i += 2\n          continue\n        }\n      }\n\n      match = false\n      for (a = 0, ll = args.length; a < ll && !match; a++) {\n        match = line.toLowerCase().indexOf(args[a].toLowerCase()) !== -1\n      }\n      if (match) {\n        // skip over the next line\n        i++\n        continue\n      }\n\n      lines[i] = null\n    }\n\n    // now squish any string of nulls into a single null\n    lines = lines.reduce(function (l, r) {\n      if (!(r === null && l[l.length - 1] === null)) l.push(r)\n      return l\n    }, [])\n\n    if (lines[lines.length - 1] === null) lines.pop()\n    if (lines[0] === null) lines.shift()\n\n    // now see how many args were found at all.\n    var found = {}\n    var totalHits = 0\n    lines.forEach(function (line) {\n      args.forEach(function (arg) {\n        var hit = (line || '').toLowerCase()\n          .split(arg.toLowerCase()).length - 1\n        if (hit > 0) {\n          found[arg] = (found[arg] || 0) + hit\n          totalHits += hit\n        }\n      })\n    })\n\n    var cmd = 'npm help '\n    if (path.basename(path.dirname(file)) === 'api') {\n      cmd = 'npm apihelp '\n    }\n    cmd += path.basename(file, '.md').replace(/^npm-/, '')\n    results.push({\n      file: file,\n      cmd: cmd,\n      lines: lines,\n      found: Object.keys(found),\n      hits: found,\n      totalHits: totalHits\n    })\n  })\n\n  // if only one result, then just show that help section.\n  if (results.length === 1) {\n    return npm.commands.help([results[0].file.replace(/\\.md$/, '')], cb)\n  }\n\n  if (results.length === 0) {\n    output('No results for ' + args.map(JSON.stringify).join(' '))\n    return cb()\n  }\n\n  // sort results by number of results found, then by number of hits\n  // then by number of matching lines\n  results = results.sort(function (a, b) {\n    return a.found.length > b.found.length ? -1\n      : a.found.length < b.found.length ? 1\n        : a.totalHits > b.totalHits ? -1\n          : a.totalHits < b.totalHits ? 1\n            : a.lines.length > b.lines.length ? -1\n              : a.lines.length < b.lines.length ? 1\n                : 0\n  })\n\n  cb(null, results)\n}\n\nfunction formatResults (args, results, cb) {\n  if (!results) return cb(null)\n\n  var cols = Math.min(process.stdout.columns || Infinity, 80) + 1\n\n  var out = results.map(function (res) {\n    var out = res.cmd\n    var r = Object.keys(res.hits)\n      .map(function (k) {\n        return k + ':' + res.hits[k]\n      }).sort(function (a, b) {\n        return a > b ? 1 : -1\n      }).join(' ')\n\n    out += ((new Array(Math.max(1, cols - out.length - r.length)))\n      .join(' ')) + r\n\n    if (!npm.config.get('long')) return out\n\n    out = '\\n\\n' + out + '\\n' +\n      (new Array(cols)).join('—') + '\\n' +\n      res.lines.map(function (line, i) {\n        if (line === null || i > 3) return ''\n        for (var out = line, a = 0, l = args.length; a < l; a++) {\n          var finder = out.toLowerCase().split(args[a].toLowerCase())\n          var newOut = ''\n          var p = 0\n\n          finder.forEach(function (f) {\n            newOut += out.substr(p, f.length)\n\n            var hilit = out.substr(p + f.length, args[a].length)\n            if (npm.color) hilit = color.bgBlack(color.red(hilit))\n            newOut += hilit\n\n            p += f.length + args[a].length\n          })\n        }\n\n        return newOut\n      }).join('\\n').trim()\n    return out\n  }).join('\\n')\n\n  if (results.length && !npm.config.get('long')) {\n    out = 'Top hits for ' + (args.map(JSON.stringify).join(' ')) + '\\n' +\n          (new Array(cols)).join('—') + '\\n' +\n          out + '\\n' +\n          (new Array(cols)).join('—') + '\\n' +\n          '(run with -l or --long to see more context)'\n  }\n\n  output(out.trim())\n  cb(null, results)\n}\n"]}
{"version":3,"sources":["../../../../node_modules/npm/lib/install.js"],"names":["module","exports","install","Installer","usage","require","completion","opts","cb","validate","arguments","test","partialWord","lastSlashIdx","lastIndexOf","partialName","slice","partialPath","annotatePackageDirMatch","sibling","fullPath","path","join","length","fs","readdir","err","contents","isPackage","indexOf","siblings","asyncMap","matches","cleaned","filter","x","log","readPackageTree","readPackageJson","chain","archy","mkdirp","rimraf","iferr","uniq","Bluebird","npm","locker","lock","unlock","parseJSON","output","saveMetrics","save","copyTree","readShrinkwrap","computeMetadata","prefetchDeps","loadDeps","loadDevDeps","getAllMetadata","loadRequestedDeps","loadExtraneous","diffTrees","checkPermissions","decomposeActions","validateTree","validateArgs","saveRequested","saveShrinkwrap","audit","getSaveType","doSerialActions","doSerial","doReverseSerialActions","doReverseSerial","doParallelActions","doParallel","doOneAction","doOne","removeObsoleteDep","removeExtraneous","computeVersionSpec","packageId","moduleName","errorMessage","isExtraneous","unlockCB","lockPath","name","installEr","args","reportErrorAndReturn","unlockEx","process","nextTick","unlockEr","code","warn","apply","where","globalTop","resolve","globalDir","config","get","prefix","dryrun","a","run","currentTree","idealTree","differences","todo","progress","noPackageJsonOk","topLevelLifecycles","autoPrune","dev","only","onlyProd","onlyDev","prod","packageLockOnly","rollback","link","saveOnlyLock","global","started","Date","now","prototype","_cb","result","Promise","reject","value","prevGlobal","set","next","installSteps","postInstallSteps","push","newTracker","runPreinstallTopLevelLifecycles","loadCurrentTree","finishTracker","loadIdealTree","debugTree","generateActionsToTake","debugActions","startAudit","saveToDependencies","executeActions","node_modules","staging","rollbackFailedOptional","commit","runPostinstallTopLevelLifecycles","pruneIdealTree","debugLogicalTree","printWarnings","printInstalled","self","failing","postInstallEr","msg","summary","forEach","logline","detail","verbose","getInstalledModules","loadArgMetadata","cwd","tracker","size","newGroup","emit","silly","readGlobalPackageData","readLocalPackageData","normalizeCurrentTree","createNode","create","flatNameFromTree","isTop","normalizeTree","error","children","child","fakeChild","package","dependencies","tree","seen","Set","has","add","location","cloneCurrentTreeToIdealTree","loadShrinkwrap","loadAllDepsIntoIdealTree","hasRequiresFromLock","some","n","toPrune","removing","map","saveDeps","cg","installNewModules","steps","depsToPreload","Object","assign","devDependencies","andResolveDeps","computeLinked","linkTodoList","action","cmd","pkg","isReqByTop","requiredBy","mod","isReqByUser","userRequired","isLinkable","Array","globalPackage","globalPrefix","globalPackageJson","stat","er","readFile","data","json","noExceptions","version","trackLifecycle","actionsToRun","failed","top","asCallback","toCommit","done","runTopLevelLifecycles","auditSubmission","try","generateFromInstall","remove","then","auditData","submitForInstallReport","catch","pkgs","ctx","kid","parent","warnings","Error","errno","andInflate","mutation","_id","warned","warning","levels","console","diffs","removedChildren","deps","r","d","timeout","auditResult","printInstalledForJSON","printInstalledForParseable","printInstalledForHuman","removed","added","updated","moved","contributors","people","meta","author","isArray","concat","person","normalized","normalizePerson","report","p","actions","packages","from","metadata","totalDependencies","lastAction","pop","printInstallReport","num","argument","returned","email","url","elapsed","message","flattenMessage","record","recordAction","JSON","stringify","previousPath","fromPath","previousVersion","oldPkg","relative","actionListName","actionsToLog","treeName","archyDebugTree","trim","byName","aa","bb","localeCompare","expandTree","label","nodes","sort","unicode","archyDebugLogicalTree","requires"],"mappings":"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","file":"install.js","sourcesContent":["'use strict'\n/* eslint-disable camelcase */\n/* eslint-disable standard/no-callback-literal */\n// npm install <pkg> <pkg> <pkg>\n//\n// See doc/cli/npm-install.md for more description\n//\n// Managing contexts...\n// there's a lot of state associated with an \"install\" operation, including\n// packages that are already installed, parent packages, current shrinkwrap, and\n// so on. We maintain this state in a \"context\" object that gets passed around.\n// every time we dive into a deeper node_modules folder, the \"family\" list that\n// gets passed along uses the previous \"family\" list as its __proto__.  Any\n// \"resolved precise dependency\" things that aren't already on this object get\n// added, and then that's passed to the next generation of installation.\n\nmodule.exports = install\nmodule.exports.Installer = Installer\n\nvar usage = require('./utils/usage')\n\ninstall.usage = usage(\n  'install',\n  '\\nnpm install (with no args, in package dir)' +\n  '\\nnpm install [<@scope>/]<pkg>' +\n  '\\nnpm install [<@scope>/]<pkg>@<tag>' +\n  '\\nnpm install [<@scope>/]<pkg>@<version>' +\n  '\\nnpm install [<@scope>/]<pkg>@<version range>' +\n  '\\nnpm install <folder>' +\n  '\\nnpm install <tarball file>' +\n  '\\nnpm install <tarball url>' +\n  '\\nnpm install <git:// url>' +\n  '\\nnpm install <github username>/<github project>',\n  '[--save-prod|--save-dev|--save-optional] [--save-exact] [--no-save]'\n)\n\ninstall.completion = function (opts, cb) {\n  validate('OF', arguments)\n  // install can complete to a folder with a package.json, or any package.\n  // if it has a slash, then it's gotta be a folder\n  // if it starts with https?://, then just give up, because it's a url\n  if (/^https?:\\/\\//.test(opts.partialWord)) {\n    // do not complete to URLs\n    return cb(null, [])\n  }\n\n  if (/\\//.test(opts.partialWord)) {\n    // Complete fully to folder if there is exactly one match and it\n    // is a folder containing a package.json file.  If that is not the\n    // case we return 0 matches, which will trigger the default bash\n    // complete.\n    var lastSlashIdx = opts.partialWord.lastIndexOf('/')\n    var partialName = opts.partialWord.slice(lastSlashIdx + 1)\n    var partialPath = opts.partialWord.slice(0, lastSlashIdx)\n    if (partialPath === '') partialPath = '/'\n\n    var annotatePackageDirMatch = function (sibling, cb) {\n      var fullPath = path.join(partialPath, sibling)\n      if (sibling.slice(0, partialName.length) !== partialName) {\n        return cb(null, null) // not name match\n      }\n      fs.readdir(fullPath, function (err, contents) {\n        if (err) return cb(null, { isPackage: false })\n\n        cb(\n          null,\n          {\n            fullPath: fullPath,\n            isPackage: contents.indexOf('package.json') !== -1\n          }\n        )\n      })\n    }\n\n    return fs.readdir(partialPath, function (err, siblings) {\n      if (err) return cb(null, []) // invalid dir: no matching\n\n      asyncMap(siblings, annotatePackageDirMatch, function (err, matches) {\n        if (err) return cb(err)\n\n        var cleaned = matches.filter(function (x) { return x !== null })\n        if (cleaned.length !== 1) return cb(null, [])\n        if (!cleaned[0].isPackage) return cb(null, [])\n\n        // Success - only one match and it is a package dir\n        return cb(null, [cleaned[0].fullPath])\n      })\n    })\n  }\n\n  // FIXME: there used to be registry completion here, but it stopped making\n  // sense somewhere around 50,000 packages on the registry\n  cb()\n}\n\n// system packages\nvar fs = require('fs')\nvar path = require('path')\n\n// dependencies\nvar log = require('npmlog')\nvar readPackageTree = require('read-package-tree')\nvar readPackageJson = require('read-package-json')\nvar chain = require('slide').chain\nvar asyncMap = require('slide').asyncMap\nvar archy = require('archy')\nvar mkdirp = require('mkdirp')\nvar rimraf = require('rimraf')\nvar iferr = require('iferr')\nvar validate = require('aproba')\nvar uniq = require('lodash.uniq')\nvar Bluebird = require('bluebird')\n\n// npm internal utils\nvar npm = require('./npm.js')\nvar locker = require('./utils/locker.js')\nvar lock = locker.lock\nvar unlock = locker.unlock\nvar parseJSON = require('./utils/parse-json.js')\nvar output = require('./utils/output.js')\nvar saveMetrics = require('./utils/metrics.js').save\n\n// install specific libraries\nvar copyTree = require('./install/copy-tree.js')\nvar readShrinkwrap = require('./install/read-shrinkwrap.js')\nvar computeMetadata = require('./install/deps.js').computeMetadata\nvar prefetchDeps = require('./install/deps.js').prefetchDeps\nvar loadDeps = require('./install/deps.js').loadDeps\nvar loadDevDeps = require('./install/deps.js').loadDevDeps\nvar getAllMetadata = require('./install/deps.js').getAllMetadata\nvar loadRequestedDeps = require('./install/deps.js').loadRequestedDeps\nvar loadExtraneous = require('./install/deps.js').loadExtraneous\nvar diffTrees = require('./install/diff-trees.js')\nvar checkPermissions = require('./install/check-permissions.js')\nvar decomposeActions = require('./install/decompose-actions.js')\nvar validateTree = require('./install/validate-tree.js')\nvar validateArgs = require('./install/validate-args.js')\nvar saveRequested = require('./install/save.js').saveRequested\nvar saveShrinkwrap = require('./install/save.js').saveShrinkwrap\nvar audit = require('./install/audit.js')\nvar getSaveType = require('./install/save.js').getSaveType\nvar doSerialActions = require('./install/actions.js').doSerial\nvar doReverseSerialActions = require('./install/actions.js').doReverseSerial\nvar doParallelActions = require('./install/actions.js').doParallel\nvar doOneAction = require('./install/actions.js').doOne\nvar removeObsoleteDep = require('./install/deps.js').removeObsoleteDep\nvar removeExtraneous = require('./install/deps.js').removeExtraneous\nvar computeVersionSpec = require('./install/deps.js').computeVersionSpec\nvar packageId = require('./utils/package-id.js')\nvar moduleName = require('./utils/module-name.js')\nvar errorMessage = require('./utils/error-message.js')\nvar isExtraneous = require('./install/is-extraneous.js')\n\nfunction unlockCB (lockPath, name, cb) {\n  validate('SSF', arguments)\n  return function (installEr) {\n    var args = arguments\n    try {\n      unlock(lockPath, name, reportErrorAndReturn)\n    } catch (unlockEx) {\n      process.nextTick(function () {\n        reportErrorAndReturn(unlockEx)\n      })\n    }\n    function reportErrorAndReturn (unlockEr) {\n      if (installEr) {\n        if (unlockEr && unlockEr.code !== 'ENOTLOCKED') {\n          log.warn('unlock' + name, unlockEr)\n        }\n        return cb.apply(null, args)\n      }\n      if (unlockEr) return cb(unlockEr)\n      return cb.apply(null, args)\n    }\n  }\n}\n\nfunction install (where, args, cb) {\n  if (!cb) {\n    cb = args\n    args = where\n    where = null\n  }\n  var globalTop = path.resolve(npm.globalDir, '..')\n  if (!where) {\n    where = npm.config.get('global')\n      ? globalTop\n      : npm.prefix\n  }\n  validate('SAF', [where, args, cb])\n  // the /path/to/node_modules/..\n  var dryrun = !!npm.config.get('dry-run')\n\n  if (npm.config.get('dev')) {\n    log.warn('install', 'Usage of the `--dev` option is deprecated. Use `--only=dev` instead.')\n  }\n\n  if (where === globalTop && !args.length) {\n    args = ['.']\n  }\n  args = args.filter(function (a) {\n    return path.resolve(a) !== npm.prefix\n  })\n\n  new Installer(where, dryrun, args).run(cb)\n}\n\nfunction Installer (where, dryrun, args, opts) {\n  validate('SBA|SBAO', arguments)\n  if (!opts) opts = {}\n  this.where = where\n  this.dryrun = dryrun\n  this.args = args\n  // fakechildren are children created from the lockfile and lack relationship data\n  // the only exist when the tree does not match the lockfile\n  // this is fine when doing full tree installs/updates but not ok when modifying only\n  // a few deps via `npm install` or `npm uninstall`.\n  this.currentTree = null\n  this.idealTree = null\n  this.differences = []\n  this.todo = []\n  this.progress = {}\n  this.noPackageJsonOk = !!args.length\n  this.topLevelLifecycles = !args.length\n\n  this.autoPrune = npm.config.get('package-lock')\n\n  const dev = npm.config.get('dev')\n  const only = npm.config.get('only')\n  const onlyProd = /^prod(uction)?$/.test(only)\n  const onlyDev = /^dev(elopment)?$/.test(only)\n  const prod = npm.config.get('production')\n  this.dev = opts.dev != null ? opts.dev : dev || (!onlyProd && !prod) || onlyDev\n  this.prod = opts.prod != null ? opts.prod : !onlyDev\n\n  this.packageLockOnly = opts.packageLockOnly != null\n    ? opts.packageLockOnly : npm.config.get('package-lock-only')\n  this.rollback = opts.rollback != null ? opts.rollback : npm.config.get('rollback')\n  this.link = opts.link != null ? opts.link : npm.config.get('link')\n  this.saveOnlyLock = opts.saveOnlyLock\n  this.global = opts.global != null ? opts.global : this.where === path.resolve(npm.globalDir, '..')\n  this.audit = npm.config.get('audit') && !this.global\n  this.started = Date.now()\n}\nInstaller.prototype = {}\n\nInstaller.prototype.run = function (_cb) {\n  validate('F|', arguments)\n\n  var result\n  var cb\n  if (_cb) {\n    cb = function (err) {\n      saveMetrics(!err)\n      return _cb.apply(this, arguments)\n    }\n  } else {\n    result = new Promise((resolve, reject) => {\n      cb = (err, value) => err ? reject(err) : resolve(value)\n    })\n  }\n  // FIXME: This is bad and I should feel bad.\n  // lib/install needs to have some way of sharing _limited_\n  // state with the things it calls. Passing the object is too\n  // much. The global config is WAY too much. =( =(\n  // But not having this is gonna break linked modules in\n  // subtle stupid ways, and refactoring all this code isn't\n  // the right thing to do just yet.\n  if (this.global) {\n    var prevGlobal = npm.config.get('global')\n    npm.config.set('global', true)\n    var next = cb\n    cb = function () {\n      npm.config.set('global', prevGlobal)\n      next.apply(null, arguments)\n    }\n  }\n\n  var installSteps = []\n  var postInstallSteps = []\n  if (!this.dryrun) {\n    installSteps.push(\n      [this.newTracker(log, 'runTopLevelLifecycles', 2)],\n      [this, this.runPreinstallTopLevelLifecycles])\n  }\n  installSteps.push(\n    [this.newTracker(log, 'loadCurrentTree', 4)],\n    [this, this.loadCurrentTree],\n    [this, this.finishTracker, 'loadCurrentTree'],\n\n    [this.newTracker(log, 'loadIdealTree', 12)],\n    [this, this.loadIdealTree],\n    [this, this.finishTracker, 'loadIdealTree'],\n\n    [this, this.debugTree, 'currentTree', 'currentTree'],\n    [this, this.debugTree, 'idealTree', 'idealTree'],\n\n    [this.newTracker(log, 'generateActionsToTake')],\n    [this, this.generateActionsToTake],\n    [this, this.finishTracker, 'generateActionsToTake'],\n\n    [this, this.debugActions, 'diffTrees', 'differences'],\n    [this, this.debugActions, 'decomposeActions', 'todo'],\n    [this, this.startAudit]\n  )\n\n  if (this.packageLockOnly) {\n    postInstallSteps.push(\n      [this, this.saveToDependencies])\n  } else if (!this.dryrun) {\n    installSteps.push(\n      [this.newTracker(log, 'executeActions', 8)],\n      [this, this.executeActions],\n      [this, this.finishTracker, 'executeActions'])\n    var node_modules = path.resolve(this.where, 'node_modules')\n    var staging = path.resolve(node_modules, '.staging')\n    postInstallSteps.push(\n      [this.newTracker(log, 'rollbackFailedOptional', 1)],\n      [this, this.rollbackFailedOptional, staging, this.todo],\n      [this, this.finishTracker, 'rollbackFailedOptional'],\n      [this, this.commit, staging, this.todo],\n\n      [this, this.runPostinstallTopLevelLifecycles],\n      [this, this.finishTracker, 'runTopLevelLifecycles']\n    )\n    if (getSaveType()) {\n      postInstallSteps.push(\n        // this is necessary as we don't fill in `dependencies` and `devDependencies` in deps loaded from shrinkwrap\n        // until after we extract them\n        [this, (next) => { computeMetadata(this.idealTree); next() }],\n        [this, this.pruneIdealTree],\n        [this, this.debugLogicalTree, 'saveTree', 'idealTree'],\n        [this, this.saveToDependencies])\n    }\n  }\n  postInstallSteps.push(\n    [this, this.printWarnings],\n    [this, this.printInstalled])\n\n  var self = this\n  chain(installSteps, function (installEr) {\n    if (installEr) self.failing = true\n    chain(postInstallSteps, function (postInstallEr) {\n      if (installEr && postInstallEr) {\n        var msg = errorMessage(postInstallEr)\n        msg.summary.forEach(function (logline) {\n          log.warn.apply(log, logline)\n        })\n        msg.detail.forEach(function (logline) {\n          log.verbose.apply(log, logline)\n        })\n      }\n      cb(installEr || postInstallEr, self.getInstalledModules(), self.idealTree)\n    })\n  })\n  return result\n}\n\nInstaller.prototype.loadArgMetadata = function (next) {\n  getAllMetadata(this.args, this.currentTree, process.cwd(), iferr(next, (args) => {\n    this.args = args\n    next()\n  }))\n}\n\nInstaller.prototype.newTracker = function (tracker, name, size) {\n  validate('OS', [tracker, name])\n  if (size) validate('N', [size])\n  this.progress[name] = tracker.newGroup(name, size)\n  return function (next) {\n    process.emit('time', 'stage:' + name)\n    next()\n  }\n}\n\nInstaller.prototype.finishTracker = function (name, cb) {\n  validate('SF', arguments)\n  process.emit('timeEnd', 'stage:' + name)\n  cb()\n}\n\nInstaller.prototype.loadCurrentTree = function (cb) {\n  validate('F', arguments)\n  log.silly('install', 'loadCurrentTree')\n  var todo = []\n  if (this.global) {\n    todo.push([this, this.readGlobalPackageData])\n  } else {\n    todo.push([this, this.readLocalPackageData])\n  }\n  todo.push([this, this.normalizeCurrentTree])\n  chain(todo, cb)\n}\n\nvar createNode = require('./install/node.js').create\nvar flatNameFromTree = require('./install/flatten-tree.js').flatNameFromTree\nInstaller.prototype.normalizeCurrentTree = function (cb) {\n  this.currentTree.isTop = true\n  normalizeTree(this.currentTree)\n  // If the user didn't have a package.json then fill in deps with what was on disk\n  if (this.currentTree.error) {\n    for (let child of this.currentTree.children) {\n      if (!child.fakeChild && isExtraneous(child)) {\n        this.currentTree.package.dependencies[child.package.name] = computeVersionSpec(this.currentTree, child)\n      }\n    }\n  }\n  computeMetadata(this.currentTree)\n  return cb()\n\n  function normalizeTree (tree, seen) {\n    if (!seen) seen = new Set()\n    if (seen.has(tree)) return\n    seen.add(tree)\n    createNode(tree)\n    tree.location = flatNameFromTree(tree)\n    tree.children.forEach((child) => normalizeTree(child, seen))\n  }\n}\n\nInstaller.prototype.loadIdealTree = function (cb) {\n  validate('F', arguments)\n  log.silly('install', 'loadIdealTree')\n\n  chain([\n    [this.newTracker(this.progress.loadIdealTree, 'loadIdealTree:cloneCurrentTree')],\n    [this, this.cloneCurrentTreeToIdealTree],\n    [this, this.finishTracker, 'loadIdealTree:cloneCurrentTree'],\n\n    [this.newTracker(this.progress.loadIdealTree, 'loadIdealTree:loadShrinkwrap')],\n    [this, this.loadShrinkwrap],\n    [this, this.finishTracker, 'loadIdealTree:loadShrinkwrap'],\n\n    [this.newTracker(this.progress.loadIdealTree, 'loadIdealTree:loadAllDepsIntoIdealTree', 10)],\n    [this, this.loadAllDepsIntoIdealTree],\n    [this, this.finishTracker, 'loadIdealTree:loadAllDepsIntoIdealTree'],\n    [this, function (next) { computeMetadata(this.idealTree); next() }],\n    [this, this.pruneIdealTree]\n  ], cb)\n}\n\nInstaller.prototype.pruneIdealTree = function (cb) {\n  if (!this.idealTree) return cb()\n  // if our lock file didn't have the requires field and there\n  // are any fake children then forgo pruning until we have more info.\n  if (!this.idealTree.hasRequiresFromLock && this.idealTree.children.some((n) => n.fakeChild)) return cb()\n  const toPrune = this.idealTree.children\n    .filter((child) => isExtraneous(child) && (this.autoPrune || child.removing))\n    .map((n) => ({name: moduleName(n)}))\n  return removeExtraneous(toPrune, this.idealTree, cb)\n}\n\nInstaller.prototype.loadAllDepsIntoIdealTree = function (cb) {\n  validate('F', arguments)\n  log.silly('install', 'loadAllDepsIntoIdealTree')\n  var saveDeps = getSaveType()\n\n  var cg = this.progress['loadIdealTree:loadAllDepsIntoIdealTree']\n  var installNewModules = !!this.args.length\n  var steps = []\n\n  if (installNewModules) {\n    steps.push([validateArgs, this.idealTree, this.args])\n    steps.push([loadRequestedDeps, this.args, this.idealTree, saveDeps, cg.newGroup('loadRequestedDeps')])\n  } else {\n    const depsToPreload = Object.assign({},\n      this.idealTree.package.devDependencies,\n      this.idealTree.package.dependencies\n    )\n    steps.push(\n      [prefetchDeps, this.idealTree, depsToPreload, cg.newGroup('prefetchDeps')],\n      [loadDeps, this.idealTree, cg.newGroup('loadDeps')],\n      [loadDevDeps, this.idealTree, cg.newGroup('loadDevDeps')])\n  }\n  steps.push(\n    [loadExtraneous.andResolveDeps, this.idealTree, cg.newGroup('loadExtraneous')])\n  chain(steps, cb)\n}\n\nInstaller.prototype.generateActionsToTake = function (cb) {\n  validate('F', arguments)\n  log.silly('install', 'generateActionsToTake')\n  var cg = this.progress.generateActionsToTake\n  chain([\n    [validateTree, this.idealTree, cg.newGroup('validateTree')],\n    [diffTrees, this.currentTree, this.idealTree, this.differences, cg.newGroup('diffTrees')],\n    [this, this.computeLinked],\n    [checkPermissions, this.differences],\n    [decomposeActions, this.differences, this.todo]\n  ], cb)\n}\n\nInstaller.prototype.computeLinked = function (cb) {\n  validate('F', arguments)\n  if (!this.link || this.global) return cb()\n  var linkTodoList = []\n  var self = this\n  asyncMap(this.differences, function (action, next) {\n    var cmd = action[0]\n    var pkg = action[1]\n    if (cmd !== 'add' && cmd !== 'update') return next()\n    var isReqByTop = pkg.requiredBy.filter(function (mod) { return mod.isTop }).length\n    var isReqByUser = pkg.userRequired\n    var isExtraneous = pkg.requiredBy.length === 0\n    if (!isReqByTop && !isReqByUser && !isExtraneous) return next()\n    isLinkable(pkg, function (install, link) {\n      if (install) linkTodoList.push(['global-install', pkg])\n      if (link) linkTodoList.push(['global-link', pkg])\n      if (install || link) removeObsoleteDep(pkg)\n      next()\n    })\n  }, function () {\n    if (linkTodoList.length === 0) return cb()\n    self.differences.length = 0\n    Array.prototype.push.apply(self.differences, linkTodoList)\n    diffTrees(self.currentTree, self.idealTree, self.differences, log.newGroup('d2'), cb)\n  })\n}\n\nfunction isLinkable (pkg, cb) {\n  var globalPackage = path.resolve(npm.globalPrefix, 'lib', 'node_modules', moduleName(pkg))\n  var globalPackageJson = path.resolve(globalPackage, 'package.json')\n  fs.stat(globalPackage, function (er) {\n    if (er) return cb(true, true)\n    fs.readFile(globalPackageJson, function (er, data) {\n      var json = parseJSON.noExceptions(data)\n      cb(false, json && json.version === pkg.package.version)\n    })\n  })\n}\n\nInstaller.prototype.executeActions = function (cb) {\n  validate('F', arguments)\n  log.silly('install', 'executeActions')\n  var todo = this.todo\n  var cg = this.progress.executeActions\n\n  var node_modules = path.resolve(this.where, 'node_modules')\n  var staging = path.resolve(node_modules, '.staging')\n  var steps = []\n  var trackLifecycle = cg.newGroup('lifecycle')\n\n  cb = unlockCB(node_modules, '.staging', cb)\n\n  steps.push(\n    [doSerialActions, 'global-install', staging, todo, trackLifecycle.newGroup('global-install')],\n    [lock, node_modules, '.staging'],\n    [rimraf, staging],\n    [doParallelActions, 'extract', staging, todo, cg.newGroup('extract', 100)],\n    [doReverseSerialActions, 'unbuild', staging, todo, cg.newGroup('unbuild')],\n    [doSerialActions, 'remove', staging, todo, cg.newGroup('remove')],\n    [doSerialActions, 'move', staging, todo, cg.newGroup('move')],\n    [doSerialActions, 'finalize', staging, todo, cg.newGroup('finalize')],\n    [doParallelActions, 'refresh-package-json', staging, todo, cg.newGroup('refresh-package-json')],\n    [doParallelActions, 'preinstall', staging, todo, trackLifecycle.newGroup('preinstall')],\n    [doSerialActions, 'build', staging, todo, trackLifecycle.newGroup('build')],\n    [doSerialActions, 'global-link', staging, todo, trackLifecycle.newGroup('global-link')],\n    [doParallelActions, 'update-linked', staging, todo, trackLifecycle.newGroup('update-linked')],\n    [doSerialActions, 'install', staging, todo, trackLifecycle.newGroup('install')],\n    [doSerialActions, 'postinstall', staging, todo, trackLifecycle.newGroup('postinstall')])\n\n  var self = this\n  chain(steps, function (er) {\n    if (!er || self.rollback) {\n      rimraf(staging, function () { cb(er) })\n    } else {\n      cb(er)\n    }\n  })\n}\n\nInstaller.prototype.rollbackFailedOptional = function (staging, actionsToRun, cb) {\n  if (!this.rollback) return cb()\n  var failed = uniq(actionsToRun.map(function (action) {\n    return action[1]\n  }).filter(function (pkg) {\n    return pkg.failed && pkg.rollback\n  }))\n  var top = this.currentTree && this.currentTree.path\n  Bluebird.map(failed, (pkg) => {\n    return Bluebird.map(pkg.rollback, (rollback) => rollback(top, staging, pkg))\n  }).asCallback(cb)\n}\n\nInstaller.prototype.commit = function (staging, actionsToRun, cb) {\n  var toCommit = actionsToRun.map(function (action) { return action[1] }).filter(function (pkg) { return !pkg.failed && pkg.commit })\n  asyncMap(toCommit, function (pkg, next) {\n    asyncMap(pkg.commit, function (commit, done) {\n      commit(staging, pkg, done)\n    }, function () {\n      pkg.commit = []\n      next.apply(null, arguments)\n    })\n  }, cb)\n}\n\nInstaller.prototype.runPreinstallTopLevelLifecycles = function (cb) {\n  validate('F', arguments)\n  if (this.failing) return cb()\n  if (!this.topLevelLifecycles) return cb()\n  log.silly('install', 'runPreinstallTopLevelLifecycles')\n\n  readPackageJson(path.join(this.where, 'package.json'), log, false, (err, data) => {\n    if (err) return cb()\n    this.currentTree = createNode({\n      isTop: true,\n      package: data,\n      path: this.where\n    })\n    doOneAction('preinstall', this.where, this.currentTree, log.newGroup('preinstall:.'), cb)\n  })\n}\n\nInstaller.prototype.runPostinstallTopLevelLifecycles = function (cb) {\n  validate('F', arguments)\n  if (this.failing) return cb()\n  if (!this.topLevelLifecycles) return cb()\n  log.silly('install', 'runPostinstallTopLevelLifecycles')\n  var steps = []\n  var trackLifecycle = this.progress.runTopLevelLifecycles\n\n  steps.push(\n    [doOneAction, 'build', this.idealTree.path, this.idealTree, trackLifecycle.newGroup('build:.')],\n    [doOneAction, 'install', this.idealTree.path, this.idealTree, trackLifecycle.newGroup('install:.')],\n    [doOneAction, 'postinstall', this.idealTree.path, this.idealTree, trackLifecycle.newGroup('postinstall:.')])\n  if (this.dev) {\n    steps.push(\n      [doOneAction, 'prepare', this.idealTree.path, this.idealTree, trackLifecycle.newGroup('prepare')])\n  }\n  chain(steps, cb)\n}\n\nInstaller.prototype.startAudit = function (cb) {\n  if (!this.audit) return cb()\n  this.auditSubmission = Bluebird.try(() => {\n    return audit.generateFromInstall(this.idealTree, this.differences, this.args, this.remove)\n  }).then((auditData) => {\n    return audit.submitForInstallReport(auditData)\n  }).catch(_ => {})\n  cb()\n}\n\nInstaller.prototype.saveToDependencies = function (cb) {\n  validate('F', arguments)\n  if (this.failing) return cb()\n  log.silly('install', 'saveToDependencies')\n  if (this.saveOnlyLock) {\n    saveShrinkwrap(this.idealTree, cb)\n  } else {\n    saveRequested(this.idealTree, cb)\n  }\n}\n\nInstaller.prototype.readGlobalPackageData = function (cb) {\n  validate('F', arguments)\n  log.silly('install', 'readGlobalPackageData')\n  var self = this\n  this.loadArgMetadata(iferr(cb, function () {\n    mkdirp(self.where, iferr(cb, function () {\n      var pkgs = {}\n      self.args.forEach(function (pkg) {\n        pkgs[pkg.name] = true\n      })\n      readPackageTree(self.where, function (ctx, kid) { return ctx.parent || pkgs[kid] }, iferr(cb, function (currentTree) {\n        self.currentTree = currentTree\n        return cb()\n      }))\n    }))\n  }))\n}\n\nInstaller.prototype.readLocalPackageData = function (cb) {\n  validate('F', arguments)\n  log.silly('install', 'readLocalPackageData')\n  var self = this\n  mkdirp(this.where, iferr(cb, function () {\n    readPackageTree(self.where, iferr(cb, function (currentTree) {\n      self.currentTree = currentTree\n      self.currentTree.warnings = []\n      if (currentTree.error && currentTree.error.code === 'EJSONPARSE') {\n        return cb(currentTree.error)\n      }\n      if (!self.noPackageJsonOk && !currentTree.package) {\n        log.error('install', \"Couldn't read dependencies\")\n        var er = new Error(\"ENOENT, open '\" + path.join(self.where, 'package.json') + \"'\")\n        er.code = 'ENOPACKAGEJSON'\n        er.errno = 34\n        return cb(er)\n      }\n      if (!currentTree.package) currentTree.package = {}\n      readShrinkwrap(currentTree, function (err) {\n        if (err) {\n          cb(err)\n        } else {\n          self.loadArgMetadata(cb)\n        }\n      })\n    }))\n  }))\n}\n\nInstaller.prototype.cloneCurrentTreeToIdealTree = function (cb) {\n  validate('F', arguments)\n  log.silly('install', 'cloneCurrentTreeToIdealTree')\n\n  this.idealTree = copyTree(this.currentTree)\n  this.idealTree.warnings = []\n  cb()\n}\n\nInstaller.prototype.loadShrinkwrap = function (cb) {\n  validate('F', arguments)\n  log.silly('install', 'loadShrinkwrap')\n  readShrinkwrap.andInflate(this.idealTree, iferr(cb, () => {\n    computeMetadata(this.idealTree)\n    cb()\n  }))\n}\n\nInstaller.prototype.getInstalledModules = function () {\n  return this.differences.filter(function (action) {\n    var mutation = action[0]\n    return (mutation === 'add' || mutation === 'update')\n  }).map(function (action) {\n    var child = action[1]\n    return [child.package._id, child.path]\n  })\n}\n\nInstaller.prototype.printWarnings = function (cb) {\n  if (!this.idealTree) return cb()\n\n  var self = this\n  var warned = false\n  this.idealTree.warnings.forEach(function (warning) {\n    if (warning.code === 'EPACKAGEJSON' && self.global) return\n    if (warning.code === 'ENOTDIR') return\n    warned = true\n    var msg = errorMessage(warning)\n    msg.summary.forEach(function (logline) {\n      log.warn.apply(log, logline)\n    })\n    msg.detail.forEach(function (logline) {\n      log.verbose.apply(log, logline)\n    })\n  })\n  if (warned && log.levels[npm.config.get('loglevel')] <= log.levels.warn) console.error()\n  cb()\n}\n\nInstaller.prototype.printInstalled = function (cb) {\n  validate('F', arguments)\n  if (this.failing) return cb()\n  log.silly('install', 'printInstalled')\n  const diffs = this.differences\n  if (!this.idealTree.error && this.idealTree.removedChildren) {\n    const deps = this.currentTree.package.dependencies || {}\n    const dev = this.currentTree.package.devDependencies || {}\n    this.idealTree.removedChildren.forEach((r) => {\n      if (diffs.some((d) => d[0] === 'remove' && d[1].path === r.path)) return\n      if (!deps[moduleName(r)] && !dev[moduleName(r)]) return\n      diffs.push(['remove', r])\n    })\n  }\n  return Bluebird.try(() => {\n    if (!this.auditSubmission) return\n    return Bluebird.resolve(this.auditSubmission).timeout(10000).catch(() => null)\n  }).then((auditResult) => {\n    // maybe write audit report w/ hash of pjson & shrinkwrap for later reading by `npm audit`\n    if (npm.config.get('json')) {\n      return this.printInstalledForJSON(diffs, auditResult)\n    } else if (npm.config.get('parseable')) {\n      return this.printInstalledForParseable(diffs, auditResult)\n    } else {\n      return this.printInstalledForHuman(diffs, auditResult)\n    }\n  }).asCallback(cb)\n}\n\nInstaller.prototype.printInstalledForHuman = function (diffs, auditResult) {\n  var removed = 0\n  var added = 0\n  var updated = 0\n  var moved = 0\n  // Count the number of contributors to packages added, tracking\n  // contributors we've seen, so we can produce a running unique count.\n  var contributors = new Set()\n  diffs.forEach(function (action) {\n    var mutation = action[0]\n    var pkg = action[1]\n    if (pkg.failed) return\n    if (mutation === 'remove') {\n      ++removed\n    } else if (mutation === 'move') {\n      ++moved\n    } else if (mutation === 'add') {\n      ++added\n      // Count contributors to added packages. Start by combining `author`\n      // and `contributors` data into a single array of contributor-people\n      // for this package.\n      var people = []\n      var meta = pkg.package\n      if (meta.author) people.push(meta.author)\n      if (meta.contributors && Array.isArray(meta.contributors)) {\n        people = people.concat(meta.contributors)\n      }\n      // Make sure a normalized string for every person behind this\n      // package is in `contributors`.\n      people.forEach(function (person) {\n        // Ignore errors from malformed `author` and `contributors`.\n        try {\n          var normalized = normalizePerson(person)\n        } catch (error) {\n          return\n        }\n        if (!contributors.has(normalized)) contributors.add(normalized)\n      })\n    } else if (mutation === 'update' || mutation === 'update-linked') {\n      ++updated\n    }\n  })\n  var report = ''\n  if (this.args.length && (added || updated)) {\n    report += this.args.map((p) => {\n      return `+ ${p.name}@${p.version}`\n    }).join('\\n') + '\\n'\n  }\n  var actions = []\n  if (added) {\n    var action = 'added ' + packages(added)\n    if (contributors.size) action += from(contributors.size)\n    actions.push(action)\n  }\n  if (removed) actions.push('removed ' + packages(removed))\n  if (updated) actions.push('updated ' + packages(updated))\n  if (moved) actions.push('moved ' + packages(moved))\n  if (auditResult && auditResult.metadata.totalDependencies) {\n    actions.push('audited ' + packages(auditResult.metadata.totalDependencies))\n  }\n  if (actions.length === 0) {\n    report += 'up to date'\n  } else if (actions.length === 1) {\n    report += actions[0]\n  } else {\n    var lastAction = actions.pop()\n    report += actions.join(', ') + ' and ' + lastAction\n  }\n  report += ' in ' + ((Date.now() - this.started) / 1000) + 's'\n\n  output(report)\n  return auditResult && audit.printInstallReport(auditResult)\n\n  function packages (num) {\n    return num + ' package' + (num > 1 ? 's' : '')\n  }\n\n  function from (num) {\n    return ' from ' + num + ' contributor' + (num > 1 ? 's' : '')\n  }\n\n  // Values of `author` and elements of `contributors` in `package.json`\n  // files can be e-mail style strings or Objects with `name`, `email,\n  // and `url` String properties.  Convert Objects to Strings so that\n  // we can efficiently keep a set of contributors we have already seen.\n  function normalizePerson (argument) {\n    if (typeof argument === 'string') return argument\n    var returned = ''\n    if (argument.name) returned += argument.name\n    if (argument.email) returned += ' <' + argument.email + '>'\n    if (argument.url) returned += ' (' + argument.email + ')'\n    return returned\n  }\n}\n\nInstaller.prototype.printInstalledForJSON = function (diffs, auditResult) {\n  var result = {\n    added: [],\n    removed: [],\n    updated: [],\n    moved: [],\n    failed: [],\n    warnings: [],\n    audit: auditResult,\n    elapsed: Date.now() - this.started\n  }\n  var self = this\n  this.idealTree.warnings.forEach(function (warning) {\n    if (warning.code === 'EPACKAGEJSON' && self.global) return\n    if (warning.code === 'ENOTDIR') return\n    var output = errorMessage(warning)\n    var message = flattenMessage(output.summary)\n    if (output.detail.length) {\n      message += '\\n' + flattenMessage(output.detail)\n    }\n    result.warnings.push(message)\n  })\n  diffs.forEach(function (action) {\n    var mutation = action[0]\n    var child = action[1]\n    var record = recordAction(action)\n    if (child.failed) {\n      result.failed.push(record)\n    } else if (mutation === 'add') {\n      result.added.push(record)\n    } else if (mutation === 'update' || mutation === 'update-linked') {\n      result.updated.push(record)\n    } else if (mutation === 'move') {\n      result.moved.push(record)\n    } else if (mutation === 'remove') {\n      result.removed.push(record)\n    }\n  })\n  output(JSON.stringify(result, null, 2))\n\n  function flattenMessage (msg) {\n    return msg.map(function (logline) { return logline.slice(1).join(' ') }).join('\\n')\n  }\n\n  function recordAction (action) {\n    var mutation = action[0]\n    var child = action[1]\n    var result = {\n      action: mutation,\n      name: moduleName(child),\n      version: child.package && child.package.version,\n      path: child.path\n    }\n    if (mutation === 'move') {\n      result.previousPath = child.fromPath\n    } else if (mutation === 'update') {\n      result.previousVersion = child.oldPkg.package && child.oldPkg.package.version\n    }\n    return result\n  }\n}\n\nInstaller.prototype.printInstalledForParseable = function (diffs) {\n  var self = this\n  diffs.forEach(function (action) {\n    var mutation = action[0]\n    var child = action[1]\n    if (mutation === 'move') {\n      var previousPath = path.relative(self.where, child.fromPath)\n    } else if (mutation === 'update') {\n      var previousVersion = child.oldPkg.package && child.oldPkg.package.version\n    }\n    output(\n      mutation + '\\t' +\n      moduleName(child) + '\\t' +\n      (child.package ? child.package.version : '') + '\\t' +\n      (child.path ? path.relative(self.where, child.path) : '') + '\\t' +\n      (previousVersion || '') + '\\t' +\n      (previousPath || ''))\n  })\n}\n\nInstaller.prototype.debugActions = function (name, actionListName, cb) {\n  validate('SSF', arguments)\n  var actionsToLog = this[actionListName]\n  log.silly(name, 'action count', actionsToLog.length)\n  actionsToLog.forEach(function (action) {\n    log.silly(name, action.map(function (value) {\n      return (value && value.package) ? packageId(value) : value\n    }).join(' '))\n  })\n  cb()\n}\n\n// This takes an object and a property name instead of a value to allow us\n// to define the arguments for use by chain before the property exists yet.\nInstaller.prototype.debugTree = function (name, treeName, cb) {\n  validate('SSF', arguments)\n  log.silly(name, this.archyDebugTree(this[treeName]).trim())\n  cb()\n}\n\nInstaller.prototype.archyDebugTree = function (tree) {\n  validate('O', arguments)\n  var seen = new Set()\n  function byName (aa, bb) {\n    return packageId(aa).localeCompare(packageId(bb))\n  }\n  function expandTree (tree) {\n    seen.add(tree)\n    return {\n      label: packageId(tree),\n      nodes: tree.children.filter((tree) => { return !seen.has(tree) && !tree.removed }).sort(byName).map(expandTree)\n    }\n  }\n  return archy(expandTree(tree), '', { unicode: npm.config.get('unicode') })\n}\n\nInstaller.prototype.debugLogicalTree = function (name, treeName, cb) {\n  validate('SSF', arguments)\n  this[treeName] && log.silly(name, this.archyDebugLogicalTree(this[treeName]).trim())\n  cb()\n}\n\nInstaller.prototype.archyDebugLogicalTree = function (tree) {\n  validate('O', arguments)\n  var seen = new Set()\n  function byName (aa, bb) {\n    return packageId(aa).localeCompare(packageId(bb))\n  }\n  function expandTree (tree) {\n    seen.add(tree)\n    return {\n      label: packageId(tree),\n      nodes: tree.requires.filter((tree) => { return !seen.has(tree) && !tree.removed }).sort(byName).map(expandTree)\n    }\n  }\n  return archy(expandTree(tree), '', { unicode: npm.config.get('unicode') })\n}\n"]}
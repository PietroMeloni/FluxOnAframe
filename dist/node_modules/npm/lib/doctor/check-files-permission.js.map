{"version":3,"sources":["../../../../../node_modules/npm/lib/doctor/check-files-permission.js"],"names":["fs","require","path","getUid","chain","log","npm","fileCompletion","checkFilesPermission","root","fmask","dmask","cb","process","platform","config","get","e","uid","gid","tracker","newItem","finish","warn","info","Infinity","files","addWork","length","completeWork","map","andCheckFile","er","f","checkFile","next","file","join","silly","lstat","stat","isDirectory","isFile","access","err","error","Error","module","exports"],"mappings":";;AAAA,IAAIA,KAAKC,QAAQ,IAAR,CAAT;AACA,IAAIC,OAAOD,QAAQ,MAAR,CAAX;AACA,IAAIE,SAASF,QAAQ,YAAR,CAAb;AACA,IAAIG,QAAQH,QAAQ,OAAR,EAAiBG,KAA7B;AACA,IAAIC,MAAMJ,QAAQ,QAAR,CAAV;AACA,IAAIK,MAAML,QAAQ,WAAR,CAAV;AACA,IAAIM,iBAAiBN,QAAQ,wCAAR,CAArB;;AAEA,SAASO,oBAAT,CAA+BC,IAA/B,EAAqCC,KAArC,EAA4CC,KAA5C,EAAmDC,EAAnD,EAAuD;AACrD,MAAIC,QAAQC,QAAR,KAAqB,OAAzB,EAAkC,OAAOF,GAAG,IAAH,EAAS,IAAT,CAAP;AAClCT,SAAOG,IAAIS,MAAJ,CAAWC,GAAX,CAAe,MAAf,CAAP,EAA+BV,IAAIS,MAAJ,CAAWC,GAAX,CAAe,OAAf,CAA/B,EAAwD,UAAUC,CAAV,EAAaC,GAAb,EAAkBC,GAAlB,EAAuB;AAC7E,QAAIC,UAAUf,IAAIgB,OAAJ,CAAY,sBAAZ,EAAoC,CAApC,CAAd;AACA,QAAIJ,CAAJ,EAAO;AACLG,cAAQE,MAAR;AACAF,cAAQG,IAAR,CAAa,sBAAb,EAAqC,kCAArC,EAAyEN,CAAzE;AACA,aAAOL,GAAGK,CAAH,CAAP;AACD;AACDG,YAAQI,IAAR,CAAa,sBAAb,EAAqC,2BAA2Bf,IAAhE;AACAF,mBAAeE,IAAf,EAAqB,GAArB,EAA0BgB,QAA1B,EAAoC,UAAUR,CAAV,EAAaS,KAAb,EAAoB;AACtD,UAAIT,CAAJ,EAAO;AACLG,gBAAQG,IAAR,CAAa,sBAAb,EAAqC,2BAArC,EAAkEN,CAAlE;AACAG,gBAAQE,MAAR;AACA,eAAOV,GAAGK,CAAH,CAAP;AACD;AACDG,cAAQO,OAAR,CAAgBD,MAAME,MAAtB;AACAR,cAAQS,YAAR,CAAqB,CAArB;AACAzB,YAAMsB,MAAMI,GAAN,CAAUC,YAAV,CAAN,EAA+B,UAAUC,EAAV,EAAc;AAC3CZ,gBAAQE,MAAR;AACAV,WAAG,IAAH,EAAS,CAACoB,EAAV;AACD,OAHD;AAIA,eAASD,YAAT,CAAuBE,CAAvB,EAA0B;AACxB,eAAO,CAACC,SAAD,EAAYD,CAAZ,CAAP;AACD;AACD,eAASC,SAAT,CAAoBD,CAApB,EAAuBE,IAAvB,EAA6B;AAC3B,YAAIC,OAAOlC,KAAKmC,IAAL,CAAU5B,IAAV,EAAgBwB,CAAhB,CAAX;AACAb,gBAAQkB,KAAR,CAAc,sBAAd,EAAsCL,CAAtC;AACAjC,WAAGuC,KAAH,CAASH,IAAT,EAAe,UAAUnB,CAAV,EAAauB,IAAb,EAAmB;AAChCpB,kBAAQS,YAAR,CAAqB,CAArB;AACA,cAAIZ,CAAJ,EAAO,OAAOkB,KAAKlB,CAAL,CAAP;AACP,cAAI,CAACuB,KAAKC,WAAL,EAAD,IAAuB,CAACD,KAAKE,MAAL,EAA5B,EAA2C,OAAOP,MAAP;AAC3C;AACA;AACAnC,aAAG2C,MAAH,CAAUP,IAAV,EAAgBI,KAAKE,MAAL,KAAgBhC,KAAhB,GAAwBC,KAAxC,EAA+C,UAACiC,GAAD,EAAS;AACtD,gBAAIA,GAAJ,EAAS;AACPxB,sBAAQyB,KAAR,CAAc,sBAAd,8BAAgET,IAAhE;AACA,qBAAOD,KAAK,IAAIW,KAAJ,CAAU,6BAA6BV,IAAvC,CAAL,CAAP;AACD,aAHD,MAGO;AACL,qBAAOD,MAAP;AACD;AACF,WAPD;AAQD,SAdD;AAeD;AACF,KAlCD;AAmCD,GA3CD;AA4CD;;AAEDY,OAAOC,OAAP,GAAiBxC,oBAAjB","file":"check-files-permission.js","sourcesContent":["var fs = require('fs')\nvar path = require('path')\nvar getUid = require('uid-number')\nvar chain = require('slide').chain\nvar log = require('npmlog')\nvar npm = require('../npm.js')\nvar fileCompletion = require('../utils/completion/file-completion.js')\n\nfunction checkFilesPermission (root, fmask, dmask, cb) {\n  if (process.platform === 'win32') return cb(null, true)\n  getUid(npm.config.get('user'), npm.config.get('group'), function (e, uid, gid) {\n    var tracker = log.newItem('checkFilePermissions', 1)\n    if (e) {\n      tracker.finish()\n      tracker.warn('checkFilePermissions', 'Error looking up user and group:', e)\n      return cb(e)\n    }\n    tracker.info('checkFilePermissions', 'Building file list of ' + root)\n    fileCompletion(root, '.', Infinity, function (e, files) {\n      if (e) {\n        tracker.warn('checkFilePermissions', 'Error building file list:', e)\n        tracker.finish()\n        return cb(e)\n      }\n      tracker.addWork(files.length)\n      tracker.completeWork(1)\n      chain(files.map(andCheckFile), function (er) {\n        tracker.finish()\n        cb(null, !er)\n      })\n      function andCheckFile (f) {\n        return [checkFile, f]\n      }\n      function checkFile (f, next) {\n        var file = path.join(root, f)\n        tracker.silly('checkFilePermissions', f)\n        fs.lstat(file, function (e, stat) {\n          tracker.completeWork(1)\n          if (e) return next(e)\n          if (!stat.isDirectory() && !stat.isFile()) return next()\n          // 6 = fs.constants.R_OK | fs.constants.W_OK\n          // constants aren't available on v4\n          fs.access(file, stat.isFile() ? fmask : dmask, (err) => {\n            if (err) {\n              tracker.error('checkFilePermissions', `Missing permissions on ${file}`)\n              return next(new Error('Missing permissions for ' + file))\n            } else {\n              return next()\n            }\n          })\n        })\n      }\n    })\n  })\n}\n\nmodule.exports = checkFilesPermission\n"]}
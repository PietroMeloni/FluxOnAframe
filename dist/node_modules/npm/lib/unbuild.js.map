{"version":3,"sources":["../../../../node_modules/npm/lib/unbuild.js"],"names":["module","exports","unbuild","rmStuff","usage","readJson","require","gentlyRm","npm","path","isInside","lifecycle","asyncMap","chain","log","build","output","args","silent","cb","unbuild_","folder","cb_","er","relative","root","resolve","base","prefix","_didBuild","verbose","substr","length","pkg","failOk","_id","parent","name","dirname","gnm","dir","top","rmBins","rmMans","fn","bin","binRoot","Object","keys","b","process","platform","gentlyRmBinRoot","err","man","config","get","manRoot","Array","isArray","forEach","rmMan","silly","parseMan","match","error","stem","sxn","gz","bn","basename","manDest","join","indexOf"],"mappings":"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","file":"unbuild.js","sourcesContent":["module.exports = unbuild\nmodule.exports.rmStuff = rmStuff\nunbuild.usage = 'npm unbuild <folder>\\n(this is plumbing)'\n\nvar readJson = require('read-package-json')\nvar gentlyRm = require('./utils/gently-rm.js')\nvar npm = require('./npm.js')\nvar path = require('path')\nvar isInside = require('path-is-inside')\nvar lifecycle = require('./utils/lifecycle.js')\nvar asyncMap = require('slide').asyncMap\nvar chain = require('slide').chain\nvar log = require('npmlog')\nvar build = require('./build.js')\nvar output = require('./utils/output.js')\n\n// args is a list of folders.\n// remove any bins/etc, and then delete the folder.\nfunction unbuild (args, silent, cb) {\n  if (typeof silent === 'function') {\n    cb = silent\n    silent = false\n  }\n  asyncMap(args, unbuild_(silent), cb)\n}\n\nfunction unbuild_ (silent) {\n  return function (folder, cb_) {\n    function cb (er) {\n      cb_(er, path.relative(npm.root, folder))\n    }\n    folder = path.resolve(folder)\n    var base = isInside(folder, npm.prefix) ? npm.prefix : folder\n    delete build._didBuild[folder]\n    log.verbose('unbuild', folder.substr(npm.prefix.length + 1))\n    readJson(path.resolve(folder, 'package.json'), function (er, pkg) {\n      // if no json, then just trash it, but no scripts or whatever.\n      if (er) return gentlyRm(folder, false, base, cb)\n      chain(\n        [\n          [lifecycle, pkg, 'preuninstall', folder, { failOk: true }],\n          [lifecycle, pkg, 'uninstall', folder, { failOk: true }],\n          !silent && function (cb) {\n            output('unbuild ' + pkg._id)\n            cb()\n          },\n          [rmStuff, pkg, folder],\n          [lifecycle, pkg, 'postuninstall', folder, { failOk: true }],\n          [gentlyRm, folder, false, base]\n        ],\n        cb\n      )\n    })\n  }\n}\n\nfunction rmStuff (pkg, folder, cb) {\n  // if it's global, and folder is in {prefix}/node_modules,\n  // then bins are in {prefix}/bin\n  // otherwise, then bins are in folder/../.bin\n  var parent = pkg.name[0] === '@' ? path.dirname(path.dirname(folder)) : path.dirname(folder)\n  var gnm = npm.dir\n  // gnm might be an absolute path, parent might be relative\n  // this checks they're the same directory regardless\n  var top = path.relative(gnm, parent) === ''\n\n  log.verbose('unbuild rmStuff', pkg._id, 'from', gnm)\n  if (!top) log.verbose('unbuild rmStuff', 'in', parent)\n  asyncMap([rmBins, rmMans], function (fn, cb) {\n    fn(pkg, folder, parent, top, cb)\n  }, cb)\n}\n\nfunction rmBins (pkg, folder, parent, top, cb) {\n  if (!pkg.bin) return cb()\n  var binRoot = top ? npm.bin : path.resolve(parent, '.bin')\n  asyncMap(Object.keys(pkg.bin), function (b, cb) {\n    if (process.platform === 'win32') {\n      chain([ [gentlyRm, path.resolve(binRoot, b) + '.cmd', true, folder],\n        [gentlyRm, path.resolve(binRoot, b), true, folder] ], cb)\n    } else {\n      gentlyRm(path.resolve(binRoot, b), true, folder, cb)\n    }\n  }, gentlyRmBinRoot)\n\n  function gentlyRmBinRoot (err) {\n    if (err || top) return cb(err)\n    return gentlyRm(binRoot, true, parent, cb)\n  }\n}\n\nfunction rmMans (pkg, folder, parent, top, cb) {\n  if (!pkg.man ||\n      !top ||\n      process.platform === 'win32' ||\n      !npm.config.get('global')) {\n    return cb()\n  }\n  var manRoot = path.resolve(npm.config.get('prefix'), 'share', 'man')\n  log.verbose('rmMans', 'man files are', pkg.man, 'in', manRoot)\n  asyncMap(pkg.man, function (man, cb) {\n    if (Array.isArray(man)) {\n      man.forEach(rmMan)\n    } else {\n      rmMan(man)\n    }\n\n    function rmMan (man) {\n      log.silly('rmMan', 'preparing to remove', man)\n      var parseMan = man.match(/(.*\\.([0-9]+)(\\.gz)?)$/)\n      if (!parseMan) {\n        log.error(\n          'rmMan', man, 'is not a valid name for a man file.',\n          'Man files must end with a number, ' +\n          'and optionally a .gz suffix if they are compressed.'\n        )\n        return cb()\n      }\n\n      var stem = parseMan[1]\n      var sxn = parseMan[2]\n      var gz = parseMan[3] || ''\n      var bn = path.basename(stem)\n      var manDest = path.join(\n        manRoot,\n        'man' + sxn,\n        (bn.indexOf(pkg.name) === 0 ? bn : pkg.name + '-' + bn) + '.' + sxn + gz\n      )\n      gentlyRm(manDest, true, cb)\n    }\n  }, cb)\n}\n"]}
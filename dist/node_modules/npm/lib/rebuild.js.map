{"version":3,"sources":["../../../../node_modules/npm/lib/rebuild.js"],"names":["module","exports","rebuild","readInstalled","require","semver","log","npm","npa","usage","output","completion","args","cb","opt","depth","config","get","dev","prefix","er","data","info","set","filter","folders","Object","keys","f","length","silly","cleanBuild","commands","build","map","join","seen","Set","hasOwnProperty","path","has","add","pass","name","_id","i","l","arg","nv","n","v","rawSpec","satisfies","version","verbose","dependencies","forEach","d","dep"],"mappings":"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","file":"rebuild.js","sourcesContent":["\nmodule.exports = rebuild\n\nvar readInstalled = require('read-installed')\nvar semver = require('semver')\nvar log = require('npmlog')\nvar npm = require('./npm.js')\nvar npa = require('npm-package-arg')\nvar usage = require('./utils/usage')\nvar output = require('./utils/output.js')\n\nrebuild.usage = usage(\n  'rebuild',\n  'npm rebuild [[<@scope>/<name>]...]'\n)\n\nrebuild.completion = require('./utils/completion/installed-deep.js')\n\nfunction rebuild (args, cb) {\n  var opt = { depth: npm.config.get('depth'), dev: true }\n  readInstalled(npm.prefix, opt, function (er, data) {\n    log.info('readInstalled', typeof data)\n    if (er) return cb(er)\n    var set = filter(data, args)\n    var folders = Object.keys(set).filter(function (f) {\n      return f !== npm.prefix\n    })\n    if (!folders.length) return cb()\n    log.silly('rebuild set', folders)\n    cleanBuild(folders, set, cb)\n  })\n}\n\nfunction cleanBuild (folders, set, cb) {\n  npm.commands.build(folders, function (er) {\n    if (er) return cb(er)\n    output(folders.map(function (f) {\n      return set[f] + ' ' + f\n    }).join('\\n'))\n    cb()\n  })\n}\n\nfunction filter (data, args, set, seen) {\n  if (!set) set = {}\n  if (!seen) seen = new Set()\n  if (set.hasOwnProperty(data.path)) return set\n  if (seen.has(data)) return set\n  seen.add(data)\n  var pass\n  if (!args.length) pass = true // rebuild everything\n  else if (data.name && data._id) {\n    for (var i = 0, l = args.length; i < l; i++) {\n      var arg = args[i]\n      var nv = npa(arg)\n      var n = nv.name\n      var v = nv.rawSpec\n      if (n !== data.name) continue\n      if (!semver.satisfies(data.version, v, true)) continue\n      pass = true\n      break\n    }\n  }\n  if (pass && data._id) {\n    log.verbose('rebuild', 'path, id', [data.path, data._id])\n    set[data.path] = data._id\n  }\n  // need to also dive through kids, always.\n  // since this isn't an install these won't get auto-built unless\n  // they're not dependencies.\n  Object.keys(data.dependencies || {}).forEach(function (d) {\n    // return\n    var dep = data.dependencies[d]\n    if (typeof dep === 'string') return\n    filter(dep, args, set, seen)\n  })\n  return set\n}\n"]}
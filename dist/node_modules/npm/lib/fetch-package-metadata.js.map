{"version":3,"sources":["../../../../node_modules/npm/lib/fetch-package-metadata.js"],"names":["deprCheck","require","path","log","readPackageTree","rimraf","validate","npa","npm","npmlog","limit","tempFilename","pacote","pacoteOpts","isWindows","andLogAndFinish","spec","tracker","done","er","pkg","silly","String","message","finish","CACHE","max","length","p","_contentLength","module","exports","fetchPackageMetadata","fetch","where","opts","logAndFinish","dep","type","test","fetchSpec","err","Error","replace","code","manifest","annotate","fullMetadata","memoize","then","enolocal","relative","process","cwd","stack","enopackage","addBundled","next","arguments","_bundled","undefined","bundleDependencies","_requested","requested","_from","tree","children","target","integrity","_integrity","extract","_resolved","resolve","name","version"],"mappings":"AAAA;;;;AAEA,IAAMA,YAAYC,QAAQ,oBAAR,CAAlB;AACA,IAAMC,OAAOD,QAAQ,MAAR,CAAb;AACA,IAAME,MAAMF,QAAQ,QAAR,CAAZ;AACA,IAAMG,kBAAkBH,QAAQ,mBAAR,CAAxB;AACA,IAAMI,SAASJ,QAAQ,QAAR,CAAf;AACA,IAAMK,WAAWL,QAAQ,QAAR,CAAjB;AACA,IAAMM,MAAMN,QAAQ,iBAAR,CAAZ;AACA,IAAMO,MAAMP,QAAQ,OAAR,CAAZ;AACA,IAAMQ,SAASR,QAAQ,QAAR,CAAf;AACA,IAAMS,QAAQT,QAAQ,YAAR,CAAd;AACA,IAAMU,eAAeV,QAAQ,uBAAR,CAArB;AACA,IAAMW,SAASX,QAAQ,QAAR,CAAf;AACA,IAAIY,mBAAJ;AACA,IAAMC,YAAYb,QAAQ,uBAAR,CAAlB;;AAEA,SAASc,eAAT,CAA0BC,IAA1B,EAAgCC,OAAhC,EAAyCC,IAAzC,EAA+C;AAC7CZ,WAAS,iBAAT,EAA4B,CAACU,IAAD,EAAOC,OAAP,EAAgBC,IAAhB,CAA5B;AACA,SAAO,UAACC,EAAD,EAAKC,GAAL,EAAa;AAClB,QAAID,EAAJ,EAAQ;AACNhB,UAAIkB,KAAJ,CAAU,sBAAV,EAAkC,eAAeC,OAAON,IAAP,CAAjD,EAA+DG,GAAGI,OAAlE;AACA,UAAIN,OAAJ,EAAaA,QAAQO,MAAR;AACd;AACD,WAAON,KAAKC,EAAL,EAASC,GAAT,CAAP;AACD,GAND;AAOD;;AAED,IAAMK,QAAQxB,QAAQ,WAAR,EAAqB;AACjCyB,OAAK,MAAM,IAAN,GAAa,IADe;AAEjCC,UAAQ,gBAACC,CAAD;AAAA,WAAOA,EAAEC,cAAT;AAAA;AAFyB,CAArB,CAAd;;AAKAC,OAAOC,OAAP,GAAiBrB,MAAMsB,oBAAN,EAA4BxB,IAAIE,KAAJ,CAAUuB,KAAtC,CAAjB;AACA,SAASD,oBAAT,CAA+BhB,IAA/B,EAAqCkB,KAArC,EAA4CC,IAA5C,EAAkDjB,IAAlD,EAAwD;AACtDZ,WAAS,qBAAT,EAAgC,CAACU,IAAD,EAAOkB,KAAP,EAAcC,IAAd,EAAoBjB,IAApB,CAAhC;;AAEA,MAAI,CAACA,IAAL,EAAW;AACTA,WAAOiB,IAAP;AACAA,WAAO,EAAP;AACD;AACD,MAAIlB,UAAUkB,KAAKlB,OAAnB;AACA,MAAMmB,eAAerB,gBAAgBC,IAAhB,EAAsBC,OAAtB,EAA+BC,IAA/B,CAArB;;AAEA,MAAI,QAAOF,IAAP,yCAAOA,IAAP,OAAgB,QAApB,EAA8B;AAC5B,QAAIqB,MAAMrB,IAAV;AACD,GAFD,MAEO;AACLqB,UAAM9B,IAAIS,IAAJ,CAAN;AACD;AACD,MAAI,CAACF,SAAD,IAAcuB,IAAIC,IAAJ,KAAa,WAA3B,IAA0C,aAAaC,IAAb,CAAkBF,IAAIG,SAAtB,CAA9C,EAAgF;AAC9E,QAAIC,MAAM,IAAIC,KAAJ,gEAAsEL,IAAIG,SAAJ,CAAcG,OAAd,CAAsB,MAAtB,EAA8B,IAA9B,CAAtE,CAAV;AACAF,QAAIG,IAAJ,GAAW,cAAX;AACA,WAAOR,aAAaK,GAAb,CAAP;AACD;AACD,MAAI,CAAC5B,UAAL,EAAiB;AACfA,iBAAaZ,QAAQ,iBAAR,CAAb;AACD;AACDW,SAAOiC,QAAP,CAAgBR,GAAhB,EAAqBxB,WAAW;AAC9BiC,cAAU,IADoB;AAE9BC,kBAAcZ,KAAKY,YAFW;AAG9B5C,SAAKc,WAAWR,MAHc;AAI9BuC,aAASvB,KAJqB;AAK9BS,WAAOA;AALuB,GAAX,CAArB,EAMIe,IANJ,CAOE,UAAC7B,GAAD;AAAA,WAASgB,aAAa,IAAb,EAAmBpC,UAAUoB,GAAV,CAAnB,CAAT;AAAA,GAPF,EAQE,UAACqB,GAAD,EAAS;AACP,QAAIJ,IAAIC,IAAJ,KAAa,WAAjB,EAA8B,OAAOF,aAAaK,GAAb,CAAP;AAC9B,QAAIA,IAAIG,IAAJ,KAAa,SAAjB,EAA4B;AAC1B,UAAIM,WAAW,IAAIR,KAAJ,yBAAgCxC,KAAKiD,QAAL,CAAcC,QAAQC,GAAR,EAAd,EAA6BhB,IAAIG,SAAjC,CAAhC,8FAAf;AACAU,eAASN,IAAT,GAAgB,UAAhB;AACA,UAAIH,IAAIa,KAAR,EAAeJ,SAASI,KAAT,GAAiBb,IAAIa,KAArB;AACf,aAAOlB,aAAac,QAAb,CAAP;AACD,KALD,MAKO,IAAIT,IAAIG,IAAJ,KAAa,gBAAjB,EAAmC;AACxC,UAAIW,aAAa,IAAIb,KAAJ,8BAAqCxC,KAAKiD,QAAL,CAAcC,QAAQC,GAAR,EAAd,EAA6BhB,IAAIG,SAAjC,CAArC,mDAAjB;AACAe,iBAAWX,IAAX,GAAkB,UAAlB;AACA,UAAIH,IAAIa,KAAR,EAAeC,WAAWD,KAAX,GAAmBb,IAAIa,KAAvB;AACf,aAAOlB,aAAamB,UAAb,CAAP;AACD,KALM,MAKA;AACL,aAAOnB,aAAaK,GAAb,CAAP;AACD;AACF,GAvBH;AAyBD;;AAEDX,OAAOC,OAAP,CAAeyB,UAAf,GAA4BA,UAA5B;AACA,SAASA,UAAT,CAAqBpC,GAArB,EAA0BqC,IAA1B,EAAgC;AAC9BnD,WAAS,IAAT,EAAeoD,SAAf;AACA,MAAI,CAAC7C,UAAL,EAAiB;AACfA,iBAAaZ,QAAQ,iBAAR,CAAb;AACD;AACD,MAAImB,IAAIuC,QAAJ,KAAiBC,SAArB,EAAgC,OAAOH,KAAK,IAAL,EAAWrC,GAAX,CAAP;;AAEhC,MAAI,CAACA,IAAIyC,kBAAL,IAA2BzC,IAAI0C,UAAJ,CAAexB,IAAf,KAAwB,WAAvD,EAAoE,OAAOmB,KAAK,IAAL,EAAWrC,GAAX,CAAP;AACpE,MAAM2C,YAAY3C,IAAI0C,UAAJ,IAAkBvD,IAAIa,IAAI4C,KAAR,CAApC;AACA,MAAID,UAAUzB,IAAV,KAAmB,WAAvB,EAAoC;AAClClB,QAAIuC,QAAJ,GAAe,IAAf;AACA,WAAOvD,gBAAgBgB,IAAI0C,UAAJ,CAAetB,SAA/B,EAA0C,UAAUrB,EAAV,EAAc8C,IAAd,EAAoB;AACnE,UAAIA,IAAJ,EAAU7C,IAAIuC,QAAJ,GAAeM,KAAKC,QAApB;AACV,aAAOT,KAAK,IAAL,EAAWrC,GAAX,CAAP;AACD,KAHM,CAAP;AAID;AACDA,MAAIuC,QAAJ,GAAe,IAAf;AACA,MAAMQ,SAASxD,aAAa,QAAb,CAAf;AACA,MAAMwB,OAAOtB,WAAW,EAACuD,WAAWhD,IAAIiD,UAAhB,EAAX,CAAb;AACAzD,SAAO0D,OAAP,CAAelD,IAAImD,SAAJ,IAAiBnD,IAAI0C,UAArB,IAAmCvD,IAAIiE,OAAJ,CAAYpD,IAAIqD,IAAhB,EAAsBrD,IAAIsD,OAA1B,CAAlD,EAAsFP,MAAtF,EAA8FhC,IAA9F,EAAoGc,IAApG,CAAyG,YAAM;AAC7G9C,QAAIkB,KAAJ,CAAU,YAAV,EAAwB,cAAxB;AACAjB,oBAAgB+D,MAAhB,EAAwB,UAAC1B,GAAD,EAAMwB,IAAN,EAAe;AACrC,UAAIxB,GAAJ,EAAS;AAAE,eAAOgB,KAAKhB,GAAL,CAAP;AAAkB;AAC7BtC,UAAIkB,KAAJ,CAAU,SAAV,EAAqB,yBAArB;AACAhB,aAAO8D,MAAP,EAAe,YAAY;AACzB,YAAIF,IAAJ,EAAU;AACR7C,cAAIuC,QAAJ,GAAeM,KAAKC,QAApB;AACD;AACDT,aAAK,IAAL,EAAWrC,GAAX;AACD,OALD;AAMD,KATD;AAUD,GAZD,EAYGqC,IAZH;AAaD","file":"fetch-package-metadata.js","sourcesContent":["'use strict'\n\nconst deprCheck = require('./utils/depr-check')\nconst path = require('path')\nconst log = require('npmlog')\nconst readPackageTree = require('read-package-tree')\nconst rimraf = require('rimraf')\nconst validate = require('aproba')\nconst npa = require('npm-package-arg')\nconst npm = require('./npm')\nconst npmlog = require('npmlog')\nconst limit = require('call-limit')\nconst tempFilename = require('./utils/temp-filename')\nconst pacote = require('pacote')\nlet pacoteOpts\nconst isWindows = require('./utils/is-windows.js')\n\nfunction andLogAndFinish (spec, tracker, done) {\n  validate('SOF|SZF|OOF|OZF', [spec, tracker, done])\n  return (er, pkg) => {\n    if (er) {\n      log.silly('fetchPackageMetaData', 'error for ' + String(spec), er.message)\n      if (tracker) tracker.finish()\n    }\n    return done(er, pkg)\n  }\n}\n\nconst CACHE = require('lru-cache')({\n  max: 300 * 1024 * 1024,\n  length: (p) => p._contentLength\n})\n\nmodule.exports = limit(fetchPackageMetadata, npm.limit.fetch)\nfunction fetchPackageMetadata (spec, where, opts, done) {\n  validate('SSOF|SSFZ|OSOF|OSFZ', [spec, where, opts, done])\n\n  if (!done) {\n    done = opts\n    opts = {}\n  }\n  var tracker = opts.tracker\n  const logAndFinish = andLogAndFinish(spec, tracker, done)\n\n  if (typeof spec === 'object') {\n    var dep = spec\n  } else {\n    dep = npa(spec)\n  }\n  if (!isWindows && dep.type === 'directory' && /^[a-zA-Z]:/.test(dep.fetchSpec)) {\n    var err = new Error(`Can't install from windows path on a non-windows system: ${dep.fetchSpec.replace(/[/]/g, '\\\\')}`)\n    err.code = 'EWINDOWSPATH'\n    return logAndFinish(err)\n  }\n  if (!pacoteOpts) {\n    pacoteOpts = require('./config/pacote')\n  }\n  pacote.manifest(dep, pacoteOpts({\n    annotate: true,\n    fullMetadata: opts.fullMetadata,\n    log: tracker || npmlog,\n    memoize: CACHE,\n    where: where\n  })).then(\n    (pkg) => logAndFinish(null, deprCheck(pkg)),\n    (err) => {\n      if (dep.type !== 'directory') return logAndFinish(err)\n      if (err.code === 'ENOTDIR') {\n        var enolocal = new Error(`Could not install \"${path.relative(process.cwd(), dep.fetchSpec)}\" as it is not a directory and is not a file with a name ending in .tgz, .tar.gz or .tar`)\n        enolocal.code = 'ENOLOCAL'\n        if (err.stack) enolocal.stack = err.stack\n        return logAndFinish(enolocal)\n      } else if (err.code === 'ENOPACKAGEJSON') {\n        var enopackage = new Error(`Could not install from \"${path.relative(process.cwd(), dep.fetchSpec)}\" as it does not contain a package.json file.`)\n        enopackage.code = 'ENOLOCAL'\n        if (err.stack) enopackage.stack = err.stack\n        return logAndFinish(enopackage)\n      } else {\n        return logAndFinish(err)\n      }\n    }\n  )\n}\n\nmodule.exports.addBundled = addBundled\nfunction addBundled (pkg, next) {\n  validate('OF', arguments)\n  if (!pacoteOpts) {\n    pacoteOpts = require('./config/pacote')\n  }\n  if (pkg._bundled !== undefined) return next(null, pkg)\n\n  if (!pkg.bundleDependencies && pkg._requested.type !== 'directory') return next(null, pkg)\n  const requested = pkg._requested || npa(pkg._from)\n  if (requested.type === 'directory') {\n    pkg._bundled = null\n    return readPackageTree(pkg._requested.fetchSpec, function (er, tree) {\n      if (tree) pkg._bundled = tree.children\n      return next(null, pkg)\n    })\n  }\n  pkg._bundled = null\n  const target = tempFilename('unpack')\n  const opts = pacoteOpts({integrity: pkg._integrity})\n  pacote.extract(pkg._resolved || pkg._requested || npa.resolve(pkg.name, pkg.version), target, opts).then(() => {\n    log.silly('addBundled', 'read tarball')\n    readPackageTree(target, (err, tree) => {\n      if (err) { return next(err) }\n      log.silly('cleanup', 'remove extracted module')\n      rimraf(target, function () {\n        if (tree) {\n          pkg._bundled = tree.children\n        }\n        next(null, pkg)\n      })\n    })\n  }, next)\n}\n"]}
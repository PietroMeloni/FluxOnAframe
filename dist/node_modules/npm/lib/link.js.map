{"version":3,"sources":["../../../../node_modules/npm/lib/link.js"],"names":["npm","require","symlink","fs","log","asyncMap","chain","path","build","npa","usage","output","module","exports","link","completion","opts","cb","dir","globalDir","readdir","er","files","filter","f","match","args","process","platform","semver","gte","version","msg","e","Error","code","errno","ENOTSUP","config","get","length","linkInstall","linkPkg","prefix","parentFolder","id","folder","resolve","pkgs","pkg","t","pp","rp","target","n","data","installed","info","what","name","next","indexOf","lstat","st","isDirectory","commands","install","isSymbolicLink","realpath","real","warn","resultPrinter","verbose","_noLC","cb_","me","readJson","d","_id","basename","src","dest","where","trim","parseableOutput"],"mappings":"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","file":"link.js","sourcesContent":["// link with no args: symlink the folder to the global location\n// link with package arg: symlink the global to the local\n\nvar npm = require('./npm.js')\nvar symlink = require('./utils/link.js')\nvar fs = require('graceful-fs')\nvar log = require('npmlog')\nvar asyncMap = require('slide').asyncMap\nvar chain = require('slide').chain\nvar path = require('path')\nvar build = require('./build.js')\nvar npa = require('npm-package-arg')\nvar usage = require('./utils/usage')\nvar output = require('./utils/output.js')\n\nmodule.exports = link\n\nlink.usage = usage(\n  'link',\n  'npm link (in package dir)' +\n  '\\nnpm link [<@scope>/]<pkg>[@<version>]'\n)\n\nlink.completion = function (opts, cb) {\n  var dir = npm.globalDir\n  fs.readdir(dir, function (er, files) {\n    cb(er, files.filter(function (f) {\n      return !f.match(/^[._-]/)\n    }))\n  })\n}\n\nfunction link (args, cb) {\n  if (process.platform === 'win32') {\n    var semver = require('semver')\n    if (!semver.gte(process.version, '0.7.9')) {\n      var msg = 'npm link not supported on windows prior to node 0.7.9'\n      var e = new Error(msg)\n      e.code = 'ENOTSUP'\n      e.errno = require('constants').ENOTSUP // eslint-disable-line node/no-deprecated-api\n      return cb(e)\n    }\n  }\n\n  if (npm.config.get('global')) {\n    return cb(new Error(\n      'link should never be --global.\\n' +\n      'Please re-run this command with --local'\n    ))\n  }\n\n  if (args.length === 1 && args[0] === '.') args = []\n  if (args.length) return linkInstall(args, cb)\n  linkPkg(npm.prefix, cb)\n}\n\nfunction parentFolder (id, folder) {\n  if (id[0] === '@') {\n    return path.resolve(folder, '..', '..')\n  } else {\n    return path.resolve(folder, '..')\n  }\n}\n\nfunction linkInstall (pkgs, cb) {\n  asyncMap(pkgs, function (pkg, cb) {\n    var t = path.resolve(npm.globalDir, '..')\n    var pp = path.resolve(npm.globalDir, pkg)\n    var rp = null\n    var target = path.resolve(npm.dir, pkg)\n\n    function n (er, data) {\n      if (er) return cb(er, data)\n      // we want the ONE thing that was installed into the global dir\n      var installed = data.filter(function (info) {\n        var id = info[0]\n        var folder = info[1]\n        return parentFolder(id, folder) === npm.globalDir\n      })\n      var id = installed[0][0]\n      pp = installed[0][1]\n      var what = npa(id)\n      pkg = what.name\n      target = path.resolve(npm.dir, pkg)\n      next()\n    }\n\n    // if it's a folder, a random not-installed thing, or not a scoped package,\n    // then link or install it first\n    if (pkg[0] !== '@' && (pkg.indexOf('/') !== -1 || pkg.indexOf('\\\\') !== -1)) {\n      return fs.lstat(path.resolve(pkg), function (er, st) {\n        if (er || !st.isDirectory()) {\n          npm.commands.install(t, pkg, n)\n        } else {\n          rp = path.resolve(pkg)\n          linkPkg(rp, n)\n        }\n      })\n    }\n\n    fs.lstat(pp, function (er, st) {\n      if (er) {\n        rp = pp\n        return npm.commands.install(t, [pkg], n)\n      } else if (!st.isSymbolicLink()) {\n        rp = pp\n        next()\n      } else {\n        return fs.realpath(pp, function (er, real) {\n          if (er) log.warn('invalid symbolic link', pkg)\n          else rp = real\n          next()\n        })\n      }\n    })\n\n    function next () {\n      if (npm.config.get('dry-run')) return resultPrinter(pkg, pp, target, rp, cb)\n      chain(\n        [\n          [ function (cb) {\n            log.verbose('link', 'symlinking %s to %s', pp, target)\n            cb()\n          } ],\n          [symlink, pp, target, false, false],\n          // do not run any scripts\n          rp && [build, [target], npm.config.get('global'), build._noLC, true],\n          [resultPrinter, pkg, pp, target, rp]\n        ],\n        cb\n      )\n    }\n  }, cb)\n}\n\nfunction linkPkg (folder, cb_) {\n  var me = folder || npm.prefix\n  var readJson = require('read-package-json')\n\n  log.verbose('linkPkg', folder)\n\n  readJson(path.resolve(me, 'package.json'), function (er, d) {\n    function cb (er) {\n      return cb_(er, [[d && d._id, target, null, null]])\n    }\n    if (er) return cb(er)\n    if (!d.name) {\n      er = new Error('Package must have a name field to be linked')\n      return cb(er)\n    }\n    var target = path.resolve(npm.globalDir, d.name)\n    if (npm.config.get('dry-run')) return resultPrinter(path.basename(me), me, target, cb)\n    symlink(me, target, false, true, function (er) {\n      if (er) return cb(er)\n      log.verbose('link', 'build target', target)\n      // also install missing dependencies.\n      npm.commands.install(me, [], function (er) {\n        if (er) return cb(er)\n        // build the global stuff.  Don't run *any* scripts, because\n        // install command already will have done that.\n        build([target], true, build._noLC, true, function (er) {\n          if (er) return cb(er)\n          resultPrinter(path.basename(me), me, target, cb)\n        })\n      })\n    })\n  })\n}\n\nfunction resultPrinter (pkg, src, dest, rp, cb) {\n  if (typeof cb !== 'function') {\n    cb = rp\n    rp = null\n  }\n  var where = dest\n  rp = (rp || '').trim()\n  src = (src || '').trim()\n  // XXX If --json is set, then look up the data from the package.json\n  if (npm.config.get('parseable')) {\n    return parseableOutput(dest, rp || src, cb)\n  }\n  if (rp === src) rp = null\n  output(where + ' -> ' + src + (rp ? ' -> ' + rp : ''))\n  cb()\n}\n\nfunction parseableOutput (dest, rp, cb) {\n  // XXX this should match ls --parseable and install --parseable\n  // look up the data from package.json, format it the same way.\n  //\n  // link is always effectively 'long', since it doesn't help much to\n  // *just* print the target folder.\n  // However, we don't actually ever read the version number, so\n  // the second field is always blank.\n  output(dest + '::' + rp)\n  cb()\n}\n"]}
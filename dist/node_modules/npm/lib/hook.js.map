{"version":3,"sources":["../../../../node_modules/npm/lib/hook.js"],"names":["BB","require","crypto","hookApi","log","npm","output","pudding","relativeDate","Table","usage","validate","hook","completion","opts","cb","npmSession","randomBytes","toString","hookConfig","config","refer","projectScope","module","exports","args","try","nodeify","add","ls","rm","update","pkg","uri","secret","then","get","JSON","stringify","hookName","endpoint","hooks","length","table","head","forEach","push","rowSpan","content","id","last_delivery","colSpan","response_code","target","name","type"],"mappings":"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","file":"hook.js","sourcesContent":["'use strict'\n\nconst BB = require('bluebird')\n\nconst crypto = require('crypto')\nconst hookApi = require('libnpmhook')\nconst log = require('npmlog')\nconst npm = require('./npm.js')\nconst output = require('./utils/output.js')\nconst pudding = require('figgy-pudding')\nconst relativeDate = require('tiny-relative-date')\nconst Table = require('cli-table3')\nconst usage = require('./utils/usage.js')\nconst validate = require('aproba')\n\nhook.usage = usage([\n  'npm hook add <pkg> <url> <secret> [--type=<type>]',\n  'npm hook ls [pkg]',\n  'npm hook rm <id>',\n  'npm hook update <id> <url> <secret>'\n])\n\nhook.completion = (opts, cb) => {\n  validate('OF', [opts, cb])\n  return cb(null, []) // fill in this array with completion values\n}\n\nconst npmSession = crypto.randomBytes(8).toString('hex')\nconst hookConfig = pudding()\nfunction config () {\n  return hookConfig({\n    refer: npm.refer,\n    projectScope: npm.projectScope,\n    log,\n    npmSession\n  }, npm.config)\n}\n\nmodule.exports = (args, cb) => BB.try(() => hook(args)).nodeify(cb)\nfunction hook (args) {\n  switch (args[0]) {\n    case 'add':\n      return add(args[1], args[2], args[3])\n    case 'ls':\n      return ls(args[1])\n    case 'rm':\n      return rm(args[1])\n    case 'update':\n    case 'up':\n      return update(args[1], args[2], args[3])\n  }\n}\n\nfunction add (pkg, uri, secret) {\n  return hookApi.add(pkg, uri, secret, config())\n    .then((hook) => {\n      if (npm.config.get('json')) {\n        output(JSON.stringify(hook, null, 2))\n      } else {\n        output(`+ ${hookName(hook)} ${\n          npm.config.get('unicode') ? ' ➜ ' : ' -> '\n        } ${hook.endpoint}`)\n      }\n    })\n}\n\nfunction ls (pkg) {\n  return hookApi.ls(pkg, config())\n    .then((hooks) => {\n      if (npm.config.get('json')) {\n        output(JSON.stringify(hooks, null, 2))\n      } else if (!hooks.length) {\n        output(\"You don't have any hooks configured yet.\")\n      } else {\n        if (hooks.length === 1) {\n          output('You have one hook configured.')\n        } else {\n          output(`You have ${hooks.length} hooks configured.`)\n        }\n        const table = new Table({head: ['id', 'target', 'endpoint']})\n        hooks.forEach((hook) => {\n          table.push([\n            {rowSpan: 2, content: hook.id},\n            hookName(hook),\n            hook.endpoint\n          ])\n          if (hook.last_delivery) {\n            table.push([\n              {\n                colSpan: 1,\n                content: `triggered ${relativeDate(hook.last_delivery)}`\n              },\n              hook.response_code\n            ])\n          } else {\n            table.push([{colSpan: 2, content: 'never triggered'}])\n          }\n        })\n        output(table.toString())\n      }\n    })\n}\n\nfunction rm (id) {\n  return hookApi.rm(id, config())\n    .then((hook) => {\n      if (npm.config.get('json')) {\n        output(JSON.stringify(hook, null, 2))\n      } else {\n        output(`- ${hookName(hook)} ${\n          npm.config.get('unicode') ? ' ✘ ' : ' X '\n        } ${hook.endpoint}`)\n      }\n    })\n}\n\nfunction update (id, uri, secret) {\n  return hookApi.update(id, uri, secret, config())\n    .then((hook) => {\n      if (npm.config.get('json')) {\n        output(JSON.stringify(hook, null, 2))\n      } else {\n        output(`+ ${hookName(hook)} ${\n          npm.config.get('unicode') ? ' ➜ ' : ' -> '\n        } ${hook.endpoint}`)\n      }\n    })\n}\n\nfunction hookName (hook) {\n  let target = hook.name\n  if (hook.type === 'scope') { target = '@' + target }\n  if (hook.type === 'owner') { target = '~' + target }\n  return target\n}\n"]}
{"version":3,"sources":["../../../../../node_modules/npm/lib/install/validate-tree.js"],"names":["path","require","validate","asyncMap","chain","npmInstallChecks","checkGit","clone","normalizePackageData","npm","andFinishTracker","flattenTree","validateAllPeerDeps","packageId","module","exports","idealTree","log","next","arguments","moduleMap","modules","Object","keys","map","name","mod","done","parent","isLink","realpath","checkErrors","thenValidateAllPeerDeps","thenCheckTop","thenCheckDuplicateDeps","error","resolve","globalDir","warnings","push","tree","pkgname","version","warn","Error","code","package","pkg","warnObj","er","nodeVersion","config","get","test","deps","dependencies","devDeps","devDependencies"],"mappings":"AAAA;;AACA,IAAIA,OAAOC,QAAQ,MAAR,CAAX;AACA,IAAIC,WAAWD,QAAQ,QAAR,CAAf;AACA,IAAIE,WAAWF,QAAQ,OAAR,EAAiBE,QAAhC;AACA,IAAIC,QAAQH,QAAQ,OAAR,EAAiBG,KAA7B;AACA,IAAIC,mBAAmBJ,QAAQ,oBAAR,CAAvB;AACA,IAAIK,WAAWD,iBAAiBC,QAAhC;AACA,IAAIC,QAAQN,QAAQ,kBAAR,CAAZ;AACA,IAAIO,uBAAuBP,QAAQ,wBAAR,CAA3B;AACA,IAAIQ,MAAMR,QAAQ,WAAR,CAAV;AACA,IAAIS,mBAAmBT,QAAQ,yBAAR,CAAvB;AACA,IAAIU,cAAcV,QAAQ,mBAAR,CAAlB;AACA,IAAIW,sBAAsBX,QAAQ,WAAR,EAAqBW,mBAA/C;AACA,IAAIC,YAAYZ,QAAQ,wBAAR,CAAhB;;AAEAa,OAAOC,OAAP,GAAiB,UAAUC,SAAV,EAAqBC,GAArB,EAA0BC,IAA1B,EAAgC;AAC/ChB,WAAS,KAAT,EAAgBiB,SAAhB;AACA,MAAIC,YAAYT,YAAYK,SAAZ,CAAhB;AACA,MAAIK,UAAUC,OAAOC,IAAP,CAAYH,SAAZ,EAAuBI,GAAvB,CAA2B,UAAUC,IAAV,EAAgB;AAAE,WAAOL,UAAUK,IAAV,CAAP;AAAwB,GAArE,CAAd;;AAEArB,QAAM,CACJ,CAACD,QAAD,EAAWkB,OAAX,EAAoB,UAAUK,GAAV,EAAeC,IAAf,EAAqB;AACvCvB,UAAM,CACJsB,IAAIE,MAAJ,IAAc,CAACF,IAAIG,MAAnB,IAA6B,CAACvB,QAAD,EAAWoB,IAAII,QAAf,CADzB,EAEJ,CAACC,WAAD,EAAcL,GAAd,EAAmBV,SAAnB,CAFI,CAAN,EAGGW,IAHH;AAID,GALD,CADI,EAOJ,CAACK,uBAAD,EAA0BhB,SAA1B,CAPI,EAQJ,CAACiB,YAAD,EAAejB,SAAf,CARI,EASJ,CAACkB,sBAAD,EAAyBlB,SAAzB,CATI,CAAN,EAUGN,iBAAiBO,GAAjB,EAAsBC,IAAtB,CAVH;AAWD,CAhBD;;AAkBA,SAASa,WAAT,CAAsBL,GAAtB,EAA2BV,SAA3B,EAAsCE,IAAtC,EAA4C;AAC1C,MAAIQ,IAAIS,KAAJ,KAAcT,IAAIE,MAAJ,IAAc5B,KAAKoC,OAAL,CAAa3B,IAAI4B,SAAjB,EAA4B,IAA5B,MAAsCX,IAAI1B,IAAtE,CAAJ,EAAiFgB,UAAUsB,QAAV,CAAmBC,IAAnB,CAAwBb,IAAIS,KAA5B;AACjFjB;AACD;;AAED,SAASc,uBAAT,CAAkChB,SAAlC,EAA6CE,IAA7C,EAAmD;AACjDhB,WAAS,IAAT,EAAeiB,SAAf;AACAP,sBAAoBI,SAApB,EAA+B,UAAUwB,IAAV,EAAgBC,OAAhB,EAAyBC,OAAzB,EAAkC;AAC/D,QAAIC,OAAO,IAAIC,KAAJ,CAAU/B,UAAU2B,IAAV,IAAkB,sBAAlB,GAA2CC,OAA3C,GAAqD,GAArD,GACnBC,OADmB,GACT,sEADD,CAAX;AAEAC,SAAKE,IAAL,GAAY,cAAZ;AACA7B,cAAUsB,QAAV,CAAmBC,IAAnB,CAAwBI,IAAxB;AACD,GALD;AAMAzB;AACD;;AAED,SAASe,YAAT,CAAuBjB,SAAvB,EAAkCE,IAAlC,EAAwC;AACtChB,WAAS,IAAT,EAAeiB,SAAf;AACA,MAAIH,UAAU8B,OAAV,CAAkBX,KAAtB,EAA6B,OAAOjB,MAAP;;AAE7B;AACA;AACA;AACA;AACA,MAAI6B,MAAMxC,MAAMS,UAAU8B,OAAhB,CAAV;AACA,MAAI;AACFtC,yBAAqBuC,GAArB,EAA0B,UAAUJ,IAAV,EAAgB;AACxC,UAAIK,UAAU,IAAIJ,KAAJ,CAAU/B,UAAUG,SAAV,IAAuB,GAAvB,GAA6B2B,IAAvC,CAAd;AACAK,cAAQH,IAAR,GAAe,cAAf;AACA7B,gBAAUsB,QAAV,CAAmBC,IAAnB,CAAwBS,OAAxB;AACD,KAJD,EAIG,KAJH;AAKD,GAND,CAME,OAAOC,EAAP,EAAW;AACXA,OAAGJ,IAAH,GAAU,cAAV;AACA7B,cAAUsB,QAAV,CAAmBC,IAAnB,CAAwBU,EAAxB;AACD;;AAED,MAAIC,cAAczC,IAAI0C,MAAJ,CAAWC,GAAX,CAAe,cAAf,CAAlB;AACA,MAAI,IAAIC,IAAJ,CAASH,WAAT,CAAJ,EAA2B;AACzB;AACA,QAAIF,UAAU,IAAIJ,KAAJ,CAAU,iFAAV,CAAd;AACAI,YAAQH,IAAR,GAAe,UAAf;AACA7B,cAAUsB,QAAV,CAAmBC,IAAnB,CAAwBS,OAAxB;AACD;;AAED9B;AACD;;AAED;AACA,SAASgB,sBAAT,CAAiClB,SAAjC,EAA4CE,IAA5C,EAAkD;AAChD,MAAIoC,OAAOtC,UAAU8B,OAAV,CAAkBS,YAAlB,IAAkC,EAA7C;AACA,MAAIC,UAAUxC,UAAU8B,OAAV,CAAkBW,eAAlB,IAAqC,EAAnD;;AAEA,OAAK,IAAIV,GAAT,IAAgBS,OAAhB,EAAyB;AACvB,QAAIT,OAAOO,IAAX,EAAiB;AACf,UAAIN,UAAU,IAAIJ,KAAJ,CAAU,iBAAiBG,GAAjB,GAAuB,uDAAjC,CAAd;AACAC,cAAQH,IAAR,GAAe,eAAf;AACA7B,gBAAUsB,QAAV,CAAmBC,IAAnB,CAAwBS,OAAxB;AACD;AACF;;AAED9B;AACD","file":"validate-tree.js","sourcesContent":["'use strict'\nvar path = require('path')\nvar validate = require('aproba')\nvar asyncMap = require('slide').asyncMap\nvar chain = require('slide').chain\nvar npmInstallChecks = require('npm-install-checks')\nvar checkGit = npmInstallChecks.checkGit\nvar clone = require('lodash.clonedeep')\nvar normalizePackageData = require('normalize-package-data')\nvar npm = require('../npm.js')\nvar andFinishTracker = require('./and-finish-tracker.js')\nvar flattenTree = require('./flatten-tree.js')\nvar validateAllPeerDeps = require('./deps.js').validateAllPeerDeps\nvar packageId = require('../utils/package-id.js')\n\nmodule.exports = function (idealTree, log, next) {\n  validate('OOF', arguments)\n  var moduleMap = flattenTree(idealTree)\n  var modules = Object.keys(moduleMap).map(function (name) { return moduleMap[name] })\n\n  chain([\n    [asyncMap, modules, function (mod, done) {\n      chain([\n        mod.parent && !mod.isLink && [checkGit, mod.realpath],\n        [checkErrors, mod, idealTree]\n      ], done)\n    }],\n    [thenValidateAllPeerDeps, idealTree],\n    [thenCheckTop, idealTree],\n    [thenCheckDuplicateDeps, idealTree]\n  ], andFinishTracker(log, next))\n}\n\nfunction checkErrors (mod, idealTree, next) {\n  if (mod.error && (mod.parent || path.resolve(npm.globalDir, '..') !== mod.path)) idealTree.warnings.push(mod.error)\n  next()\n}\n\nfunction thenValidateAllPeerDeps (idealTree, next) {\n  validate('OF', arguments)\n  validateAllPeerDeps(idealTree, function (tree, pkgname, version) {\n    var warn = new Error(packageId(tree) + ' requires a peer of ' + pkgname + '@' +\n      version + ' but none is installed. You must install peer dependencies yourself.')\n    warn.code = 'EPEERINVALID'\n    idealTree.warnings.push(warn)\n  })\n  next()\n}\n\nfunction thenCheckTop (idealTree, next) {\n  validate('OF', arguments)\n  if (idealTree.package.error) return next()\n\n  // FIXME: when we replace read-package-json with something less magic,\n  // this should done elsewhere.\n  // As it is, the package has already been normalized and thus some\n  // errors are suppressed.\n  var pkg = clone(idealTree.package)\n  try {\n    normalizePackageData(pkg, function (warn) {\n      var warnObj = new Error(packageId(idealTree) + ' ' + warn)\n      warnObj.code = 'EPACKAGEJSON'\n      idealTree.warnings.push(warnObj)\n    }, false)\n  } catch (er) {\n    er.code = 'EPACKAGEJSON'\n    idealTree.warnings.push(er)\n  }\n\n  var nodeVersion = npm.config.get('node-version')\n  if (/-/.test(nodeVersion)) {\n    // if this is a prerelease nodeâ€¦\n    var warnObj = new Error('You are using a pre-release version of node and things may not work as expected')\n    warnObj.code = 'ENODEPRE'\n    idealTree.warnings.push(warnObj)\n  }\n\n  next()\n}\n\n// check for deps duplciated between devdeps and regular deps\nfunction thenCheckDuplicateDeps (idealTree, next) {\n  var deps = idealTree.package.dependencies || {}\n  var devDeps = idealTree.package.devDependencies || {}\n\n  for (var pkg in devDeps) {\n    if (pkg in deps) {\n      var warnObj = new Error('The package ' + pkg + ' is included as both a dev and production dependency.')\n      warnObj.code = 'EDUPLICATEDEP'\n      idealTree.warnings.push(warnObj)\n    }\n  }\n\n  next()\n}\n"]}
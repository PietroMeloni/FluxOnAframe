{"version":3,"sources":["../../../../../node_modules/npm/lib/install/actions.js"],"names":["BB","require","andAddParentToErrors","failedDependency","isInstallable","promisify","moduleName","npm","reportOptionalFailure","validate","actions","fetch","extract","build","preinstall","install","postinstall","prepare","finalize","remove","unbuild","move","Object","keys","forEach","actionName","action","staging","pkg","log","failed","resolve","rollback","unshift","commit","push","actionP","knownInstallable","runAction","package","then","finish","err","fromNode","cb","parent","catch","handleOptionalDepErrors","init","teardown","exports","result","markAsFailed","requires","req","requiredBy","filter","reqReqBy","length","userRequired","anyFatal","doOne","cmd","next","arguments","prepped","prepareAction","withInit","execAction","nodeify","doParallel","type","actionsToRun","acts","reduce","acc","todo","silly","time","map","concurrency","limit","timeEnd","doSerial","runSerial","doReverseSerial","concat","reverse","each","process","emit","name","body","using","disposer","Error","newGroup","apply","slice"],"mappings":"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","file":"actions.js","sourcesContent":["'use strict'\n\nconst BB = require('bluebird')\n\nconst andAddParentToErrors = require('./and-add-parent-to-errors.js')\nconst failedDependency = require('./deps.js').failedDependency\nconst isInstallable = BB.promisify(require('./validate-args.js').isInstallable)\nconst moduleName = require('../utils/module-name.js')\nconst npm = require('../npm.js')\nconst reportOptionalFailure = require('./report-optional-failure.js')\nconst validate = require('aproba')\n\nconst actions = {}\n\nactions.fetch = require('./action/fetch.js')\nactions.extract = require('./action/extract.js')\nactions.build = require('./action/build.js')\nactions.preinstall = require('./action/preinstall.js')\nactions.install = require('./action/install.js')\nactions.postinstall = require('./action/postinstall.js')\nactions.prepare = require('./action/prepare.js')\nactions.finalize = require('./action/finalize.js')\nactions.remove = require('./action/remove.js')\nactions.unbuild = require('./action/unbuild.js')\nactions.move = require('./action/move.js')\nactions['global-install'] = require('./action/global-install.js')\nactions['global-link'] = require('./action/global-link.js')\nactions['refresh-package-json'] = require('./action/refresh-package-json.js')\n\n// FIXME: We wrap actions like three ways to sunday here.\n// Rewrite this to only work one way.\n\nObject.keys(actions).forEach(function (actionName) {\n  var action = actions[actionName]\n  actions[actionName] = (staging, pkg, log) => {\n    validate('SOO', [staging, pkg, log])\n    // refuse to run actions for failed packages\n    if (pkg.failed) return BB.resolve()\n    if (action.rollback) {\n      if (!pkg.rollback) pkg.rollback = []\n      pkg.rollback.unshift(action.rollback)\n    }\n    if (action.commit) {\n      if (!pkg.commit) pkg.commit = []\n      pkg.commit.push(action.commit)\n    }\n\n    let actionP\n    if (pkg.knownInstallable) {\n      actionP = runAction(action, staging, pkg, log)\n    } else {\n      actionP = isInstallable(pkg.package).then(() => {\n        pkg.knownInstallable = true\n        return runAction(action, staging, pkg, log)\n      })\n    }\n\n    return actionP.then(() => {\n      log.finish()\n    }, (err) => {\n      return BB.fromNode((cb) => {\n        andAddParentToErrors(pkg.parent, cb)(err)\n      }).catch((err) => {\n        return handleOptionalDepErrors(pkg, err)\n      })\n    })\n  }\n  actions[actionName].init = action.init || (() => BB.resolve())\n  actions[actionName].teardown = action.teardown || (() => BB.resolve())\n})\nexports.actions = actions\n\nfunction runAction (action, staging, pkg, log) {\n  return BB.fromNode((cb) => {\n    const result = action(staging, pkg, log, cb)\n    if (result && result.then) {\n      result.then(() => cb(), cb)\n    }\n  })\n}\n\nfunction markAsFailed (pkg) {\n  if (pkg.failed) return\n  pkg.failed = true\n  pkg.requires.forEach((req) => {\n    var requiredBy = req.requiredBy.filter((reqReqBy) => !reqReqBy.failed)\n    if (requiredBy.length === 0 && !req.userRequired) {\n      markAsFailed(req)\n    }\n  })\n}\n\nfunction handleOptionalDepErrors (pkg, err) {\n  markAsFailed(pkg)\n  var anyFatal = failedDependency(pkg)\n  if (anyFatal) {\n    throw err\n  } else {\n    reportOptionalFailure(pkg, null, err)\n  }\n}\n\nexports.doOne = doOne\nfunction doOne (cmd, staging, pkg, log, next) {\n  validate('SSOOF', arguments)\n  const prepped = prepareAction([cmd, pkg], staging, log)\n  return withInit(actions[cmd], () => {\n    return execAction(prepped)\n  }).nodeify(next)\n}\n\nexports.doParallel = doParallel\nfunction doParallel (type, staging, actionsToRun, log, next) {\n  validate('SSAOF', arguments)\n  const acts = actionsToRun.reduce((acc, todo) => {\n    if (todo[0] === type) {\n      acc.push(prepareAction(todo, staging, log))\n    }\n    return acc\n  }, [])\n  log.silly('doParallel', type + ' ' + acts.length)\n  time(log)\n  if (!acts.length) { return next() }\n  return withInit(actions[type], () => {\n    return BB.map(acts, execAction, {\n      concurrency: npm.limit.action\n    })\n  }).nodeify((err) => {\n    log.finish()\n    timeEnd(log)\n    next(err)\n  })\n}\n\nexports.doSerial = doSerial\nfunction doSerial (type, staging, actionsToRun, log, next) {\n  validate('SSAOF', arguments)\n  log.silly('doSerial', '%s %d', type, actionsToRun.length)\n  runSerial(type, staging, actionsToRun, log, next)\n}\n\nexports.doReverseSerial = doReverseSerial\nfunction doReverseSerial (type, staging, actionsToRun, log, next) {\n  validate('SSAOF', arguments)\n  log.silly('doReverseSerial', '%s %d', type, actionsToRun.length)\n  runSerial(type, staging, [].concat(actionsToRun).reverse(), log, next)\n}\n\nfunction runSerial (type, staging, actionsToRun, log, next) {\n  const acts = actionsToRun.reduce((acc, todo) => {\n    if (todo[0] === type) {\n      acc.push(prepareAction(todo, staging, log))\n    }\n    return acc\n  }, [])\n  time(log)\n  if (!acts.length) { return next() }\n  return withInit(actions[type], () => {\n    return BB.each(acts, execAction)\n  }).nodeify((err) => {\n    log.finish()\n    timeEnd(log)\n    next(err)\n  })\n}\n\nfunction time (log) {\n  process.emit('time', 'action:' + log.name)\n}\nfunction timeEnd (log) {\n  process.emit('timeEnd', 'action:' + log.name)\n}\n\nfunction withInit (action, body) {\n  return BB.using(\n    action.init().disposer(() => action.teardown()),\n    body\n  )\n}\n\nfunction prepareAction (action, staging, log) {\n  validate('ASO', arguments)\n  validate('SO', action)\n  var cmd = action[0]\n  var pkg = action[1]\n  if (!actions[cmd]) throw new Error('Unknown decomposed command \"' + cmd + '\" (is it new?)')\n  return [actions[cmd], staging, pkg, log.newGroup(cmd + ':' + moduleName(pkg))]\n}\n\nfunction execAction (todo) {\n  return todo[0].apply(null, todo.slice(1))\n}\n"]}
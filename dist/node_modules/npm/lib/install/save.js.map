{"version":3,"sources":["../../../../../node_modules/npm/lib/install/save.js"],"names":["deepSortObject","require","detectIndent","detectNewline","fs","iferr","log","moduleName","npm","parseJSON","path","stringifyPackage","validate","without","writeFileAtomic","exports","saveRequested","tree","andReturn","arguments","savePackageJson","andWarnErrors","andSaveShrinkwrap","er","saveShrinkwrap","cb","warn","message","apply","next","config","get","createShrinkwrap","silent","saveBundle","saveTarget","resolve","readFile","packagejson","indent","newline","package","ex","bundle","bundleDependencies","bundledDependencies","Array","isArray","toSave","getThingsToSave","toRemove","getThingsToRemove","savingTo","forEach","pkg","save","Object","keys","verbose","types","name","spec","movedFrom","saveType","push","length","notice","join","ii","indexOf","key","json","getSaveType","arg","globalInstall","noSaveFlags","optionalDependencies","devDependencies","children","filter","child","map","saveSpec","removedChildren"],"mappings":"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","file":"save.js","sourcesContent":["'use strict'\n\nconst deepSortObject = require('../utils/deep-sort-object.js')\nconst detectIndent = require('detect-indent')\nconst detectNewline = require('detect-newline')\nconst fs = require('graceful-fs')\nconst iferr = require('iferr')\nconst log = require('npmlog')\nconst moduleName = require('../utils/module-name.js')\nconst npm = require('../npm.js')\nconst parseJSON = require('../utils/parse-json.js')\nconst path = require('path')\nconst stringifyPackage = require('../utils/stringify-package')\nconst validate = require('aproba')\nconst without = require('lodash.without')\nconst writeFileAtomic = require('write-file-atomic')\n\n// if the -S|--save option is specified, then write installed packages\n// as dependencies to a package.json file.\n\nexports.saveRequested = function (tree, andReturn) {\n  validate('OF', arguments)\n  savePackageJson(tree, andWarnErrors(andSaveShrinkwrap(tree, andReturn)))\n}\n\nfunction andSaveShrinkwrap (tree, andReturn) {\n  validate('OF', arguments)\n  return function (er) {\n    validate('E', arguments)\n    saveShrinkwrap(tree, andWarnErrors(andReturn))\n  }\n}\n\nfunction andWarnErrors (cb) {\n  validate('F', arguments)\n  return function (er) {\n    if (er) log.warn('saveError', er.message)\n    arguments[0] = null\n    cb.apply(null, arguments)\n  }\n}\n\nexports.saveShrinkwrap = saveShrinkwrap\n\nfunction saveShrinkwrap (tree, next) {\n  validate('OF', arguments)\n  if (!npm.config.get('shrinkwrap') || !npm.config.get('package-lock')) {\n    return next()\n  }\n  require('../shrinkwrap.js').createShrinkwrap(tree, {silent: false}, next)\n}\n\nfunction savePackageJson (tree, next) {\n  validate('OF', arguments)\n  var saveBundle = npm.config.get('save-bundle')\n\n  // each item in the tree is a top-level thing that should be saved\n  // to the package.json file.\n  // The relevant tree shape is { <folder>: {what:<pkg>} }\n  var saveTarget = path.resolve(tree.path, 'package.json')\n  // don't use readJson, because we don't want to do all the other\n  // tricky npm-specific stuff that's in there.\n  fs.readFile(saveTarget, 'utf8', iferr(next, function (packagejson) {\n    const indent = detectIndent(packagejson).indent\n    const newline = detectNewline(packagejson)\n    try {\n      tree.package = parseJSON(packagejson)\n    } catch (ex) {\n      return next(ex)\n    }\n\n    // If we're saving bundled deps, normalize the key before we start\n    if (saveBundle) {\n      var bundle = tree.package.bundleDependencies || tree.package.bundledDependencies\n      delete tree.package.bundledDependencies\n      if (!Array.isArray(bundle)) bundle = []\n    }\n\n    var toSave = getThingsToSave(tree)\n    var toRemove = getThingsToRemove(tree)\n    var savingTo = {}\n    toSave.forEach(function (pkg) { if (pkg.save) savingTo[pkg.save] = true })\n    toRemove.forEach(function (pkg) { if (pkg.save) savingTo[pkg.save] = true })\n\n    Object.keys(savingTo).forEach(function (save) {\n      if (!tree.package[save]) tree.package[save] = {}\n    })\n\n    log.verbose('saving', toSave)\n    const types = ['dependencies', 'devDependencies', 'optionalDependencies']\n    toSave.forEach(function (pkg) {\n      if (pkg.save) tree.package[pkg.save][pkg.name] = pkg.spec\n      const movedFrom = []\n      for (let saveType of types) {\n        if (\n          pkg.save !== saveType &&\n          tree.package[saveType] &&\n          tree.package[saveType][pkg.name]\n        ) {\n          movedFrom.push(saveType)\n          delete tree.package[saveType][pkg.name]\n        }\n      }\n      if (movedFrom.length) {\n        log.notice('save', `${pkg.name} is being moved from ${movedFrom.join(' and ')} to ${pkg.save}`)\n      }\n      if (saveBundle) {\n        var ii = bundle.indexOf(pkg.name)\n        if (ii === -1) bundle.push(pkg.name)\n      }\n    })\n\n    toRemove.forEach(function (pkg) {\n      if (pkg.save) delete tree.package[pkg.save][pkg.name]\n      if (saveBundle) {\n        bundle = without(bundle, pkg.name)\n      }\n    })\n\n    Object.keys(savingTo).forEach(function (key) {\n      tree.package[key] = deepSortObject(tree.package[key])\n    })\n    if (saveBundle) {\n      tree.package.bundleDependencies = deepSortObject(bundle)\n    }\n\n    var json = stringifyPackage(tree.package, indent, newline)\n    if (json === packagejson) {\n      log.verbose('shrinkwrap', 'skipping write for package.json because there were no changes.')\n      next()\n    } else {\n      writeFileAtomic(saveTarget, json, next)\n    }\n  }))\n}\n\nexports.getSaveType = function (tree, arg) {\n  if (arguments.length) validate('OO', arguments)\n  var globalInstall = npm.config.get('global')\n  var noSaveFlags = !npm.config.get('save') &&\n                    !npm.config.get('save-dev') &&\n                    !npm.config.get('save-prod') &&\n                    !npm.config.get('save-optional')\n  if (globalInstall || noSaveFlags) return null\n\n  if (npm.config.get('save-optional')) {\n    return 'optionalDependencies'\n  } else if (npm.config.get('save-dev')) {\n    return 'devDependencies'\n  } else if (npm.config.get('save-prod')) {\n    return 'dependencies'\n  } else {\n    if (arg) {\n      var name = moduleName(arg)\n      if (tree.package.optionalDependencies[name]) {\n        return 'optionalDependencies'\n      } else if (tree.package.devDependencies[name]) {\n        return 'devDependencies'\n      }\n    }\n    return 'dependencies'\n  }\n}\n\nfunction getThingsToSave (tree) {\n  validate('O', arguments)\n  var toSave = tree.children.filter(function (child) {\n    return child.save\n  }).map(function (child) {\n    return {\n      name: moduleName(child),\n      spec: child.saveSpec,\n      save: child.save\n    }\n  })\n  return toSave\n}\n\nfunction getThingsToRemove (tree) {\n  validate('O', arguments)\n  if (!tree.removedChildren) return []\n  var toRemove = tree.removedChildren.map(function (child) {\n    return {\n      name: moduleName(child),\n      save: child.save\n    }\n  })\n  return toRemove\n}\n"]}
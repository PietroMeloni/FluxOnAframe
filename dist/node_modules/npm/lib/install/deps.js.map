{"version":3,"sources":["../../../../../node_modules/npm/lib/install/deps.js"],"names":["BB","require","fs","assert","path","semver","asyncMap","chain","iferr","npa","validate","dezalgo","fetchPackageMetadata","andAddParentToErrors","addBundled","readShrinkwrap","inflateShrinkwrap","inflateBundled","andFinishTracker","npm","flatNameFromTree","createChild","create","resetMetadata","reset","isInstallable","packageId","moduleName","isDevDep","isProdDep","reportOptionalFailure","getSaveType","unixFormatPath","isExtraneous","isRegistry","hasModernMeta","registryTypes","range","version","doesChildVersionMatch","child","requested","requestor","fromShrinkwrap","hasRequiresFromLock","type","fetchSpec","isLink","relative","realpath","fromSw","package","_from","name","toString","childReq","_requested","rawSpec","saveSpec","fromReq","resolve","replace","RegExp","satisfies","e","childDependencySpecifier","tree","spec","where","packageRelativePath","exports","computeMetadata","seen","Set","has","add","parent","isTop","location","findChild","kind","req","err","findRequirement","resolveWithExistingModule","deps","dependencies","reqs","swRequires","Object","keys","missingDeps","devDeps","devDependencies","missingDevDeps","children","filter","removed","forEach","isDep","prodVer","devVer","prodSpec","matches","devSpec","addRequiredDep","dep","replaceModuleByPath","replaceModuleByName","removeObsoleteDep","log","silly","pchild","requires","requirement","requiredBy","reqBy","isLocal","isInLink","preserveSymlinks","matchingDep","getAllMetadata","args","next","arg","done","stat","join","loadRequestedDeps","saveToDependencies","pkg","depLoaded","resolveWithNewModule","newGroup","tracker","arguments","config","get","isGlobal","childName","computeVersionSpec","userRequired","save","types","saveType","childIsDep","andForEachChild","loadDeps","isNotEmpty","value","getTop","rangeDescriptor","valid","gte","moduleNameMatches","removeDeps","pkgName","toRemove","pkgToRemove","flagAsRemoving","removing","required","removeExtraneous","length","load","er","logs","cmds","ii","push","sortedCmds","sort","installOrder","aa","bb","localeCompare","isDepOptional","_optional","optDeps","optionalDependencies","includeDev","test","prodDeps","includeProd","failedDependency","failed","anyFailed","requireParent","andHandleOptionalErrors","childLog","isFatal","prefetchDeps","skipOptional","finished","fpm","promisify","resolveBranchDeps","then","allDependencies","map","newItem","loaded","now","addDependency","loadDevDeps","logGroup","loadExtraneous","finish","andResolveDeps","versionSpec","swReq","_where","_shrinkwrap","undefined","andInflate","registry","fromBundle","reportBundleOverride","code","top","bundlerId","warnings","some","w","Error","verbose","updatePhantomChildren","current","phantomChildren","_replaceModuleByPath","obj","key","replaceModule","replacing","_replaceModuleByName","matchBy","concat","replaceAt","splice","installable","bundleErr","earliestInstallable","_bundled","knownInstallable","hasBundled","replaced","swErr","validatePeerDeps","onInvalid","peerDependencies","pkgname","match","validateAllPeerDeps","nameMatch","versionMatch","process","env","NODE_PRESERVE_SYMLINKS","undeletedModuleMatches","undeletedMatches","binaryMatches","bin"],"mappings":"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","file":"deps.js","sourcesContent":["'use strict'\n\nconst BB = require('bluebird')\n\nvar fs = require('fs')\nvar assert = require('assert')\nvar path = require('path')\nvar semver = require('semver')\nvar asyncMap = require('slide').asyncMap\nvar chain = require('slide').chain\nvar iferr = require('iferr')\nvar npa = require('npm-package-arg')\nvar validate = require('aproba')\nvar dezalgo = require('dezalgo')\nvar fetchPackageMetadata = require('../fetch-package-metadata.js')\nvar andAddParentToErrors = require('./and-add-parent-to-errors.js')\nvar addBundled = require('../fetch-package-metadata.js').addBundled\nvar readShrinkwrap = require('./read-shrinkwrap.js')\nvar inflateShrinkwrap = require('./inflate-shrinkwrap.js')\nvar inflateBundled = require('./inflate-bundled.js')\nvar andFinishTracker = require('./and-finish-tracker.js')\nvar npm = require('../npm.js')\nvar flatNameFromTree = require('./flatten-tree.js').flatNameFromTree\nvar createChild = require('./node.js').create\nvar resetMetadata = require('./node.js').reset\nvar isInstallable = require('./validate-args.js').isInstallable\nvar packageId = require('../utils/package-id.js')\nvar moduleName = require('../utils/module-name.js')\nvar isDevDep = require('./is-dev-dep.js')\nvar isProdDep = require('./is-prod-dep.js')\nvar reportOptionalFailure = require('./report-optional-failure.js')\nvar getSaveType = require('./save.js').getSaveType\nvar unixFormatPath = require('../utils/unix-format-path.js')\nvar isExtraneous = require('./is-extraneous.js')\nvar isRegistry = require('../utils/is-registry.js')\nvar hasModernMeta = require('./has-modern-meta.js')\n\n// The export functions in this module mutate a dependency tree, adding\n// items to them.\n\nvar registryTypes = { range: true, version: true }\n\nfunction doesChildVersionMatch (child, requested, requestor) {\n  if (child.fromShrinkwrap && !child.hasRequiresFromLock) return true\n  // ranges of * ALWAYS count as a match, because when downloading we allow\n  // prereleases to match * if there are ONLY prereleases\n  if (requested.type === 'range' && requested.fetchSpec === '*') return true\n\n  if (requested.type === 'directory') {\n    if (!child.isLink) return false\n    return path.relative(child.realpath, requested.fetchSpec) === ''\n  }\n\n  if (requested.type === 'git' && child.fromShrinkwrap) {\n    const fromSw = child.package._from ? npa(child.package._from) : child.fromShrinkwrap\n    fromSw.name = requested.name // we're only checking specifiers here\n    if (fromSw.toString() === requested.toString()) return true\n  }\n\n  if (!registryTypes[requested.type]) {\n    var childReq = child.package._requested\n    if (childReq) {\n      if (childReq.rawSpec === requested.rawSpec) return true\n      if (childReq.type === requested.type && childReq.saveSpec === requested.saveSpec) return true\n    }\n    // If _requested didn't exist OR if it didn't match then we'll try using\n    // _from. We pass it through npa to normalize the specifier.\n    // This can happen when installing from an `npm-shrinkwrap.json` where `_requested` will\n    // be the tarball URL from `resolved` and thus can't match what's in the `package.json`.\n    // In those cases _from, will be preserved and we can compare that to ensure that they\n    // really came from the same sources.\n    // You'll see this scenario happen with at least tags and git dependencies.\n    // Some buggy clients will write spaces into the module name part of a _from.\n    if (child.package._from) {\n      var fromReq = npa.resolve(moduleName(child), child.package._from.replace(new RegExp('^\\\\s*' + moduleName(child) + '\\\\s*@'), ''))\n      if (fromReq.rawSpec === requested.rawSpec) return true\n      if (fromReq.type === requested.type && fromReq.saveSpec && fromReq.saveSpec === requested.saveSpec) return true\n    }\n    return false\n  }\n  try {\n    return semver.satisfies(child.package.version, requested.fetchSpec, true)\n  } catch (e) {\n    return false\n  }\n}\n\nfunction childDependencySpecifier (tree, name, spec, where) {\n  return npa.resolve(name, spec, where || packageRelativePath(tree))\n}\n\nexports.computeMetadata = computeMetadata\nfunction computeMetadata (tree, seen) {\n  if (!seen) seen = new Set()\n  if (!tree || seen.has(tree)) return\n  seen.add(tree)\n  if (tree.parent == null) {\n    resetMetadata(tree)\n    tree.isTop = true\n  }\n  tree.location = flatNameFromTree(tree)\n\n  function findChild (name, spec, kind) {\n    try {\n      var req = childDependencySpecifier(tree, name, spec)\n    } catch (err) {\n      return\n    }\n    var child = findRequirement(tree, req.name, req)\n    if (child) {\n      resolveWithExistingModule(child, tree)\n      return true\n    }\n  }\n\n  const deps = tree.package.dependencies || {}\n  const reqs = tree.swRequires || {}\n  for (let name of Object.keys(deps)) {\n    if (findChild(name, deps[name])) continue\n    if (name in reqs && findChild(name, reqs[name])) continue\n    tree.missingDeps[name] = deps[name]\n  }\n  if (tree.isTop) {\n    const devDeps = tree.package.devDependencies || {}\n    for (let name of Object.keys(devDeps)) {\n      if (findChild(name, devDeps[name])) continue\n      tree.missingDevDeps[name] = devDeps[name]\n    }\n  }\n\n  tree.children.filter((child) => !child.removed).forEach((child) => computeMetadata(child, seen))\n\n  return tree\n}\n\nfunction isDep (tree, child) {\n  var name = moduleName(child)\n  var prodVer = isProdDep(tree, name)\n  var devVer = isDevDep(tree, name)\n\n  try {\n    var prodSpec = childDependencySpecifier(tree, name, prodVer)\n  } catch (err) {\n    return {isDep: true, isProdDep: false, isDevDep: false}\n  }\n  var matches\n  if (prodSpec) matches = doesChildVersionMatch(child, prodSpec, tree)\n  if (matches) return {isDep: true, isProdDep: prodSpec, isDevDep: false}\n  if (devVer === prodVer) return {isDep: child.fromShrinkwrap, isProdDep: false, isDevDep: false}\n  try {\n    var devSpec = childDependencySpecifier(tree, name, devVer)\n    return {isDep: doesChildVersionMatch(child, devSpec, tree) || child.fromShrinkwrap, isProdDep: false, isDevDep: devSpec}\n  } catch (err) {\n    return {isDep: child.fromShrinkwrap, isProdDep: false, isDevDep: false}\n  }\n}\n\nfunction addRequiredDep (tree, child) {\n  var dep = isDep(tree, child)\n  if (!dep.isDep) return false\n  replaceModuleByPath(child, 'requiredBy', tree)\n  replaceModuleByName(tree, 'requires', child)\n  if (dep.isProdDep && tree.missingDeps) delete tree.missingDeps[moduleName(child)]\n  if (dep.isDevDep && tree.missingDevDeps) delete tree.missingDevDeps[moduleName(child)]\n  return true\n}\n\nexports.removeObsoleteDep = removeObsoleteDep\nfunction removeObsoleteDep (child, log) {\n  if (child.removed) return\n  child.removed = true\n  if (log) {\n    log.silly('removeObsoleteDep', 'removing ' + packageId(child) +\n      ' from the tree as its been replaced by a newer version or is no longer required')\n  }\n  // remove from physical tree\n  if (child.parent) {\n    child.parent.children = child.parent.children.filter(function (pchild) { return pchild !== child })\n  }\n  // remove from logical tree\n  var requires = child.requires || []\n  requires.forEach(function (requirement) {\n    requirement.requiredBy = requirement.requiredBy.filter(function (reqBy) { return reqBy !== child })\n    // we don't just check requirement.requires because that doesn't account\n    // for circular deps.  isExtraneous does.\n    if (isExtraneous(requirement)) removeObsoleteDep(requirement, log)\n  })\n}\n\nfunction packageRelativePath (tree) {\n  if (!tree) return ''\n  var requested = tree.package._requested || {}\n  var isLocal = requested.type === 'directory' || requested.type === 'file'\n  return isLocal ? requested.fetchSpec\n    : (tree.isLink || tree.isInLink) && !preserveSymlinks() ? tree.realpath\n      : tree.path\n}\n\nfunction matchingDep (tree, name) {\n  if (!tree || !tree.package) return\n  if (tree.package.dependencies && tree.package.dependencies[name]) return tree.package.dependencies[name]\n  if (tree.package.devDependencies && tree.package.devDependencies[name]) return tree.package.devDependencies[name]\n}\n\nexports.getAllMetadata = function (args, tree, where, next) {\n  asyncMap(args, function (arg, done) {\n    let spec\n    try {\n      spec = npa(arg)\n    } catch (e) {\n      return done(e)\n    }\n    if (spec.type !== 'file' && spec.type !== 'directory' && (spec.name == null || spec.rawSpec === '')) {\n      return fs.stat(path.join(arg, 'package.json'), (err) => {\n        if (err) {\n          var version = matchingDep(tree, spec.name)\n          if (version) {\n            try {\n              return fetchPackageMetadata(npa.resolve(spec.name, version), where, done)\n            } catch (e) {\n              return done(e)\n            }\n          } else {\n            return fetchPackageMetadata(spec, where, done)\n          }\n        } else {\n          try {\n            return fetchPackageMetadata(npa('file:' + arg), where, done)\n          } catch (e) {\n            return done(e)\n          }\n        }\n      })\n    } else {\n      return fetchPackageMetadata(spec, where, done)\n    }\n  }, next)\n}\n\n// Add a list of args to tree's top level dependencies\nexports.loadRequestedDeps = function (args, tree, saveToDependencies, log, next) {\n  validate('AOOF', [args, tree, log, next])\n  asyncMap(args, function (pkg, done) {\n    var depLoaded = andAddParentToErrors(tree, done)\n    resolveWithNewModule(pkg, tree, log.newGroup('loadRequestedDeps'), iferr(depLoaded, function (child, tracker) {\n      validate('OO', arguments)\n      if (npm.config.get('global')) {\n        child.isGlobal = true\n      }\n      var childName = moduleName(child)\n      child.saveSpec = computeVersionSpec(tree, child)\n      child.userRequired = true\n      child.save = getSaveType(tree, child)\n      const types = ['dependencies', 'devDependencies', 'optionalDependencies']\n      if (child.save) {\n        tree.package[child.save][childName] = child.saveSpec\n        // Astute readers might notice that this exact same code exists in\n        // save.js under a different guise. That code is responsible for deps\n        // being removed from the final written `package.json`. The removal in\n        // this function is specifically to prevent \"installed as both X and Y\"\n        // warnings when moving an existing dep between different dep fields.\n        //\n        // Or, try it by removing this loop, and do `npm i -P x && npm i -D x`\n        for (let saveType of types) {\n          if (child.save !== saveType) {\n            delete tree.package[saveType][childName]\n          }\n        }\n        if (child.save === 'optionalDependencies') tree.package.dependencies[childName] = child.saveSpec\n      }\n\n      // For things the user asked to install, that aren't a dependency (or\n      // won't be when we're done), flag it as \"depending\" on the user\n      // themselves, so we don't remove it as a dep that no longer exists\n      var childIsDep = addRequiredDep(tree, child)\n      if (!childIsDep) child.userRequired = true\n      depLoaded(null, child, tracker)\n    }))\n  }, andForEachChild(loadDeps, andFinishTracker(log, next)))\n}\n\nfunction isNotEmpty (value) {\n  return value != null && value !== ''\n}\n\nexports.computeVersionSpec = computeVersionSpec\nfunction computeVersionSpec (tree, child) {\n  validate('OO', arguments)\n  var requested\n  var childReq = child.package._requested\n  if (child.isLink) {\n    requested = npa.resolve(child.package.name, 'file:' + child.realpath, getTop(tree).path)\n  } else if (childReq && (isNotEmpty(childReq.saveSpec) || (isNotEmpty(childReq.rawSpec) && isNotEmpty(childReq.fetchSpec)))) {\n    requested = child.package._requested\n  } else if (child.package._from) {\n    requested = npa(child.package._from, tree.path)\n  } else {\n    requested = npa.resolve(child.package.name, child.package.version)\n  }\n  if (isRegistry(requested)) {\n    var version = child.package.version\n    var rangeDescriptor = ''\n    if (semver.valid(version, true) &&\n        semver.gte(version, '0.1.0', true) &&\n        !npm.config.get('save-exact')) {\n      rangeDescriptor = npm.config.get('save-prefix')\n    }\n    return rangeDescriptor + version\n  } else if (requested.type === 'directory' || requested.type === 'file') {\n    return 'file:' + unixFormatPath(path.relative(getTop(tree).path, requested.fetchSpec))\n  } else {\n    return requested.saveSpec || requested.rawSpec\n  }\n}\n\nfunction moduleNameMatches (name) {\n  return function (child) { return moduleName(child) === name }\n}\n\n// while this implementation does not require async calling, doing so\n// gives this a consistent interface with loadDeps et al\nexports.removeDeps = function (args, tree, saveToDependencies, next) {\n  validate('AOSF|AOZF', [args, tree, saveToDependencies, next])\n  for (let pkg of args) {\n    var pkgName = moduleName(pkg)\n    var toRemove = tree.children.filter(moduleNameMatches(pkgName))\n    var pkgToRemove = toRemove[0] || createChild({package: {name: pkgName}})\n    var saveType = getSaveType(tree, pkg) || 'dependencies'\n    if (tree.isTop && saveToDependencies) {\n      pkgToRemove.save = saveType\n    }\n    if (tree.package[saveType][pkgName]) {\n      delete tree.package[saveType][pkgName]\n      if (saveType === 'optionalDependencies' && tree.package.dependencies[pkgName]) {\n        delete tree.package.dependencies[pkgName]\n      }\n    }\n    replaceModuleByPath(tree, 'removedChildren', pkgToRemove)\n    for (let parent of pkgToRemove.requiredBy) {\n      parent.requires = parent.requires.filter((child) => child !== pkgToRemove)\n    }\n    pkgToRemove.requiredBy = pkgToRemove.requiredBy.filter((parent) => parent !== tree)\n    flagAsRemoving(pkgToRemove)\n  }\n  next()\n}\n\nfunction flagAsRemoving (toRemove, seen) {\n  if (!seen) seen = new Set()\n  if (seen.has(toRemove)) return\n  seen.add(toRemove)\n  toRemove.removing = true\n  toRemove.requires.forEach((required) => {\n    flagAsRemoving(required, seen)\n  })\n}\n\nexports.removeExtraneous = function (args, tree, next) {\n  for (let pkg of args) {\n    var pkgName = moduleName(pkg)\n    var toRemove = tree.children.filter(moduleNameMatches(pkgName))\n    if (toRemove.length) {\n      removeObsoleteDep(toRemove[0])\n    }\n  }\n  next()\n}\n\nfunction andForEachChild (load, next) {\n  validate('F', [next])\n  next = dezalgo(next)\n  return function (er, children, logs) {\n    // when children is empty, logs won't be passed in at all (asyncMap is weird)\n    // so shortcircuit before arg validation\n    if (!er && (!children || children.length === 0)) return next()\n    validate('EAA', arguments)\n    if (er) return next(er)\n    assert(children.length === logs.length)\n    var cmds = []\n    for (var ii = 0; ii < children.length; ++ii) {\n      cmds.push([load, children[ii], logs[ii]])\n    }\n    var sortedCmds = cmds.sort(function installOrder (aa, bb) {\n      return moduleName(aa[1]).localeCompare(moduleName(bb[1]))\n    })\n    chain(sortedCmds, next)\n  }\n}\n\nfunction isDepOptional (tree, name, pkg) {\n  if (pkg.package && pkg.package._optional) return true\n  const optDeps = tree.package.optionalDependencies\n  if (optDeps && optDeps[name] != null) return true\n\n  const devDeps = tree.package.devDependencies\n  if (devDeps && devDeps[name] != null) {\n    const includeDev = npm.config.get('dev') ||\n      (!/^prod(uction)?$/.test(npm.config.get('only')) && !npm.config.get('production')) ||\n      /^dev(elopment)?$/.test(npm.config.get('only')) ||\n      /^dev(elopment)?$/.test(npm.config.get('also'))\n    return !includeDev\n  }\n  const prodDeps = tree.package.dependencies\n  if (prodDeps && prodDeps[name] != null) {\n    const includeProd = !/^dev(elopment)?$/.test(npm.config.get('only'))\n    return !includeProd\n  }\n  return false\n}\n\nexports.failedDependency = failedDependency\nfunction failedDependency (tree, name, pkg) {\n  if (name) {\n    if (isDepOptional(tree, name, pkg || {})) {\n      return false\n    }\n  }\n\n  tree.failed = true\n\n  if (tree.isTop) return true\n\n  if (tree.userRequired) return true\n\n  if (!tree.requiredBy) return false\n\n  let anyFailed = false\n  for (var ii = 0; ii < tree.requiredBy.length; ++ii) {\n    var requireParent = tree.requiredBy[ii]\n    if (failedDependency(requireParent, moduleName(tree), tree)) {\n      anyFailed = true\n    }\n  }\n  return anyFailed\n}\n\nfunction andHandleOptionalErrors (log, tree, name, done) {\n  validate('OOSF', arguments)\n  return function (er, child, childLog) {\n    if (!er) validate('OO', [child, childLog])\n    if (!er) return done(er, child, childLog)\n    var isFatal = failedDependency(tree, name)\n    if (er && !isFatal) {\n      reportOptionalFailure(tree, name, er)\n      return done()\n    } else {\n      return done(er, child, childLog)\n    }\n  }\n}\n\nexports.prefetchDeps = prefetchDeps\nfunction prefetchDeps (tree, deps, log, next) {\n  validate('OOOF', arguments)\n  var skipOptional = !npm.config.get('optional')\n  var seen = new Set()\n  const finished = andFinishTracker(log, next)\n  const fpm = BB.promisify(fetchPackageMetadata)\n  resolveBranchDeps(tree.package, deps).then(\n    () => finished(), finished\n  )\n\n  function resolveBranchDeps (pkg, deps) {\n    return BB.resolve(null).then(() => {\n      var allDependencies = Object.keys(deps).map((dep) => {\n        return npa.resolve(dep, deps[dep])\n      }).filter((dep) => {\n        return isRegistry(dep) &&\n               !seen.has(dep.toString()) &&\n               !findRequirement(tree, dep.name, dep)\n      })\n      if (skipOptional) {\n        var optDeps = pkg.optionalDependencies || {}\n        allDependencies = allDependencies.filter((dep) => !optDeps[dep.name])\n      }\n      return BB.map(allDependencies, (dep) => {\n        seen.add(dep.toString())\n        return fpm(dep, '', {tracker: log.newItem('fetchMetadata')}).then(\n          (pkg) => {\n            return pkg && pkg.dependencies && resolveBranchDeps(pkg, pkg.dependencies)\n          },\n          () => null\n        )\n      })\n    })\n  }\n}\n\n// Load any missing dependencies in the given tree\nexports.loadDeps = loadDeps\nfunction loadDeps (tree, log, next) {\n  validate('OOF', arguments)\n  if (tree.loaded || (tree.parent && tree.parent.failed) || tree.removed) return andFinishTracker.now(log, next)\n  if (tree.parent) tree.loaded = true\n  if (!tree.package.dependencies) tree.package.dependencies = {}\n  asyncMap(Object.keys(tree.package.dependencies), function (dep, done) {\n    var version = tree.package.dependencies[dep]\n    addDependency(dep, version, tree, log.newGroup('loadDep:' + dep), andHandleOptionalErrors(log, tree, dep, done))\n  }, andForEachChild(loadDeps, andFinishTracker(log, next)))\n}\n\n// Load development dependencies into the given tree\nexports.loadDevDeps = function (tree, log, next) {\n  validate('OOF', arguments)\n  if (!tree.package.devDependencies) return andFinishTracker.now(log, next)\n  asyncMap(Object.keys(tree.package.devDependencies), function (dep, done) {\n    // things defined as both dev dependencies and regular dependencies are treated\n    // as the former\n    if (tree.package.dependencies[dep]) return done()\n\n    var logGroup = log.newGroup('loadDevDep:' + dep)\n    addDependency(dep, tree.package.devDependencies[dep], tree, logGroup, andHandleOptionalErrors(log, tree, dep, done))\n  }, andForEachChild(loadDeps, andFinishTracker(log, next)))\n}\n\nvar loadExtraneous = exports.loadExtraneous = function (tree, log, next) {\n  var seen = new Set()\n\n  function loadExtraneous (tree) {\n    if (seen.has(tree)) return\n    seen.add(tree)\n    for (var child of tree.children) {\n      if (child.loaded) continue\n      resolveWithExistingModule(child, tree)\n      loadExtraneous(child)\n    }\n  }\n  loadExtraneous(tree)\n  log.finish()\n  next()\n}\n\nexports.loadExtraneous.andResolveDeps = function (tree, log, next) {\n  validate('OOF', arguments)\n  // For canonicalized trees (eg from shrinkwrap) we don't want to bother\n  // resolving the dependencies of extraneous deps.\n  if (tree.loaded) return loadExtraneous(tree, log, next)\n  asyncMap(tree.children.filter(function (child) { return !child.loaded }), function (child, done) {\n    resolveWithExistingModule(child, tree)\n    done(null, child, log)\n  }, andForEachChild(loadDeps, andFinishTracker(log, next)))\n}\n\nfunction addDependency (name, versionSpec, tree, log, done) {\n  validate('SSOOF', arguments)\n  var next = andAddParentToErrors(tree, done)\n  try {\n    var req = childDependencySpecifier(tree, name, versionSpec)\n    if (tree.swRequires && tree.swRequires[name]) {\n      var swReq = childDependencySpecifier(tree, name, tree.swRequires[name], tree.package._where)\n    }\n  } catch (err) {\n    return done(err)\n  }\n  var child = findRequirement(tree, name, req)\n  if (!child && swReq) child = findRequirement(tree, name, swReq)\n  if (hasModernMeta(child)) {\n    resolveWithExistingModule(child, tree)\n    if (child.package._shrinkwrap === undefined) {\n      readShrinkwrap.andInflate(child, function (er) { next(er, child, log) })\n    } else {\n      next(null, child, log)\n    }\n  } else {\n    if (child) {\n      if (req.registry) {\n        req = childDependencySpecifier(tree, name, child.package.version)\n      }\n      if (child.fromBundle) reportBundleOverride(child, log)\n      removeObsoleteDep(child, log)\n    }\n    fetchPackageMetadata(req, packageRelativePath(tree), {tracker: log.newItem('fetchMetadata')}, iferr(next, function (pkg) {\n      resolveWithNewModule(pkg, tree, log, next)\n    }))\n  }\n}\n\nfunction getTop (pkg) {\n  const seen = new Set()\n  while (pkg.parent && !seen.has(pkg.parent)) {\n    pkg = pkg.parent\n    seen.add(pkg)\n  }\n  return pkg\n}\n\nfunction reportBundleOverride (child, log) {\n  const code = 'EBUNDLEOVERRIDE'\n  const top = getTop(child.fromBundle)\n  const bundlerId = packageId(child.fromBundle)\n  if (!top.warnings.some((w) => {\n    return w.code === code\n  })) {\n    const err = new Error(`${bundlerId} had bundled packages that do not match the required version(s). They have been replaced with non-bundled versions.`)\n    err.code = code\n    top.warnings.push(err)\n  }\n  if (log) log.verbose('bundle', `${code}: Replacing ${bundlerId}'s bundled version of ${moduleName(child)} with ${packageId(child)}.`)\n}\n\nfunction resolveWithExistingModule (child, tree) {\n  validate('OO', arguments)\n  addRequiredDep(tree, child)\n  if (tree.parent && child.parent !== tree) updatePhantomChildren(tree.parent, child)\n}\n\nvar updatePhantomChildren = exports.updatePhantomChildren = function (current, child) {\n  validate('OO', arguments)\n  while (current && current !== child.parent) {\n    if (!current.phantomChildren) current.phantomChildren = {}\n    current.phantomChildren[moduleName(child)] = child\n    current = current.parent\n  }\n}\n\nexports._replaceModuleByPath = replaceModuleByPath\nfunction replaceModuleByPath (obj, key, child) {\n  return replaceModule(obj, key, child, function (replacing, child) {\n    return replacing.path === child.path\n  })\n}\n\nexports._replaceModuleByName = replaceModuleByName\nfunction replaceModuleByName (obj, key, child) {\n  var childName = moduleName(child)\n  return replaceModule(obj, key, child, function (replacing, child) {\n    return moduleName(replacing) === childName\n  })\n}\n\nfunction replaceModule (obj, key, child, matchBy) {\n  validate('OSOF', arguments)\n  if (!obj[key]) obj[key] = []\n  // we replace children with a new array object instead of mutating it\n  // because mutating it results in weird failure states.\n  // I would very much like to know _why_ this is. =/\n  var children = [].concat(obj[key])\n  for (var replaceAt = 0; replaceAt < children.length; ++replaceAt) {\n    if (matchBy(children[replaceAt], child)) break\n  }\n  var replacing = children.splice(replaceAt, 1, child)\n  obj[key] = children\n  return replacing[0]\n}\n\nfunction resolveWithNewModule (pkg, tree, log, next) {\n  validate('OOOF', arguments)\n\n  log.silly('resolveWithNewModule', packageId(pkg), 'checking installable status')\n  return isInstallable(pkg, (err) => {\n    let installable = !err\n    addBundled(pkg, (bundleErr) => {\n      var parent = earliestInstallable(tree, tree, pkg, log) || tree\n      var isLink = pkg._requested.type === 'directory'\n      var child = createChild({\n        package: pkg,\n        parent: parent,\n        path: path.join(parent.isLink ? parent.realpath : parent.path, 'node_modules', pkg.name),\n        realpath: isLink ? pkg._requested.fetchSpec : path.join(parent.realpath, 'node_modules', pkg.name),\n        children: pkg._bundled || [],\n        isLink: isLink,\n        isInLink: parent.isLink,\n        knownInstallable: installable\n      })\n      if (!installable || bundleErr) child.failed = true\n      delete pkg._bundled\n      var hasBundled = child.children.length\n\n      var replaced = replaceModuleByName(parent, 'children', child)\n      if (replaced) {\n        if (replaced.fromBundle) reportBundleOverride(replaced, log)\n        removeObsoleteDep(replaced)\n      }\n      addRequiredDep(tree, child)\n      child.location = flatNameFromTree(child)\n\n      if (tree.parent && parent !== tree) updatePhantomChildren(tree.parent, child)\n\n      if (hasBundled) {\n        inflateBundled(child, child, child.children)\n      }\n\n      if (pkg._shrinkwrap && pkg._shrinkwrap.dependencies) {\n        return inflateShrinkwrap(child, pkg._shrinkwrap, (swErr) => {\n          if (swErr) child.failed = true\n          next(err || bundleErr || swErr, child, log)\n        })\n      }\n      next(err || bundleErr, child, log)\n    })\n  })\n}\n\nvar validatePeerDeps = exports.validatePeerDeps = function (tree, onInvalid) {\n  if (!tree.package.peerDependencies) return\n  Object.keys(tree.package.peerDependencies).forEach(function (pkgname) {\n    var version = tree.package.peerDependencies[pkgname]\n    try {\n      var spec = npa.resolve(pkgname, version)\n    } catch (e) {}\n    var match = spec && findRequirement(tree.parent || tree, pkgname, spec)\n    if (!match) onInvalid(tree, pkgname, version)\n  })\n}\n\nexports.validateAllPeerDeps = function (tree, onInvalid) {\n  validateAllPeerDeps(tree, onInvalid, new Set())\n}\n\nfunction validateAllPeerDeps (tree, onInvalid, seen) {\n  validate('OFO', arguments)\n  if (seen.has(tree)) return\n  seen.add(tree)\n  validatePeerDeps(tree, onInvalid)\n  tree.children.forEach(function (child) { validateAllPeerDeps(child, onInvalid, seen) })\n}\n\n// Determine if a module requirement is already met by the tree at or above\n// our current location in the tree.\nvar findRequirement = exports.findRequirement = function (tree, name, requested, requestor) {\n  validate('OSO', [tree, name, requested])\n  if (!requestor) requestor = tree\n  var nameMatch = function (child) {\n    return moduleName(child) === name && child.parent && !child.removed\n  }\n  var versionMatch = function (child) {\n    return doesChildVersionMatch(child, requested, requestor)\n  }\n  if (nameMatch(tree)) {\n    // this *is* the module, but it doesn't match the version, so a\n    // new copy will have to be installed\n    return versionMatch(tree) ? tree : null\n  }\n\n  var matches = tree.children.filter(nameMatch)\n  if (matches.length) {\n    matches = matches.filter(versionMatch)\n    // the module exists as a dependent, but the version doesn't match, so\n    // a new copy will have to be installed above here\n    if (matches.length) return matches[0]\n    return null\n  }\n  if (tree.isTop) return null\n  if (!preserveSymlinks() && /^[.][.][\\\\/]/.test(path.relative(tree.parent.realpath, tree.realpath))) return null\n  return findRequirement(tree.parent, name, requested, requestor)\n}\n\nfunction preserveSymlinks () {\n  if (!('NODE_PRESERVE_SYMLINKS' in process.env)) return false\n  const value = process.env.NODE_PRESERVE_SYMLINKS\n  if (value == null || value === '' || value === 'false' || value === 'no' || value === '0') return false\n  return true\n}\n\n// Find the highest level in the tree that we can install this module in.\n// If the module isn't installed above us yet, that'd be the very top.\n// If it is, then it's the level below where its installed.\nvar earliestInstallable = exports.earliestInstallable = function (requiredBy, tree, pkg, log) {\n  validate('OOOO', arguments)\n\n  function undeletedModuleMatches (child) {\n    return !child.removed && moduleName(child) === pkg.name\n  }\n  const undeletedMatches = tree.children.filter(undeletedModuleMatches)\n  if (undeletedMatches.length) {\n    // if there's a conflict with another child AT THE SAME level then we're replacing it, so\n    // mark it as removed and continue with resolution normally.\n    if (tree === requiredBy) {\n      undeletedMatches.forEach((pkg) => {\n        if (pkg.fromBundle) reportBundleOverride(pkg, log)\n        removeObsoleteDep(pkg, log)\n      })\n    } else {\n      return null\n    }\n  }\n\n  // If any of the children of this tree have conflicting\n  // binaries then we need to decline to install this package here.\n  var binaryMatches = pkg.bin && tree.children.some(function (child) {\n    if (child.removed || !child.package.bin) return false\n    return Object.keys(child.package.bin).some(function (bin) {\n      return pkg.bin[bin]\n    })\n  })\n\n  if (binaryMatches) return null\n\n  // if this tree location requested the same module then we KNOW it\n  // isn't compatible because if it were findRequirement would have\n  // found that version.\n  var deps = tree.package.dependencies || {}\n  if (!tree.removed && requiredBy !== tree && deps[pkg.name]) {\n    return null\n  }\n\n  var devDeps = tree.package.devDependencies || {}\n  if (tree.isTop && devDeps[pkg.name]) {\n    var requested = childDependencySpecifier(tree, pkg.name, devDeps[pkg.name])\n    if (!doesChildVersionMatch({package: pkg}, requested, tree)) {\n      return null\n    }\n  }\n\n  if (tree.phantomChildren && tree.phantomChildren[pkg.name]) return null\n\n  if (tree.isTop) return tree\n  if (tree.isGlobal) return tree\n\n  if (npm.config.get('global-style') && tree.parent.isTop) return tree\n  if (npm.config.get('legacy-bundling')) return tree\n\n  if (!preserveSymlinks() && /^[.][.][\\\\/]/.test(path.relative(tree.parent.realpath, tree.realpath))) return tree\n\n  return (earliestInstallable(requiredBy, tree.parent, pkg, log) || tree)\n}\n"]}
{"version":3,"sources":["../../../../../node_modules/npm/lib/install/check-permissions.js"],"names":["path","require","log","validate","uniq","asyncMap","npm","exists","writable","module","exports","actions","next","arguments","errors","action","done","cmd","pkg","hasAnyWriteAccess","resolve","hasWriteAccess","andHasWriteAccess","fromPath","length","map","er","forEach","warn","config","get","dir","findNearestDir","nextDir","dirDoesntExist","push"],"mappings":"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","file":"check-permissions.js","sourcesContent":["'use strict'\nvar path = require('path')\nvar log = require('npmlog')\nvar validate = require('aproba')\nvar uniq = require('lodash.uniq')\nvar asyncMap = require('slide').asyncMap\nvar npm = require('../npm.js')\nvar exists = require('./exists.js')\nvar writable = require('./writable.js')\n\nmodule.exports = function (actions, next) {\n  validate('AF', arguments)\n  var errors = []\n  asyncMap(actions, function (action, done) {\n    var cmd = action[0]\n    var pkg = action[1]\n    switch (cmd) {\n      case 'add':\n        hasAnyWriteAccess(path.resolve(pkg.path, '..'), errors, done)\n        break\n      case 'update':\n      case 'remove':\n        hasWriteAccess(pkg.path, errors, andHasWriteAccess(path.resolve(pkg.path, '..'), errors, done))\n        break\n      case 'move':\n        hasAnyWriteAccess(pkg.path, errors, andHasWriteAccess(path.resolve(pkg.fromPath, '..'), errors, done))\n        break\n      default:\n        done()\n    }\n  }, function () {\n    if (!errors.length) return next()\n    uniq(errors.map(function (er) { return 'Missing write access to ' + er.path })).forEach(function (er) {\n      log.warn('checkPermissions', er)\n    })\n    npm.config.get('force') ? next() : next(errors[0])\n  })\n}\n\nfunction andHasWriteAccess (dir, errors, done) {\n  validate('SAF', arguments)\n  return function () {\n    hasWriteAccess(dir, errors, done)\n  }\n}\n\nfunction hasAnyWriteAccess (dir, errors, done) {\n  validate('SAF', arguments)\n  findNearestDir()\n  function findNearestDir () {\n    var nextDir = path.resolve(dir, '..')\n    exists(dir, function (dirDoesntExist) {\n      if (!dirDoesntExist || nextDir === dir) {\n        return hasWriteAccess(dir, errors, done)\n      } else {\n        dir = nextDir\n        findNearestDir()\n      }\n    })\n  }\n}\n\nfunction hasWriteAccess (dir, errors, done) {\n  validate('SAF', arguments)\n  writable(dir, function (er) {\n    if (er) errors.push(er)\n    done()\n  })\n}\n"]}
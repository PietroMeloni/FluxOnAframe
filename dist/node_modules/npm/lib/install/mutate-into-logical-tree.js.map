{"version":3,"sources":["../../../../../node_modules/npm/lib/install/mutate-into-logical-tree.js"],"names":["union","require","without","validate","flattenTree","isExtraneous","validateAllPeerDeps","packageId","moduleName","npm","isDisconnectedCycle","tree","seen","isTop","cycleTop","requiredBy","length","path","every","node","Object","create","mutateIntoLogicalTree","module","exports","arguments","pkgname","version","missingPeers","flat","keys","sort","forEach","flatname","parent","children","parentNode","asReadInstalled","translateTree","translateTree_","Set","pkg","package","has","add","_dependencies","dependencies","child","dep","fakeChild","missing","optional","_optional","_spec","markMissing","name","invalid","realName","extraneous","optionalDependencies","missingDeps","missingDevDeps","checkForMissingPeers","concat","filter","peerPkg","_id","peerMissing","push","requires","error","config","get","target","link","realpath"],"mappings":"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","file":"mutate-into-logical-tree.js","sourcesContent":["'use strict'\nvar union = require('lodash.union')\nvar without = require('lodash.without')\nvar validate = require('aproba')\nvar flattenTree = require('./flatten-tree.js')\nvar isExtraneous = require('./is-extraneous.js')\nvar validateAllPeerDeps = require('./deps.js').validateAllPeerDeps\nvar packageId = require('../utils/package-id.js')\nvar moduleName = require('../utils/module-name.js')\nvar npm = require('../npm.js')\n\n// Return true if tree is a part of a cycle that:\n//   A) Never connects to the top of the tree\n//   B) Has not not had a point in the cycle arbitraryly declared its top\n//      yet.\nfunction isDisconnectedCycle (tree, seen) {\n  if (!seen) seen = {}\n  if (tree.isTop || tree.cycleTop || tree.requiredBy.length === 0) {\n    return false\n  } else if (seen[tree.path]) {\n    return true\n  } else {\n    seen[tree.path] = true\n    return tree.requiredBy.every(function (node) {\n      return isDisconnectedCycle(node, Object.create(seen))\n    })\n  }\n}\n\nvar mutateIntoLogicalTree = module.exports = function (tree) {\n  validate('O', arguments)\n\n  validateAllPeerDeps(tree, function (tree, pkgname, version) {\n    if (!tree.missingPeers) tree.missingPeers = {}\n    tree.missingPeers[pkgname] = version\n  })\n\n  var flat = flattenTree(tree)\n\n  Object.keys(flat).sort().forEach(function (flatname) {\n    var node = flat[flatname]\n    if (!(node.requiredBy && node.requiredBy.length)) return\n\n    if (node.parent) {\n      // If a node is a cycle that never reaches the root of the logical\n      // tree then we'll leave it attached to the root, or else it\n      // would go missing. Further we'll note that this is the node in the\n      // cycle that we picked arbitrarily to be the one attached to the root.\n      // others will fall\n      if (isDisconnectedCycle(node)) {\n        node.cycleTop = true\n      // Nor do we want to disconnect non-cyclical extraneous modules from the tree.\n      } else if (node.requiredBy.length) {\n        // regular deps though, we do, as we're moving them into the capable\n        // hands of the modules that require them.\n        node.parent.children = without(node.parent.children, node)\n      }\n    }\n\n    node.requiredBy.forEach(function (parentNode) {\n      parentNode.children = union(parentNode.children, [node])\n    })\n  })\n  return tree\n}\n\nmodule.exports.asReadInstalled = function (tree) {\n  mutateIntoLogicalTree(tree)\n  return translateTree(tree)\n}\n\nfunction translateTree (tree) {\n  return translateTree_(tree, new Set())\n}\n\nfunction translateTree_ (tree, seen) {\n  var pkg = tree.package\n  if (seen.has(tree)) return pkg\n  seen.add(tree)\n  if (pkg._dependencies) return pkg\n  pkg._dependencies = pkg.dependencies\n  pkg.dependencies = {}\n  tree.children.forEach(function (child) {\n    const dep = pkg.dependencies[moduleName(child)] = translateTree_(child, seen)\n    if (child.fakeChild) {\n      dep.missing = true\n      dep.optional = child.package._optional\n      dep.requiredBy = child.package._spec\n    }\n  })\n\n  function markMissing (name, requiredBy) {\n    if (pkg.dependencies[name]) {\n      if (pkg.dependencies[name].missing) return\n      pkg.dependencies[name].invalid = true\n      pkg.dependencies[name].realName = name\n      pkg.dependencies[name].extraneous = false\n    } else {\n      pkg.dependencies[name] = {\n        requiredBy: requiredBy,\n        missing: true,\n        optional: !!pkg.optionalDependencies[name]\n      }\n    }\n  }\n\n  Object.keys(tree.missingDeps).forEach(function (name) {\n    markMissing(name, tree.missingDeps[name])\n  })\n  Object.keys(tree.missingDevDeps).forEach(function (name) {\n    markMissing(name, tree.missingDevDeps[name])\n  })\n  var checkForMissingPeers = (tree.parent ? [] : [tree]).concat(tree.children)\n  checkForMissingPeers.filter(function (child) {\n    return child.missingPeers\n  }).forEach(function (child) {\n    Object.keys(child.missingPeers).forEach(function (pkgname) {\n      var version = child.missingPeers[pkgname]\n      var peerPkg = pkg.dependencies[pkgname]\n      if (!peerPkg) {\n        peerPkg = pkg.dependencies[pkgname] = {\n          _id: pkgname + '@' + version,\n          name: pkgname,\n          version: version\n        }\n      }\n      if (!peerPkg.peerMissing) peerPkg.peerMissing = []\n      peerPkg.peerMissing.push({\n        requiredBy: packageId(child),\n        requires: pkgname + '@' + version\n      })\n    })\n  })\n  pkg.path = tree.path\n\n  pkg.error = tree.error\n  pkg.extraneous = !tree.isTop && (!tree.parent.isTop || !tree.parent.error) && !npm.config.get('global') && isExtraneous(tree)\n  if (tree.target && tree.parent && !tree.parent.target) pkg.link = tree.realpath\n  return pkg\n}\n"]}
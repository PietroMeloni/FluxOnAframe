{"version":3,"sources":["../../../../../../node_modules/npm/lib/install/action/move.js"],"names":["fs","require","path","chain","iferr","rimraf","mkdirp","rmStuff","lifecycle","move","module","exports","staging","pkg","log","next","silly","fromPath","package","failOk","moveModuleOnly","removeEmptyParents","resolve","pkgdir","rmdir","er","code","from","to","done","fromModules","join","tempFromModules","toModules","tempToModules","then","removeDestination","makeDestination","moveToModulesBack","moveNodeModules","doMove","moveNodeModulesBack"],"mappings":"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","file":"move.js","sourcesContent":["'use strict'\nvar fs = require('graceful-fs')\nvar path = require('path')\nvar chain = require('slide').chain\nvar iferr = require('iferr')\nvar rimraf = require('rimraf')\nvar mkdirp = require('mkdirp')\nvar rmStuff = require('../../unbuild.js').rmStuff\nvar lifecycle = require('../../utils/lifecycle.js')\nvar move = require('../../utils/move.js')\n\n/*\n  Move a module from one point in the node_modules tree to another.\n  Do not disturb either the source or target location's node_modules\n  folders.\n*/\n\nmodule.exports = function (staging, pkg, log, next) {\n  log.silly('move', pkg.fromPath, pkg.path)\n  chain([\n    [lifecycle, pkg.package, 'preuninstall', pkg.fromPath, { failOk: true }],\n    [lifecycle, pkg.package, 'uninstall', pkg.fromPath, { failOk: true }],\n    [rmStuff, pkg.package, pkg.fromPath],\n    [lifecycle, pkg.package, 'postuninstall', pkg.fromPath, { failOk: true }],\n    [moveModuleOnly, pkg.fromPath, pkg.path, log],\n    [lifecycle, pkg.package, 'preinstall', pkg.path, { failOk: true }],\n    [removeEmptyParents, path.resolve(pkg.fromPath, '..')]\n  ], next)\n}\n\nfunction removeEmptyParents (pkgdir, next) {\n  fs.rmdir(pkgdir, function (er) {\n    // FIXME: Make sure windows does what we want here\n    if (er && er.code !== 'ENOENT') return next()\n    removeEmptyParents(path.resolve(pkgdir, '..'), next)\n  })\n}\n\nfunction moveModuleOnly (from, to, log, done) {\n  var fromModules = path.join(from, 'node_modules')\n  var tempFromModules = from + '.node_modules'\n  var toModules = path.join(to, 'node_modules')\n  var tempToModules = to + '.node_modules'\n\n  log.silly('move', 'move existing destination node_modules away', toModules)\n\n  move(toModules, tempToModules).then(removeDestination(done), removeDestination(done))\n\n  function removeDestination (next) {\n    return function (er) {\n      log.silly('move', 'remove existing destination', to)\n      if (er) {\n        rimraf(to, iferr(next, makeDestination(next)))\n      } else {\n        rimraf(to, iferr(next, makeDestination(iferr(next, moveToModulesBack(next)))))\n      }\n    }\n  }\n\n  function moveToModulesBack (next) {\n    return function () {\n      log.silly('move', 'move existing destination node_modules back', toModules)\n      move(tempToModules, toModules).then(next, done)\n    }\n  }\n\n  function makeDestination (next) {\n    return function () {\n      log.silly('move', 'make sure destination parent exists', path.resolve(to, '..'))\n      mkdirp(path.resolve(to, '..'), iferr(done, moveNodeModules(next)))\n    }\n  }\n\n  function moveNodeModules (next) {\n    return function () {\n      log.silly('move', 'move source node_modules away', fromModules)\n      move(fromModules, tempFromModules).then(doMove(moveNodeModulesBack(next)), doMove(next))\n    }\n  }\n\n  function doMove (next) {\n    return function () {\n      log.silly('move', 'move module dir to final dest', from, to)\n      move(from, to).then(next, done)\n    }\n  }\n\n  function moveNodeModulesBack (next) {\n    return function () {\n      mkdirp(from, iferr(done, function () {\n        log.silly('move', 'put source node_modules back', fromModules)\n        move(tempFromModules, fromModules).then(next, done)\n      }))\n    }\n  }\n}\n"]}
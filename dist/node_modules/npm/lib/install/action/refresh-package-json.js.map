{"version":3,"sources":["../../../../../../node_modules/npm/lib/install/action/refresh-package-json.js"],"names":["Bluebird","require","checkPlatform","promisify","getRequested","npm","path","readJson","updatePackageJson","module","exports","staging","pkg","log","silly","realpath","join","then","metadata","Object","keys","package","forEach","key","isEmpty","_resolved","fakeChild","resolved","readme","readmeFilename","catch","config","get","requested","_requested","type","value","Array","isArray","length"],"mappings":"AAAA;;;;AAEA,IAAMA,WAAWC,QAAQ,UAAR,CAAjB;;AAEA,IAAMC,gBAAgBF,SAASG,SAAT,CAAmBF,QAAQ,oBAAR,EAA8BC,aAAjD,CAAtB;AACA,IAAME,eAAeH,QAAQ,qBAAR,CAArB;AACA,IAAMI,MAAMJ,QAAQ,cAAR,CAAZ;AACA,IAAMK,OAAOL,QAAQ,MAAR,CAAb;AACA,IAAMM,WAAWP,SAASG,SAAT,CAAmBF,QAAQ,mBAAR,CAAnB,CAAjB;AACA,IAAMO,oBAAoBR,SAASG,SAAT,CAAmBF,QAAQ,wBAAR,CAAnB,CAA1B;;AAEAQ,OAAOC,OAAP,GAAiB,UAAUC,OAAV,EAAmBC,GAAnB,EAAwBC,GAAxB,EAA6B;AAC5CA,MAAIC,KAAJ,CAAU,sBAAV,EAAkCF,IAAIG,QAAtC;;AAEA,SAAOR,SAASD,KAAKU,IAAL,CAAUJ,IAAIN,IAAd,EAAoB,cAApB,CAAT,EAA8C,KAA9C,EAAqDW,IAArD,CAA0D,UAACC,QAAD,EAAc;AAC7EC,WAAOC,IAAP,CAAYR,IAAIS,OAAhB,EAAyBC,OAAzB,CAAiC,UAAUC,GAAV,EAAe;AAC9C,UAAIA,QAAQ,SAAR,IAAqBA,QAAQ,cAA7B,IAA+C,CAACC,QAAQZ,IAAIS,OAAJ,CAAYE,GAAZ,CAAR,CAApD,EAA+E;AAC7EL,iBAASK,GAAT,IAAgBX,IAAIS,OAAJ,CAAYE,GAAZ,CAAhB;AACD;AACF,KAJD;AAKA,QAAIL,SAASO,SAAT,IAAsB,IAAtB,IAA8Bb,IAAIc,SAAtC,EAAiD;AAC/CR,eAASO,SAAT,GAAqBb,IAAIc,SAAJ,CAAcC,QAAnC;AACD;AACD;AACA,WAAOT,SAASU,MAAhB;AACA,WAAOV,SAASW,cAAhB;;AAEAjB,QAAIS,OAAJ,GAAcH,QAAd;AACAN,QAAIc,SAAJ,GAAgB,KAAhB;AACD,GAfM,EAeJI,KAfI,CAeE;AAAA,WAAM,QAAN;AAAA,GAfF,EAekBb,IAflB,CAeuB,YAAM;AAClC,WAAOf,cAAcU,IAAIS,OAAlB,EAA2BhB,IAAI0B,MAAJ,CAAWC,GAAX,CAAe,OAAf,CAA3B,CAAP;AACD,GAjBM,EAiBJf,IAjBI,CAiBC,YAAM;AACZ,QAAMgB,YAAYrB,IAAIS,OAAJ,CAAYa,UAAZ,IAA0B9B,aAAaQ,GAAb,CAA5C;AACA,QAAIqB,UAAUE,IAAV,KAAmB,WAAvB,EAAoC;AAClC,aAAO3B,kBAAkBI,GAAlB,EAAuBA,IAAIN,IAA3B,CAAP;AACD;AACF,GAtBM,CAAP;AAuBD,CA1BD;;AA4BA,SAASkB,OAAT,CAAkBY,KAAlB,EAAyB;AACvB,MAAIA,SAAS,IAAb,EAAmB,OAAO,IAAP;AACnB,MAAIC,MAAMC,OAAN,CAAcF,KAAd,CAAJ,EAA0B,OAAO,CAACA,MAAMG,MAAd;AAC1B,MAAI,QAAOH,KAAP,yCAAOA,KAAP,OAAiB,QAArB,EAA+B,OAAO,CAACjB,OAAOC,IAAP,CAAYgB,KAAZ,EAAmBG,MAA3B;AAC/B,SAAO,KAAP;AACD","file":"refresh-package-json.js","sourcesContent":["'use strict'\n\nconst Bluebird = require('bluebird')\n\nconst checkPlatform = Bluebird.promisify(require('npm-install-checks').checkPlatform)\nconst getRequested = require('../get-requested.js')\nconst npm = require('../../npm.js')\nconst path = require('path')\nconst readJson = Bluebird.promisify(require('read-package-json'))\nconst updatePackageJson = Bluebird.promisify(require('../update-package-json'))\n\nmodule.exports = function (staging, pkg, log) {\n  log.silly('refresh-package-json', pkg.realpath)\n\n  return readJson(path.join(pkg.path, 'package.json'), false).then((metadata) => {\n    Object.keys(pkg.package).forEach(function (key) {\n      if (key !== 'version' && key !== 'dependencies' && !isEmpty(pkg.package[key])) {\n        metadata[key] = pkg.package[key]\n      }\n    })\n    if (metadata._resolved == null && pkg.fakeChild) {\n      metadata._resolved = pkg.fakeChild.resolved\n    }\n    // These two sneak in and it's awful\n    delete metadata.readme\n    delete metadata.readmeFilename\n\n    pkg.package = metadata\n    pkg.fakeChild = false\n  }).catch(() => 'ignore').then(() => {\n    return checkPlatform(pkg.package, npm.config.get('force'))\n  }).then(() => {\n    const requested = pkg.package._requested || getRequested(pkg)\n    if (requested.type !== 'directory') {\n      return updatePackageJson(pkg, pkg.path)\n    }\n  })\n}\n\nfunction isEmpty (value) {\n  if (value == null) return true\n  if (Array.isArray(value)) return !value.length\n  if (typeof value === 'object') return !Object.keys(value).length\n  return false\n}\n"]}
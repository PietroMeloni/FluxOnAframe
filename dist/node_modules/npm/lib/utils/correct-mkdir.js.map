{"version":3,"sources":["../../../../../node_modules/npm/lib/utils/correct-mkdir.js"],"names":["chownr","require","dezalgo","fs","inflight","log","mkdirp","stats","effectiveOwner","module","exports","correctMkdir","path","cb","verbose","stat","er","st","makeDirectory","isDirectory","error","ownerStats","calculateOwner","uid","setPermissions","gid","process","getuid","getgid","env","SUDO_UID","SUDO_GID","owner","platform","HOME","silly","afterMkdir","made","isNaN","code"],"mappings":"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","file":"correct-mkdir.js","sourcesContent":["var chownr = require('chownr')\nvar dezalgo = require('dezalgo')\nvar fs = require('graceful-fs')\nvar inflight = require('inflight')\nvar log = require('npmlog')\nvar mkdirp = require('mkdirp')\n\n// memoize the directories created by this step\nvar stats = {}\nvar effectiveOwner\nmodule.exports = function correctMkdir (path, cb) {\n  cb = dezalgo(cb)\n  cb = inflight('correctMkdir:' + path, cb)\n  if (!cb) {\n    return log.verbose('correctMkdir', path, 'correctMkdir already in flight; waiting')\n  } else {\n    log.verbose('correctMkdir', path, 'correctMkdir not in flight; initializing')\n  }\n\n  if (stats[path]) return cb(null, stats[path])\n\n  fs.stat(path, function (er, st) {\n    if (er) return makeDirectory(path, cb)\n\n    if (!st.isDirectory()) {\n      log.error('correctMkdir', 'invalid dir %s', path)\n      return cb(er)\n    }\n\n    var ownerStats = calculateOwner()\n    // there's always a chance the permissions could have been frobbed, so fix\n    if (st.uid !== ownerStats.uid) {\n      stats[path] = ownerStats\n      setPermissions(path, ownerStats, cb)\n    } else {\n      stats[path] = st\n      cb(null, stats[path])\n    }\n  })\n}\n\nfunction calculateOwner () {\n  if (!effectiveOwner) {\n    effectiveOwner = { uid: 0, gid: 0 }\n\n    // Pretty much only on windows\n    if (!process.getuid) {\n      return effectiveOwner\n    }\n\n    effectiveOwner.uid = +process.getuid()\n    effectiveOwner.gid = +process.getgid()\n\n    if (effectiveOwner.uid === 0) {\n      if (process.env.SUDO_UID) effectiveOwner.uid = +process.env.SUDO_UID\n      if (process.env.SUDO_GID) effectiveOwner.gid = +process.env.SUDO_GID\n    }\n  }\n\n  return effectiveOwner\n}\n\nfunction makeDirectory (path, cb) {\n  cb = inflight('makeDirectory:' + path, cb)\n  if (!cb) {\n    return log.verbose('makeDirectory', path, 'creation already in flight; waiting')\n  } else {\n    log.verbose('makeDirectory', path, 'creation not in flight; initializing')\n  }\n\n  var owner = calculateOwner()\n\n  if (!process.getuid) {\n    return mkdirp(path, function (er) {\n      log.verbose('makeCacheDir', 'UID & GID are irrelevant on', process.platform)\n\n      stats[path] = owner\n      return cb(er, stats[path])\n    })\n  }\n\n  if (owner.uid !== 0 || !process.env.HOME) {\n    log.silly(\n      'makeDirectory', path,\n      'uid:', owner.uid,\n      'gid:', owner.gid\n    )\n    stats[path] = owner\n    mkdirp(path, afterMkdir)\n  } else {\n    fs.stat(process.env.HOME, function (er, st) {\n      if (er) {\n        log.error('makeDirectory', 'homeless?')\n        return cb(er)\n      }\n\n      log.silly(\n        'makeDirectory', path,\n        'uid:', st.uid,\n        'gid:', st.gid\n      )\n      stats[path] = st\n      mkdirp(path, afterMkdir)\n    })\n  }\n\n  function afterMkdir (er, made) {\n    if (er || !stats[path] || isNaN(stats[path].uid) || isNaN(stats[path].gid)) {\n      return cb(er, stats[path])\n    }\n\n    if (!made) return cb(er, stats[path])\n\n    setPermissions(made, stats[path], cb)\n  }\n}\n\nfunction setPermissions (path, st, cb) {\n  chownr(path, st.uid, st.gid, function (er) {\n    if (er && er.code === 'ENOENT') return cb(null, st)\n    return cb(er, st)\n  })\n}\n"]}
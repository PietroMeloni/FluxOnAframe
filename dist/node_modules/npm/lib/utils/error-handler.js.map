{"version":3,"sources":["../../../../../node_modules/npm/lib/utils/error-handler.js"],"names":["module","exports","errorHandler","exit","cbCalled","log","require","npm","itWorked","path","wroteLogFile","exitCode","rollbacks","chain","writeFileAtomic","errorMessage","stopMetrics","stop","mkdirp","fs","logFileName","getLogFile","resolve","config","get","Date","toISOString","replace","timings","version","command","process","argv","slice","logfile","on","name","value","code","emit","disableProgress","loaded","appendFileSync","join","JSON","stringify","_","info","error","console","writeLogFile","verbose","levels","level","doExit","noLog","length","map","f","cb","commands","unbuild","er","reallyExit","errno","stdout","write","Error","stack","message","m","match","forEach","k","v","cwd","os","type","release","msg","summary","concat","detail","errline","apply","messageText","line","sync","logOutput","record","pref","id","prefix","push","trim","split","EOL","ex"],"mappings":"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","file":"error-handler.js","sourcesContent":["\nmodule.exports = errorHandler\nmodule.exports.exit = exit\n\nvar cbCalled = false\nvar log = require('npmlog')\nvar npm = require('../npm.js')\nvar itWorked = false\nvar path = require('path')\nvar wroteLogFile = false\nvar exitCode = 0\nvar rollbacks = npm.rollbacks\nvar chain = require('slide').chain\nvar writeFileAtomic = require('write-file-atomic')\nvar errorMessage = require('./error-message.js')\nvar stopMetrics = require('./metrics.js').stop\nvar mkdirp = require('mkdirp')\nvar fs = require('graceful-fs')\n\nvar logFileName\nfunction getLogFile () {\n  if (!logFileName) {\n    logFileName = path.resolve(npm.config.get('cache'), '_logs', (new Date()).toISOString().replace(/[.:]/g, '_') + '-debug.log')\n  }\n  return logFileName\n}\n\nvar timings = {\n  version: npm.version,\n  command: process.argv.slice(2),\n  logfile: null\n}\nprocess.on('timing', function (name, value) {\n  if (timings[name]) { timings[name] += value } else { timings[name] = value }\n})\n\nprocess.on('exit', function (code) {\n  process.emit('timeEnd', 'npm')\n  log.disableProgress()\n  if (npm.config.loaded && npm.config.get('timing')) {\n    try {\n      timings.logfile = getLogFile()\n      fs.appendFileSync(path.join(npm.config.get('cache'), '_timing.json'), JSON.stringify(timings) + '\\n')\n    } catch (_) {\n      // ignore\n    }\n  }\n\n  // kill any outstanding stats reporter if it hasn't finished yet\n  stopMetrics()\n\n  if (code) itWorked = false\n  if (itWorked) {\n    log.info('ok')\n  } else {\n    if (!cbCalled) {\n      log.error('', 'cb() never called!')\n      console.error('')\n      log.error('', 'This is an error with npm itself. Please report this error at:')\n      log.error('', '    <https://npm.community>')\n      writeLogFile()\n    }\n\n    if (code) {\n      log.verbose('code', code)\n    }\n  }\n  if (npm.config.loaded && npm.config.get('timing') && !wroteLogFile) writeLogFile()\n  if (wroteLogFile) {\n    // just a line break\n    if (log.levels[log.level] <= log.levels.error) console.error('')\n\n    log.error(\n      '',\n      [\n        'A complete log of this run can be found in:',\n        '    ' + getLogFile()\n      ].join('\\n')\n    )\n    wroteLogFile = false\n  }\n\n  var doExit = npm.config.loaded && npm.config.get('_exit')\n  if (doExit) {\n    // actually exit.\n    if (exitCode === 0 && !itWorked) {\n      exitCode = 1\n    }\n    if (exitCode !== 0) process.exit(exitCode)\n  } else {\n    itWorked = false // ready for next exit\n  }\n})\n\nfunction exit (code, noLog) {\n  exitCode = exitCode || process.exitCode || code\n\n  var doExit = npm.config.loaded ? npm.config.get('_exit') : true\n  log.verbose('exit', [code, doExit])\n  if (log.level === 'silent') noLog = true\n\n  if (rollbacks.length) {\n    chain(rollbacks.map(function (f) {\n      return function (cb) {\n        npm.commands.unbuild([f], true, cb)\n      }\n    }), function (er) {\n      if (er) {\n        log.error('error rolling back', er)\n        if (!code) {\n          errorHandler(er)\n        } else {\n          if (!noLog) writeLogFile()\n          reallyExit(er)\n        }\n      } else {\n        if (!noLog && code) writeLogFile()\n        reallyExit()\n      }\n    })\n    rollbacks.length = 0\n  } else if (code && !noLog) {\n    writeLogFile()\n  } else {\n    reallyExit()\n  }\n\n  function reallyExit (er) {\n    if (er && !code) code = typeof er.errno === 'number' ? er.errno : 1\n\n    itWorked = !code\n\n    // Exit directly -- nothing in the CLI should still be running in the\n    // background at this point, and this makes sure anything left dangling\n    // for whatever reason gets thrown away, instead of leaving the CLI open\n    //\n    // Commands that expect long-running actions should just delay `cb()`\n    process.stdout.write('', () => {\n      process.exit(code)\n    })\n  }\n}\n\nfunction errorHandler (er) {\n  log.disableProgress()\n  if (!npm.config || !npm.config.loaded) {\n    // logging won't work unless we pretend that it's ready\n    er = er || new Error('Exit prior to config file resolving.')\n    console.error(er.stack || er.message)\n  }\n\n  if (cbCalled) {\n    er = er || new Error('Callback called more than once.')\n  }\n\n  cbCalled = true\n  if (!er) return exit(0)\n  if (typeof er === 'string') {\n    log.error('', er)\n    return exit(1, true)\n  } else if (!(er instanceof Error)) {\n    log.error('weird error', er)\n    return exit(1, true)\n  }\n\n  var m = er.code || er.message.match(/^(?:Error: )?(E[A-Z]+)/)\n  if (m && !er.code) {\n    er.code = m\n  }\n\n  ;[\n    'type',\n    'stack',\n    'statusCode',\n    'pkgid'\n  ].forEach(function (k) {\n    var v = er[k]\n    if (!v) return\n    log.verbose(k, v)\n  })\n\n  log.verbose('cwd', process.cwd())\n\n  var os = require('os')\n  log.verbose('', os.type() + ' ' + os.release())\n  log.verbose('argv', process.argv.map(JSON.stringify).join(' '))\n  log.verbose('node', process.version)\n  log.verbose('npm ', 'v' + npm.version)\n\n  ;[\n    'file',\n    'path',\n    'code',\n    'errno',\n    'syscall'\n  ].forEach(function (k) {\n    var v = er[k]\n    if (v) log.error(k, v)\n  })\n\n  var msg = errorMessage(er)\n  msg.summary.concat(msg.detail).forEach(function (errline) {\n    log.error.apply(log, errline)\n  })\n  if (npm.config.get('json')) {\n    var error = {\n      error: {\n        code: er.code,\n        summary: messageText(msg.summary),\n        detail: messageText(msg.detail)\n      }\n    }\n    console.log(JSON.stringify(error, null, 2))\n  }\n\n  exit(typeof er.errno === 'number' ? er.errno : 1)\n}\n\nfunction messageText (msg) {\n  return msg.map(function (line) {\n    return line.slice(1).join(' ')\n  }).join('\\n')\n}\n\nfunction writeLogFile () {\n  if (wroteLogFile) return\n\n  var os = require('os')\n\n  try {\n    mkdirp.sync(path.resolve(npm.config.get('cache'), '_logs'))\n    var logOutput = ''\n    log.record.forEach(function (m) {\n      var pref = [m.id, m.level]\n      if (m.prefix) pref.push(m.prefix)\n      pref = pref.join(' ')\n\n      m.message.trim().split(/\\r?\\n/).map(function (line) {\n        return (pref + ' ' + line).trim()\n      }).forEach(function (line) {\n        logOutput += line + os.EOL\n      })\n    })\n    writeFileAtomic.sync(getLogFile(), logOutput)\n\n    // truncate once it's been written.\n    log.record.length = 0\n    wroteLogFile = true\n  } catch (ex) {\n\n  }\n}\n"]}
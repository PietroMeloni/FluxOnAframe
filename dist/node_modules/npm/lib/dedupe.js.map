{"version":3,"sources":["../../../../node_modules/npm/lib/dedupe.js"],"names":["util","require","path","validate","without","asyncMap","chain","npa","log","npm","Installer","findRequirement","earliestInstallable","checkPermissions","decomposeActions","loadExtraneous","computeMetadata","sortActions","moduleName","packageId","childPath","usage","getRequested","module","exports","dedupe","Deduper","args","cb","arguments","where","resolve","dir","dryrun","command","match","config","get","set","run","call","noPackageJsonOk","topLevelLifecycles","inherits","prototype","loadIdealTree","silly","self","newTracker","progress","cloneCurrentTreeToIdealTree","finishTracker","next","idealTree","loadAllDepsIntoIdealTree","andComputeMetadata","tree","generateActionsToTake","hoistChildren","differences","todo","move","node","hoistTo","diff","parent","children","push","fromPath","filter","action","length","moveRemainingChildren","forEach","child","remove","done","remove_","Set","seen","has","add","hoistChildren_","fromBundle","package","_inBundle","better"],"mappings":"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","file":"dedupe.js","sourcesContent":["var util = require('util')\nvar path = require('path')\nvar validate = require('aproba')\nvar without = require('lodash.without')\nvar asyncMap = require('slide').asyncMap\nvar chain = require('slide').chain\nvar npa = require('npm-package-arg')\nvar log = require('npmlog')\nvar npm = require('./npm.js')\nvar Installer = require('./install.js').Installer\nvar findRequirement = require('./install/deps.js').findRequirement\nvar earliestInstallable = require('./install/deps.js').earliestInstallable\nvar checkPermissions = require('./install/check-permissions.js')\nvar decomposeActions = require('./install/decompose-actions.js')\nvar loadExtraneous = require('./install/deps.js').loadExtraneous\nvar computeMetadata = require('./install/deps.js').computeMetadata\nvar sortActions = require('./install/diff-trees.js').sortActions\nvar moduleName = require('./utils/module-name.js')\nvar packageId = require('./utils/package-id.js')\nvar childPath = require('./utils/child-path.js')\nvar usage = require('./utils/usage')\nvar getRequested = require('./install/get-requested.js')\n\nmodule.exports = dedupe\nmodule.exports.Deduper = Deduper\n\ndedupe.usage = usage(\n  'dedupe',\n  'npm dedupe'\n)\n\nfunction dedupe (args, cb) {\n  validate('AF', arguments)\n  // the /path/to/node_modules/..\n  var where = path.resolve(npm.dir, '..')\n  var dryrun = false\n  if (npm.command.match(/^find/)) dryrun = true\n  if (npm.config.get('dry-run')) dryrun = true\n  if (dryrun && !npm.config.get('json')) npm.config.set('parseable', true)\n\n  new Deduper(where, dryrun).run(cb)\n}\n\nfunction Deduper (where, dryrun) {\n  validate('SB', arguments)\n  Installer.call(this, where, dryrun, [])\n  this.noPackageJsonOk = true\n  this.topLevelLifecycles = false\n}\nutil.inherits(Deduper, Installer)\n\nDeduper.prototype.loadIdealTree = function (cb) {\n  validate('F', arguments)\n  log.silly('install', 'loadIdealTree')\n\n  var self = this\n  chain([\n    [this.newTracker(this.progress.loadIdealTree, 'cloneCurrentTree')],\n    [this, this.cloneCurrentTreeToIdealTree],\n    [this, this.finishTracker, 'cloneCurrentTree'],\n\n    [this.newTracker(this.progress.loadIdealTree, 'loadAllDepsIntoIdealTree', 10)],\n    [ function (next) {\n      loadExtraneous(self.idealTree, self.progress.loadAllDepsIntoIdealTree, next)\n    } ],\n    [this, this.finishTracker, 'loadAllDepsIntoIdealTree'],\n\n    [this, andComputeMetadata(this.idealTree)]\n  ], cb)\n}\n\nfunction andComputeMetadata (tree) {\n  return function (next) {\n    next(null, computeMetadata(tree))\n  }\n}\n\nDeduper.prototype.generateActionsToTake = function (cb) {\n  validate('F', arguments)\n  log.silly('dedupe', 'generateActionsToTake')\n  chain([\n    [this.newTracker(log, 'hoist', 1)],\n    [hoistChildren, this.idealTree, this.differences],\n    [this, this.finishTracker, 'hoist'],\n    [this.newTracker(log, 'sort-actions', 1)],\n    [this, function (next) {\n      this.differences = sortActions(this.differences)\n      next()\n    }],\n    [this, this.finishTracker, 'sort-actions'],\n    [checkPermissions, this.differences],\n    [decomposeActions, this.differences, this.todo]\n  ], cb)\n}\n\nfunction move (node, hoistTo, diff) {\n  node.parent.children = without(node.parent.children, node)\n  hoistTo.children.push(node)\n  node.fromPath = node.path\n  node.path = childPath(hoistTo.path, node)\n  node.parent = hoistTo\n  if (!diff.filter(function (action) { return action[0] === 'move' && action[1] === node }).length) {\n    diff.push(['move', node])\n  }\n}\n\nfunction moveRemainingChildren (node, diff) {\n  node.children.forEach(function (child) {\n    move(child, node, diff)\n    moveRemainingChildren(child, diff)\n  })\n}\n\nfunction remove (child, diff, done) {\n  remove_(child, diff, new Set(), done)\n}\n\nfunction remove_ (child, diff, seen, done) {\n  if (seen.has(child)) return done()\n  seen.add(child)\n  diff.push(['remove', child])\n  child.parent.children = without(child.parent.children, child)\n  asyncMap(child.children, function (child, next) {\n    remove_(child, diff, seen, next)\n  }, done)\n}\n\nfunction hoistChildren (tree, diff, next) {\n  hoistChildren_(tree, diff, new Set(), next)\n}\n\nfunction hoistChildren_ (tree, diff, seen, next) {\n  validate('OAOF', arguments)\n  if (seen.has(tree)) return next()\n  seen.add(tree)\n  asyncMap(tree.children, function (child, done) {\n    if (!tree.parent || child.fromBundle || child.package._inBundle) return hoistChildren_(child, diff, seen, done)\n    var better = findRequirement(tree.parent, moduleName(child), getRequested(child) || npa(packageId(child)))\n    if (better) {\n      return chain([\n        [remove, child, diff],\n        [andComputeMetadata(tree)]\n      ], done)\n    }\n    var hoistTo = earliestInstallable(tree, tree.parent, child.package, log)\n    if (hoistTo) {\n      move(child, hoistTo, diff)\n      chain([\n        [andComputeMetadata(hoistTo)],\n        [hoistChildren_, child, diff, seen],\n        [ function (next) {\n          moveRemainingChildren(child, diff)\n          next()\n        } ]\n      ], done)\n    } else {\n      done()\n    }\n  }, next)\n}\n"]}
'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _utils = require('./utils');

var _internal = require('./-internal');

var _then2 = require('./then');

var _then3 = _interopRequireDefault(_then2);

var _promise = require('./promise');

var _promise2 = _interopRequireDefault(_promise);

var _resolve = require('./promise/resolve');

var _resolve2 = _interopRequireDefault(_resolve);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function validationError() {
  return new Error('Array Methods must be provided an Array');
};

var Enumerator = function () {
  function Enumerator(Constructor, input) {
    _classCallCheck(this, Enumerator);

    this._instanceConstructor = Constructor;
    this.promise = new Constructor(_internal.noop);

    if (!this.promise[_internal.PROMISE_ID]) {
      (0, _internal.makePromise)(this.promise);
    }

    if ((0, _utils.isArray)(input)) {
      this.length = input.length;
      this._remaining = input.length;

      this._result = new Array(this.length);

      if (this.length === 0) {
        (0, _internal.fulfill)(this.promise, this._result);
      } else {
        this.length = this.length || 0;
        this._enumerate(input);
        if (this._remaining === 0) {
          (0, _internal.fulfill)(this.promise, this._result);
        }
      }
    } else {
      (0, _internal.reject)(this.promise, validationError());
    }
  }

  _createClass(Enumerator, [{
    key: '_enumerate',
    value: function _enumerate(input) {
      for (var i = 0; this._state === _internal.PENDING && i < input.length; i++) {
        this._eachEntry(input[i], i);
      }
    }
  }, {
    key: '_eachEntry',
    value: function _eachEntry(entry, i) {
      var c = this._instanceConstructor;
      var resolve = c.resolve;


      if (resolve === _resolve2.default) {
        var _then = (0, _internal.getThen)(entry);

        if (_then === _then3.default && entry._state !== _internal.PENDING) {
          this._settledAt(entry._state, i, entry._result);
        } else if (typeof _then !== 'function') {
          this._remaining--;
          this._result[i] = entry;
        } else if (c === _promise2.default) {
          var promise = new c(_internal.noop);
          (0, _internal.handleMaybeThenable)(promise, entry, _then);
          this._willSettleAt(promise, i);
        } else {
          this._willSettleAt(new c(function (resolve) {
            return resolve(entry);
          }), i);
        }
      } else {
        this._willSettleAt(resolve(entry), i);
      }
    }
  }, {
    key: '_settledAt',
    value: function _settledAt(state, i, value) {
      var promise = this.promise;


      if (promise._state === _internal.PENDING) {
        this._remaining--;

        if (state === _internal.REJECTED) {
          (0, _internal.reject)(promise, value);
        } else {
          this._result[i] = value;
        }
      }

      if (this._remaining === 0) {
        (0, _internal.fulfill)(promise, this._result);
      }
    }
  }, {
    key: '_willSettleAt',
    value: function _willSettleAt(promise, i) {
      var enumerator = this;

      (0, _internal.subscribe)(promise, undefined, function (value) {
        return enumerator._settledAt(_internal.FULFILLED, i, value);
      }, function (reason) {
        return enumerator._settledAt(_internal.REJECTED, i, reason);
      });
    }
  }]);

  return Enumerator;
}();

exports.default = Enumerator;
;
//# sourceMappingURL=enumerator.js.map
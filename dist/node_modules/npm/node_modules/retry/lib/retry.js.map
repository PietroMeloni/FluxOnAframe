{"version":3,"sources":["../../../../../../node_modules/npm/node_modules/retry/lib/retry.js"],"names":["RetryOperation","require","exports","operation","options","timeouts","forever","unref","maxRetryTime","Array","concat","opts","retries","factor","minTimeout","maxTimeout","Infinity","randomize","key","Error","i","push","createTimeout","length","sort","a","b","attempt","random","Math","timeout","round","pow","min","wrap","obj","methods","method","original","retryWrapper","op","args","prototype","slice","call","arguments","callback","pop","err","retry","mainError","apply","bind"],"mappings":"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","file":"retry.js","sourcesContent":["var RetryOperation = require('./retry_operation');\n\nexports.operation = function(options) {\n  var timeouts = exports.timeouts(options);\n  return new RetryOperation(timeouts, {\n      forever: options && options.forever,\n      unref: options && options.unref,\n      maxRetryTime: options && options.maxRetryTime\n  });\n};\n\nexports.timeouts = function(options) {\n  if (options instanceof Array) {\n    return [].concat(options);\n  }\n\n  var opts = {\n    retries: 10,\n    factor: 2,\n    minTimeout: 1 * 1000,\n    maxTimeout: Infinity,\n    randomize: false\n  };\n  for (var key in options) {\n    opts[key] = options[key];\n  }\n\n  if (opts.minTimeout > opts.maxTimeout) {\n    throw new Error('minTimeout is greater than maxTimeout');\n  }\n\n  var timeouts = [];\n  for (var i = 0; i < opts.retries; i++) {\n    timeouts.push(this.createTimeout(i, opts));\n  }\n\n  if (options && options.forever && !timeouts.length) {\n    timeouts.push(this.createTimeout(i, opts));\n  }\n\n  // sort the array numerically ascending\n  timeouts.sort(function(a,b) {\n    return a - b;\n  });\n\n  return timeouts;\n};\n\nexports.createTimeout = function(attempt, opts) {\n  var random = (opts.randomize)\n    ? (Math.random() + 1)\n    : 1;\n\n  var timeout = Math.round(random * opts.minTimeout * Math.pow(opts.factor, attempt));\n  timeout = Math.min(timeout, opts.maxTimeout);\n\n  return timeout;\n};\n\nexports.wrap = function(obj, options, methods) {\n  if (options instanceof Array) {\n    methods = options;\n    options = null;\n  }\n\n  if (!methods) {\n    methods = [];\n    for (var key in obj) {\n      if (typeof obj[key] === 'function') {\n        methods.push(key);\n      }\n    }\n  }\n\n  for (var i = 0; i < methods.length; i++) {\n    var method   = methods[i];\n    var original = obj[method];\n\n    obj[method] = function retryWrapper(original) {\n      var op       = exports.operation(options);\n      var args     = Array.prototype.slice.call(arguments, 1);\n      var callback = args.pop();\n\n      args.push(function(err) {\n        if (op.retry(err)) {\n          return;\n        }\n        if (err) {\n          arguments[0] = op.mainError();\n        }\n        callback.apply(this, arguments);\n      });\n\n      op.attempt(function() {\n        original.apply(obj, args);\n      });\n    }.bind(obj, original);\n    obj[method].options = options;\n  }\n};\n"]}
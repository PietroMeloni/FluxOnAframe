{"version":3,"sources":["../../../../../../node_modules/npm/node_modules/hawk/lib/client.js"],"names":["Url","require","Hoek","Cryptiles","Crypto","Utils","internals","exports","header","uri","method","options","result","field","artifacts","err","timestamp","nowSecs","localtimeOffsetMsec","credentials","id","key","algorithm","algorithms","indexOf","parse","ts","nonce","randomString","resource","pathname","search","host","hostname","port","protocol","hash","ext","app","dlg","payload","calculatePayloadHash","contentType","mac","calculateMac","hasExt","undefined","escapeHeaderAttribute","authenticate","res","clone","headers","wwwAttributes","parseAuthorizationHeader","Error","tsm","calculateTsMac","required","attributes","calculatedHash","getBewit","ttlSec","now","exp","Math","floor","bewit","base64urlEncode","message"],"mappings":"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","file":"client.js","sourcesContent":["// Load modules\r\n\r\nvar Url = require('url');\r\nvar Hoek = require('hoek');\r\nvar Cryptiles = require('cryptiles');\r\nvar Crypto = require('./crypto');\r\nvar Utils = require('./utils');\r\n\r\n\r\n// Declare internals\r\n\r\nvar internals = {};\r\n\r\n\r\n// Generate an Authorization header for a given request\r\n\r\n/*\r\n    uri: 'http://example.com/resource?a=b' or object from Url.parse()\r\n    method: HTTP verb (e.g. 'GET', 'POST')\r\n    options: {\r\n\r\n        // Required\r\n\r\n        credentials: {\r\n            id: 'dh37fgj492je',\r\n            key: 'aoijedoaijsdlaksjdl',\r\n            algorithm: 'sha256'                                 // 'sha1', 'sha256'\r\n        },\r\n\r\n        // Optional\r\n\r\n        ext: 'application-specific',                        // Application specific data sent via the ext attribute\r\n        timestamp: Date.now(),                              // A pre-calculated timestamp\r\n        nonce: '2334f34f',                                  // A pre-generated nonce\r\n        localtimeOffsetMsec: 400,                           // Time offset to sync with server time (ignored if timestamp provided)\r\n        payload: '{\"some\":\"payload\"}',                      // UTF-8 encoded string for body hash generation (ignored if hash provided)\r\n        contentType: 'application/json',                    // Payload content-type (ignored if hash provided)\r\n        hash: 'U4MKKSmiVxk37JCCrAVIjV=',                    // Pre-calculated payload hash\r\n        app: '24s23423f34dx',                               // Oz application id\r\n        dlg: '234sz34tww3sd'                                // Oz delegated-by application id\r\n    }\r\n*/\r\n\r\nexports.header = function (uri, method, options) {\r\n\r\n    var result = {\r\n        field: '',\r\n        artifacts: {}\r\n    };\r\n\r\n    // Validate inputs\r\n\r\n    if (!uri || (typeof uri !== 'string' && typeof uri !== 'object') ||\r\n        !method || typeof method !== 'string' ||\r\n        !options || typeof options !== 'object') {\r\n\r\n        result.err = 'Invalid argument type';\r\n        return result;\r\n    }\r\n\r\n    // Application time\r\n\r\n    var timestamp = options.timestamp || Utils.nowSecs(options.localtimeOffsetMsec);\r\n\r\n    // Validate credentials\r\n\r\n    var credentials = options.credentials;\r\n    if (!credentials ||\r\n        !credentials.id ||\r\n        !credentials.key ||\r\n        !credentials.algorithm) {\r\n\r\n        result.err = 'Invalid credential object';\r\n        return result;\r\n    }\r\n\r\n    if (Crypto.algorithms.indexOf(credentials.algorithm) === -1) {\r\n        result.err = 'Unknown algorithm';\r\n        return result;\r\n    }\r\n\r\n    // Parse URI\r\n\r\n    if (typeof uri === 'string') {\r\n        uri = Url.parse(uri);\r\n    }\r\n\r\n    // Calculate signature\r\n\r\n    var artifacts = {\r\n        ts: timestamp,\r\n        nonce: options.nonce || Cryptiles.randomString(6),\r\n        method: method,\r\n        resource: uri.pathname + (uri.search || ''),                            // Maintain trailing '?'\r\n        host: uri.hostname,\r\n        port: uri.port || (uri.protocol === 'http:' ? 80 : 443),\r\n        hash: options.hash,\r\n        ext: options.ext,\r\n        app: options.app,\r\n        dlg: options.dlg\r\n    };\r\n\r\n    result.artifacts = artifacts;\r\n\r\n    // Calculate payload hash\r\n\r\n    if (!artifacts.hash &&\r\n        (options.payload || options.payload === '')) {\r\n\r\n        artifacts.hash = Crypto.calculatePayloadHash(options.payload, credentials.algorithm, options.contentType);\r\n    }\r\n\r\n    var mac = Crypto.calculateMac('header', credentials, artifacts);\r\n\r\n    // Construct header\r\n\r\n    var hasExt = artifacts.ext !== null && artifacts.ext !== undefined && artifacts.ext !== '';       // Other falsey values allowed\r\n    var header = 'Hawk id=\"' + credentials.id +\r\n                 '\", ts=\"' + artifacts.ts +\r\n                 '\", nonce=\"' + artifacts.nonce +\r\n                 (artifacts.hash ? '\", hash=\"' + artifacts.hash : '') +\r\n                 (hasExt ? '\", ext=\"' + Hoek.escapeHeaderAttribute(artifacts.ext) : '') +\r\n                 '\", mac=\"' + mac + '\"';\r\n\r\n    if (artifacts.app) {\r\n        header += ', app=\"' + artifacts.app +\r\n                  (artifacts.dlg ? '\", dlg=\"' + artifacts.dlg : '') + '\"';\r\n    }\r\n\r\n    result.field = header;\r\n\r\n    return result;\r\n};\r\n\r\n\r\n// Validate server response\r\n\r\n/*\r\n    res:        node's response object\r\n    artifacts:  object received from header().artifacts\r\n    options: {\r\n        payload:    optional payload received\r\n        required:   specifies if a Server-Authorization header is required. Defaults to 'false'\r\n    }\r\n*/\r\n\r\nexports.authenticate = function (res, credentials, artifacts, options) {\r\n\r\n    artifacts = Hoek.clone(artifacts);\r\n    options = options || {};\r\n\r\n    if (res.headers['www-authenticate']) {\r\n\r\n        // Parse HTTP WWW-Authenticate header\r\n\r\n        var wwwAttributes = Utils.parseAuthorizationHeader(res.headers['www-authenticate'], ['ts', 'tsm', 'error']);\r\n        if (wwwAttributes instanceof Error) {\r\n            return false;\r\n        }\r\n\r\n        // Validate server timestamp (not used to update clock since it is done via the SNPT client)\r\n\r\n        if (wwwAttributes.ts) {\r\n            var tsm = Crypto.calculateTsMac(wwwAttributes.ts, credentials);\r\n            if (tsm !== wwwAttributes.tsm) {\r\n                return false;\r\n            }\r\n        }\r\n    }\r\n\r\n    // Parse HTTP Server-Authorization header\r\n\r\n    if (!res.headers['server-authorization'] &&\r\n        !options.required) {\r\n\r\n        return true;\r\n    }\r\n\r\n    var attributes = Utils.parseAuthorizationHeader(res.headers['server-authorization'], ['mac', 'ext', 'hash']);\r\n    if (attributes instanceof Error) {\r\n        return false;\r\n    }\r\n\r\n    artifacts.ext = attributes.ext;\r\n    artifacts.hash = attributes.hash;\r\n\r\n    var mac = Crypto.calculateMac('response', credentials, artifacts);\r\n    if (mac !== attributes.mac) {\r\n        return false;\r\n    }\r\n\r\n    if (!options.payload &&\r\n        options.payload !== '') {\r\n\r\n        return true;\r\n    }\r\n\r\n    if (!attributes.hash) {\r\n        return false;\r\n    }\r\n\r\n    var calculatedHash = Crypto.calculatePayloadHash(options.payload, credentials.algorithm, res.headers['content-type']);\r\n    return (calculatedHash === attributes.hash);\r\n};\r\n\r\n\r\n// Generate a bewit value for a given URI\r\n\r\n/*\r\n    uri: 'http://example.com/resource?a=b' or object from Url.parse()\r\n    options: {\r\n\r\n        // Required\r\n\r\n        credentials: {\r\n            id: 'dh37fgj492je',\r\n            key: 'aoijedoaijsdlaksjdl',\r\n            algorithm: 'sha256'                             // 'sha1', 'sha256'\r\n        },\r\n        ttlSec: 60 * 60,                                    // TTL in seconds\r\n\r\n        // Optional\r\n\r\n        ext: 'application-specific',                        // Application specific data sent via the ext attribute\r\n        localtimeOffsetMsec: 400                            // Time offset to sync with server time\r\n    };\r\n*/\r\n\r\nexports.getBewit = function (uri, options) {\r\n\r\n    // Validate inputs\r\n\r\n    if (!uri ||\r\n        (typeof uri !== 'string' && typeof uri !== 'object') ||\r\n        !options ||\r\n        typeof options !== 'object' ||\r\n        !options.ttlSec) {\r\n\r\n        return '';\r\n    }\r\n\r\n    options.ext = (options.ext === null || options.ext === undefined ? '' : options.ext);       // Zero is valid value\r\n\r\n    // Application time\r\n\r\n    var now = Utils.now(options.localtimeOffsetMsec);\r\n\r\n    // Validate credentials\r\n\r\n    var credentials = options.credentials;\r\n    if (!credentials ||\r\n        !credentials.id ||\r\n        !credentials.key ||\r\n        !credentials.algorithm) {\r\n\r\n        return '';\r\n    }\r\n\r\n    if (Crypto.algorithms.indexOf(credentials.algorithm) === -1) {\r\n        return '';\r\n    }\r\n\r\n    // Parse URI\r\n\r\n    if (typeof uri === 'string') {\r\n        uri = Url.parse(uri);\r\n    }\r\n\r\n    // Calculate signature\r\n\r\n    var exp = Math.floor(now / 1000) + options.ttlSec;\r\n    var mac = Crypto.calculateMac('bewit', credentials, {\r\n        ts: exp,\r\n        nonce: '',\r\n        method: 'GET',\r\n        resource: uri.pathname + (uri.search || ''),                            // Maintain trailing '?'\r\n        host: uri.hostname,\r\n        port: uri.port || (uri.protocol === 'http:' ? 80 : 443),\r\n        ext: options.ext\r\n    });\r\n\r\n    // Construct bewit: id\\exp\\mac\\ext\r\n\r\n    var bewit = credentials.id + '\\\\' + exp + '\\\\' + mac + '\\\\' + options.ext;\r\n    return Hoek.base64urlEncode(bewit);\r\n};\r\n\r\n\r\n// Generate an authorization string for a message\r\n\r\n/*\r\n    host: 'example.com',\r\n    port: 8000,\r\n    message: '{\"some\":\"payload\"}',                          // UTF-8 encoded string for body hash generation\r\n    options: {\r\n\r\n        // Required\r\n\r\n        credentials: {\r\n            id: 'dh37fgj492je',\r\n            key: 'aoijedoaijsdlaksjdl',\r\n            algorithm: 'sha256'                             // 'sha1', 'sha256'\r\n        },\r\n\r\n        // Optional\r\n\r\n        timestamp: Date.now(),                              // A pre-calculated timestamp\r\n        nonce: '2334f34f',                                  // A pre-generated nonce\r\n        localtimeOffsetMsec: 400,                           // Time offset to sync with server time (ignored if timestamp provided)\r\n    }\r\n*/\r\n\r\nexports.message = function (host, port, message, options) {\r\n\r\n    // Validate inputs\r\n\r\n    if (!host || typeof host !== 'string' ||\r\n        !port || typeof port !== 'number' ||\r\n        message === null || message === undefined || typeof message !== 'string' ||\r\n        !options || typeof options !== 'object') {\r\n\r\n        return null;\r\n    }\r\n\r\n    // Application time\r\n\r\n    var timestamp = options.timestamp || Utils.nowSecs(options.localtimeOffsetMsec);\r\n\r\n    // Validate credentials\r\n\r\n    var credentials = options.credentials;\r\n    if (!credentials ||\r\n        !credentials.id ||\r\n        !credentials.key ||\r\n        !credentials.algorithm) {\r\n\r\n        // Invalid credential object\r\n        return null;\r\n    }\r\n\r\n    if (Crypto.algorithms.indexOf(credentials.algorithm) === -1) {\r\n        return null;\r\n    }\r\n\r\n    // Calculate signature\r\n\r\n    var artifacts = {\r\n        ts: timestamp,\r\n        nonce: options.nonce || Cryptiles.randomString(6),\r\n        host: host,\r\n        port: port,\r\n        hash: Crypto.calculatePayloadHash(message, credentials.algorithm)\r\n    };\r\n\r\n    // Construct authorization\r\n\r\n    var result = {\r\n        id: credentials.id,\r\n        ts: artifacts.ts,\r\n        nonce: artifacts.nonce,\r\n        hash: artifacts.hash,\r\n        mac: Crypto.calculateMac('message', credentials, artifacts)\r\n    };\r\n\r\n    return result;\r\n};\r\n\r\n\r\n\r\n"]}
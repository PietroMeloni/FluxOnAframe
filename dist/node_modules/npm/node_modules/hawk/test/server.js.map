{"version":3,"sources":["../../../../../../node_modules/npm/node_modules/hawk/test/server.js"],"names":["Url","require","Code","Hawk","Hoek","Lab","internals","lab","exports","script","describe","experiment","it","test","expect","credentialsFunc","id","callback","credentials","key","algorithm","user","done","req","method","url","host","port","authorization","server","authenticate","localtimeOffsetMsec","utils","now","err","artifacts","to","not","exist","equal","headers","payload","output","message","header","ts","match","parseInt","be","within","res","client","memoryCache","options","nonceFunc","nonce","Error","credentials1","artifacts1","credentials2","artifacts2","reqSteve","reqBob","credentialsFuncion","isMissing","some","resource","hash","ext","mac","contentType","crypto","calculatePayloadHash","long","i","authenticateBewit","bewit","statusCode","auth","authenticateMessage","nonceCallback","timestampSkewSec","errFunc","creds","clone","authenticatePayloadHash"],"mappings":"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","file":"server.js","sourcesContent":["// Load modules\r\n\r\nvar Url = require('url');\r\nvar Code = require('code');\r\nvar Hawk = require('../lib');\r\nvar Hoek = require('hoek');\r\nvar Lab = require('lab');\r\n\r\n\r\n// Declare internals\r\n\r\nvar internals = {};\r\n\r\n\r\n// Test shortcuts\r\n\r\nvar lab = exports.lab = Lab.script();\r\nvar describe = lab.experiment;\r\nvar it = lab.test;\r\nvar expect = Code.expect;\r\n\r\n\r\ndescribe('Server', function () {\r\n\r\n    var credentialsFunc = function (id, callback) {\r\n\r\n        var credentials = {\r\n            id: id,\r\n            key: 'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn',\r\n            algorithm: (id === '1' ? 'sha1' : 'sha256'),\r\n            user: 'steve'\r\n        };\r\n\r\n        return callback(null, credentials);\r\n    };\r\n\r\n    describe('authenticate()', function () {\r\n\r\n        it('parses a valid authentication header (sha1)', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"1\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"zy79QQ5/EYFmQqutVnYb73gAc/U=\", ext=\"hello\"'\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.not.exist();\r\n                expect(credentials.user).to.equal('steve');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('parses a valid authentication header (sha256)', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/1?b=1&a=2',\r\n                host: 'example.com',\r\n                port: 8000,\r\n                authorization: 'Hawk id=\"dh37fgj492je\", ts=\"1353832234\", nonce=\"j4h3g2\", mac=\"m8r1rHbXN6NgO+KIIhjO7sFRyd78RNGVUwehe8Cp2dU=\", ext=\"some-app-data\"'\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 1353832234000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.not.exist();\r\n                expect(credentials.user).to.equal('steve');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('parses a valid authentication header (host override)', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                headers: {\r\n                    host: 'example1.com:8080',\r\n                    authorization: 'Hawk id=\"1\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"zy79QQ5/EYFmQqutVnYb73gAc/U=\", ext=\"hello\"'\r\n                }\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { host: 'example.com', localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.not.exist();\r\n                expect(credentials.user).to.equal('steve');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('parses a valid authentication header (host port override)', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                headers: {\r\n                    host: 'example1.com:80',\r\n                    authorization: 'Hawk id=\"1\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"zy79QQ5/EYFmQqutVnYb73gAc/U=\", ext=\"hello\"'\r\n                }\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { host: 'example.com', port: 8080, localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.not.exist();\r\n                expect(credentials.user).to.equal('steve');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('parses a valid authentication header (POST with payload)', function (done) {\r\n\r\n            var req = {\r\n                method: 'POST',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"123456\", ts=\"1357926341\", nonce=\"1AwuJD\", hash=\"qAiXIVv+yjDATneWxZP2YCTa9aHRgQdnH9b3Wc+o3dg=\", ext=\"some-app-data\", mac=\"UeYcj5UoTVaAWXNvJfLVia7kU3VabxCqrccXP8sUGC4=\"'\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 1357926341000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.not.exist();\r\n                expect(credentials.user).to.equal('steve');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on missing hash', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/1?b=1&a=2',\r\n                host: 'example.com',\r\n                port: 8000,\r\n                authorization: 'Hawk id=\"dh37fgj492je\", ts=\"1353832234\", nonce=\"j4h3g2\", mac=\"m8r1rHbXN6NgO+KIIhjO7sFRyd78RNGVUwehe8Cp2dU=\", ext=\"some-app-data\"'\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { payload: 'body', localtimeOffsetMsec: 1353832234000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.equal('Missing required payload hash');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on a stale timestamp', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"123456\", ts=\"1362337299\", nonce=\"UzmxSs\", ext=\"some-app-data\", mac=\"wnNUxchvvryMH2RxckTdZ/gY3ijzvccx4keVvELC61w=\"'\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.equal('Stale timestamp');\r\n                var header = err.output.headers['WWW-Authenticate'];\r\n                var ts = header.match(/^Hawk ts\\=\\\"(\\d+)\\\"\\, tsm\\=\\\"([^\\\"]+)\\\"\\, error=\\\"Stale timestamp\\\"$/);\r\n                var now = Hawk.utils.now();\r\n                expect(parseInt(ts[1], 10) * 1000).to.be.within(now - 1000, now + 1000);\r\n\r\n                var res = {\r\n                    headers: {\r\n                        'www-authenticate': header\r\n                    }\r\n                };\r\n\r\n                expect(Hawk.client.authenticate(res, credentials, artifacts)).to.equal(true);\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on a replay', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"123\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"bXx7a7p1h9QYQNZ8x7QhvDQym8ACgab4m3lVSFn4DBw=\", ext=\"hello\"'\r\n            };\r\n\r\n            var memoryCache = {};\r\n            var options = {\r\n                localtimeOffsetMsec: 1353788437000 - Hawk.utils.now(),\r\n                nonceFunc: function (key, nonce, ts, callback) {\r\n\r\n                    if (memoryCache[key + nonce]) {\r\n                        return callback(new Error());\r\n                    }\r\n\r\n                    memoryCache[key + nonce] = true;\r\n                    return callback();\r\n                }\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, options, function (err, credentials1, artifacts1) {\r\n\r\n                expect(err).to.not.exist();\r\n                expect(credentials1.user).to.equal('steve');\r\n\r\n                Hawk.server.authenticate(req, credentialsFunc, options, function (err, credentials2, artifacts2) {\r\n\r\n                    expect(err).to.exist();\r\n                    expect(err.output.payload.message).to.equal('Invalid nonce');\r\n                    done();\r\n                });\r\n            });\r\n        });\r\n\r\n        it('does not error on nonce collision if keys differ', function (done) {\r\n\r\n            var reqSteve = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"123\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"bXx7a7p1h9QYQNZ8x7QhvDQym8ACgab4m3lVSFn4DBw=\", ext=\"hello\"'\r\n            };\r\n\r\n            var reqBob = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"456\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"LXfmTnRzrLd9TD7yfH+4se46Bx6AHyhpM94hLCiNia4=\", ext=\"hello\"'\r\n            };\r\n\r\n            var credentialsFuncion = function (id, callback) {\r\n\r\n                var credentials = {\r\n                    '123': {\r\n                        id: id,\r\n                        key: 'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn',\r\n                        algorithm: (id === '1' ? 'sha1' : 'sha256'),\r\n                        user: 'steve'\r\n                    },\r\n                    '456': {\r\n                        id: id,\r\n                        key: 'xrunpaw3489ruxnpa98w4rxnwerxhqb98rpaxn39848',\r\n                        algorithm: (id === '1' ? 'sha1' : 'sha256'),\r\n                        user: 'bob'\r\n                    }\r\n                };\r\n\r\n                return callback(null, credentials[id]);\r\n            };\r\n\r\n            var memoryCache = {};\r\n            var options = {\r\n                localtimeOffsetMsec: 1353788437000 - Hawk.utils.now(),\r\n                nonceFunc: function (key, nonce, ts, callback) {\r\n\r\n                    if (memoryCache[key + nonce]) {\r\n                        return callback(new Error());\r\n                    }\r\n\r\n                    memoryCache[key + nonce] = true;\r\n                    return callback();\r\n                }\r\n            };\r\n\r\n            Hawk.server.authenticate(reqSteve, credentialsFuncion, options, function (err, credentials1, artifacts1) {\r\n\r\n                expect(err).to.not.exist();\r\n                expect(credentials1.user).to.equal('steve');\r\n\r\n                Hawk.server.authenticate(reqBob, credentialsFuncion, options, function (err, credentials2, artifacts2) {\r\n\r\n                    expect(err).to.not.exist();\r\n                    expect(credentials2.user).to.equal('bob');\r\n                    done();\r\n                });\r\n            });\r\n        });\r\n\r\n        it('errors on an invalid authentication header: wrong scheme', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Basic asdasdasdasd'\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.not.exist();\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on an invalid authentication header: no scheme', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: '!@#'\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.equal('Invalid header syntax');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on an missing authorization header', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.isMissing).to.equal(true);\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on an missing host header', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                headers: {\r\n                    authorization: 'Hawk id=\"123\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=\", ext=\"hello\"'\r\n                }\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.equal('Invalid Host header');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on an missing authorization attribute (id)', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=\", ext=\"hello\"'\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.equal('Missing attributes');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on an missing authorization attribute (ts)', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"123\", nonce=\"k3j4h2\", mac=\"/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=\", ext=\"hello\"'\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.equal('Missing attributes');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on an missing authorization attribute (nonce)', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"123\", ts=\"1353788437\", mac=\"/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=\", ext=\"hello\"'\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.equal('Missing attributes');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on an missing authorization attribute (mac)', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"123\", ts=\"1353788437\", nonce=\"k3j4h2\", ext=\"hello\"'\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.equal('Missing attributes');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on an unknown authorization attribute', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"123\", ts=\"1353788437\", nonce=\"k3j4h2\", x=\"3\", mac=\"/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=\", ext=\"hello\"'\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.equal('Unknown attribute: x');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on an bad authorization header format', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"123\\\\\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=\", ext=\"hello\"'\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.equal('Bad header format');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on an bad authorization attribute value', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"\\t\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=\", ext=\"hello\"'\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.equal('Bad attribute value: id');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on an empty authorization attribute value', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=\", ext=\"hello\"'\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.equal('Bad attribute value: id');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on duplicated authorization attribute key', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"123\", id=\"456\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=\", ext=\"hello\"'\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.equal('Duplicate attribute: id');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on an invalid authorization header format', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk'\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.equal('Invalid header syntax');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on an bad host header (missing host)', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                headers: {\r\n                    host: ':8080',\r\n                    authorization: 'Hawk id=\"123\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=\", ext=\"hello\"'\r\n                }\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.equal('Invalid Host header');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on an bad host header (pad port)', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                headers: {\r\n                    host: 'example.com:something',\r\n                    authorization: 'Hawk id=\"123\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=\", ext=\"hello\"'\r\n                }\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.equal('Invalid Host header');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on credentialsFunc error', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"123\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=\", ext=\"hello\"'\r\n            };\r\n\r\n            var credentialsFuncion = function (id, callback) {\r\n\r\n                return callback(new Error('Unknown user'));\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFuncion, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.message).to.equal('Unknown user');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on credentialsFunc error (with credentials)', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"123\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=\", ext=\"hello\"'\r\n            };\r\n\r\n            var credentialsFuncion = function (id, callback) {\r\n\r\n                return callback(new Error('Unknown user'), { some: 'value' });\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFuncion, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.message).to.equal('Unknown user');\r\n                expect(credentials.some).to.equal('value');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on missing credentials', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"123\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=\", ext=\"hello\"'\r\n            };\r\n\r\n            var credentialsFuncion = function (id, callback) {\r\n\r\n                return callback(null, null);\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFuncion, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.equal('Unknown credentials');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on invalid credentials (id)', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"123\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=\", ext=\"hello\"'\r\n            };\r\n\r\n            var credentialsFuncion = function (id, callback) {\r\n\r\n                var credentials = {\r\n                    key: 'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn',\r\n                    user: 'steve'\r\n                };\r\n\r\n                return callback(null, credentials);\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFuncion, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.message).to.equal('Invalid credentials');\r\n                expect(err.output.payload.message).to.equal('An internal server error occurred');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on invalid credentials (key)', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"123\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=\", ext=\"hello\"'\r\n            };\r\n\r\n            var credentialsFuncion = function (id, callback) {\r\n\r\n                var credentials = {\r\n                    id: '23434d3q4d5345d',\r\n                    user: 'steve'\r\n                };\r\n\r\n                return callback(null, credentials);\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFuncion, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.message).to.equal('Invalid credentials');\r\n                expect(err.output.payload.message).to.equal('An internal server error occurred');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on unknown credentials algorithm', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"123\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=\", ext=\"hello\"'\r\n            };\r\n\r\n            var credentialsFuncion = function (id, callback) {\r\n\r\n                var credentials = {\r\n                    key: 'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn',\r\n                    algorithm: 'hmac-sha-0',\r\n                    user: 'steve'\r\n                };\r\n\r\n                return callback(null, credentials);\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFuncion, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.message).to.equal('Unknown algorithm');\r\n                expect(err.output.payload.message).to.equal('An internal server error occurred');\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('errors on unknown bad mac', function (done) {\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: '/resource/4?filter=a',\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"123\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"/qwS4UjfVWMcU4jlr7T/wuKe3dKijvTvSos=\", ext=\"hello\"'\r\n            };\r\n\r\n            var credentialsFuncion = function (id, callback) {\r\n\r\n                var credentials = {\r\n                    key: 'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn',\r\n                    algorithm: 'sha256',\r\n                    user: 'steve'\r\n                };\r\n\r\n                return callback(null, credentials);\r\n            };\r\n\r\n            Hawk.server.authenticate(req, credentialsFuncion, { localtimeOffsetMsec: 1353788437000 - Hawk.utils.now() }, function (err, credentials, artifacts) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.payload.message).to.equal('Bad mac');\r\n                done();\r\n            });\r\n        });\r\n    });\r\n\r\n    describe('header()', function () {\r\n\r\n        it('generates header', function (done) {\r\n\r\n            var credentials = {\r\n                id: '123456',\r\n                key: 'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn',\r\n                algorithm: 'sha256',\r\n                user: 'steve'\r\n            };\r\n\r\n            var artifacts = {\r\n                method: 'POST',\r\n                host: 'example.com',\r\n                port: '8080',\r\n                resource: '/resource/4?filter=a',\r\n                ts: '1398546787',\r\n                nonce: 'xUwusx',\r\n                hash: 'nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=',\r\n                ext: 'some-app-data',\r\n                mac: 'dvIvMThwi28J61Jc3P0ryAhuKpanU63GXdx6hkmQkJA=',\r\n                id: '123456'\r\n            };\r\n\r\n            var header = Hawk.server.header(credentials, artifacts, { payload: 'some reply', contentType: 'text/plain', ext: 'response-specific' });\r\n            expect(header).to.equal('Hawk mac=\\\"n14wVJK4cOxAytPUMc5bPezQzuJGl5n7MYXhFQgEKsE=\\\", hash=\\\"f9cDF/TDm7TkYRLnGwRMfeDzT6LixQVLvrIKhh0vgmM=\\\", ext=\\\"response-specific\\\"');\r\n            done();\r\n        });\r\n\r\n        it('generates header (empty payload)', function (done) {\r\n\r\n            var credentials = {\r\n                id: '123456',\r\n                key: 'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn',\r\n                algorithm: 'sha256',\r\n                user: 'steve'\r\n            };\r\n\r\n            var artifacts = {\r\n                method: 'POST',\r\n                host: 'example.com',\r\n                port: '8080',\r\n                resource: '/resource/4?filter=a',\r\n                ts: '1398546787',\r\n                nonce: 'xUwusx',\r\n                hash: 'nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=',\r\n                ext: 'some-app-data',\r\n                mac: 'dvIvMThwi28J61Jc3P0ryAhuKpanU63GXdx6hkmQkJA=',\r\n                id: '123456'\r\n            };\r\n\r\n            var header = Hawk.server.header(credentials, artifacts, { payload: '', contentType: 'text/plain', ext: 'response-specific' });\r\n            expect(header).to.equal('Hawk mac=\\\"i8/kUBDx0QF+PpCtW860kkV/fa9dbwEoe/FpGUXowf0=\\\", hash=\\\"q/t+NNAkQZNlq/aAD6PlexImwQTxwgT2MahfTa9XRLA=\\\", ext=\\\"response-specific\\\"');\r\n            done();\r\n        });\r\n\r\n        it('generates header (pre calculated hash)', function (done) {\r\n\r\n            var credentials = {\r\n                id: '123456',\r\n                key: 'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn',\r\n                algorithm: 'sha256',\r\n                user: 'steve'\r\n            };\r\n\r\n            var artifacts = {\r\n                method: 'POST',\r\n                host: 'example.com',\r\n                port: '8080',\r\n                resource: '/resource/4?filter=a',\r\n                ts: '1398546787',\r\n                nonce: 'xUwusx',\r\n                hash: 'nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=',\r\n                ext: 'some-app-data',\r\n                mac: 'dvIvMThwi28J61Jc3P0ryAhuKpanU63GXdx6hkmQkJA=',\r\n                id: '123456'\r\n            };\r\n\r\n            var options = { payload: 'some reply', contentType: 'text/plain', ext: 'response-specific' };\r\n            options.hash = Hawk.crypto.calculatePayloadHash(options.payload, credentials.algorithm, options.contentType);\r\n            var header = Hawk.server.header(credentials, artifacts, options);\r\n            expect(header).to.equal('Hawk mac=\\\"n14wVJK4cOxAytPUMc5bPezQzuJGl5n7MYXhFQgEKsE=\\\", hash=\\\"f9cDF/TDm7TkYRLnGwRMfeDzT6LixQVLvrIKhh0vgmM=\\\", ext=\\\"response-specific\\\"');\r\n            done();\r\n        });\r\n\r\n        it('generates header (null ext)', function (done) {\r\n\r\n            var credentials = {\r\n                id: '123456',\r\n                key: 'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn',\r\n                algorithm: 'sha256',\r\n                user: 'steve'\r\n            };\r\n\r\n            var artifacts = {\r\n                method: 'POST',\r\n                host: 'example.com',\r\n                port: '8080',\r\n                resource: '/resource/4?filter=a',\r\n                ts: '1398546787',\r\n                nonce: 'xUwusx',\r\n                hash: 'nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=',\r\n                mac: 'dvIvMThwi28J61Jc3P0ryAhuKpanU63GXdx6hkmQkJA=',\r\n                id: '123456'\r\n            };\r\n\r\n            var header = Hawk.server.header(credentials, artifacts, { payload: 'some reply', contentType: 'text/plain', ext: null });\r\n            expect(header).to.equal('Hawk mac=\\\"6PrybJTJs20jsgBw5eilXpcytD8kUbaIKNYXL+6g0ns=\\\", hash=\\\"f9cDF/TDm7TkYRLnGwRMfeDzT6LixQVLvrIKhh0vgmM=\\\"');\r\n            done();\r\n        });\r\n\r\n        it('errors on missing artifacts', function (done) {\r\n\r\n            var credentials = {\r\n                id: '123456',\r\n                key: 'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn',\r\n                algorithm: 'sha256',\r\n                user: 'steve'\r\n            };\r\n\r\n            var header = Hawk.server.header(credentials, null, { payload: 'some reply', contentType: 'text/plain', ext: 'response-specific' });\r\n            expect(header).to.equal('');\r\n            done();\r\n        });\r\n\r\n        it('errors on invalid artifacts', function (done) {\r\n\r\n            var credentials = {\r\n                id: '123456',\r\n                key: 'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn',\r\n                algorithm: 'sha256',\r\n                user: 'steve'\r\n            };\r\n\r\n            var header = Hawk.server.header(credentials, 5, { payload: 'some reply', contentType: 'text/plain', ext: 'response-specific' });\r\n            expect(header).to.equal('');\r\n            done();\r\n        });\r\n\r\n        it('errors on missing credentials', function (done) {\r\n\r\n            var artifacts = {\r\n                method: 'POST',\r\n                host: 'example.com',\r\n                port: '8080',\r\n                resource: '/resource/4?filter=a',\r\n                ts: '1398546787',\r\n                nonce: 'xUwusx',\r\n                hash: 'nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=',\r\n                ext: 'some-app-data',\r\n                mac: 'dvIvMThwi28J61Jc3P0ryAhuKpanU63GXdx6hkmQkJA=',\r\n                id: '123456'\r\n            };\r\n\r\n            var header = Hawk.server.header(null, artifacts, { payload: 'some reply', contentType: 'text/plain', ext: 'response-specific' });\r\n            expect(header).to.equal('');\r\n            done();\r\n        });\r\n\r\n        it('errors on invalid credentials (key)', function (done) {\r\n\r\n            var credentials = {\r\n                id: '123456',\r\n                algorithm: 'sha256',\r\n                user: 'steve'\r\n            };\r\n\r\n            var artifacts = {\r\n                method: 'POST',\r\n                host: 'example.com',\r\n                port: '8080',\r\n                resource: '/resource/4?filter=a',\r\n                ts: '1398546787',\r\n                nonce: 'xUwusx',\r\n                hash: 'nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=',\r\n                ext: 'some-app-data',\r\n                mac: 'dvIvMThwi28J61Jc3P0ryAhuKpanU63GXdx6hkmQkJA=',\r\n                id: '123456'\r\n            };\r\n\r\n            var header = Hawk.server.header(credentials, artifacts, { payload: 'some reply', contentType: 'text/plain', ext: 'response-specific' });\r\n            expect(header).to.equal('');\r\n            done();\r\n        });\r\n\r\n        it('errors on invalid algorithm', function (done) {\r\n\r\n            var credentials = {\r\n                id: '123456',\r\n                key: 'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn',\r\n                algorithm: 'x',\r\n                user: 'steve'\r\n            };\r\n\r\n            var artifacts = {\r\n                method: 'POST',\r\n                host: 'example.com',\r\n                port: '8080',\r\n                resource: '/resource/4?filter=a',\r\n                ts: '1398546787',\r\n                nonce: 'xUwusx',\r\n                hash: 'nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=',\r\n                ext: 'some-app-data',\r\n                mac: 'dvIvMThwi28J61Jc3P0ryAhuKpanU63GXdx6hkmQkJA=',\r\n                id: '123456'\r\n            };\r\n\r\n            var header = Hawk.server.header(credentials, artifacts, { payload: 'some reply', contentType: 'text/plain', ext: 'response-specific' });\r\n            expect(header).to.equal('');\r\n            done();\r\n        });\r\n    });\r\n\r\n    describe('authenticateBewit()', function () {\r\n\r\n        it('errors on uri too long', function (done) {\r\n\r\n            var long = '/';\r\n            for (var i = 0; i < 5000; ++i) {\r\n                long += 'x';\r\n            }\r\n\r\n            var req = {\r\n                method: 'GET',\r\n                url: long,\r\n                host: 'example.com',\r\n                port: 8080,\r\n                authorization: 'Hawk id=\"1\", ts=\"1353788437\", nonce=\"k3j4h2\", mac=\"zy79QQ5/EYFmQqutVnYb73gAc/U=\", ext=\"hello\"'\r\n            };\r\n\r\n            Hawk.server.authenticateBewit(req, credentialsFunc, {}, function (err, credentials, bewit) {\r\n\r\n                expect(err).to.exist();\r\n                expect(err.output.statusCode).to.equal(400);\r\n                expect(err.message).to.equal('Resource path exceeds max length');\r\n                done();\r\n            });\r\n        });\r\n    });\r\n\r\n    describe('authenticateMessage()', function () {\r\n\r\n        it('errors on invalid authorization (ts)', function (done) {\r\n\r\n            credentialsFunc('123456', function (err, credentials1) {\r\n\r\n                var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials1 });\r\n                delete auth.ts;\r\n\r\n                Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, credentialsFunc, {}, function (err, credentials2) {\r\n\r\n                    expect(err).to.exist();\r\n                    expect(err.message).to.equal('Invalid authorization');\r\n                    done();\r\n                });\r\n            });\r\n        });\r\n\r\n        it('errors on invalid authorization (nonce)', function (done) {\r\n\r\n            credentialsFunc('123456', function (err, credentials1) {\r\n\r\n                var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials1 });\r\n                delete auth.nonce;\r\n\r\n                Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, credentialsFunc, {}, function (err, credentials2) {\r\n\r\n                    expect(err).to.exist();\r\n                    expect(err.message).to.equal('Invalid authorization');\r\n                    done();\r\n                });\r\n            });\r\n        });\r\n\r\n        it('errors on invalid authorization (hash)', function (done) {\r\n\r\n            credentialsFunc('123456', function (err, credentials1) {\r\n\r\n                var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials1 });\r\n                delete auth.hash;\r\n\r\n                Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, credentialsFunc, {}, function (err, credentials2) {\r\n\r\n                    expect(err).to.exist();\r\n                    expect(err.message).to.equal('Invalid authorization');\r\n                    done();\r\n                });\r\n            });\r\n        });\r\n\r\n        it('errors with credentials', function (done) {\r\n\r\n            credentialsFunc('123456', function (err, credentials1) {\r\n\r\n                var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials1 });\r\n\r\n                Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, function (id, callback) {\r\n\r\n                    callback(new Error('something'), { some: 'value' });\r\n                }, {}, function (err, credentials2) {\r\n\r\n                    expect(err).to.exist();\r\n                    expect(err.message).to.equal('something');\r\n                    expect(credentials2.some).to.equal('value');\r\n                    done();\r\n                });\r\n            });\r\n        });\r\n\r\n        it('errors on nonce collision', function (done) {\r\n\r\n            credentialsFunc('123456', function (err, credentials1) {\r\n\r\n                var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials1 });\r\n                Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, credentialsFunc, {\r\n                    nonceFunc: function (key, nonce, ts, nonceCallback) {\r\n\r\n                        nonceCallback(true);\r\n                    }\r\n                }, function (err, credentials2) {\r\n\r\n                    expect(err).to.exist();\r\n                    expect(err.message).to.equal('Invalid nonce');\r\n                    done();\r\n                });\r\n            });\r\n        });\r\n\r\n        it('should generate an authorization then successfully parse it', function (done) {\r\n\r\n            credentialsFunc('123456', function (err, credentials1) {\r\n\r\n                var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials1 });\r\n                expect(auth).to.exist();\r\n\r\n                Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, credentialsFunc, {}, function (err, credentials2) {\r\n\r\n                    expect(err).to.not.exist();\r\n                    expect(credentials2.user).to.equal('steve');\r\n                    done();\r\n                });\r\n            });\r\n        });\r\n\r\n        it('should fail authorization on mismatching host', function (done) {\r\n\r\n            credentialsFunc('123456', function (err, credentials1) {\r\n\r\n                var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials1 });\r\n                expect(auth).to.exist();\r\n\r\n                Hawk.server.authenticateMessage('example1.com', 8080, 'some message', auth, credentialsFunc, {}, function (err, credentials2) {\r\n\r\n                    expect(err).to.exist();\r\n                    expect(err.message).to.equal('Bad mac');\r\n                    done();\r\n                });\r\n            });\r\n        });\r\n\r\n        it('should fail authorization on stale timestamp', function (done) {\r\n\r\n            credentialsFunc('123456', function (err, credentials1) {\r\n\r\n                var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials1 });\r\n                expect(auth).to.exist();\r\n\r\n                Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, credentialsFunc, { localtimeOffsetMsec: 100000 }, function (err, credentials2) {\r\n\r\n                    expect(err).to.exist();\r\n                    expect(err.message).to.equal('Stale timestamp');\r\n                    done();\r\n                });\r\n            });\r\n        });\r\n\r\n        it('overrides timestampSkewSec', function (done) {\r\n\r\n            credentialsFunc('123456', function (err, credentials1) {\r\n\r\n                var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials1, localtimeOffsetMsec: 100000 });\r\n                expect(auth).to.exist();\r\n\r\n                Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, credentialsFunc, { timestampSkewSec: 500 }, function (err, credentials2) {\r\n\r\n                    expect(err).to.not.exist();\r\n                    done();\r\n                });\r\n            });\r\n        });\r\n\r\n        it('should fail authorization on invalid authorization', function (done) {\r\n\r\n            credentialsFunc('123456', function (err, credentials1) {\r\n\r\n                var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials1 });\r\n                expect(auth).to.exist();\r\n                delete auth.id;\r\n\r\n                Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, credentialsFunc, {}, function (err, credentials2) {\r\n\r\n                    expect(err).to.exist();\r\n                    expect(err.message).to.equal('Invalid authorization');\r\n                    done();\r\n                });\r\n            });\r\n        });\r\n\r\n        it('should fail authorization on bad hash', function (done) {\r\n\r\n            credentialsFunc('123456', function (err, credentials1) {\r\n\r\n                var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials1 });\r\n                expect(auth).to.exist();\r\n\r\n                Hawk.server.authenticateMessage('example.com', 8080, 'some message1', auth, credentialsFunc, {}, function (err, credentials2) {\r\n\r\n                    expect(err).to.exist();\r\n                    expect(err.message).to.equal('Bad message hash');\r\n                    done();\r\n                });\r\n            });\r\n        });\r\n\r\n        it('should fail authorization on nonce error', function (done) {\r\n\r\n            credentialsFunc('123456', function (err, credentials1) {\r\n\r\n                var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials1 });\r\n                expect(auth).to.exist();\r\n\r\n                Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, credentialsFunc, {\r\n                    nonceFunc: function (key, nonce, ts, callback) {\r\n\r\n                        callback(new Error('kaboom'));\r\n                    }\r\n                }, function (err, credentials2) {\r\n\r\n                    expect(err).to.exist();\r\n                    expect(err.message).to.equal('Invalid nonce');\r\n                    done();\r\n                });\r\n            });\r\n        });\r\n\r\n        it('should fail authorization on credentials error', function (done) {\r\n\r\n            credentialsFunc('123456', function (err, credentials1) {\r\n\r\n                var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials1 });\r\n                expect(auth).to.exist();\r\n\r\n                var errFunc = function (id, callback) {\r\n\r\n                    callback(new Error('kablooey'));\r\n                };\r\n\r\n                Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, errFunc, {}, function (err, credentials2) {\r\n\r\n                    expect(err).to.exist();\r\n                    expect(err.message).to.equal('kablooey');\r\n                    done();\r\n                });\r\n            });\r\n        });\r\n\r\n        it('should fail authorization on missing credentials', function (done) {\r\n\r\n            credentialsFunc('123456', function (err, credentials1) {\r\n\r\n                var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials1 });\r\n                expect(auth).to.exist();\r\n\r\n                var errFunc = function (id, callback) {\r\n\r\n                    callback();\r\n                };\r\n\r\n                Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, errFunc, {}, function (err, credentials2) {\r\n\r\n                    expect(err).to.exist();\r\n                    expect(err.message).to.equal('Unknown credentials');\r\n                    done();\r\n                });\r\n            });\r\n        });\r\n\r\n        it('should fail authorization on invalid credentials', function (done) {\r\n\r\n            credentialsFunc('123456', function (err, credentials1) {\r\n\r\n                var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials1 });\r\n                expect(auth).to.exist();\r\n\r\n                var errFunc = function (id, callback) {\r\n\r\n                    callback(null, {});\r\n                };\r\n\r\n                Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, errFunc, {}, function (err, credentials2) {\r\n\r\n                    expect(err).to.exist();\r\n                    expect(err.message).to.equal('Invalid credentials');\r\n                    done();\r\n                });\r\n            });\r\n        });\r\n\r\n        it('should fail authorization on invalid credentials algorithm', function (done) {\r\n\r\n            credentialsFunc('123456', function (err, credentials1) {\r\n\r\n                var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials1 });\r\n                expect(auth).to.exist();\r\n\r\n                var errFunc = function (id, callback) {\r\n\r\n                    callback(null, { key: '123', algorithm: '456' });\r\n                };\r\n\r\n                Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, errFunc, {}, function (err, credentials2) {\r\n\r\n                    expect(err).to.exist();\r\n                    expect(err.message).to.equal('Unknown algorithm');\r\n                    done();\r\n                });\r\n            });\r\n        });\r\n\r\n        it('should fail on missing host', function (done) {\r\n\r\n            credentialsFunc('123456', function (err, credentials) {\r\n\r\n                var auth = Hawk.client.message(null, 8080, 'some message', { credentials: credentials });\r\n                expect(auth).to.not.exist();\r\n                done();\r\n            });\r\n        });\r\n\r\n        it('should fail on missing credentials', function (done) {\r\n\r\n            var auth = Hawk.client.message('example.com', 8080, 'some message', {});\r\n            expect(auth).to.not.exist();\r\n            done();\r\n        });\r\n\r\n        it('should fail on invalid algorithm', function (done) {\r\n\r\n            credentialsFunc('123456', function (err, credentials) {\r\n\r\n                var creds = Hoek.clone(credentials);\r\n                creds.algorithm = 'blah';\r\n                var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: creds });\r\n                expect(auth).to.not.exist();\r\n                done();\r\n            });\r\n        });\r\n    });\r\n\r\n    describe('authenticatePayloadHash()', function () {\r\n\r\n        it('checks payload hash', function (done) {\r\n\r\n            expect(Hawk.server.authenticatePayloadHash('abcdefg', { hash: 'abcdefg' })).to.equal(true);\r\n            expect(Hawk.server.authenticatePayloadHash('1234567', { hash: 'abcdefg' })).to.equal(false);\r\n            done();\r\n        });\r\n    });\r\n});\r\n\r\n"]}
{"version":3,"sources":["../../../../../node_modules/npm/node_modules/read-package-tree/rpt.js"],"names":["fs","require","rpj","path","dz","once","readdir","debug","asyncForEach","items","todo","done","remaining","length","seenErr","forEach","item","handleComplete","err","dpath","p","indexOf","process","cwd","substr","module","exports","rpt","Node","Link","ID","pkg","logical","physical","er","cache","fromLink","node","constructor","name","_id","parent","dirname","basename","realpath","error","id","package","isLink","children","prototype","dir","target","Object","create","value","loadNode","cb","thenReadPackageJson","real","pj","join","thenCreateNode","loadChildren","filterWith","nm","rm","thenReaddir","real_nm","thenLoadKids","kids","filter","kid","thenLoadNode","thenSortChildren","kidPath","kidRealPath","andAddNode","push","sortChildren","sort","a","b","toLowerCase","loadTree","did","thenProcessChildren","loadTreeForKid","root","topErr","tree","realRoot","thenLoadTree","thenHandleErrors","code"],"mappings":"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","file":"rpt.js","sourcesContent":["var fs = require('fs')\nvar rpj = require('read-package-json')\nvar path = require('path')\nvar dz = require('dezalgo')\nvar once = require('once')\nvar readdir = require('readdir-scoped-modules')\nvar debug = require('debuglog')('rpt')\n\nfunction asyncForEach (items, todo, done) {\n  var remaining = items.length\n  if (remaining === 0) return done()\n  var seenErr\n  items.forEach(function (item) {\n    todo(item, handleComplete)\n  })\n  function handleComplete (err) {\n    if (seenErr) return\n    if (err) {\n      seenErr = true\n      return done(err)\n    }\n    if (--remaining === 0) done()\n  }\n}\n\nfunction dpath (p) {\n  if (!p) return ''\n  if (p.indexOf(process.cwd()) === 0) {\n    p = p.substr(process.cwd().length + 1)\n  }\n  return p\n}\n\nmodule.exports = rpt\n\nrpt.Node = Node\nrpt.Link = Link\n\nvar ID = 0\nfunction Node (pkg, logical, physical, er, cache, fromLink) {\n  if (!(this instanceof Node)) {\n    return new Node(pkg, logical, physical, er, cache)\n  }\n\n  var node = cache[physical] || this\n  if (fromLink && cache[physical]) return cache[physical]\n\n  debug(node.constructor.name, dpath(physical), pkg && pkg._id)\n\n  const parent = path.dirname(logical)\n  if (parent[0] === '@') {\n    node.name = path.basename(parent) + '/' + path.basename(logical)\n  } else {\n    node.name = path.basename(logical)\n  }\n  node.path = logical\n  node.realpath = physical\n  node.error = er\n  if (!cache[physical]) {\n    node.id = ID++\n    node.package = pkg || {}\n    node.parent = null\n    node.isLink = false\n    node.children = []\n  }\n  return cache[physical] = node\n}\n\nNode.prototype.package = null\nNode.prototype.path = ''\nNode.prototype.realpath = ''\nNode.prototype.children = null\nNode.prototype.error = null\n\nfunction Link (pkg, logical, physical, realpath, er, cache) {\n  if (cache[physical]) return cache[physical]\n\n  if (!(this instanceof Link)) {\n    return new Link(pkg, logical, physical, realpath, er, cache)\n  }\n\n  cache[physical] = this\n\n  debug(this.constructor.name, dpath(physical), pkg && pkg._id)\n\n  const dir = path.dirname(logical)\n  const parent = path.dirname(dir)\n  if (parent[0] === '@') {\n    this.name = path.basename(parent) + '/' + path.basename(dir)\n  } else {\n    this.name = path.basename(dir)\n  }\n  this.id = ID++\n  this.path = logical\n  this.realpath = realpath\n  this.package = pkg || {}\n  this.parent = null\n  this.target = new Node(this.package, logical, realpath, er, cache, true)\n  this.isLink = true\n  this.children = this.target.children\n  this.error = er\n}\n\nLink.prototype = Object.create(Node.prototype, {\n  constructor: { value: Link }\n})\nLink.prototype.target = null\nLink.prototype.realpath = ''\n\nfunction loadNode (logical, physical, cache, cb) {\n  debug('loadNode', dpath(logical))\n  return fs.realpath(physical, thenReadPackageJson)\n\n  var realpath\n  function thenReadPackageJson (er, real) {\n    if (er) {\n      var node = new Node(null, logical, physical, er, cache)\n      return cb(null, node)\n    }\n    debug('realpath l=%j p=%j real=%j', dpath(logical), dpath(physical), dpath(real))\n    var pj = path.join(real, 'package.json')\n    realpath = real\n    return rpj(pj, thenCreateNode)\n  }\n  function thenCreateNode (er, pkg) {\n    pkg = pkg || null\n    var node\n    if (physical === realpath) {\n      node = new Node(pkg, logical, physical, er, cache)\n    } else {\n      node = new Link(pkg, logical, physical, realpath, er, cache)\n    }\n\n    cb(null, node)\n  }\n}\n\nfunction loadChildren (node, cache, filterWith, cb) {\n  debug('loadChildren', dpath(node.path))\n  // needed 'cause we process all kids async-like and errors\n  // short circuit, so we have to be sure that after an error\n  // the cbs from other kids don't result in calling cb a second\n  // (or more) time.\n  cb = once(cb)\n  var nm = path.join(node.path, 'node_modules')\n  var rm\n  return fs.realpath(path.join(node.path, 'node_modules'), thenReaddir)\n\n  function thenReaddir (er, real_nm) {\n    if (er) return cb(null, node)\n    rm = real_nm\n    readdir(nm, thenLoadKids)\n  }\n\n  function thenLoadKids (er, kids) {\n    // If there are no children, that's fine, just return\n    if (er) return cb(null, node)\n\n    kids = kids.filter(function (kid) {\n      return kid[0] !== '.' && (!filterWith || filterWith(node, kid))\n    })\n\n    asyncForEach(kids, thenLoadNode, thenSortChildren)\n  }\n  function thenLoadNode (kid, done) {\n    var kidPath = path.join(nm, kid)\n    var kidRealPath = path.join(rm, kid)\n    loadNode(kidPath, kidRealPath, cache, andAddNode(done))\n  }\n  function andAddNode (done) {\n    return function (er, kid) {\n      if (er) return done(er)\n      node.children.push(kid)\n      kid.parent = node\n      done()\n    }\n  }\n  function thenSortChildren (er) {\n    sortChildren(node)\n    cb(er, node)\n  }\n}\n\nfunction sortChildren (node) {\n  node.children = node.children.sort(function (a, b) {\n    a = a.package.name ? a.package.name.toLowerCase() : a.path\n    b = b.package.name ? b.package.name.toLowerCase() : b.path\n    return a > b ? 1 : -1\n  })\n}\n\nfunction loadTree (node, did, cache, filterWith, cb) {\n  debug('loadTree', dpath(node.path), !!cache[node.path])\n\n  if (did[node.realpath]) {\n    return dz(cb)(null, node)\n  }\n\n  did[node.realpath] = true\n\n  // needed 'cause we process all kids async-like and errors\n  // short circuit, so we have to be sure that after an error\n  // the cbs from other kids don't result in calling cb a second\n  // (or more) time.\n  cb = once(cb)\n  return loadChildren(node, cache, filterWith, thenProcessChildren)\n\n  function thenProcessChildren (er, node) {\n    if (er) return cb(er)\n\n    var kids = node.children.filter(function (kid) {\n      return !did[kid.realpath]\n    })\n\n    return asyncForEach(kids, loadTreeForKid, cb)\n  }\n  function loadTreeForKid (kid, done) {\n    loadTree(kid, did, cache, filterWith, done)\n  }\n}\n\nfunction rpt (root, filterWith, cb) {\n  if (!cb) {\n    cb = filterWith\n    filterWith = null\n  }\n  var cache = Object.create(null)\n  var topErr\n  var tree\n  return fs.realpath(root, thenLoadNode)\n\n  function thenLoadNode (er, realRoot) {\n    if (er) return cb(er)\n    debug('rpt', dpath(realRoot))\n    loadNode(root, realRoot, cache, thenLoadTree)\n  }\n  function thenLoadTree(er, node) {\n    // even if there's an error, it's fine, as long as we got a node\n    if (node) {\n      topErr = er\n      tree = node\n      loadTree(node, {}, cache, filterWith, thenHandleErrors)\n    } else {\n      cb(er)\n    }\n  }\n  function thenHandleErrors (er) {\n    cb(topErr && topErr.code !== 'ENOENT' ? topErr : er, tree)\n  }\n}\n"]}
{"version":3,"sources":["../../../../../node_modules/npm/node_modules/npm-registry-fetch/index.js"],"names":["Buffer","require","checkResponse","config","getAuth","fetch","npa","qs","silentLog","url","module","exports","regFetch","uri","opts","Object","assign","log","registry","get","pickRegistry","parse","protocol","trim","replace","startTime","Date","now","headers","getHeaders","body","bodyIsStream","pipe","isBuffer","JSON","stringify","q","parsed","search","query","format","agent","algorithms","cache","getCacheMode","cacheManager","ca","cert","integrity","key","localAddress","maxSockets","memoize","method","noProxy","Promise","proxy","referer","retry","retries","factor","minTimeout","maxTimeout","strictSSL","timeout","uid","gid","then","res","json","fetchJSON","spec","Error","scope","process","env","auth","shouldAuth","alwaysAuth","host","token","authorization","username","password","encoded","from","toString","_auth","otp"],"mappings":"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","file":"index.js","sourcesContent":["'use strict'\n\nconst Buffer = require('safe-buffer').Buffer\n\nconst checkResponse = require('./check-response.js')\nconst config = require('./config.js')\nconst getAuth = require('./auth.js')\nconst fetch = require('make-fetch-happen')\nconst npa = require('npm-package-arg')\nconst qs = require('querystring')\nconst silentLog = require('./silentlog.js')\nconst url = require('url')\n\nmodule.exports = regFetch\nfunction regFetch (uri, opts) {\n  opts = config(Object.assign({\n    log: silentLog\n  }, opts))\n  const registry = (\n    (opts.get('spec') && pickRegistry(opts.get('spec'), opts)) ||\n    opts.get('registry') ||\n    'https://registry.npmjs.org/'\n  )\n  uri = url.parse(uri).protocol\n    ? uri\n    : `${\n      registry.trim().replace(/\\/?$/g, '')\n    }/${\n      uri.trim().replace(/^\\//, '')\n    }`\n  // through that takes into account the scope, the prefix of `uri`, etc\n  const startTime = Date.now()\n  const headers = getHeaders(registry, uri, opts)\n  let body = opts.get('body')\n  const bodyIsStream = body &&\n    typeof body === 'object' &&\n    typeof body.pipe === 'function'\n  if (body && !bodyIsStream && typeof body !== 'string' && !Buffer.isBuffer(body)) {\n    headers['content-type'] = headers['content-type'] || 'application/json'\n    body = JSON.stringify(body)\n  } else if (body && !headers['content-type']) {\n    headers['content-type'] = 'application/octet-stream'\n  }\n  if (opts.get('query')) {\n    let q = opts.get('query')\n    if (typeof q === 'string') {\n      q = qs.parse(q)\n    }\n    const parsed = url.parse(uri)\n    parsed.search = '?' + qs.stringify(\n      parsed.query\n        ? Object.assign(qs.parse(parsed.query), q)\n        : q\n    )\n    uri = url.format(parsed)\n  }\n  return fetch(uri, {\n    agent: opts.get('agent'),\n    algorithms: opts.get('algorithms'),\n    body,\n    cache: getCacheMode(opts),\n    cacheManager: opts.get('cache'),\n    ca: opts.get('ca'),\n    cert: opts.get('cert'),\n    headers,\n    integrity: opts.get('integrity'),\n    key: opts.get('key'),\n    localAddress: opts.get('local-address'),\n    maxSockets: opts.get('maxsockets'),\n    memoize: opts.get('memoize'),\n    method: opts.get('method') || 'GET',\n    noProxy: opts.get('noproxy'),\n    Promise: opts.get('Promise'),\n    proxy: opts.get('proxy'),\n    referer: opts.get('refer'),\n    retry: opts.get('retry') || {\n      retries: opts.get('fetch-retries'),\n      factor: opts.get('fetch-retry-factor'),\n      minTimeout: opts.get('fetch-retry-mintimeout'),\n      maxTimeout: opts.get('fetch-retry-maxtimeout')\n    },\n    strictSSL: !!opts.get('strict-ssl'),\n    timeout: opts.get('timeout'),\n    uid: opts.get('uid'),\n    gid: opts.get('gid')\n  }).then(res => checkResponse(\n    opts.get('method') || 'GET', res, registry, startTime, opts\n  ))\n}\n\nmodule.exports.json = fetchJSON\nfunction fetchJSON (uri, opts) {\n  return regFetch(uri, opts).then(res => res.json())\n}\n\nmodule.exports.pickRegistry = pickRegistry\nfunction pickRegistry (spec, opts) {\n  spec = npa(spec)\n  opts = config(opts)\n  if (!spec.registry) {\n    throw new Error(`${spec} is not a valid registry dependency spec`)\n  }\n  let registry = spec.scope &&\n    opts.get(spec.scope.replace(/^@?/, '@') + ':registry')\n\n  if (!registry && opts.get('scope')) {\n    registry = opts.get(\n      opts.get('scope').replace(/^@?/, '@') + ':registry'\n    )\n  }\n\n  if (!registry) {\n    registry = opts.get('registry') || 'https://registry.npmjs.org/'\n  }\n\n  return registry\n}\n\nfunction getCacheMode (opts) {\n  return opts.get('offline')\n    ? 'only-if-cached'\n    : opts.get('prefer-offline')\n      ? 'force-cache'\n      : opts.get('prefer-online')\n        ? 'no-cache'\n        : 'default'\n}\n\nfunction getHeaders (registry, uri, opts) {\n  const headers = Object.assign({\n    'npm-in-ci': !!(\n      opts.get('is-from-ci') ||\n      process.env['CI'] === 'true' ||\n      process.env['TDDIUM'] ||\n      process.env['JENKINS_URL'] ||\n      process.env['bamboo.buildKey'] ||\n      process.env['GO_PIPELINE_NAME']\n    ),\n    'npm-scope': opts.get('project-scope'),\n    'npm-session': opts.get('npm-session'),\n    'user-agent': opts.get('user-agent'),\n    'referer': opts.get('refer')\n  }, opts.get('headers'))\n\n  const auth = getAuth(registry, opts)\n  // If a tarball is hosted on a different place than the manifest, only send\n  // credentials on `alwaysAuth`\n  const shouldAuth = (\n    auth.alwaysAuth ||\n    url.parse(uri).host === url.parse(registry).host\n  )\n  if (shouldAuth && auth.token) {\n    headers.authorization = `Bearer ${auth.token}`\n  } else if (shouldAuth && auth.username && auth.password) {\n    const encoded = Buffer.from(\n      `${auth.username}:${auth.password}`, 'utf8'\n    ).toString('base64')\n    headers.authorization = `Basic ${encoded}`\n  } else if (shouldAuth && auth._auth) {\n    headers.authorization = `Basic ${auth._auth}`\n  }\n  if (shouldAuth && auth.otp) {\n    headers['npm-otp'] = auth.otp\n  }\n  return headers\n}\n"]}
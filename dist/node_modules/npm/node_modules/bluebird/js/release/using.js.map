{"version":3,"sources":["../../../../../../../node_modules/npm/node_modules/bluebird/js/release/using.js"],"names":["module","exports","Promise","apiRejection","tryConvertToPromise","createContext","INTERNAL","debug","util","require","TypeError","inherits","errorObj","tryCatch","NULL","thrower","e","setTimeout","castPreservingDisposable","thenable","maybePromise","_isDisposable","_getDisposer","_setDisposable","dispose","resources","inspection","i","len","length","ret","iterator","_fulfill","tryDispose","promise","_then","Disposer","data","context","_data","_promise","_context","prototype","resource","isFulfilled","value","undefined","_pushContext","doDispose","_popContext","_unsetDisposable","isDisposer","d","FunctionDisposer","fn","constructor$","call","maybeUnwrapDisposer","index","ResourceList","_resultCancelled","item","cancel","using","arguments","classString","input","spreadArgs","Array","isArray","disposer","reflectedResources","resolve","reflect","resultPromise","all","then","inspections","isRejected","error","apply","promiseCreated","checkForgottenReturns","lastly","PromiseInspection","_setOnCancel","_bitField","_disposer"],"mappings":"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","file":"using.js","sourcesContent":["\"use strict\";\nmodule.exports = function (Promise, apiRejection, tryConvertToPromise,\n    createContext, INTERNAL, debug) {\n    var util = require(\"./util\");\n    var TypeError = require(\"./errors\").TypeError;\n    var inherits = require(\"./util\").inherits;\n    var errorObj = util.errorObj;\n    var tryCatch = util.tryCatch;\n    var NULL = {};\n\n    function thrower(e) {\n        setTimeout(function(){throw e;}, 0);\n    }\n\n    function castPreservingDisposable(thenable) {\n        var maybePromise = tryConvertToPromise(thenable);\n        if (maybePromise !== thenable &&\n            typeof thenable._isDisposable === \"function\" &&\n            typeof thenable._getDisposer === \"function\" &&\n            thenable._isDisposable()) {\n            maybePromise._setDisposable(thenable._getDisposer());\n        }\n        return maybePromise;\n    }\n    function dispose(resources, inspection) {\n        var i = 0;\n        var len = resources.length;\n        var ret = new Promise(INTERNAL);\n        function iterator() {\n            if (i >= len) return ret._fulfill();\n            var maybePromise = castPreservingDisposable(resources[i++]);\n            if (maybePromise instanceof Promise &&\n                maybePromise._isDisposable()) {\n                try {\n                    maybePromise = tryConvertToPromise(\n                        maybePromise._getDisposer().tryDispose(inspection),\n                        resources.promise);\n                } catch (e) {\n                    return thrower(e);\n                }\n                if (maybePromise instanceof Promise) {\n                    return maybePromise._then(iterator, thrower,\n                                              null, null, null);\n                }\n            }\n            iterator();\n        }\n        iterator();\n        return ret;\n    }\n\n    function Disposer(data, promise, context) {\n        this._data = data;\n        this._promise = promise;\n        this._context = context;\n    }\n\n    Disposer.prototype.data = function () {\n        return this._data;\n    };\n\n    Disposer.prototype.promise = function () {\n        return this._promise;\n    };\n\n    Disposer.prototype.resource = function () {\n        if (this.promise().isFulfilled()) {\n            return this.promise().value();\n        }\n        return NULL;\n    };\n\n    Disposer.prototype.tryDispose = function(inspection) {\n        var resource = this.resource();\n        var context = this._context;\n        if (context !== undefined) context._pushContext();\n        var ret = resource !== NULL\n            ? this.doDispose(resource, inspection) : null;\n        if (context !== undefined) context._popContext();\n        this._promise._unsetDisposable();\n        this._data = null;\n        return ret;\n    };\n\n    Disposer.isDisposer = function (d) {\n        return (d != null &&\n                typeof d.resource === \"function\" &&\n                typeof d.tryDispose === \"function\");\n    };\n\n    function FunctionDisposer(fn, promise, context) {\n        this.constructor$(fn, promise, context);\n    }\n    inherits(FunctionDisposer, Disposer);\n\n    FunctionDisposer.prototype.doDispose = function (resource, inspection) {\n        var fn = this.data();\n        return fn.call(resource, resource, inspection);\n    };\n\n    function maybeUnwrapDisposer(value) {\n        if (Disposer.isDisposer(value)) {\n            this.resources[this.index]._setDisposable(value);\n            return value.promise();\n        }\n        return value;\n    }\n\n    function ResourceList(length) {\n        this.length = length;\n        this.promise = null;\n        this[length-1] = null;\n    }\n\n    ResourceList.prototype._resultCancelled = function() {\n        var len = this.length;\n        for (var i = 0; i < len; ++i) {\n            var item = this[i];\n            if (item instanceof Promise) {\n                item.cancel();\n            }\n        }\n    };\n\n    Promise.using = function () {\n        var len = arguments.length;\n        if (len < 2) return apiRejection(\n                        \"you must pass at least 2 arguments to Promise.using\");\n        var fn = arguments[len - 1];\n        if (typeof fn !== \"function\") {\n            return apiRejection(\"expecting a function but got \" + util.classString(fn));\n        }\n        var input;\n        var spreadArgs = true;\n        if (len === 2 && Array.isArray(arguments[0])) {\n            input = arguments[0];\n            len = input.length;\n            spreadArgs = false;\n        } else {\n            input = arguments;\n            len--;\n        }\n        var resources = new ResourceList(len);\n        for (var i = 0; i < len; ++i) {\n            var resource = input[i];\n            if (Disposer.isDisposer(resource)) {\n                var disposer = resource;\n                resource = resource.promise();\n                resource._setDisposable(disposer);\n            } else {\n                var maybePromise = tryConvertToPromise(resource);\n                if (maybePromise instanceof Promise) {\n                    resource =\n                        maybePromise._then(maybeUnwrapDisposer, null, null, {\n                            resources: resources,\n                            index: i\n                    }, undefined);\n                }\n            }\n            resources[i] = resource;\n        }\n\n        var reflectedResources = new Array(resources.length);\n        for (var i = 0; i < reflectedResources.length; ++i) {\n            reflectedResources[i] = Promise.resolve(resources[i]).reflect();\n        }\n\n        var resultPromise = Promise.all(reflectedResources)\n            .then(function(inspections) {\n                for (var i = 0; i < inspections.length; ++i) {\n                    var inspection = inspections[i];\n                    if (inspection.isRejected()) {\n                        errorObj.e = inspection.error();\n                        return errorObj;\n                    } else if (!inspection.isFulfilled()) {\n                        resultPromise.cancel();\n                        return;\n                    }\n                    inspections[i] = inspection.value();\n                }\n                promise._pushContext();\n\n                fn = tryCatch(fn);\n                var ret = spreadArgs\n                    ? fn.apply(undefined, inspections) : fn(inspections);\n                var promiseCreated = promise._popContext();\n                debug.checkForgottenReturns(\n                    ret, promiseCreated, \"Promise.using\", promise);\n                return ret;\n            });\n\n        var promise = resultPromise.lastly(function() {\n            var inspection = new Promise.PromiseInspection(resultPromise);\n            return dispose(resources, inspection);\n        });\n        resources.promise = promise;\n        promise._setOnCancel(resources);\n        return promise;\n    };\n\n    Promise.prototype._setDisposable = function (disposer) {\n        this._bitField = this._bitField | 131072;\n        this._disposer = disposer;\n    };\n\n    Promise.prototype._isDisposable = function () {\n        return (this._bitField & 131072) > 0;\n    };\n\n    Promise.prototype._getDisposer = function () {\n        return this._disposer;\n    };\n\n    Promise.prototype._unsetDisposable = function () {\n        this._bitField = this._bitField & (~131072);\n        this._disposer = undefined;\n    };\n\n    Promise.prototype.disposer = function (fn) {\n        if (typeof fn === \"function\") {\n            return new FunctionDisposer(fn, this, createContext());\n        }\n        throw new TypeError();\n    };\n\n};\n"]}
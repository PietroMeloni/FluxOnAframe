'use strict';

var BB = require('bluebird');

var figgyPudding = require('figgy-pudding');
var fixOwner = require('./fix-owner');
var path = require('path');
var rimraf = BB.promisify(require('rimraf'));
var uniqueFilename = require('unique-filename');

var TmpOpts = figgyPudding({
  tmpPrefix: {},
  uid: {},
  gid: {}
});

module.exports.mkdir = mktmpdir;
function mktmpdir(cache, opts) {
  opts = TmpOpts(opts);
  var tmpTarget = uniqueFilename(path.join(cache, 'tmp'), opts.tmpPrefix);
  return fixOwner.mkdirfix(tmpTarget, opts.uid, opts.gid).then(function () {
    return tmpTarget;
  });
}

module.exports.withTmp = withTmp;
function withTmp(cache, opts, cb) {
  if (!cb) {
    cb = opts;
    opts = null;
  }
  opts = TmpOpts(opts);
  return BB.using(mktmpdir(cache, opts).disposer(rimraf), cb);
}

module.exports.fix = fixtmpdir;
function fixtmpdir(cache, opts) {
  opts = TmpOpts(opts);
  return fixOwner(path.join(cache, 'tmp'), opts.uid, opts.gid);
}
//# sourceMappingURL=tmp.js.map
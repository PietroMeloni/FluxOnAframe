{"version":3,"sources":["../../../../../../node_modules/npm/node_modules/cacache/lib/verify.js"],"names":["BB","require","contentPath","figgyPudding","finished","promisify","fixOwner","fs","glob","index","path","rimraf","ssri","promisifyAll","VerifyOpts","concurrency","default","filter","log","silly","uid","gid","module","exports","verify","cache","opts","reduce","markStartTime","fixPerms","garbageCollect","rebuildIndex","cleanTmp","writeVerifile","markEndTime","stats","step","i","label","name","start","Date","resolve","then","s","Object","keys","forEach","k","end","runTime","tap","total","endTime","startTime","mkdirfix","chownr","indexStream","lsStream","liveContent","Set","on","entry","add","integrity","toString","contentDir","_contentDir","join","follow","nodir","nosort","verifiedContent","reclaimedCount","reclaimedSize","badContentCount","keptSize","map","files","f","split","digest","slice","length","algo","fromHex","has","verifyContent","info","valid","size","statAsync","filepath","sri","contentInfo","stat","checkStream","createReadStream","catch","err","code","ls","missingContent","rejectedEntries","totalEntries","buckets","entries","hasOwnProperty","hashed","_hashKey","excluded","push","_path","_bucketPath","rebuildBucket","key","bucket","truncateAsync","mapSeries","content","insert","metadata","verifile","writeFileAsync","lastRun","readFileAsync","data"],"mappings":"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","file":"verify.js","sourcesContent":["'use strict'\n\nconst BB = require('bluebird')\n\nconst contentPath = require('./content/path')\nconst figgyPudding = require('figgy-pudding')\nconst finished = BB.promisify(require('mississippi').finished)\nconst fixOwner = require('./util/fix-owner')\nconst fs = require('graceful-fs')\nconst glob = BB.promisify(require('glob'))\nconst index = require('./entry-index')\nconst path = require('path')\nconst rimraf = BB.promisify(require('rimraf'))\nconst ssri = require('ssri')\n\nBB.promisifyAll(fs)\n\nconst VerifyOpts = figgyPudding({\n  concurrency: {\n    default: 20\n  },\n  filter: {},\n  log: {\n    default: { silly () {} }\n  },\n  uid: {},\n  gid: {}\n})\n\nmodule.exports = verify\nfunction verify (cache, opts) {\n  opts = VerifyOpts(opts)\n  opts.log.silly('verify', 'verifying cache at', cache)\n  return BB.reduce([\n    markStartTime,\n    fixPerms,\n    garbageCollect,\n    rebuildIndex,\n    cleanTmp,\n    writeVerifile,\n    markEndTime\n  ], (stats, step, i) => {\n    const label = step.name || `step #${i}`\n    const start = new Date()\n    return BB.resolve(step(cache, opts)).then(s => {\n      s && Object.keys(s).forEach(k => {\n        stats[k] = s[k]\n      })\n      const end = new Date()\n      if (!stats.runTime) { stats.runTime = {} }\n      stats.runTime[label] = end - start\n      return stats\n    })\n  }, {}).tap(stats => {\n    stats.runTime.total = stats.endTime - stats.startTime\n    opts.log.silly('verify', 'verification finished for', cache, 'in', `${stats.runTime.total}ms`)\n  })\n}\n\nfunction markStartTime (cache, opts) {\n  return { startTime: new Date() }\n}\n\nfunction markEndTime (cache, opts) {\n  return { endTime: new Date() }\n}\n\nfunction fixPerms (cache, opts) {\n  opts.log.silly('verify', 'fixing cache permissions')\n  return fixOwner.mkdirfix(cache, opts.uid, opts.gid).then(() => {\n    // TODO - fix file permissions too\n    return fixOwner.chownr(cache, opts.uid, opts.gid)\n  }).then(() => null)\n}\n\n// Implements a naive mark-and-sweep tracing garbage collector.\n//\n// The algorithm is basically as follows:\n// 1. Read (and filter) all index entries (\"pointers\")\n// 2. Mark each integrity value as \"live\"\n// 3. Read entire filesystem tree in `content-vX/` dir\n// 4. If content is live, verify its checksum and delete it if it fails\n// 5. If content is not marked as live, rimraf it.\n//\nfunction garbageCollect (cache, opts) {\n  opts.log.silly('verify', 'garbage collecting content')\n  const indexStream = index.lsStream(cache)\n  const liveContent = new Set()\n  indexStream.on('data', entry => {\n    if (opts.filter && !opts.filter(entry)) { return }\n    liveContent.add(entry.integrity.toString())\n  })\n  return finished(indexStream).then(() => {\n    const contentDir = contentPath._contentDir(cache)\n    return glob(path.join(contentDir, '**'), {\n      follow: false,\n      nodir: true,\n      nosort: true\n    }).then(files => {\n      return BB.resolve({\n        verifiedContent: 0,\n        reclaimedCount: 0,\n        reclaimedSize: 0,\n        badContentCount: 0,\n        keptSize: 0\n      }).tap((stats) => BB.map(files, (f) => {\n        const split = f.split(/[/\\\\]/)\n        const digest = split.slice(split.length - 3).join('')\n        const algo = split[split.length - 4]\n        const integrity = ssri.fromHex(digest, algo)\n        if (liveContent.has(integrity.toString())) {\n          return verifyContent(f, integrity).then(info => {\n            if (!info.valid) {\n              stats.reclaimedCount++\n              stats.badContentCount++\n              stats.reclaimedSize += info.size\n            } else {\n              stats.verifiedContent++\n              stats.keptSize += info.size\n            }\n            return stats\n          })\n        } else {\n          // No entries refer to this content. We can delete.\n          stats.reclaimedCount++\n          return fs.statAsync(f).then(s => {\n            return rimraf(f).then(() => {\n              stats.reclaimedSize += s.size\n              return stats\n            })\n          })\n        }\n      }, {concurrency: opts.concurrency}))\n    })\n  })\n}\n\nfunction verifyContent (filepath, sri) {\n  return fs.statAsync(filepath).then(stat => {\n    const contentInfo = {\n      size: stat.size,\n      valid: true\n    }\n    return ssri.checkStream(\n      fs.createReadStream(filepath),\n      sri\n    ).catch(err => {\n      if (err.code !== 'EINTEGRITY') { throw err }\n      return rimraf(filepath).then(() => {\n        contentInfo.valid = false\n      })\n    }).then(() => contentInfo)\n  }).catch({code: 'ENOENT'}, () => ({size: 0, valid: false}))\n}\n\nfunction rebuildIndex (cache, opts) {\n  opts.log.silly('verify', 'rebuilding index')\n  return index.ls(cache).then(entries => {\n    const stats = {\n      missingContent: 0,\n      rejectedEntries: 0,\n      totalEntries: 0\n    }\n    const buckets = {}\n    for (let k in entries) {\n      if (entries.hasOwnProperty(k)) {\n        const hashed = index._hashKey(k)\n        const entry = entries[k]\n        const excluded = opts.filter && !opts.filter(entry)\n        excluded && stats.rejectedEntries++\n        if (buckets[hashed] && !excluded) {\n          buckets[hashed].push(entry)\n        } else if (buckets[hashed] && excluded) {\n          // skip\n        } else if (excluded) {\n          buckets[hashed] = []\n          buckets[hashed]._path = index._bucketPath(cache, k)\n        } else {\n          buckets[hashed] = [entry]\n          buckets[hashed]._path = index._bucketPath(cache, k)\n        }\n      }\n    }\n    return BB.map(Object.keys(buckets), key => {\n      return rebuildBucket(cache, buckets[key], stats, opts)\n    }, {concurrency: opts.concurrency}).then(() => stats)\n  })\n}\n\nfunction rebuildBucket (cache, bucket, stats, opts) {\n  return fs.truncateAsync(bucket._path).then(() => {\n    // This needs to be serialized because cacache explicitly\n    // lets very racy bucket conflicts clobber each other.\n    return BB.mapSeries(bucket, entry => {\n      const content = contentPath(cache, entry.integrity)\n      return fs.statAsync(content).then(() => {\n        return index.insert(cache, entry.key, entry.integrity, {\n          uid: opts.uid,\n          gid: opts.gid,\n          metadata: entry.metadata,\n          size: entry.size\n        }).then(() => { stats.totalEntries++ })\n      }).catch({code: 'ENOENT'}, () => {\n        stats.rejectedEntries++\n        stats.missingContent++\n      })\n    })\n  })\n}\n\nfunction cleanTmp (cache, opts) {\n  opts.log.silly('verify', 'cleaning tmp directory')\n  return rimraf(path.join(cache, 'tmp'))\n}\n\nfunction writeVerifile (cache, opts) {\n  const verifile = path.join(cache, '_lastverified')\n  opts.log.silly('verify', 'writing verifile to ' + verifile)\n  return fs.writeFileAsync(verifile, '' + (+(new Date())))\n}\n\nmodule.exports.lastRun = lastRun\nfunction lastRun (cache) {\n  return fs.readFileAsync(\n    path.join(cache, '_lastverified'), 'utf8'\n  ).then(data => new Date(+data))\n}\n"]}
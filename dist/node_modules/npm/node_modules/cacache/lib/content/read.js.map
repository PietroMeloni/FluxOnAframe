{"version":3,"sources":["../../../../../../../node_modules/npm/node_modules/cacache/lib/content/read.js"],"names":["BB","require","contentPath","figgyPudding","fs","PassThrough","pipe","promisify","ssri","Y","promisifyAll","ReadOpts","size","module","exports","read","cache","integrity","opts","pickContentSri","then","sri","content","cpath","readFileAsync","data","length","sizeError","checkData","integrityError","stream","readStream","createReadStream","integrityStream","catch","emit","err","copyFile","copy","dest","copyFileAsync","hasContent","resolve","code","process","platform","stat","_pickContentSri","parse","algo","pickAlgorithm","digests","lstatAsync","any","map","meta","some","call","e","Object","assign","Error","toString","expected","found","path"],"mappings":"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","file":"read.js","sourcesContent":["'use strict'\n\nconst BB = require('bluebird')\n\nconst contentPath = require('./path')\nconst figgyPudding = require('figgy-pudding')\nconst fs = require('graceful-fs')\nconst PassThrough = require('stream').PassThrough\nconst pipe = BB.promisify(require('mississippi').pipe)\nconst ssri = require('ssri')\nconst Y = require('../util/y.js')\n\nBB.promisifyAll(fs)\n\nconst ReadOpts = figgyPudding({\n  size: {}\n})\n\nmodule.exports = read\nfunction read (cache, integrity, opts) {\n  opts = ReadOpts(opts)\n  return pickContentSri(cache, integrity).then(content => {\n    const sri = content.sri\n    const cpath = contentPath(cache, sri)\n    return fs.readFileAsync(cpath, null).then(data => {\n      if (typeof opts.size === 'number' && opts.size !== data.length) {\n        throw sizeError(opts.size, data.length)\n      } else if (ssri.checkData(data, sri)) {\n        return data\n      } else {\n        throw integrityError(sri, cpath)\n      }\n    })\n  })\n}\n\nmodule.exports.stream = readStream\nmodule.exports.readStream = readStream\nfunction readStream (cache, integrity, opts) {\n  opts = ReadOpts(opts)\n  const stream = new PassThrough()\n  pickContentSri(\n    cache, integrity\n  ).then(content => {\n    const sri = content.sri\n    return pipe(\n      fs.createReadStream(contentPath(cache, sri)),\n      ssri.integrityStream({\n        integrity: sri,\n        size: opts.size\n      }),\n      stream\n    )\n  }).catch(err => {\n    stream.emit('error', err)\n  })\n  return stream\n}\n\nif (fs.copyFile) {\n  module.exports.copy = copy\n}\nfunction copy (cache, integrity, dest, opts) {\n  opts = ReadOpts(opts)\n  return pickContentSri(cache, integrity).then(content => {\n    const sri = content.sri\n    const cpath = contentPath(cache, sri)\n    return fs.copyFileAsync(cpath, dest).then(() => content.size)\n  })\n}\n\nmodule.exports.hasContent = hasContent\nfunction hasContent (cache, integrity) {\n  if (!integrity) { return BB.resolve(false) }\n  return pickContentSri(cache, integrity)\n    .catch({code: 'ENOENT'}, () => false)\n    .catch({code: 'EPERM'}, err => {\n      if (process.platform !== 'win32') {\n        throw err\n      } else {\n        return false\n      }\n    }).then(content => {\n      if (!content.sri) return false\n      return ({ sri: content.sri, size: content.stat.size })\n    })\n}\n\nmodule.exports._pickContentSri = pickContentSri\nfunction pickContentSri (cache, integrity) {\n  const sri = ssri.parse(integrity)\n  // If `integrity` has multiple entries, pick the first digest\n  // with available local data.\n  const algo = sri.pickAlgorithm()\n  const digests = sri[algo]\n  if (digests.length <= 1) {\n    const cpath = contentPath(cache, digests[0])\n    return fs.lstatAsync(cpath).then(stat => ({ sri: digests[0], stat }))\n  } else {\n    return BB.any(sri[sri.pickAlgorithm()].map(meta => {\n      return pickContentSri(cache, meta)\n    }))\n      .catch(err => {\n        if ([].some.call(err, e => e.code === 'ENOENT')) {\n          throw Object.assign(\n            new Error('No matching content found for ' + sri.toString()),\n            {code: 'ENOENT'}\n          )\n        } else {\n          throw err[0]\n        }\n      })\n  }\n}\n\nfunction sizeError (expected, found) {\n  var err = new Error(Y`Bad data size: expected inserted data to be ${expected} bytes, but got ${found} instead`)\n  err.expected = expected\n  err.found = found\n  err.code = 'EBADSIZE'\n  return err\n}\n\nfunction integrityError (sri, path) {\n  var err = new Error(Y`Integrity verification failed for ${sri} (${path})`)\n  err.code = 'EINTEGRITY'\n  err.sri = sri\n  err.path = path\n  return err\n}\n"]}
{"version":3,"sources":["../../../../../../node_modules/npm/node_modules/cacache/lib/entry-index.js"],"names":["BB","require","contentPath","crypto","figgyPudding","fixOwner","fs","hashToSegments","ms","path","ssri","Y","indexV","index","appendFileAsync","promisify","appendFile","readFileAsync","readFile","readdirAsync","readdir","concat","from","module","exports","NotFoundError","cache","key","code","Error","IndexOpts","metadata","size","uid","gid","insert","integrity","opts","bucket","bucketPath","entry","stringify","time","Date","now","mkdirfix","dirname","then","stringified","JSON","hashEntry","chownr","catch","formatEntry","find","bucketEntries","entries","reduce","latest","next","err","delete","del","lsStream","indexDir","bucketDir","stream","obj","readdirOrEmpty","map","join","subbucketPath","subbucket","getKeyToEntry","acc","set","Map","reduced","values","formatted","push","nop","emit","ls","fromNode","on","cb","pipe","xs","filter","data","split","forEach","pieces","parse","e","_bucketDir","_bucketPath","hashed","hashKey","apply","_hashKey","hash","_hashEntry","str","digest","createHash","update","dir"],"mappings":"AAAA;;;;;;;;;;;;AAEA,IAAMA,KAAKC,QAAQ,UAAR,CAAX;;AAEA,IAAMC,cAAcD,QAAQ,gBAAR,CAApB;AACA,IAAME,SAASF,QAAQ,QAAR,CAAf;AACA,IAAMG,eAAeH,QAAQ,eAAR,CAArB;AACA,IAAMI,WAAWJ,QAAQ,kBAAR,CAAjB;AACA,IAAMK,KAAKL,QAAQ,aAAR,CAAX;AACA,IAAMM,iBAAiBN,QAAQ,yBAAR,CAAvB;AACA,IAAMO,KAAKP,QAAQ,aAAR,CAAX;AACA,IAAMQ,OAAOR,QAAQ,MAAR,CAAb;AACA,IAAMS,OAAOT,QAAQ,MAAR,CAAb;AACA,IAAMU,IAAIV,QAAQ,aAAR,CAAV;;AAEA,IAAMW,SAASX,QAAQ,iBAAR,EAA2B,eAA3B,EAA4CY,KAA3D;;AAEA,IAAMC,kBAAkBd,GAAGe,SAAH,CAAaT,GAAGU,UAAhB,CAAxB;AACA,IAAMC,gBAAgBjB,GAAGe,SAAH,CAAaT,GAAGY,QAAhB,CAAtB;AACA,IAAMC,eAAenB,GAAGe,SAAH,CAAaT,GAAGc,OAAhB,CAArB;AACA,IAAMC,SAASb,GAAGa,MAAlB;AACA,IAAMC,OAAOd,GAAGc,IAAhB;;AAEAC,OAAOC,OAAP,CAAeC,aAAf;AAAA;;AACE,yBAAaC,KAAb,EAAoBC,GAApB,EAAyB;AAAA;;AAAA,8HACjBhB,CADiB,kBACQgB,GADR,EAC4BD,KAD5B;;AAEvB,UAAKE,IAAL,GAAY,QAAZ;AACA,UAAKF,KAAL,GAAaA,KAAb;AACA,UAAKC,GAAL,GAAWA,GAAX;AAJuB;AAKxB;;AANH;AAAA,EAA2DE,KAA3D;;AASA,IAAMC,YAAY1B,aAAa;AAC7B2B,YAAU,EADmB;AAE7BC,QAAM,EAFuB;AAG7BC,OAAK,EAHwB;AAI7BC,OAAK;AAJwB,CAAb,CAAlB;;AAOAX,OAAOC,OAAP,CAAeW,MAAf,GAAwBA,MAAxB;AACA,SAASA,MAAT,CAAiBT,KAAjB,EAAwBC,GAAxB,EAA6BS,SAA7B,EAAwCC,IAAxC,EAA8C;AAC5CA,SAAOP,UAAUO,IAAV,CAAP;AACA,MAAMC,SAASC,WAAWb,KAAX,EAAkBC,GAAlB,CAAf;AACA,MAAMa,QAAQ;AACZb,YADY;AAEZS,eAAWA,aAAa1B,KAAK+B,SAAL,CAAeL,SAAf,CAFZ;AAGZM,UAAMC,KAAKC,GAAL,EAHM;AAIZZ,UAAMK,KAAKL,IAJC;AAKZD,cAAUM,KAAKN;AALH,GAAd;AAOA,SAAO1B,SAASwC,QAAT,CACLpC,KAAKqC,OAAL,CAAaR,MAAb,CADK,EACiBD,KAAKJ,GADtB,EAC2BI,KAAKH,GADhC,EAELa,IAFK,CAEA,YAAM;AACX,QAAMC,cAAcC,KAAKR,SAAL,CAAeD,KAAf,CAApB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAO1B,gBACLwB,MADK,SACQY,UAAUF,WAAV,CADR,UACmCA,WADnC,CAAP;AAGD,GAdM,EAcJD,IAdI,CAeL;AAAA,WAAM1C,SAAS8C,MAAT,CAAgBb,MAAhB,EAAwBD,KAAKJ,GAA7B,EAAkCI,KAAKH,GAAvC,CAAN;AAAA,GAfK,EAgBLkB,KAhBK,CAgBC,EAACxB,MAAM,QAAP,EAhBD,EAgBmB,YAAM;AAC9B;AACA;AACA;AACA;AACA;AACD,GAtBM,EAsBJmB,IAtBI,CAsBC,YAAM;AACZ,WAAOM,YAAY3B,KAAZ,EAAmBc,KAAnB,CAAP;AACD,GAxBM,CAAP;AAyBD;;AAEDjB,OAAOC,OAAP,CAAe8B,IAAf,GAAsBA,IAAtB;AACA,SAASA,IAAT,CAAe5B,KAAf,EAAsBC,GAAtB,EAA2B;AACzB,MAAMW,SAASC,WAAWb,KAAX,EAAkBC,GAAlB,CAAf;AACA,SAAO4B,cAAc7B,KAAd,EAAqBY,MAArB,EAA6BS,IAA7B,CAAkC,mBAAW;AAClD,WAAOS,QAAQC,MAAR,CAAe,UAACC,MAAD,EAASC,IAAT,EAAkB;AACtC,UAAIA,QAAQA,KAAKhC,GAAL,KAAaA,GAAzB,EAA8B;AAC5B,eAAO0B,YAAY3B,KAAZ,EAAmBiC,IAAnB,CAAP;AACD,OAFD,MAEO;AACL,eAAOD,MAAP;AACD;AACF,KANM,EAMJ,IANI,CAAP;AAOD,GARM,EAQJN,KARI,CAQE,eAAO;AACd,QAAIQ,IAAIhC,IAAJ,KAAa,QAAjB,EAA2B;AACzB,aAAO,IAAP;AACD,KAFD,MAEO;AACL,YAAMgC,GAAN;AACD;AACF,GAdM,CAAP;AAeD;;AAEDrC,OAAOC,OAAP,CAAeqC,MAAf,GAAwBC,GAAxB;AACA,SAASA,GAAT,CAAcpC,KAAd,EAAqBC,GAArB,EAA0BU,IAA1B,EAAgC;AAC9B,SAAOF,OAAOT,KAAP,EAAcC,GAAd,EAAmB,IAAnB,EAAyBU,IAAzB,CAAP;AACD;;AAEDd,OAAOC,OAAP,CAAeuC,QAAf,GAA0BA,QAA1B;AACA,SAASA,QAAT,CAAmBrC,KAAnB,EAA0B;AACxB,MAAMsC,WAAWC,UAAUvC,KAAV,CAAjB;AACA,MAAMwC,SAAS5C,KAAK6C,GAAL,EAAf;;AAEA;AACAC,iBAAeJ,QAAf,EAAyBK,GAAzB,CAA6B,kBAAU;AACrC,QAAM9B,aAAa9B,KAAK6D,IAAL,CAAUN,QAAV,EAAoB1B,MAApB,CAAnB;;AAEA;AACA,WAAO8B,eAAe7B,UAAf,EAA2B8B,GAA3B,CAA+B,qBAAa;AACjD,UAAME,gBAAgB9D,KAAK6D,IAAL,CAAU/B,UAAV,EAAsBiC,SAAtB,CAAtB;;AAEA;AACA,aAAOJ,eAAeG,aAAf,EAA8BF,GAA9B,CAAkC,iBAAS;AAChD,YAAMI,gBAAgBlB,cACpB7B,KADoB,EAEpBjB,KAAK6D,IAAL,CAAUC,aAAV,EAAyB/B,KAAzB,CAFoB,EAGpBiB,MAHoB,CAGb,UAACiB,GAAD,EAAMlC,KAAN,EAAgB;AACvBkC,cAAIC,GAAJ,CAAQnC,MAAMb,GAAd,EAAmBa,KAAnB;AACA,iBAAOkC,GAAP;AACD,SANqB,EAMnB,IAAIE,GAAJ,EANmB,CAAtB;;AAQA,eAAOH,cAAc1B,IAAd,CAAmB,mBAAW;AAAA;AAAA;AAAA;;AAAA;AACnC,iCAAkB8B,QAAQC,MAAR,EAAlB,8HAAoC;AAAA,kBAA3BtC,MAA2B;;AAClC,kBAAMuC,YAAY1B,YAAY3B,KAAZ,EAAmBc,MAAnB,CAAlB;AACAuC,2BAAab,OAAOc,IAAP,CAAYD,SAAZ,CAAb;AACD;AAJkC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAKpC,SALM,EAKJ3B,KALI,CAKE,EAACxB,MAAM,QAAP,EALF,EAKoBqD,GALpB,CAAP;AAMD,OAfM,CAAP;AAgBD,KApBM,CAAP;AAqBD,GAzBD,EAyBGlC,IAzBH,CAyBQ,YAAM;AACZmB,WAAOc,IAAP,CAAY,IAAZ;AACD,GA3BD,EA2BG,eAAO;AACRd,WAAOgB,IAAP,CAAY,OAAZ,EAAqBtB,GAArB;AACD,GA7BD;;AA+BA,SAAOM,MAAP;AACD;;AAED3C,OAAOC,OAAP,CAAe2D,EAAf,GAAoBA,EAApB;AACA,SAASA,EAAT,CAAazD,KAAb,EAAoB;AAClB,SAAO1B,GAAGoF,QAAH,CAAY,cAAM;AACvBrB,aAASrC,KAAT,EAAgB2D,EAAhB,CAAmB,OAAnB,EAA4BC,EAA5B,EAAgCC,IAAhC,CAAqClE,OAAO,mBAAW;AACrDiE,SAAG,IAAH,EAAS9B,QAAQC,MAAR,CAAe,UAACiB,GAAD,EAAMc,EAAN,EAAa;AACnCd,YAAIc,GAAG7D,GAAP,IAAc6D,EAAd;AACA,eAAOd,GAAP;AACD,OAHQ,EAGN,EAHM,CAAT;AAID,KALoC,CAArC;AAMD,GAPM,CAAP;AAQD;;AAED,SAASnB,aAAT,CAAwB7B,KAAxB,EAA+BY,MAA/B,EAAuCmD,MAAvC,EAA+C;AAC7C,SAAOxE,cACLqB,MADK,EACG,MADH,EAELS,IAFK,CAEA,gBAAQ;AACb,QAAIS,UAAU,EAAd;AACAkC,SAAKC,KAAL,CAAW,IAAX,EAAiBC,OAAjB,CAAyB,iBAAS;AAChC,UAAI,CAACpD,KAAL,EAAY;AAAE;AAAQ;AACtB,UAAMqD,SAASrD,MAAMmD,KAAN,CAAY,IAAZ,CAAf;AACA,UAAI,CAACE,OAAO,CAAP,CAAD,IAAc3C,UAAU2C,OAAO,CAAP,CAAV,MAAyBA,OAAO,CAAP,CAA3C,EAAsD;AACpD;AACA;AACA;AACD;AACD,UAAI1B,YAAJ;AACA,UAAI;AACFA,cAAMlB,KAAK6C,KAAL,CAAWD,OAAO,CAAP,CAAX,CAAN;AACD,OAFD,CAEE,OAAOE,CAAP,EAAU;AACV;AACA;AACD;AACD,UAAI5B,GAAJ,EAAS;AACPX,gBAAQwB,IAAR,CAAab,GAAb;AACD;AACF,KAlBD;AAmBA,WAAOX,OAAP;AACD,GAxBM,CAAP;AAyBD;;AAEDjC,OAAOC,OAAP,CAAewE,UAAf,GAA4B/B,SAA5B;AACA,SAASA,SAAT,CAAoBvC,KAApB,EAA2B;AACzB,SAAOjB,KAAK6D,IAAL,CAAU5C,KAAV,cAA2Bd,MAA3B,CAAP;AACD;;AAEDW,OAAOC,OAAP,CAAeyE,WAAf,GAA6B1D,UAA7B;AACA,SAASA,UAAT,CAAqBb,KAArB,EAA4BC,GAA5B,EAAiC;AAC/B,MAAMuE,SAASC,QAAQxE,GAAR,CAAf;AACA,SAAOlB,KAAK6D,IAAL,CAAU8B,KAAV,CAAgB3F,IAAhB,EAAsB,CAACwD,UAAUvC,KAAV,CAAD,EAAmBL,MAAnB,CAC3Bd,eAAe2F,MAAf,CAD2B,CAAtB,CAAP;AAGD;;AAED3E,OAAOC,OAAP,CAAe6E,QAAf,GAA0BF,OAA1B;AACA,SAASA,OAAT,CAAkBxE,GAAlB,EAAuB;AACrB,SAAO2E,KAAK3E,GAAL,EAAU,QAAV,CAAP;AACD;;AAEDJ,OAAOC,OAAP,CAAe+E,UAAf,GAA4BrD,SAA5B;AACA,SAASA,SAAT,CAAoBsD,GAApB,EAAyB;AACvB,SAAOF,KAAKE,GAAL,EAAU,MAAV,CAAP;AACD;;AAED,SAASF,IAAT,CAAeE,GAAf,EAAoBC,MAApB,EAA4B;AAC1B,SAAOtG,OACJuG,UADI,CACOD,MADP,EAEJE,MAFI,CAEGH,GAFH,EAGJC,MAHI,CAGG,KAHH,CAAP;AAID;;AAED,SAASpD,WAAT,CAAsB3B,KAAtB,EAA6Bc,KAA7B,EAAoC;AAClC;AACA,MAAI,CAACA,MAAMJ,SAAX,EAAsB;AAAE,WAAO,IAAP;AAAa;AACrC,SAAO;AACLT,SAAKa,MAAMb,GADN;AAELS,eAAWI,MAAMJ,SAFZ;AAGL3B,UAAMP,YAAYwB,KAAZ,EAAmBc,MAAMJ,SAAzB,CAHD;AAILJ,UAAMQ,MAAMR,IAJP;AAKLU,UAAMF,MAAME,IALP;AAMLX,cAAUS,MAAMT;AANX,GAAP;AAQD;;AAED,SAASqC,cAAT,CAAyBwC,GAAzB,EAA8B;AAC5B,SAAOzF,aAAayF,GAAb,EACJxD,KADI,CACE,EAACxB,MAAM,QAAP,EADF,EACoB;AAAA,WAAM,EAAN;AAAA,GADpB,EAEJwB,KAFI,CAEE,EAACxB,MAAM,SAAP,EAFF,EAEqB;AAAA,WAAM,EAAN;AAAA,GAFrB,CAAP;AAGD;;AAED,SAASqD,GAAT,GAAgB,CACf","file":"entry-index.js","sourcesContent":["'use strict'\n\nconst BB = require('bluebird')\n\nconst contentPath = require('./content/path')\nconst crypto = require('crypto')\nconst figgyPudding = require('figgy-pudding')\nconst fixOwner = require('./util/fix-owner')\nconst fs = require('graceful-fs')\nconst hashToSegments = require('./util/hash-to-segments')\nconst ms = require('mississippi')\nconst path = require('path')\nconst ssri = require('ssri')\nconst Y = require('./util/y.js')\n\nconst indexV = require('../package.json')['cache-version'].index\n\nconst appendFileAsync = BB.promisify(fs.appendFile)\nconst readFileAsync = BB.promisify(fs.readFile)\nconst readdirAsync = BB.promisify(fs.readdir)\nconst concat = ms.concat\nconst from = ms.from\n\nmodule.exports.NotFoundError = class NotFoundError extends Error {\n  constructor (cache, key) {\n    super(Y`No cache entry for \\`${key}\\` found in \\`${cache}\\``)\n    this.code = 'ENOENT'\n    this.cache = cache\n    this.key = key\n  }\n}\n\nconst IndexOpts = figgyPudding({\n  metadata: {},\n  size: {},\n  uid: {},\n  gid: {}\n})\n\nmodule.exports.insert = insert\nfunction insert (cache, key, integrity, opts) {\n  opts = IndexOpts(opts)\n  const bucket = bucketPath(cache, key)\n  const entry = {\n    key,\n    integrity: integrity && ssri.stringify(integrity),\n    time: Date.now(),\n    size: opts.size,\n    metadata: opts.metadata\n  }\n  return fixOwner.mkdirfix(\n    path.dirname(bucket), opts.uid, opts.gid\n  ).then(() => {\n    const stringified = JSON.stringify(entry)\n    // NOTE - Cleverness ahoy!\n    //\n    // This works because it's tremendously unlikely for an entry to corrupt\n    // another while still preserving the string length of the JSON in\n    // question. So, we just slap the length in there and verify it on read.\n    //\n    // Thanks to @isaacs for the whiteboarding session that ended up with this.\n    return appendFileAsync(\n      bucket, `\\n${hashEntry(stringified)}\\t${stringified}`\n    )\n  }).then(\n    () => fixOwner.chownr(bucket, opts.uid, opts.gid)\n  ).catch({code: 'ENOENT'}, () => {\n    // There's a class of race conditions that happen when things get deleted\n    // during fixOwner, or between the two mkdirfix/chownr calls.\n    //\n    // It's perfectly fine to just not bother in those cases and lie\n    // that the index entry was written. Because it's a cache.\n  }).then(() => {\n    return formatEntry(cache, entry)\n  })\n}\n\nmodule.exports.find = find\nfunction find (cache, key) {\n  const bucket = bucketPath(cache, key)\n  return bucketEntries(cache, bucket).then(entries => {\n    return entries.reduce((latest, next) => {\n      if (next && next.key === key) {\n        return formatEntry(cache, next)\n      } else {\n        return latest\n      }\n    }, null)\n  }).catch(err => {\n    if (err.code === 'ENOENT') {\n      return null\n    } else {\n      throw err\n    }\n  })\n}\n\nmodule.exports.delete = del\nfunction del (cache, key, opts) {\n  return insert(cache, key, null, opts)\n}\n\nmodule.exports.lsStream = lsStream\nfunction lsStream (cache) {\n  const indexDir = bucketDir(cache)\n  const stream = from.obj()\n\n  // \"/cachename/*\"\n  readdirOrEmpty(indexDir).map(bucket => {\n    const bucketPath = path.join(indexDir, bucket)\n\n    // \"/cachename/<bucket 0xFF>/*\"\n    return readdirOrEmpty(bucketPath).map(subbucket => {\n      const subbucketPath = path.join(bucketPath, subbucket)\n\n      // \"/cachename/<bucket 0xFF>/<bucket 0xFF>/*\"\n      return readdirOrEmpty(subbucketPath).map(entry => {\n        const getKeyToEntry = bucketEntries(\n          cache,\n          path.join(subbucketPath, entry)\n        ).reduce((acc, entry) => {\n          acc.set(entry.key, entry)\n          return acc\n        }, new Map())\n\n        return getKeyToEntry.then(reduced => {\n          for (let entry of reduced.values()) {\n            const formatted = formatEntry(cache, entry)\n            formatted && stream.push(formatted)\n          }\n        }).catch({code: 'ENOENT'}, nop)\n      })\n    })\n  }).then(() => {\n    stream.push(null)\n  }, err => {\n    stream.emit('error', err)\n  })\n\n  return stream\n}\n\nmodule.exports.ls = ls\nfunction ls (cache) {\n  return BB.fromNode(cb => {\n    lsStream(cache).on('error', cb).pipe(concat(entries => {\n      cb(null, entries.reduce((acc, xs) => {\n        acc[xs.key] = xs\n        return acc\n      }, {}))\n    }))\n  })\n}\n\nfunction bucketEntries (cache, bucket, filter) {\n  return readFileAsync(\n    bucket, 'utf8'\n  ).then(data => {\n    let entries = []\n    data.split('\\n').forEach(entry => {\n      if (!entry) { return }\n      const pieces = entry.split('\\t')\n      if (!pieces[1] || hashEntry(pieces[1]) !== pieces[0]) {\n        // Hash is no good! Corruption or malice? Doesn't matter!\n        // EJECT EJECT\n        return\n      }\n      let obj\n      try {\n        obj = JSON.parse(pieces[1])\n      } catch (e) {\n        // Entry is corrupted!\n        return\n      }\n      if (obj) {\n        entries.push(obj)\n      }\n    })\n    return entries\n  })\n}\n\nmodule.exports._bucketDir = bucketDir\nfunction bucketDir (cache) {\n  return path.join(cache, `index-v${indexV}`)\n}\n\nmodule.exports._bucketPath = bucketPath\nfunction bucketPath (cache, key) {\n  const hashed = hashKey(key)\n  return path.join.apply(path, [bucketDir(cache)].concat(\n    hashToSegments(hashed)\n  ))\n}\n\nmodule.exports._hashKey = hashKey\nfunction hashKey (key) {\n  return hash(key, 'sha256')\n}\n\nmodule.exports._hashEntry = hashEntry\nfunction hashEntry (str) {\n  return hash(str, 'sha1')\n}\n\nfunction hash (str, digest) {\n  return crypto\n    .createHash(digest)\n    .update(str)\n    .digest('hex')\n}\n\nfunction formatEntry (cache, entry) {\n  // Treat null digests as deletions. They'll shadow any previous entries.\n  if (!entry.integrity) { return null }\n  return {\n    key: entry.key,\n    integrity: entry.integrity,\n    path: contentPath(cache, entry.integrity),\n    size: entry.size,\n    time: entry.time,\n    metadata: entry.metadata\n  }\n}\n\nfunction readdirOrEmpty (dir) {\n  return readdirAsync(dir)\n    .catch({code: 'ENOENT'}, () => [])\n    .catch({code: 'ENOTDIR'}, () => [])\n}\n\nfunction nop () {\n}\n"]}
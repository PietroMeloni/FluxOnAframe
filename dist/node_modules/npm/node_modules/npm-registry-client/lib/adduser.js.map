{"version":3,"sources":["../../../../../../node_modules/npm/node_modules/npm-registry-client/lib/adduser.js"],"names":["module","exports","adduser","url","require","assert","uri","params","cb","auth","username","password","email","slice","trim","Error","match","userobj","_id","name","type","roles","date","Date","toISOString","token","config","couchToken","couchLogin","done","call","logObj","Object","keys","map","k","reduce","s","kv","log","verbose","client","resolve","encodeURIComponent","options","method","body","request","assign","error","data","json","response","statusCode","er","forEach","_rev","tokenSet","JSON","stringify","warn"],"mappings":"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","file":"adduser.js","sourcesContent":["module.exports = adduser\n\nvar url = require('url')\nvar assert = require('assert')\n\nfunction adduser (uri, params, cb) {\n  assert(typeof uri === 'string', 'must pass registry URI to adduser')\n  assert(\n    params && typeof params === 'object',\n    'must pass params to adduser'\n  )\n  assert(typeof cb === 'function', 'must pass callback to adduser')\n\n  assert(params.auth && typeof params.auth, 'must pass auth to adduser')\n  var auth = params.auth\n  assert(typeof auth.username === 'string', 'must include username in auth')\n  assert(typeof auth.password === 'string', 'must include password in auth')\n  assert(typeof auth.email === 'string', 'must include email in auth')\n\n  // normalize registry URL\n  if (uri.slice(-1) !== '/') uri += '/'\n\n  var username = auth.username.trim()\n  var password = auth.password.trim()\n  var email = auth.email.trim()\n\n  // validation\n  if (!username) return cb(new Error('No username supplied.'))\n  if (!password) return cb(new Error('No password supplied.'))\n  if (!email) return cb(new Error('No email address supplied.'))\n  if (!email.match(/^[^@]+@[^.]+\\.[^.]+/)) {\n    return cb(new Error('Please use a real email address.'))\n  }\n\n  var userobj = {\n    _id: 'org.couchdb.user:' + username,\n    name: username,\n    password: password,\n    email: email,\n    type: 'user',\n    roles: [],\n    date: new Date().toISOString()\n  }\n\n  var token = this.config.couchToken\n  if (this.couchLogin) this.couchLogin.token = null\n\n  cb = done.call(this, token, cb)\n\n  var logObj = Object.keys(userobj).map(function (k) {\n    if (k === 'password') return [k, 'XXXXX']\n    return [k, userobj[k]]\n  }).reduce(function (s, kv) {\n    s[kv[0]] = kv[1]\n    return s\n  }, {})\n\n  this.log.verbose('adduser', 'before first PUT', logObj)\n\n  var client = this\n\n  uri = url.resolve(uri, '-/user/org.couchdb.user:' + encodeURIComponent(username))\n  var options = {\n    method: 'PUT',\n    body: userobj,\n    auth: auth\n  }\n  this.request(\n    uri,\n    Object.assign({}, options),\n    function (error, data, json, response) {\n      if (!error || !response || response.statusCode !== 409) {\n        return cb(error, data, json, response)\n      }\n\n      client.log.verbose('adduser', 'update existing user')\n      return client.request(\n        uri + '?write=true',\n        { auth: auth },\n        function (er, data, json, response) {\n          if (er || data.error) {\n            return cb(er, data, json, response)\n          }\n          Object.keys(data).forEach(function (k) {\n            if (!userobj[k] || k === 'roles') {\n              userobj[k] = data[k]\n            }\n          })\n          client.log.verbose('adduser', 'userobj', logObj)\n          client.request(uri + '/-rev/' + userobj._rev, options, cb)\n        }\n      )\n    }\n  )\n\n  function done (token, cb) {\n    return function (error, data, json, response) {\n      if (!error && (!response || response.statusCode === 201)) {\n        return cb(error, data, json, response)\n      }\n\n      // there was some kind of error, reinstate previous auth/token/etc.\n      if (client.couchLogin) {\n        client.couchLogin.token = token\n        if (client.couchLogin.tokenSet) {\n          client.couchLogin.tokenSet(token)\n        }\n      }\n\n      client.log.verbose('adduser', 'back', [error, data, json])\n      if (!error) {\n        error = new Error(\n          ((response && response.statusCode) || '') + ' ' +\n          'Could not create user\\n' + JSON.stringify(data)\n        )\n      }\n\n      if (response && (response.statusCode === 401 || response.statusCode === 403)) {\n        client.log.warn('adduser', 'Incorrect username or password\\n' +\n                                   'You can reset your account by visiting:\\n' +\n                                   '\\n' +\n                                   '    https://npmjs.org/forgot\\n')\n      }\n\n      return cb(error)\n    }\n  }\n}\n"]}
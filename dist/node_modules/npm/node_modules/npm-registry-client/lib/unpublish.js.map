{"version":3,"sources":["../../../../../../node_modules/npm/node_modules/npm-registry-client/lib/unpublish.js"],"names":["module","exports","unpublish","semver","require","url","chain","assert","uri","params","cb","ver","version","auth","options","timeout","follow","get","er","data","log","info","request","_rev","method","versions","versionPublic","hasOwnProperty","dist","verbose","Object","keys","length","latestVer","latest","tag","getOwnPropertyNames","sort","compareLoose","pop","rev","_revisions","_attachments","cb_","detacher","call","body","error","bind","credentials","escape","name","tb","parse","tarball","detach","pathname","bin","map","bt","d","path","resolve","Error","_id","base","escaped","replace"],"mappings":"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","file":"unpublish.js","sourcesContent":["module.exports = unpublish\n\n// fetch the data\n// modify to remove the version in question\n// If no versions remaining, then DELETE\n// else, PUT the modified data\n// delete the tarball\n\nvar semver = require('semver')\nvar url = require('url')\nvar chain = require('slide').chain\nvar assert = require('assert')\n\nfunction unpublish (uri, params, cb) {\n  assert(typeof uri === 'string', 'must pass registry URI to unpublish')\n  assert(params && typeof params === 'object', 'must pass params to unpublish')\n  assert(typeof cb === 'function', 'must pass callback to unpublish')\n\n  var ver = params.version\n  var auth = params.auth\n  assert(auth && typeof auth === 'object', 'must pass auth to unpublish')\n\n  var options = {\n    timeout: -1,\n    follow: false,\n    auth: auth\n  }\n  this.get(uri + '?write=true', options, function (er, data) {\n    if (er) {\n      this.log.info('unpublish', uri + ' not published')\n      return cb()\n    }\n    // remove all if no version specified\n    if (!ver) {\n      this.log.info('unpublish', 'No version specified, removing all')\n      return this.request(uri + '/-rev/' + data._rev, { method: 'DELETE', auth: auth }, cb)\n    }\n\n    var versions = data.versions || {}\n    var versionPublic = versions.hasOwnProperty(ver)\n\n    var dist\n    if (!versionPublic) {\n      this.log.info('unpublish', uri + '@' + ver + ' not published')\n    } else {\n      dist = versions[ver].dist\n      this.log.verbose('unpublish', 'removing attachments', dist)\n    }\n\n    delete versions[ver]\n    // if it was the only version, then delete the whole package.\n    if (!Object.keys(versions).length) {\n      this.log.info('unpublish', 'No versions remain, removing entire package')\n      return this.request(uri + '/-rev/' + data._rev, { method: 'DELETE', auth: auth }, cb)\n    }\n\n    if (!versionPublic) return cb()\n\n    var latestVer = data['dist-tags'].latest\n    for (var tag in data['dist-tags']) {\n      if (data['dist-tags'][tag] === ver) delete data['dist-tags'][tag]\n    }\n\n    if (latestVer === ver) {\n      data['dist-tags'].latest =\n        Object.getOwnPropertyNames(versions).sort(semver.compareLoose).pop()\n    }\n\n    var rev = data._rev\n    delete data._revisions\n    delete data._attachments\n    var cb_ = detacher.call(this, uri, data, dist, auth, cb)\n\n    this.request(uri + '/-rev/' + rev, { method: 'PUT', body: data, auth: auth }, function (er) {\n      if (er) {\n        this.log.error('unpublish', 'Failed to update data')\n      }\n      cb_(er)\n    }.bind(this))\n  }.bind(this))\n}\n\nfunction detacher (uri, data, dist, credentials, cb) {\n  return function (er) {\n    if (er) return cb(er)\n    this.get(escape(uri, data.name), { auth: credentials }, function (er, data) {\n      if (er) return cb(er)\n\n      var tb = url.parse(dist.tarball)\n\n      detach.call(this, uri, data, tb.pathname, data._rev, credentials, function (er) {\n        if (er || !dist.bin) return cb(er)\n        chain(Object.keys(dist.bin).map(function (bt) {\n          return function (cb) {\n            var d = dist.bin[bt]\n            detach.call(this, uri, data, url.parse(d.tarball).pathname, null, credentials, cb)\n          }.bind(this)\n        }, this), cb)\n      }.bind(this))\n    }.bind(this))\n  }.bind(this)\n}\n\nfunction detach (uri, data, path, rev, credentials, cb) {\n  if (rev) {\n    path += '/-rev/' + rev\n    this.log.info('detach', path)\n    return this.request(url.resolve(uri, path), { method: 'DELETE', auth: credentials }, cb)\n  }\n  this.get(escape(uri, data.name), { auth: credentials }, function (er, data) {\n    rev = data._rev\n    if (!rev) return cb(new Error('No _rev found in ' + data._id))\n    detach.call(this, data, path, rev, cb)\n  }.bind(this))\n}\n\nfunction escape (base, name) {\n  var escaped = name.replace(/\\//, '%2f')\n  return url.resolve(base, escaped)\n}\n"]}
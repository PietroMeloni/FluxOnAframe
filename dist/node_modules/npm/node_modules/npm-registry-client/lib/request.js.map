{"version":3,"sources":["../../../../../../node_modules/npm/node_modules/npm-registry-client/lib/request.js"],"names":["module","exports","regRequest","assert","require","url","zlib","Stream","STATUS_CODES","request","once","uri","params","cb_","method","log","verbose","cb","match","Error","adduserChange","isUserChange","adduserNew","isNewUser","alwaysAuth","auth","isDelete","isWrite","body","authed","self","attempt","operation","makeRequest","call","er","parsed","raw","response","headers","warn","message","code","statusCode","timeout","serverError","statusRetry","retry","info","undefined","apply","arguments","socket","removeListener","parse","authify","useCorgi","fullMetadata","opts","initialize","followRedirect","follow","encoding","etag","lastModified","Buffer","isBuffer","length","byteLength","size","_etag","_lastModified","json","http","href","done","requestDone","req","streaming","decodeResponseBody","on","s","parts","data","push","concat","destroy","pipe","gunzip","buf","where","urlObj","format","toString","JSON","ex","error","stringify","makeError","w","pathname","substr","name","split","index","indexOf","decodeURIComponent","reason","bind","pkgid"],"mappings":"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","file":"request.js","sourcesContent":["module.exports = regRequest\n\n// npm: means\n// 1. https\n// 2. send authorization\n// 3. content-type is 'application/json' -- metadata\n//\nvar assert = require('assert')\nvar url = require('url')\nvar zlib = require('zlib')\nvar Stream = require('stream').Stream\nvar STATUS_CODES = require('http').STATUS_CODES\n\nvar request = require('request')\nvar once = require('once')\n\nfunction regRequest (uri, params, cb_) {\n  assert(typeof uri === 'string', 'must pass uri to request')\n  assert(params && typeof params === 'object', 'must pass params to request')\n  assert(typeof cb_ === 'function', 'must pass callback to request')\n\n  params.method = params.method || 'GET'\n  this.log.verbose('request', 'uri', uri)\n\n  // Since there are multiple places where an error could occur,\n  // don't let the cb be called more than once.\n  var cb = once(cb_)\n\n  if (uri.match(/^\\/?favicon.ico/)) {\n    return cb(new Error(\"favicon.ico isn't a package, it's a picture.\"))\n  }\n\n  var adduserChange = /\\/?-\\/user\\/org\\.couchdb\\.user:([^/]+)\\/-rev/\n  var isUserChange = uri.match(adduserChange)\n  var adduserNew = /\\/?-\\/user\\/org\\.couchdb\\.user:([^/?]+)$/\n  var isNewUser = uri.match(adduserNew)\n  var alwaysAuth = params.auth && params.auth.alwaysAuth\n  var isDelete = params.method === 'DELETE'\n  var isWrite = params.body || isDelete\n\n  if (isUserChange && !isWrite) {\n    return cb(new Error('trying to change user document without writing(?!)'))\n  }\n\n  if (params.authed == null) {\n    // new users can *not* use auth, because they don't *have* auth yet\n    if (isUserChange) {\n      this.log.verbose('request', 'updating existing user; sending authorization')\n      params.authed = true\n    } else if (isNewUser) {\n      this.log.verbose('request', \"new user, so can't send auth\")\n      params.authed = false\n    } else if (alwaysAuth) {\n      this.log.verbose('request', 'always-auth set; sending authorization')\n      params.authed = true\n    } else if (isWrite) {\n      this.log.verbose('request', 'sending authorization for write operation')\n      params.authed = true\n    } else {\n      // most of the time we don't want to auth\n      this.log.verbose('request', 'no auth needed')\n      params.authed = false\n    }\n  }\n\n  var self = this\n  this.attempt(function (operation) {\n    makeRequest.call(self, uri, params, function (er, parsed, raw, response) {\n      if (response) {\n        self.log.verbose('headers', response.headers)\n        if (response.headers['npm-notice']) {\n          self.log.warn('notice', response.headers['npm-notice'])\n        }\n      }\n\n      if (!er || (er.message && er.message.match(/^SSL Error/))) {\n        if (er) er.code = 'ESSL'\n        return cb(er, parsed, raw, response)\n      }\n\n      // Only retry on 408, 5xx or no `response`.\n      var statusCode = response && response.statusCode\n\n      var timeout = statusCode === 408\n      var serverError = statusCode >= 500\n      var statusRetry = !statusCode || timeout || serverError\n      if (er && statusRetry && operation.retry(er)) {\n        self.log.info('retry', 'will retry, error on last attempt: ' + er)\n        return undefined\n      }\n      cb.apply(null, arguments)\n    })\n  })\n}\n\nfunction makeRequest (uri, params, cb_) {\n  var socket\n  var cb = once(function (er, parsed, raw, response) {\n    if (socket) {\n      // The socket might be returned to a pool for re-use, so don’t keep\n      // the 'error' listener from here attached.\n      socket.removeListener('error', cb)\n    }\n\n    return cb_(er, parsed, raw, response)\n  })\n\n  var parsed = url.parse(uri)\n  var headers = {}\n\n  // metadata should be compressed\n  headers['accept-encoding'] = 'gzip'\n\n  // metadata should be minified, if the registry supports it\n\n  var er = this.authify(params.authed, parsed, headers, params.auth)\n  if (er) return cb_(er)\n\n  var useCorgi = params.fullMetadata == null ? false : !params.fullMetadata\n\n  var opts = this.initialize(\n    parsed,\n    params.method,\n    useCorgi ? 'application/vnd.npm.install-v1+json; q=1.0, application/json; q=0.8, */*' : 'application/json',\n    headers\n  )\n\n  opts.followRedirect = (typeof params.follow === 'boolean' ? params.follow : true)\n  opts.encoding = null // tell request let body be Buffer instance\n\n  if (params.etag) {\n    this.log.verbose('etag', params.etag)\n    headers[params.method === 'GET' ? 'if-none-match' : 'if-match'] = params.etag\n  }\n\n  if (params.lastModified && params.method === 'GET') {\n    this.log.verbose('lastModified', params.lastModified)\n    headers['if-modified-since'] = params.lastModified\n  }\n\n  // figure out wth body is\n  if (params.body) {\n    if (Buffer.isBuffer(params.body)) {\n      opts.body = params.body\n      headers['content-type'] = 'application/json'\n      headers['content-length'] = params.body.length\n    } else if (typeof params.body === 'string') {\n      opts.body = params.body\n      headers['content-type'] = 'application/json'\n      headers['content-length'] = Buffer.byteLength(params.body)\n    } else if (params.body instanceof Stream) {\n      headers['content-type'] = 'application/octet-stream'\n      if (params.body.size) headers['content-length'] = params.body.size\n    } else {\n      delete params.body._etag\n      delete params.body._lastModified\n      opts.json = params.body\n    }\n  }\n\n  this.log.http('request', params.method, parsed.href || '/')\n\n  var done = requestDone.call(this, params.method, uri, cb)\n  var req = request(opts, params.streaming ? undefined : decodeResponseBody(done))\n\n  req.on('error', cb)\n\n  // This should not be necessary, as the HTTP implementation in Node\n  // passes errors occurring on the socket to the request itself. Being overly\n  // cautious comes at a low cost, though.\n  req.on('socket', function (s) {\n    socket = s\n    socket.on('error', cb)\n  })\n\n  if (params.streaming) {\n    req.on('response', function (response) {\n      if (response.statusCode >= 400) {\n        var parts = []\n        response.on('data', function (data) {\n          parts.push(data)\n        })\n        response.on('end', function () {\n          decodeResponseBody(done)(null, response, Buffer.concat(parts))\n        })\n      } else {\n        response.on('end', function () {\n          // don't ever re-use connections that had server errors.\n          // those sockets connect to the Bad Place!\n          if (response.socket && response.statusCode > 500) {\n            response.socket.destroy()\n          }\n        })\n\n        return cb(null, response)\n      }\n    })\n  }\n\n  if (params.body && (params.body instanceof Stream)) {\n    params.body.pipe(req)\n  }\n}\n\nfunction decodeResponseBody (cb) {\n  return function (er, response, data) {\n    if (er) return cb(er, response, data)\n\n    // don't ever re-use connections that had server errors.\n    // those sockets connect to the Bad Place!\n    if (response.socket && response.statusCode > 500) {\n      response.socket.destroy()\n    }\n\n    if (response.headers['content-encoding'] !== 'gzip') {\n      return cb(er, response, data)\n    }\n\n    zlib.gunzip(data, function (er, buf) {\n      if (er) return cb(er, response, data)\n\n      cb(null, response, buf)\n    })\n  }\n}\n\n// cb(er, parsed, raw, response)\nfunction requestDone (method, where, cb) {\n  return function (er, response, data) {\n    if (er) return cb(er)\n\n    var urlObj = url.parse(where)\n    if (urlObj.auth) urlObj.auth = '***'\n    this.log.http(response.statusCode, url.format(urlObj))\n\n    if (Buffer.isBuffer(data)) {\n      data = data.toString()\n    }\n\n    var parsed\n    if (data && typeof data === 'string' && response.statusCode !== 304) {\n      try {\n        parsed = JSON.parse(data)\n      } catch (ex) {\n        ex.message += '\\n' + data\n        this.log.verbose('bad json', data)\n        this.log.error('registry', 'error parsing json')\n        return cb(ex, null, data, response)\n      }\n    } else if (data) {\n      parsed = data\n      data = JSON.stringify(parsed)\n    }\n\n    // expect data with any error codes\n    if (!data && response.statusCode >= 400) {\n      var code = response.statusCode\n      return cb(\n        makeError(code + ' ' + STATUS_CODES[code], null, code),\n        null,\n        data,\n        response\n      )\n    }\n\n    er = null\n    if (parsed && response.headers.etag) {\n      parsed._etag = response.headers.etag\n    }\n\n    if (parsed && response.headers['last-modified']) {\n      parsed._lastModified = response.headers['last-modified']\n    }\n\n    // for the search endpoint, the 'error' property can be an object\n    if ((parsed && parsed.error && typeof parsed.error !== 'object') ||\n        response.statusCode >= 400) {\n      var w = url.parse(where).pathname.substr(1)\n      var name\n      if (!w.match(/^-/)) {\n        w = w.split('/')\n        var index = w.indexOf('_rewrite')\n        if (index === -1) {\n          index = w.length - 1\n        } else {\n          index++\n        }\n        name = decodeURIComponent(w[index])\n      }\n\n      if (!parsed.error) {\n        er = makeError(\n          'Registry returned ' + response.statusCode +\n          ' for ' + method +\n          ' on ' + where,\n          name,\n          response.statusCode\n        )\n      } else if (name && parsed.error === 'not_found') {\n        er = makeError('404 Not Found: ' + name, name, response.statusCode)\n      } else if (name && parsed.error === 'User not found') {\n        er = makeError('User not found. Check `npm whoami` and make sure you have a NPM account.', name, response.statusCode)\n      } else {\n        er = makeError(\n          parsed.error + ' ' + (parsed.reason || '') + ': ' + (name || w),\n          name,\n          response.statusCode\n        )\n      }\n    }\n    return cb(er, parsed, data, response)\n  }.bind(this)\n}\n\nfunction makeError (message, name, code) {\n  var er = new Error(message)\n  if (name) er.pkgid = name\n  if (code) {\n    er.statusCode = code\n    er.code = 'E' + code\n  }\n  return er\n}\n"]}
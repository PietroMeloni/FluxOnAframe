{"version":3,"sources":["../../../../../../node_modules/npm/node_modules/fstream/lib/reader.js"],"names":["module","exports","Reader","fs","require","Stream","inherits","path","getType","hardLinks","Abstract","LinkReader","props","currentStat","self","type","ClassType","call","error","readable","writable","depth","parent","root","_path","resolve","process","platform","replace","length","_swallowErrors","basename","dirname","size","filter","sort","alphasort","_stat","a","b","toLowerCase","prototype","stat","follow","nextTick","statCb","bind","er","props_","Object","keys","forEach","k","undefined","handleHardlinks","hardlinks","nlink","dev","ino","Link","linkpath","_read","who","_proxy","_disowned","abort","emit","events","e","go","_aborted","_paused","once","ev","pipe","dest","add","on","entry","ret","pause","apply","arguments","_stream","resume"],"mappings":"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","file":"reader.js","sourcesContent":["module.exports = Reader\n\nvar fs = require('graceful-fs')\nvar Stream = require('stream').Stream\nvar inherits = require('inherits')\nvar path = require('path')\nvar getType = require('./get-type.js')\nvar hardLinks = Reader.hardLinks = {}\nvar Abstract = require('./abstract.js')\n\n// Must do this *before* loading the child classes\ninherits(Reader, Abstract)\n\nvar LinkReader = require('./link-reader.js')\n\nfunction Reader (props, currentStat) {\n  var self = this\n  if (!(self instanceof Reader)) return new Reader(props, currentStat)\n\n  if (typeof props === 'string') {\n    props = { path: props }\n  }\n\n  // polymorphism.\n  // call fstream.Reader(dir) to get a DirReader object, etc.\n  // Note that, unlike in the Writer case, ProxyReader is going\n  // to be the *normal* state of affairs, since we rarely know\n  // the type of a file prior to reading it.\n\n  var type\n  var ClassType\n\n  if (props.type && typeof props.type === 'function') {\n    type = props.type\n    ClassType = type\n  } else {\n    type = getType(props)\n    ClassType = Reader\n  }\n\n  if (currentStat && !type) {\n    type = getType(currentStat)\n    props[type] = true\n    props.type = type\n  }\n\n  switch (type) {\n    case 'Directory':\n      ClassType = require('./dir-reader.js')\n      break\n\n    case 'Link':\n    // XXX hard links are just files.\n    // However, it would be good to keep track of files' dev+inode\n    // and nlink values, and create a HardLinkReader that emits\n    // a linkpath value of the original copy, so that the tar\n    // writer can preserve them.\n    // ClassType = HardLinkReader\n    // break\n\n    case 'File':\n      ClassType = require('./file-reader.js')\n      break\n\n    case 'SymbolicLink':\n      ClassType = LinkReader\n      break\n\n    case 'Socket':\n      ClassType = require('./socket-reader.js')\n      break\n\n    case null:\n      ClassType = require('./proxy-reader.js')\n      break\n  }\n\n  if (!(self instanceof ClassType)) {\n    return new ClassType(props)\n  }\n\n  Abstract.call(self)\n\n  if (!props.path) {\n    self.error('Must provide a path', null, true)\n  }\n\n  self.readable = true\n  self.writable = false\n\n  self.type = type\n  self.props = props\n  self.depth = props.depth = props.depth || 0\n  self.parent = props.parent || null\n  self.root = props.root || (props.parent && props.parent.root) || self\n\n  self._path = self.path = path.resolve(props.path)\n  if (process.platform === 'win32') {\n    self.path = self._path = self.path.replace(/\\?/g, '_')\n    if (self._path.length >= 260) {\n      // how DOES one create files on the moon?\n      // if the path has spaces in it, then UNC will fail.\n      self._swallowErrors = true\n      // if (self._path.indexOf(\" \") === -1) {\n      self._path = '\\\\\\\\?\\\\' + self.path.replace(/\\//g, '\\\\')\n    // }\n    }\n  }\n  self.basename = props.basename = path.basename(self.path)\n  self.dirname = props.dirname = path.dirname(self.path)\n\n  // these have served their purpose, and are now just noisy clutter\n  props.parent = props.root = null\n\n  // console.error(\"\\n\\n\\n%s setting size to\", props.path, props.size)\n  self.size = props.size\n  self.filter = typeof props.filter === 'function' ? props.filter : null\n  if (props.sort === 'alpha') props.sort = alphasort\n\n  // start the ball rolling.\n  // this will stat the thing, and then call self._read()\n  // to start reading whatever it is.\n  // console.error(\"calling stat\", props.path, currentStat)\n  self._stat(currentStat)\n}\n\nfunction alphasort (a, b) {\n  return a === b ? 0\n    : a.toLowerCase() > b.toLowerCase() ? 1\n      : a.toLowerCase() < b.toLowerCase() ? -1\n        : a > b ? 1\n          : -1\n}\n\nReader.prototype._stat = function (currentStat) {\n  var self = this\n  var props = self.props\n  var stat = props.follow ? 'stat' : 'lstat'\n  // console.error(\"Reader._stat\", self._path, currentStat)\n  if (currentStat) process.nextTick(statCb.bind(null, null, currentStat))\n  else fs[stat](self._path, statCb)\n\n  function statCb (er, props_) {\n    // console.error(\"Reader._stat, statCb\", self._path, props_, props_.nlink)\n    if (er) return self.error(er)\n\n    Object.keys(props_).forEach(function (k) {\n      props[k] = props_[k]\n    })\n\n    // if it's not the expected size, then abort here.\n    if (undefined !== self.size && props.size !== self.size) {\n      return self.error('incorrect size')\n    }\n    self.size = props.size\n\n    var type = getType(props)\n    var handleHardlinks = props.hardlinks !== false\n\n    // special little thing for handling hardlinks.\n    if (handleHardlinks && type !== 'Directory' && props.nlink && props.nlink > 1) {\n      var k = props.dev + ':' + props.ino\n      // console.error(\"Reader has nlink\", self._path, k)\n      if (hardLinks[k] === self._path || !hardLinks[k]) {\n        hardLinks[k] = self._path\n      } else {\n        // switch into hardlink mode.\n        type = self.type = self.props.type = 'Link'\n        self.Link = self.props.Link = true\n        self.linkpath = self.props.linkpath = hardLinks[k]\n        // console.error(\"Hardlink detected, switching mode\", self._path, self.linkpath)\n        // Setting __proto__ would arguably be the \"correct\"\n        // approach here, but that just seems too wrong.\n        self._stat = self._read = LinkReader.prototype._read\n      }\n    }\n\n    if (self.type && self.type !== type) {\n      self.error('Unexpected type: ' + type)\n    }\n\n    // if the filter doesn't pass, then just skip over this one.\n    // still have to emit end so that dir-walking can move on.\n    if (self.filter) {\n      var who = self._proxy || self\n      // special handling for ProxyReaders\n      if (!self.filter.call(who, who, props)) {\n        if (!self._disowned) {\n          self.abort()\n          self.emit('end')\n          self.emit('close')\n        }\n        return\n      }\n    }\n\n    // last chance to abort or disown before the flow starts!\n    var events = ['_stat', 'stat', 'ready']\n    var e = 0\n    ;(function go () {\n      if (self._aborted) {\n        self.emit('end')\n        self.emit('close')\n        return\n      }\n\n      if (self._paused && self.type !== 'Directory') {\n        self.once('resume', go)\n        return\n      }\n\n      var ev = events[e++]\n      if (!ev) {\n        return self._read()\n      }\n      self.emit(ev, props)\n      go()\n    })()\n  }\n}\n\nReader.prototype.pipe = function (dest) {\n  var self = this\n  if (typeof dest.add === 'function') {\n    // piping to a multi-compatible, and we've got directory entries.\n    self.on('entry', function (entry) {\n      var ret = dest.add(entry)\n      if (ret === false) {\n        self.pause()\n      }\n    })\n  }\n\n  // console.error(\"R Pipe apply Stream Pipe\")\n  return Stream.prototype.pipe.apply(this, arguments)\n}\n\nReader.prototype.pause = function (who) {\n  this._paused = true\n  who = who || this\n  this.emit('pause', who)\n  if (this._stream) this._stream.pause(who)\n}\n\nReader.prototype.resume = function (who) {\n  this._paused = false\n  who = who || this\n  this.emit('resume', who)\n  if (this._stream) this._stream.resume(who)\n  this._read()\n}\n\nReader.prototype._read = function () {\n  this.error('Cannot read unknown type: ' + this.type)\n}\n"]}
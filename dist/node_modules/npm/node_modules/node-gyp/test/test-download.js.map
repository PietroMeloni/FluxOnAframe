{"version":3,"sources":["../../../../../../node_modules/npm/node_modules/node-gyp/test/test-download.js"],"names":["fs","require","http","https","test","install","t","plan","server","createServer","req","res","strictEqual","headers","process","version","end","close","host","listen","port","address","gyp","opts","url","download","on","body","setEncoding","data","cert","readFileSync","__dirname","key","cafile","ca","readCAFile","length","options","err","e","ok","message","cas","notStrictEqual"],"mappings":"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","file":"test-download.js","sourcesContent":["'use strict'\n\nvar fs = require('fs')\nvar http = require('http')\nvar https = require('https')\nvar test = require('tape')\nvar install = require('../lib/install')\n\ntest('download over http', function (t) {\n  t.plan(2)\n\n  var server = http.createServer(function (req, res) {\n    t.strictEqual(req.headers['user-agent'],\n                  'node-gyp v42 (node ' + process.version + ')')\n    res.end('ok')\n    server.close()\n  })\n\n  var host = '127.0.0.1'\n  server.listen(0, host, function () {\n    var port = this.address().port\n    var gyp = {\n      opts: {},\n      version: '42',\n    }\n    var url = 'http://' + host + ':' + port\n    var req = install.test.download(gyp, {}, url)\n    req.on('response', function (res) {\n      var body = ''\n      res.setEncoding('utf8')\n      res.on('data', function(data) {\n        body += data\n      })\n      res.on('end', function() {\n        t.strictEqual(body, 'ok')\n      })\n    })\n  })\n})\n\ntest('download over https with custom ca', function (t) {\n  t.plan(3)\n\n  var cert = fs.readFileSync(__dirname + '/fixtures/server.crt', 'utf8')\n  var key = fs.readFileSync(__dirname + '/fixtures/server.key', 'utf8')\n\n  var cafile = __dirname + '/fixtures/ca.crt'\n  var ca = install.test.readCAFile(cafile)\n  t.strictEqual(ca.length, 1)\n\n  var options = { ca: ca, cert: cert, key: key }\n  var server = https.createServer(options, function (req, res) {\n    t.strictEqual(req.headers['user-agent'],\n                  'node-gyp v42 (node ' + process.version + ')')\n    res.end('ok')\n    server.close()\n  })\n\n  server.on('clientError', function (err) {\n    throw err\n  })\n\n  var host = '127.0.0.1'\n  server.listen(8000, host, function () {\n    var port = this.address().port\n    var gyp = {\n      opts: { cafile: cafile },\n      version: '42',\n    }\n    var url = 'https://' + host + ':' + port\n    var req = install.test.download(gyp, {}, url)\n    req.on('response', function (res) {\n      var body = ''\n      res.setEncoding('utf8')\n      res.on('data', function(data) {\n        body += data\n      })\n      res.on('end', function() {\n        t.strictEqual(body, 'ok')\n      })\n    })\n  })\n})\n\ntest('download with missing cafile', function (t) {\n  t.plan(1)\n  var gyp = {\n    opts: { cafile: 'no.such.file' },\n  }\n  try {\n    install.test.download(gyp, {}, 'http://bad/')\n  } catch (e) {\n    t.ok(/no.such.file/.test(e.message))\n  }\n})\n\ntest('check certificate splitting', function (t) {\n  var cas = install.test.readCAFile(__dirname + '/fixtures/ca-bundle.crt')\n  t.plan(2)\n  t.strictEqual(cas.length, 2)\n  t.notStrictEqual(cas[0], cas[1])\n})\n"]}
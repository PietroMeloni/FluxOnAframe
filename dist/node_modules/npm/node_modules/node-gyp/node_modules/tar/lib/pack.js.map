{"version":3,"sources":["../../../../../../../../node_modules/npm/node_modules/node-gyp/node_modules/tar/lib/pack.js"],"names":["module","exports","Pack","EntryWriter","require","Stream","path","inherits","GlobalHeaderWriter","collect","eof","Buffer","i","props","me","_noProprietary","noProprietary","_global","readable","writable","_buffer","_currentEntry","_processing","_pipeRoot","on","src","root","add","prototype","addGlobal","_didGlobal","c","emit","end","stream","_ended","Error","push","_process","_needDrain","length","pause","_paused","resume","entry","shift","ready","unshift","dirname","fromBase","wprops","Object","keys","forEach","k","relative","process","platform","replace","type","size","lp","resolve","linkpath","writer","parent","toJSON","toString","split","join","nextEntry","ended","er","pipe","destroy","write"],"mappings":";;AAAA;AACA;;AAEAA,OAAOC,OAAP,GAAiBC,IAAjB;;AAEA,IAAIC,cAAcC,QAAQ,mBAAR,CAAlB;AAAA,IACIC,SAASD,QAAQ,QAAR,EAAkBC,MAD/B;AAAA,IAEIC,OAAOF,QAAQ,MAAR,CAFX;AAAA,IAGIG,WAAWH,QAAQ,UAAR,CAHf;AAAA,IAIII,qBAAqBJ,QAAQ,2BAAR,CAJzB;AAAA,IAKIK,UAAUL,QAAQ,SAAR,EAAmBK,OALjC;AAAA,IAMIC,MAAM,IAAIC,MAAJ,CAAW,GAAX,CANV;;AAQA,KAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAI,GAApB,EAAyBA,GAAzB;AAA+BF,MAAIE,CAAJ,IAAS,CAAT;AAA/B,CAEAL,SAASL,IAAT,EAAeG,MAAf;;AAEA,SAASH,IAAT,CAAeW,KAAf,EAAsB;AACpB;AACA,MAAIC,KAAK,IAAT;AACA,MAAI,EAAEA,cAAcZ,IAAhB,CAAJ,EAA2B,OAAO,IAAIA,IAAJ,CAASW,KAAT,CAAP;;AAE3B,MAAIA,KAAJ,EAAWC,GAAGC,cAAH,GAAoBF,MAAMG,aAA1B,CAAX,KACKF,GAAGC,cAAH,GAAoB,KAApB;;AAELD,KAAGG,OAAH,GAAaJ,KAAb;;AAEAC,KAAGI,QAAH,GAAc,IAAd;AACAJ,KAAGK,QAAH,GAAc,IAAd;AACAL,KAAGM,OAAH,GAAa,EAAb;AACA;AACAN,KAAGO,aAAH,GAAmB,IAAnB;AACAP,KAAGQ,WAAH,GAAiB,KAAjB;;AAEAR,KAAGS,SAAH,GAAe,IAAf;AACAT,KAAGU,EAAH,CAAM,MAAN,EAAc,UAAUC,GAAV,EAAe;AAC3B,QAAIA,IAAIC,IAAJ,KAAaZ,GAAGS,SAApB,EAA+B;AAC/BT,OAAGS,SAAH,GAAeE,GAAf;AACAA,QAAID,EAAJ,CAAO,KAAP,EAAc,YAAY;AACxBV,SAAGS,SAAH,GAAe,IAAf;AACD,KAFD;AAGAT,OAAGa,GAAH,CAAOF,GAAP;AACD,GAPD;AAQD;;AAEDvB,KAAK0B,SAAL,CAAeC,SAAf,GAA2B,UAAUhB,KAAV,EAAiB;AAC1C;AACA,MAAI,KAAKiB,UAAT,EAAqB;AACrB,OAAKA,UAAL,GAAkB,IAAlB;;AAEA,MAAIhB,KAAK,IAAT;AACAN,qBAAmBK,KAAnB,EACGW,EADH,CACM,MADN,EACc,UAAUO,CAAV,EAAa;AACvBjB,OAAGkB,IAAH,CAAQ,MAAR,EAAgBD,CAAhB;AACD,GAHH,EAIGE,GAJH;AAKD,CAXD;;AAaA/B,KAAK0B,SAAL,CAAeD,GAAf,GAAqB,UAAUO,MAAV,EAAkB;AACrC,MAAI,KAAKjB,OAAL,IAAgB,CAAC,KAAKa,UAA1B,EAAsC,KAAKD,SAAL,CAAe,KAAKZ,OAApB;;AAEtC,MAAI,KAAKkB,MAAT,EAAiB,OAAO,KAAKH,IAAL,CAAU,OAAV,EAAmB,IAAII,KAAJ,CAAU,eAAV,CAAnB,CAAP;;AAEjB3B,UAAQyB,MAAR;AACA,OAAKd,OAAL,CAAaiB,IAAb,CAAkBH,MAAlB;AACA,OAAKI,QAAL;AACA,OAAKC,UAAL,GAAkB,KAAKnB,OAAL,CAAaoB,MAAb,GAAsB,CAAxC;AACA,SAAO,CAAC,KAAKD,UAAb;AACD,CAVD;;AAYArC,KAAK0B,SAAL,CAAea,KAAf,GAAuB,YAAY;AACjC,OAAKC,OAAL,GAAe,IAAf;AACA,MAAI,KAAKrB,aAAT,EAAwB,KAAKA,aAAL,CAAmBoB,KAAnB;AACxB,OAAKT,IAAL,CAAU,OAAV;AACD,CAJD;;AAMA9B,KAAK0B,SAAL,CAAee,MAAf,GAAwB,YAAY;AAClC,OAAKD,OAAL,GAAe,KAAf;AACA,MAAI,KAAKrB,aAAT,EAAwB,KAAKA,aAAL,CAAmBsB,MAAnB;AACxB,OAAKX,IAAL,CAAU,QAAV;AACA,OAAKM,QAAL;AACD,CALD;;AAOApC,KAAK0B,SAAL,CAAeK,GAAf,GAAqB,YAAY;AAC/B,OAAKE,MAAL,GAAc,IAAd;AACA,OAAKf,OAAL,CAAaiB,IAAb,CAAkB3B,GAAlB;AACA,OAAK4B,QAAL;AACD,CAJD;;AAMApC,KAAK0B,SAAL,CAAeU,QAAf,GAA0B,YAAY;AACpC,MAAIxB,KAAK,IAAT;AACA,MAAIA,GAAG4B,OAAH,IAAc5B,GAAGQ,WAArB,EAAkC;AAChC;AACD;;AAED,MAAIsB,QAAQ9B,GAAGM,OAAH,CAAWyB,KAAX,EAAZ;;AAEA,MAAI,CAACD,KAAL,EAAY;AACV,QAAI9B,GAAGyB,UAAP,EAAmB;AACjBzB,SAAGkB,IAAH,CAAQ,OAAR;AACD;AACD;AACD;;AAED,MAAIY,MAAME,KAAN,KAAgB,KAApB,EAA2B;AACzB;AACAhC,OAAGM,OAAH,CAAW2B,OAAX,CAAmBH,KAAnB;AACAA,UAAMpB,EAAN,CAAS,OAAT,EAAkB,YAAY;AAC5B;AACAV,SAAGwB,QAAH;AACD,KAHD;AAIA;AACD;;AAEDxB,KAAGQ,WAAH,GAAiB,IAAjB;;AAEA,MAAIsB,UAAUlC,GAAd,EAAmB;AACjB;AACAI,OAAGkB,IAAH,CAAQ,MAAR,EAAgBtB,GAAhB;AACAI,OAAGkB,IAAH,CAAQ,MAAR,EAAgBtB,GAAhB;AACAI,OAAGkB,IAAH,CAAQ,KAAR;AACAlB,OAAGkB,IAAH,CAAQ,OAAR;AACA;AACD;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,MAAIN,OAAOpB,KAAK0C,OAAL,CAAa,CAACJ,MAAMlB,IAAN,IAAckB,KAAf,EAAsBtC,IAAnC,CAAX;AACA,MAAIQ,GAAGG,OAAH,IAAcH,GAAGG,OAAH,CAAWgC,QAAzB,IAAqCL,MAAMlB,IAA3C,IAAmDkB,MAAMlB,IAAN,CAAWpB,IAAlE,EAAwE;AACtE;AACAoB,WAAOkB,MAAMlB,IAAN,CAAWpB,IAAlB;AACD;;AAED,MAAI4C,SAAS,EAAb;;AAEAC,SAAOC,IAAP,CAAYR,MAAM/B,KAAN,IAAe,EAA3B,EAA+BwC,OAA/B,CAAuC,UAAUC,CAAV,EAAa;AAClDJ,WAAOI,CAAP,IAAYV,MAAM/B,KAAN,CAAYyC,CAAZ,CAAZ;AACD,GAFD;;AAIA,MAAIxC,GAAGC,cAAP,EAAuBmC,OAAOlC,aAAP,GAAuB,IAAvB;;AAEvBkC,SAAO5C,IAAP,GAAcA,KAAKiD,QAAL,CAAc7B,IAAd,EAAoBkB,MAAMtC,IAAN,IAAc,EAAlC,CAAd;;AAEA;AACA,MAAIkD,QAAQC,QAAR,KAAqB,OAAzB,EAAkC;AAChCP,WAAO5C,IAAP,GAAc4C,OAAO5C,IAAP,CAAYoD,OAAZ,CAAoB,KAApB,EAA2B,GAA3B,CAAd;AACD;;AAED,MAAI,CAACR,OAAOS,IAAZ,EACET,OAAOS,IAAP,GAAc,WAAd;;AAEF,UAAQT,OAAOS,IAAf;AACE;AACA,SAAK,QAAL;AACE;;AAEF,SAAK,WAAL;AACET,aAAO5C,IAAP,IAAe,GAAf;AACA4C,aAAOU,IAAP,GAAc,CAAd;AACA;;AAEF,SAAK,MAAL;AACE,UAAIC,KAAKvD,KAAKwD,OAAL,CAAaxD,KAAK0C,OAAL,CAAaJ,MAAMtC,IAAnB,CAAb,EAAuCsC,MAAMmB,QAA7C,CAAT;AACAb,aAAOa,QAAP,GAAkBzD,KAAKiD,QAAL,CAAc7B,IAAd,EAAoBmC,EAApB,KAA2B,GAA7C;AACAX,aAAOU,IAAP,GAAc,CAAd;AACA;;AAEF,SAAK,cAAL;AACE,UAAIC,KAAKvD,KAAKwD,OAAL,CAAaxD,KAAK0C,OAAL,CAAaJ,MAAMtC,IAAnB,CAAb,EAAuCsC,MAAMmB,QAA7C,CAAT;AACAb,aAAOa,QAAP,GAAkBzD,KAAKiD,QAAL,CAAcjD,KAAK0C,OAAL,CAAaJ,MAAMtC,IAAnB,CAAd,EAAwCuD,EAAxC,KAA+C,GAAjE;AACAX,aAAOU,IAAP,GAAc,CAAd;AACA;AApBJ;;AAuBA;AACA;AACA;AACA;;AAEA;AACA,MAAII,SAASlD,GAAGO,aAAH,GAAmBlB,YAAY+C,MAAZ,CAAhC;;AAEAc,SAAOC,MAAP,GAAgBnD,EAAhB;;AAEA;AACA;AACA;;AAEAkD,SAAOxC,EAAP,CAAU,MAAV,EAAkB,UAAUO,CAAV,EAAa;AAC7BjB,OAAGkB,IAAH,CAAQ,MAAR,EAAgBD,CAAhB;AACD,GAFD;;AAIAiC,SAAOxC,EAAP,CAAU,QAAV,EAAoB,YAAY;AAC9Bb,WAAOiB,SAAP,CAAiBsC,MAAjB,GAA0B,YAAY;AACpC,aAAO,KAAKC,QAAL,GAAgBC,KAAhB,CAAsB,IAAtB,EAA4BC,IAA5B,CAAiC,GAAjC,CAAP;AACD,KAFD;AAGA;AACA,QAAIL,OAAOnD,KAAP,CAAa+C,IAAb,KAAsB,CAA1B,EAA6BU;AAC9B,GAND;AAOAN,SAAOxC,EAAP,CAAU,OAAV,EAAmB8C,SAAnB;;AAEA,MAAIC,QAAQ,KAAZ;AACA,WAASD,SAAT,GAAsB;AACpB,QAAIC,KAAJ,EAAW;AACXA,YAAQ,IAAR;;AAEA;AACA;AACAzD,OAAGO,aAAH,GAAmB,IAAnB;AACAP,OAAGQ,WAAH,GAAiB,KAAjB;AACAR,OAAGwB,QAAH;AACD;;AAED0B,SAAOxC,EAAP,CAAU,OAAV,EAAmB,UAAUgD,EAAV,EAAc;AAC/B;AACA1D,OAAGkB,IAAH,CAAQ,OAAR,EAAiBwC,EAAjB;AACD,GAHD;;AAKA;AACA;AACA,MAAI5B,UAAU9B,GAAGS,SAAjB,EAA4B;AAC1B;AACAyC,WAAOrC,GAAP,GAAa,IAAb;AACD;;AAEDiB,QAAM6B,IAAN,CAAWT,MAAX;AACD,CA/ID;;AAiJA9D,KAAK0B,SAAL,CAAe8C,OAAf,GAAyB,YAAY,CAAE,CAAvC;AACAxE,KAAK0B,SAAL,CAAe+C,KAAf,GAAuB,YAAY,CAAE,CAArC","file":"pack.js","sourcesContent":["// pipe in an fstream, and it'll make a tarball.\n// key-value pair argument is global extended header props.\n\nmodule.exports = Pack\n\nvar EntryWriter = require(\"./entry-writer.js\")\n  , Stream = require(\"stream\").Stream\n  , path = require(\"path\")\n  , inherits = require(\"inherits\")\n  , GlobalHeaderWriter = require(\"./global-header-writer.js\")\n  , collect = require(\"fstream\").collect\n  , eof = new Buffer(512)\n\nfor (var i = 0; i < 512; i ++) eof[i] = 0\n\ninherits(Pack, Stream)\n\nfunction Pack (props) {\n  // console.error(\"-- p ctor\")\n  var me = this\n  if (!(me instanceof Pack)) return new Pack(props)\n\n  if (props) me._noProprietary = props.noProprietary\n  else me._noProprietary = false\n\n  me._global = props\n\n  me.readable = true\n  me.writable = true\n  me._buffer = []\n  // console.error(\"-- -- set current to null in ctor\")\n  me._currentEntry = null\n  me._processing = false\n\n  me._pipeRoot = null\n  me.on(\"pipe\", function (src) {\n    if (src.root === me._pipeRoot) return\n    me._pipeRoot = src\n    src.on(\"end\", function () {\n      me._pipeRoot = null\n    })\n    me.add(src)\n  })\n}\n\nPack.prototype.addGlobal = function (props) {\n  // console.error(\"-- p addGlobal\")\n  if (this._didGlobal) return\n  this._didGlobal = true\n\n  var me = this\n  GlobalHeaderWriter(props)\n    .on(\"data\", function (c) {\n      me.emit(\"data\", c)\n    })\n    .end()\n}\n\nPack.prototype.add = function (stream) {\n  if (this._global && !this._didGlobal) this.addGlobal(this._global)\n\n  if (this._ended) return this.emit(\"error\", new Error(\"add after end\"))\n\n  collect(stream)\n  this._buffer.push(stream)\n  this._process()\n  this._needDrain = this._buffer.length > 0\n  return !this._needDrain\n}\n\nPack.prototype.pause = function () {\n  this._paused = true\n  if (this._currentEntry) this._currentEntry.pause()\n  this.emit(\"pause\")\n}\n\nPack.prototype.resume = function () {\n  this._paused = false\n  if (this._currentEntry) this._currentEntry.resume()\n  this.emit(\"resume\")\n  this._process()\n}\n\nPack.prototype.end = function () {\n  this._ended = true\n  this._buffer.push(eof)\n  this._process()\n}\n\nPack.prototype._process = function () {\n  var me = this\n  if (me._paused || me._processing) {\n    return\n  }\n\n  var entry = me._buffer.shift()\n\n  if (!entry) {\n    if (me._needDrain) {\n      me.emit(\"drain\")\n    }\n    return\n  }\n\n  if (entry.ready === false) {\n    // console.error(\"-- entry is not ready\", entry)\n    me._buffer.unshift(entry)\n    entry.on(\"ready\", function () {\n      // console.error(\"-- -- ready!\", entry)\n      me._process()\n    })\n    return\n  }\n\n  me._processing = true\n\n  if (entry === eof) {\n    // need 2 ending null blocks.\n    me.emit(\"data\", eof)\n    me.emit(\"data\", eof)\n    me.emit(\"end\")\n    me.emit(\"close\")\n    return\n  }\n\n  // Change the path to be relative to the root dir that was\n  // added to the tarball.\n  //\n  // XXX This should be more like how -C works, so you can\n  // explicitly set a root dir, and also explicitly set a pathname\n  // in the tarball to use.  That way we can skip a lot of extra\n  // work when resolving symlinks for bundled dependencies in npm.\n\n  var root = path.dirname((entry.root || entry).path);\n  if (me._global && me._global.fromBase && entry.root && entry.root.path) {\n    // user set 'fromBase: true' indicating tar root should be directory itself\n    root = entry.root.path;\n  }\n\n  var wprops = {}\n\n  Object.keys(entry.props || {}).forEach(function (k) {\n    wprops[k] = entry.props[k]\n  })\n\n  if (me._noProprietary) wprops.noProprietary = true\n\n  wprops.path = path.relative(root, entry.path || '')\n\n  // actually not a matter of opinion or taste.\n  if (process.platform === \"win32\") {\n    wprops.path = wprops.path.replace(/\\\\/g, \"/\")\n  }\n\n  if (!wprops.type)\n    wprops.type = 'Directory'\n\n  switch (wprops.type) {\n    // sockets not supported\n    case \"Socket\":\n      return\n\n    case \"Directory\":\n      wprops.path += \"/\"\n      wprops.size = 0\n      break\n\n    case \"Link\":\n      var lp = path.resolve(path.dirname(entry.path), entry.linkpath)\n      wprops.linkpath = path.relative(root, lp) || \".\"\n      wprops.size = 0\n      break\n\n    case \"SymbolicLink\":\n      var lp = path.resolve(path.dirname(entry.path), entry.linkpath)\n      wprops.linkpath = path.relative(path.dirname(entry.path), lp) || \".\"\n      wprops.size = 0\n      break\n  }\n\n  // console.error(\"-- new writer\", wprops)\n  // if (!wprops.type) {\n  //   // console.error(\"-- no type?\", entry.constructor.name, entry)\n  // }\n\n  // console.error(\"-- -- set current to new writer\", wprops.path)\n  var writer = me._currentEntry = EntryWriter(wprops)\n\n  writer.parent = me\n\n  // writer.on(\"end\", function () {\n  //   // console.error(\"-- -- writer end\", writer.path)\n  // })\n\n  writer.on(\"data\", function (c) {\n    me.emit(\"data\", c)\n  })\n\n  writer.on(\"header\", function () {\n    Buffer.prototype.toJSON = function () {\n      return this.toString().split(/\\0/).join(\".\")\n    }\n    // console.error(\"-- -- writer header %j\", writer.props)\n    if (writer.props.size === 0) nextEntry()\n  })\n  writer.on(\"close\", nextEntry)\n\n  var ended = false\n  function nextEntry () {\n    if (ended) return\n    ended = true\n\n    // console.error(\"-- -- writer close\", writer.path)\n    // console.error(\"-- -- set current to null\", wprops.path)\n    me._currentEntry = null\n    me._processing = false\n    me._process()\n  }\n\n  writer.on(\"error\", function (er) {\n    // console.error(\"-- -- writer error\", writer.path)\n    me.emit(\"error\", er)\n  })\n\n  // if it's the root, then there's no need to add its entries,\n  // or data, since they'll be added directly.\n  if (entry === me._pipeRoot) {\n    // console.error(\"-- is the root, don't auto-add\")\n    writer.add = null\n  }\n\n  entry.pipe(writer)\n}\n\nPack.prototype.destroy = function () {}\nPack.prototype.write = function () {}\n"]}
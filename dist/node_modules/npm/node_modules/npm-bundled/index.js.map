{"version":3,"sources":["../../../../../node_modules/npm/node_modules/npm-bundled/index.js"],"names":["fs","require","path","EE","EventEmitter","BundleWalker","opt","resolve","process","cwd","parent","result","base","basename","scope","dirname","add","test","root","packageJsonCache","Set","Map","didDone","children","node_modules","package","bundle","res","Array","from","emit","pj","has","onPackage","get","readPackageJson","readFile","er","data","done","onPackageJson","JSON","parse","set","pkg","bdRaw","Object","keys","dependencies","concat","optionalDependencies","bundleDependencies","bundledDependencies","bd","isArray","length","nm","readModules","readdirNodeModules","onReaddir","forEach","childDep","dep","indexOf","child","p","on","start","BundleWalkerSync","readFileSync","readdirNodeModulesSync","cb","readdir","scopes","filter","f","unscoped","count","pkgs","push","apply","map","readdirSync","reduce","a","b","walk","options","callback","Promise","reject","then","walkSync","module","exports","sync"],"mappings":"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","file":"index.js","sourcesContent":["'use strict'\n\n// walk the tree of deps starting from the top level list of bundled deps\n// Any deps at the top level that are depended on by a bundled dep that\n// does not have that dep in its own node_modules folder are considered\n// bundled deps as well.  This list of names can be passed to npm-packlist\n// as the \"bundled\" argument.  Additionally, packageJsonCache is shared so\n// packlist doesn't have to re-read files already consumed in this pass\n\nconst fs = require('fs')\nconst path = require('path')\nconst EE = require('events').EventEmitter\n\nclass BundleWalker extends EE {\n  constructor (opt) {\n    opt = opt || {}\n    super(opt)\n    this.path = path.resolve(opt.path || process.cwd())\n\n    this.parent = opt.parent || null\n    if (this.parent) {\n      this.result = this.parent.result\n      // only collect results in node_modules folders at the top level\n      // since the node_modules in a bundled dep is included always\n      if (!this.parent.parent) {\n        const base = path.basename(this.path)\n        const scope = path.basename(path.dirname(this.path))\n        this.result.add(/^@/.test(scope) ? scope + '/' + base : base)\n      }\n      this.root = this.parent.root\n      this.packageJsonCache = this.parent.packageJsonCache\n    } else {\n      this.result = new Set()\n      this.root = this.path\n      this.packageJsonCache = opt.packageJsonCache || new Map()\n    }\n\n    this.didDone = false\n    this.children = 0\n    this.node_modules = []\n    this.package = null\n    this.bundle = null\n  }\n\n  done () {\n    if (!this.didDone) {\n      this.didDone = true\n      if (!this.parent) {\n        const res = Array.from(this.result)\n        this.result = res\n        this.emit('done', res)\n      } else {\n        this.emit('done')\n      }\n    }\n  }\n\n  start () {\n    const pj = this.path + '/package.json'\n    if (this.packageJsonCache.has(pj))\n      this.onPackage(this.packageJsonCache.get(pj))\n    else\n      this.readPackageJson(pj)\n    return this\n  }\n\n  readPackageJson (pj) {\n    fs.readFile(pj, (er, data) =>\n      er ? this.done() : this.onPackageJson(pj, data))\n  }\n\n  onPackageJson (pj, data) {\n    try {\n      this.package = JSON.parse(data + '')\n    } catch (er) {\n      return this.done()\n    }\n    this.packageJsonCache.set(pj, this.package)\n    this.onPackage(this.package)\n  }\n\n  onPackage (pkg) {\n    // all deps are bundled if we got here as a child.\n    // otherwise, only bundle bundledDeps\n    // Get a unique-ified array with a short-lived Set\n    const bdRaw = this.parent\n      ? Object.keys(pkg.dependencies || {}).concat(\n        Object.keys(pkg.optionalDependencies || {}))\n      : pkg.bundleDependencies || pkg.bundledDependencies || []\n\n    const bd = Array.from(new Set(\n      Array.isArray(bdRaw) ? bdRaw : Object.keys(bdRaw)))\n\n    if (!bd.length)\n      return this.done()\n\n    this.bundle = bd\n    const nm = this.path + '/node_modules'\n    this.readModules()\n  }\n\n  readModules () {\n    readdirNodeModules(this.path + '/node_modules', (er, nm) =>\n      er ? this.onReaddir([]) : this.onReaddir(nm))\n  }\n\n  onReaddir (nm) {\n    // keep track of what we have, in case children need it\n    this.node_modules = nm\n\n    this.bundle.forEach(dep => this.childDep(dep))\n    if (this.children === 0)\n      this.done()\n  }\n\n  childDep (dep) {\n    if (this.node_modules.indexOf(dep) !== -1) {\n      this.child(dep)\n    } else if (this.parent) {\n      this.parent.childDep(dep)\n    }\n  }\n\n  child (dep) {\n    const p = this.path + '/node_modules/' + dep\n    this.children += 1\n    const child = new BundleWalker({\n      path: p,\n      parent: this\n    })\n    child.on('done', _ => {\n      if (--this.children === 0)\n        this.done()\n    })\n    child.start()\n  }\n}\n\nclass BundleWalkerSync extends BundleWalker {\n  constructor (opt) {\n    super(opt)\n  }\n\n  start () {\n    super.start()\n    this.done()\n    return this\n  }\n\n  readPackageJson (pj) {\n    try {\n      this.onPackageJson(pj, fs.readFileSync(pj))\n    } catch (er) {}\n    return this\n  }\n\n  readModules () {\n    try {\n      this.onReaddir(readdirNodeModulesSync(this.path + '/node_modules'))\n    } catch (er) {\n      this.onReaddir([])\n    }\n  }\n\n  child (dep) {\n    new BundleWalkerSync({\n      path: this.path + '/node_modules/' + dep,\n      parent: this\n    }).start()\n  }\n}\n\nconst readdirNodeModules = (nm, cb) => {\n  fs.readdir(nm, (er, set) => {\n    if (er)\n      cb(er)\n    else {\n      const scopes = set.filter(f => /^@/.test(f))\n      if (!scopes.length)\n        cb(null, set)\n      else {\n        const unscoped = set.filter(f => !/^@/.test(f))\n        let count = scopes.length\n        scopes.forEach(scope => {\n          fs.readdir(nm + '/' + scope, (er, pkgs) => {\n            if (er || !pkgs.length)\n              unscoped.push(scope)\n            else\n              unscoped.push.apply(unscoped, pkgs.map(p => scope + '/' + p))\n            if (--count === 0)\n              cb(null, unscoped)\n          })\n        })\n      }\n    }\n  })\n}\n\nconst readdirNodeModulesSync = nm => {\n  const set = fs.readdirSync(nm)\n  const unscoped = set.filter(f => !/^@/.test(f))\n  const scopes = set.filter(f => /^@/.test(f)).map(scope => {\n    try {\n      const pkgs = fs.readdirSync(nm + '/' + scope)\n      return pkgs.length ? pkgs.map(p => scope + '/' + p) : [scope]\n    } catch (er) {\n      return [scope]\n    }\n  }).reduce((a, b) => a.concat(b), [])\n  return unscoped.concat(scopes)\n}\n\nconst walk = (options, callback) => {\n  const p = new Promise((resolve, reject) => {\n    new BundleWalker(options).on('done', resolve).on('error', reject).start()\n  })\n  return callback ? p.then(res => callback(null, res), callback) : p\n}\n\nconst walkSync = options => {\n  return new BundleWalkerSync(options).start().result\n}\n\nmodule.exports = walk\nwalk.sync = walkSync\nwalk.BundleWalker = BundleWalker\nwalk.BundleWalkerSync = BundleWalkerSync\n"]}
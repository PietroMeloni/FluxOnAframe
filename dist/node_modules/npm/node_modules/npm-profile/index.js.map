{"version":3,"sources":["../../../../../node_modules/npm/node_modules/npm-profile/index.js"],"names":["fetch","require","defaults","retry","validate","url","os","exports","adduserCouch","loginCouch","adduserWeb","loginWeb","login","adduser","get","set","listTokens","removeToken","createToken","opener","prompter","conf","arguments","catch","er","WebLoginNotSupported","process","emit","creds","then","data","username","password","email","body","create","webAuth","opts","target","resolve","registry","hostname","fetchJSON","method","saveResponse","res","result","content","doneUrl","loginUrl","WebLoginInvalidResponse","doneConf","onDone","status","token","headers","Promise","setTimeout","statusCode","raw","userobj","_id","name","type","roles","date","Date","toISOString","logObj","Object","keys","forEach","k","encodeURIComponent","assign","err","code","message","req","_rev","auth","basic","profile","key","untilLastPage","href","objects","concat","urls","next","tokenKey","readonly","cidrs","props","cidr_whitelist","FetchError","HttpErrorBase","pkgid","packageName","Error","HttpErrorGeneral","error","captureStackTrace","HttpErrorAuthOTP","HttpErrorAuthIPAddress","HttpErrorAuthUnknown","authHeaders","otp","Buffer","from","toString","fetchOpts","JSON","stringify","has","json","buffer","parse","_","retVal","statusText","split","map","s","toLowerCase","indexOf","basePath","pathname","substr","match","index","length","decodeURIComponent"],"mappings":"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","file":"index.js","sourcesContent":["'use strict'\nconst fetch = require('make-fetch-happen').defaults({retry: false})\nconst validate = require('aproba')\nconst url = require('url')\nconst os = require('os')\n\nexports.adduserCouch = adduserCouch\nexports.loginCouch = loginCouch\nexports.adduserWeb = adduserWeb\nexports.loginWeb = loginWeb\nexports.login = login\nexports.adduser = adduser\nexports.get = get\nexports.set = set\nexports.listTokens = listTokens\nexports.removeToken = removeToken\nexports.createToken = createToken\n\n// try loginWeb, catch the \"not supported\" message and fall back to couch\nfunction login (opener, prompter, conf) {\n  validate('FFO', arguments)\n  return loginWeb(opener, conf).catch(er => {\n    if (er instanceof WebLoginNotSupported) {\n      process.emit('log', 'verbose', 'web login not supported, trying couch')\n      return prompter(conf.creds)\n        .then(data => loginCouch(data.username, data.password, conf))\n    } else {\n      throw er\n    }\n  })\n}\n\nfunction adduser (opener, prompter, conf) {\n  validate('FFO', arguments)\n  return adduserWeb(opener, conf).catch(er => {\n    if (er instanceof WebLoginNotSupported) {\n      process.emit('log', 'verbose', 'web adduser not supported, trying couch')\n      return prompter(conf.creds)\n        .then(data => adduserCouch(data.username, data.email, data.password, conf))\n    } else {\n      throw er\n    }\n  })\n}\n\nfunction adduserWeb (opener, conf) {\n  validate('FO', arguments)\n  const body = { create: true }\n  process.emit('log', 'verbose', 'web adduser', 'before first POST')\n  return webAuth(opener, conf, body)\n}\n\nfunction loginWeb (opener, conf) {\n  validate('FO', arguments)\n  process.emit('log', 'verbose', 'web login', 'before first POST')\n  return webAuth(opener, conf, {})\n}\n\nfunction webAuth (opener, conf, body) {\n  if (!conf.opts) conf.opts = {}\n  const target = url.resolve(conf.registry, '-/v1/login')\n  body.hostname = conf.hostname || os.hostname()\n  return fetchJSON({\n    target: target,\n    method: 'POST',\n    body: body,\n    opts: conf.opts,\n    saveResponse: true\n  }).then(result => {\n    const res = result[0]\n    const content = result[1]\n    process.emit('log', 'verbose', 'web auth', 'got response', content)\n    const doneUrl = content.doneUrl\n    const loginUrl = content.loginUrl\n    if (typeof doneUrl !== 'string' ||\n        typeof loginUrl !== 'string' ||\n        !doneUrl || !loginUrl) {\n      throw new WebLoginInvalidResponse('POST', target, res, content)\n    }\n    process.emit('log', 'verbose', 'web auth', 'opening url pair')\n    const doneConf = {\n      target: doneUrl,\n      method: 'GET',\n      opts: conf.opts,\n      saveResponse: true\n    }\n    return opener(loginUrl).then(() => fetchJSON(doneConf)).then(onDone)\n    function onDone (result) {\n      const res = result[0]\n      const content = result[1]\n      if (res.status === 200) {\n        if (!content.token) {\n          throw new WebLoginInvalidResponse('GET', doneUrl, res, content)\n        } else {\n          return content\n        }\n      } else if (res.status === 202) {\n        const retry = +res.headers.get('retry-after')\n        if (retry > 0) {\n          return new Promise(resolve => setTimeout(resolve, 1000 * retry))\n            .then(() => fetchJSON(doneConf)).then(onDone)\n        } else {\n          return fetchJSON(doneConf).then(onDone)\n        }\n      } else {\n        throw new WebLoginInvalidResponse('GET', doneUrl, res, content)\n      }\n    }\n  }).catch(er => {\n    if ((er.statusCode >= 400 && er.statusCode <= 499) || er.statusCode === 500) {\n      throw new WebLoginNotSupported('POST', target, {\n        status: er.statusCode,\n        headers: { raw: () => er.headers }\n      }, er.body)\n    } else {\n      throw er\n    }\n  })\n}\n\nfunction adduserCouch (username, email, password, conf) {\n  validate('SSSO', arguments)\n  if (!conf.opts) conf.opts = {}\n  const userobj = {\n    _id: 'org.couchdb.user:' + username,\n    name: username,\n    password: password,\n    email: email,\n    type: 'user',\n    roles: [],\n    date: new Date().toISOString()\n  }\n  const logObj = {}\n  Object.keys(userobj).forEach(k => {\n    logObj[k] = k === 'password' ? 'XXXXX' : userobj[k]\n  })\n  process.emit('log', 'verbose', 'adduser', 'before first PUT', logObj)\n\n  const target = url.resolve(conf.registry, '-/user/org.couchdb.user:' + encodeURIComponent(username))\n\n  return fetchJSON({target: target, method: 'PUT', body: userobj, opts: conf.opts})\n    .then(result => {\n      result.username = username\n      return result\n    })\n}\n\nfunction loginCouch (username, password, conf) {\n  validate('SSO', arguments)\n  const userobj = {\n    _id: 'org.couchdb.user:' + username,\n    name: username,\n    password: password,\n    type: 'user',\n    roles: [],\n    date: new Date().toISOString()\n  }\n  const logObj = {}\n  Object.keys(userobj).forEach(k => {\n    logObj[k] = k === 'password' ? 'XXXXX' : userobj[k]\n  })\n  process.emit('log', 'verbose', 'login', 'before first PUT', logObj)\n\n  const target = url.resolve(conf.registry, '-/user/org.couchdb.user:' + encodeURIComponent(username))\n  return fetchJSON(Object.assign({method: 'PUT', target: target, body: userobj}, conf)).catch(err => {\n    if (err.code === 'E400') {\n      err.message = `There is no user with the username \"${username}\".`\n      throw err\n    }\n    if (err.code !== 'E409') throw err\n    return fetchJSON(Object.assign({method: 'GET', target: target + '?write=true'}, conf)).then(result => {\n      Object.keys(result).forEach(function (k) {\n        if (!userobj[k] || k === 'roles') {\n          userobj[k] = result[k]\n        }\n      })\n      const req = {\n        method: 'PUT',\n        target: target + '/-rev/' + userobj._rev,\n        body: userobj,\n        auth: {\n          basic: {\n            username: username,\n            password: password\n          }\n        }\n      }\n      return fetchJSON(Object.assign({}, conf, req))\n    })\n  }).then(result => {\n    result.username = username\n    return result\n  })\n}\n\nfunction get (conf) {\n  validate('O', arguments)\n  const target = url.resolve(conf.registry, '-/npm/v1/user')\n  return fetchJSON(Object.assign({target: target}, conf))\n}\n\nfunction set (profile, conf) {\n  validate('OO', arguments)\n  const target = url.resolve(conf.registry, '-/npm/v1/user')\n  Object.keys(profile).forEach(key => {\n    // profile keys can't be empty strings, but they CAN be null\n    if (profile[key] === '') profile[key] = null\n  })\n  return fetchJSON(Object.assign({target: target, method: 'POST', body: profile}, conf))\n}\n\nfunction listTokens (conf) {\n  validate('O', arguments)\n\n  return untilLastPage(`-/npm/v1/tokens`)\n\n  function untilLastPage (href, objects) {\n    return fetchJSON(Object.assign({target: url.resolve(conf.registry, href)}, conf)).then(result => {\n      objects = objects ? objects.concat(result.objects) : result.objects\n      if (result.urls.next) {\n        return untilLastPage(result.urls.next, objects)\n      } else {\n        return objects\n      }\n    })\n  }\n}\n\nfunction removeToken (tokenKey, conf) {\n  validate('SO', arguments)\n  const target = url.resolve(conf.registry, `-/npm/v1/tokens/token/${tokenKey}`)\n  return fetchJSON(Object.assign({target: target, method: 'DELETE'}, conf))\n}\n\nfunction createToken (password, readonly, cidrs, conf) {\n  validate('SBAO', arguments)\n  const target = url.resolve(conf.registry, '-/npm/v1/tokens')\n  const props = {\n    password: password,\n    readonly: readonly,\n    cidr_whitelist: cidrs\n  }\n  return fetchJSON(Object.assign({target: target, method: 'POST', body: props}, conf))\n}\n\nfunction FetchError (err, method, target) {\n  err.method = method\n  err.href = target\n  return err\n}\n\nclass HttpErrorBase extends Error {\n  constructor (method, target, res, body) {\n    super()\n    this.headers = res.headers.raw()\n    this.statusCode = res.status\n    this.code = 'E' + res.status\n    this.method = method\n    this.target = target\n    this.body = body\n    this.pkgid = packageName(target)\n  }\n}\n\nclass HttpErrorGeneral extends HttpErrorBase {\n  constructor (method, target, res, body) {\n    super(method, target, res, body)\n    if (body && body.error) {\n      this.message = `Registry returned ${this.statusCode} for ${this.method} on ${this.target}: ${body.error}`\n    } else {\n      this.message = `Registry returned ${this.statusCode} for ${this.method} on ${this.target}`\n    }\n    Error.captureStackTrace(this, HttpErrorGeneral)\n  }\n}\n\nclass WebLoginInvalidResponse extends HttpErrorBase {\n  constructor (method, target, res, body) {\n    super(method, target, res, body)\n    this.message = 'Invalid response from web login endpoint'\n    Error.captureStackTrace(this, WebLoginInvalidResponse)\n  }\n}\n\nclass WebLoginNotSupported extends HttpErrorBase {\n  constructor (method, target, res, body) {\n    super(method, target, res, body)\n    this.message = 'Web login not supported'\n    this.code = 'ENYI'\n    Error.captureStackTrace(this, WebLoginNotSupported)\n  }\n}\n\nclass HttpErrorAuthOTP extends HttpErrorBase {\n  constructor (method, target, res, body) {\n    super(method, target, res, body)\n    this.message = 'OTP required for authentication'\n    this.code = 'EOTP'\n    Error.captureStackTrace(this, HttpErrorAuthOTP)\n  }\n}\n\nclass HttpErrorAuthIPAddress extends HttpErrorBase {\n  constructor (method, target, res, body) {\n    super(method, target, res, body)\n    this.message = 'Login is not allowed from your IP address'\n    this.code = 'EAUTHIP'\n    Error.captureStackTrace(this, HttpErrorAuthIPAddress)\n  }\n}\n\nclass HttpErrorAuthUnknown extends HttpErrorBase {\n  constructor (method, target, res, body) {\n    super(method, target, res, body)\n    this.message = 'Unable to authenticate, need: ' + res.headers.get('www-authenticate')\n    this.code = 'EAUTHUNKNOWN'\n    Error.captureStackTrace(this, HttpErrorAuthUnknown)\n  }\n}\n\nfunction authHeaders (auth) {\n  const headers = {}\n  if (!auth) return headers\n  if (auth.otp) headers['npm-otp'] = auth.otp\n  if (auth.token) {\n    headers['Authorization'] = 'Bearer ' + auth.token\n  } else if (auth.basic) {\n    const basic = auth.basic.username + ':' + auth.basic.password\n    headers['Authorization'] = 'Basic ' + Buffer.from(basic).toString('base64')\n  }\n  return headers\n}\n\nfunction fetchJSON (conf) {\n  const fetchOpts = {\n    method: conf.method,\n    headers: Object.assign({}, conf.headers || (conf.auth && authHeaders(conf.auth)) || {})\n  }\n  if (conf.body != null) {\n    fetchOpts.headers['Content-Type'] = 'application/json'\n    fetchOpts.body = JSON.stringify(conf.body)\n  }\n  process.emit('log', 'http', 'request', '→', conf.method || 'GET', conf.target)\n  return fetch.defaults(conf.opts || {})(conf.target, fetchOpts).catch(err => {\n    throw new FetchError(err, conf.method, conf.target)\n  }).then(res => {\n    if (res.headers.has('npm-notice')) {\n      process.emit('warn', 'notice', res.headers.get('npm-notice'))\n    }\n    if (res.headers.get('content-type') === 'application/json') {\n      return res.json().then(content => [res, content])\n    } else {\n      return res.buffer().then(content => {\n        try {\n          return [res, JSON.parse(content)]\n        } catch (_) {\n          return [res, content]\n        }\n      })\n    }\n  }).then(result => {\n    const res = result[0]\n    const content = result[1]\n    const retVal = conf.saveResponse ? result : content\n    process.emit('log', 'http', res.status, `← ${res.statusText} (${conf.target})`)\n    if (res.status === 401 && res.headers.get('www-authenticate')) {\n      const auth = res.headers.get('www-authenticate').split(/,\\s*/).map(s => s.toLowerCase())\n      if (auth.indexOf('ipaddress') !== -1) {\n        throw new HttpErrorAuthIPAddress(conf.method, conf.target, res, content)\n      } else if (auth.indexOf('otp') !== -1) {\n        throw new HttpErrorAuthOTP(conf.method, conf.target, res, content)\n      } else {\n        throw new HttpErrorAuthUnknown(conf.method, conf.target, res, content)\n      }\n    } else if (res.status < 200 || res.status >= 300) {\n      throw new HttpErrorGeneral(conf.method, conf.target, res, content)\n    } else {\n      return retVal\n    }\n  })\n}\n\nfunction packageName (href) {\n  try {\n    let basePath = url.parse(href).pathname.substr(1)\n    if (!basePath.match(/^-/)) {\n      basePath = basePath.split('/')\n      var index = basePath.indexOf('_rewrite')\n      if (index === -1) {\n        index = basePath.length - 1\n      } else {\n        index++\n      }\n      return decodeURIComponent(basePath[index])\n    }\n  } catch (_) {\n    // this is ok\n  }\n}\n"]}
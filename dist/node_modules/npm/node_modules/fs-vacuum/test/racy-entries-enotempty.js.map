{"version":3,"sources":["../../../../../../node_modules/npm/node_modules/fs-vacuum/test/racy-entries-enotempty.js"],"names":["path","require","test","readdir","readdirSync","rmdir","statSync","writeFile","mkdirp","mkdtemp","dir","tmpFile","file","EEXIST","code","ENOTEMPTY","requireInject","vacuum","lstat","cb","err","files","partialPath","length","fd","mockErr","errno","message","description","syscall","unlink","TEMP_OPTIONS","unsafeCleanup","mode","SHORT_PATH","join","PARTIAL_PATH","FULL_PATH","messages","log","push","Array","prototype","slice","call","arguments","testBase","fullPath","t","er","tmpdir","ifError","resolve","Buffer","end","purge","base","equal","stat","verifyPath","verify","throws","notOk","isFile","dirname","i","doesNotThrow","ok","isDirectory"],"mappings":"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","file":"racy-entries-enotempty.js","sourcesContent":["var path = require('path')\n\nvar test = require('tap').test\n\nvar readdir = require('graceful-fs').readdir\nvar readdirSync = require('graceful-fs').readdirSync\nvar rmdir = require('graceful-fs').rmdir\nvar statSync = require('graceful-fs').statSync\nvar writeFile = require('graceful-fs').writeFile\nvar mkdirp = require('mkdirp')\nvar mkdtemp = require('tmp').dir\nvar tmpFile = require('tmp').file\nvar EEXIST = require('errno').code.EEXIST\nvar ENOTEMPTY = require('errno').code.ENOTEMPTY\n\nvar requireInject = require('require-inject')\nvar vacuum = requireInject('../vacuum.js', {\n  'graceful-fs': {\n    'lstat': require('graceful-fs').lstat,\n    'readdir': function (dir, cb) {\n      readdir(dir, function (err, files) {\n        // Simulate racy removal by creating a file after vacuum\n        // thinks the directory is empty\n        if (dir === partialPath && files.length === 0) {\n          tmpFile({dir: dir}, function (err, path, fd) {\n            if (err) throw err\n            cb(err, files)\n          })\n        } else {\n          cb(err, files)\n        }\n      })\n    },\n    'rmdir': function (dir, cb) {\n      rmdir(dir, function (err) {\n        // Force ENOTEMPTY error from rmdir if the directory is non-empty\n        var mockErr = ENOTEMPTY\n        if (err) {\n          if (err.code === EEXIST.code) {\n            err.code = err.errno = mockErr.code\n            err.message = mockErr.code + ': ' + mockErr.description + ', ' + err.syscall + ' \\'' + dir + '\\''\n          }\n        }\n        cb(err)\n      })\n    },\n    'unlink': require('graceful-fs').unlink\n  }\n})\n\n// CONSTANTS\nvar TEMP_OPTIONS = {\n  unsafeCleanup: true,\n  mode: '0700'\n}\nvar SHORT_PATH = path.join('i', 'am', 'a', 'path')\nvar PARTIAL_PATH = path.join(SHORT_PATH, 'that', 'ends', 'at', 'a')\nvar FULL_PATH = path.join(PARTIAL_PATH, 'file')\n\nvar messages = []\nfunction log () { messages.push(Array.prototype.slice.call(arguments).join(' ')) }\n\nvar testBase, partialPath, fullPath\ntest('xXx setup xXx', function (t) {\n  mkdtemp(TEMP_OPTIONS, function (er, tmpdir) {\n    t.ifError(er, 'temp directory exists')\n\n    testBase = path.resolve(tmpdir, SHORT_PATH)\n    partialPath = path.resolve(tmpdir, PARTIAL_PATH)\n    fullPath = path.resolve(tmpdir, FULL_PATH)\n\n    mkdirp(partialPath, function (er) {\n      t.ifError(er, 'made test path')\n\n      writeFile(fullPath, new Buffer('hi'), function (er) {\n        t.ifError(er, 'made file')\n\n        t.end()\n      })\n    })\n  })\n})\n\ntest('racy removal should quit gracefully', function (t) {\n  vacuum(fullPath, {purge: false, base: testBase, log: log}, function (er) {\n    t.ifError(er, 'cleaned up to base')\n\n    t.equal(messages.length, 3, 'got 2 removal & 1 quit message')\n    t.equal(messages[2], 'quitting because new (racy) entries in ' + partialPath)\n\n    var stat\n    var verifyPath = fullPath\n\n    function verify () { stat = statSync(verifyPath) }\n\n    // handle the file separately\n    t.throws(verify, verifyPath + ' cannot be statted')\n    t.notOk(stat && stat.isFile(), verifyPath + ' is totally gone')\n    verifyPath = path.dirname(verifyPath)\n\n    for (var i = 0; i < 4; i++) {\n      t.doesNotThrow(function () {\n        stat = statSync(verifyPath)\n      }, verifyPath + ' can be statted')\n      t.ok(stat && stat.isDirectory(), verifyPath + ' is still a directory')\n      verifyPath = path.dirname(verifyPath)\n    }\n\n    t.doesNotThrow(function () {\n      stat = statSync(testBase)\n    }, testBase + ' can be statted')\n    t.ok(stat && stat.isDirectory(), testBase + ' is still a directory')\n\n    var files = readdirSync(testBase)\n    t.equal(files.length, 1, 'base directory untouched')\n\n    t.end()\n  })\n})\n"]}
{"version":3,"sources":["../../../../../node_modules/npm/node_modules/bin-links/index.js"],"names":["path","require","fs","BB","linkIfExists","promisify","cmdShimIfExists","ifExists","open","close","read","multiArgs","chmod","readFile","writeFileAtomic","module","exports","binLinks","pkg","folder","global","opts","cb","parent","name","dirname","gnm","globalDir","gtop","log","info","pkgId","silly","join","linkBins","linkMans","asCallback","isHashbangFile","file","then","fileHandle","Buffer","alloc","spread","_","buf","hasHashbang","hasCR","finally","catch","str","toString","slice","test","dos2Unix","content","replace","getLinkOpts","gently","Object","assign","bin","basename","linkOpts","execMode","parseInt","umask","binRoot","globalBin","resolve","verbose","map","keys","dest","src","linkBin","isHashbang","out","parseable","json","clearProgress","console","showProgress","err","code","ignoreScripts","from","to","process","platform","man","manRoot","prefix","set","reduce","acc","manpages","filter","parseMan","match","Error","stem","sxn","bn","manSrc","manDest"],"mappings":"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","file":"index.js","sourcesContent":["'use strict'\n\nconst path = require('path')\nconst fs = require('graceful-fs')\nconst BB = require('bluebird')\nconst linkIfExists = BB.promisify(require('gentle-fs').linkIfExists)\nconst cmdShimIfExists = BB.promisify(require('cmd-shim').ifExists)\nconst open = BB.promisify(fs.open)\nconst close = BB.promisify(fs.close)\nconst read = BB.promisify(fs.read, {multiArgs: true})\nconst chmod = BB.promisify(fs.chmod)\nconst readFile = BB.promisify(fs.readFile)\nconst writeFileAtomic = BB.promisify(require('write-file-atomic'))\n\nmodule.exports = BB.promisify(binLinks)\n\nfunction binLinks (pkg, folder, global, opts, cb) {\n  // if it's global, and folder is in {prefix}/node_modules,\n  // then bins are in {prefix}/bin\n  // otherwise, then bins are in folder/../.bin\n  var parent = pkg.name && pkg.name[0] === '@' ? path.dirname(path.dirname(folder)) : path.dirname(folder)\n  var gnm = global && opts.globalDir\n  var gtop = parent === gnm\n\n  opts.log.info('linkStuff', opts.pkgId)\n  opts.log.silly('linkStuff', opts.pkgId, 'has', parent, 'as its parent node_modules')\n  if (global) opts.log.silly('linkStuff', opts.pkgId, 'is part of a global install')\n  if (gnm) opts.log.silly('linkStuff', opts.pkgId, 'is installed into a global node_modules')\n  if (gtop) opts.log.silly('linkStuff', opts.pkgId, 'is installed into the top-level global node_modules')\n\n  return BB.join(\n    linkBins(pkg, folder, parent, gtop, opts),\n    linkMans(pkg, folder, parent, gtop, opts)\n  ).asCallback(cb)\n}\n\nfunction isHashbangFile (file) {\n  return open(file, 'r').then(fileHandle => {\n    return read(fileHandle, Buffer.alloc(2), 0, 2, 0).spread((_, buf) => {\n      if (!hasHashbang(buf)) return []\n      return read(fileHandle, Buffer.alloc(2048), 0, 2048, 0)\n    }).spread((_, buf) => buf && hasCR(buf), () => false)\n      .finally(() => close(fileHandle))\n  }).catch(() => false)\n}\n\nfunction hasHashbang (buf) {\n  const str = buf.toString()\n  return str.slice(0, 2) === '#!'\n}\n\nfunction hasCR (buf) {\n  return /^#![^\\n]+\\r\\n/.test(buf)\n}\n\nfunction dos2Unix (file) {\n  return readFile(file, 'utf8').then(content => {\n    return writeFileAtomic(file, content.replace(/^(#![^\\n]+)\\r\\n/, '$1\\n'))\n  })\n}\n\nfunction getLinkOpts (opts, gently) {\n  return Object.assign({}, opts, { gently: gently })\n}\n\nfunction linkBins (pkg, folder, parent, gtop, opts) {\n  if (!pkg.bin || (!gtop && path.basename(parent) !== 'node_modules')) {\n    return\n  }\n  var linkOpts = getLinkOpts(opts, gtop && folder)\n  var execMode = parseInt('0777', 8) & (~opts.umask)\n  var binRoot = gtop ? opts.globalBin\n                     : path.resolve(parent, '.bin')\n  opts.log.verbose('linkBins', [pkg.bin, binRoot, gtop])\n\n  return BB.map(Object.keys(pkg.bin), bin => {\n    var dest = path.resolve(binRoot, bin)\n    var src = path.resolve(folder, pkg.bin[bin])\n\n    return linkBin(src, dest, linkOpts).then(() => {\n      // bins should always be executable.\n      // XXX skip chmod on windows?\n      return chmod(src, execMode)\n    }).then(() => {\n      return isHashbangFile(src)\n    }).then(isHashbang => {\n      if (!isHashbang) return\n      opts.log.silly('linkBins', 'Converting line endings of hashbang file:', src)\n      return dos2Unix(src)\n    }).then(() => {\n      if (!gtop) return\n      var dest = path.resolve(binRoot, bin)\n      var out = opts.parseable\n              ? dest + '::' + src + ':BINFILE'\n              : dest + ' -> ' + src\n\n      if (!opts.json && !opts.parseable) {\n        opts.log.clearProgress()\n        console.log(out)\n        opts.log.showProgress()\n      }\n    }).catch(err => {\n      if (err.code === 'ENOENT' && opts.ignoreScripts) return\n      throw err\n    })\n  })\n}\n\nfunction linkBin (from, to, opts) {\n  if (process.platform !== 'win32') {\n    return linkIfExists(from, to, opts)\n  } else {\n    return cmdShimIfExists(from, to)\n  }\n}\n\nfunction linkMans (pkg, folder, parent, gtop, opts) {\n  if (!pkg.man || !gtop || process.platform === 'win32') return\n\n  var manRoot = path.resolve(opts.prefix, 'share', 'man')\n  opts.log.verbose('linkMans', 'man files are', pkg.man, 'in', manRoot)\n\n  // make sure that the mans are unique.\n  // otherwise, if there are dupes, it'll fail with EEXIST\n  var set = pkg.man.reduce(function (acc, man) {\n    acc[path.basename(man)] = man\n    return acc\n  }, {})\n  var manpages = pkg.man.filter(function (man) {\n    return set[path.basename(man)] === man\n  })\n\n  return BB.map(manpages, man => {\n    if (typeof man !== 'string') return\n    opts.log.silly('linkMans', 'preparing to link', man)\n    var parseMan = man.match(/(.*\\.([0-9]+)(\\.gz)?)$/)\n    if (!parseMan) {\n      throw new Error(\n        man + ' is not a valid name for a man file.  ' +\n        'Man files must end with a number, ' +\n        'and optionally a .gz suffix if they are compressed.'\n      )\n    }\n\n    var stem = parseMan[1]\n    var sxn = parseMan[2]\n    var bn = path.basename(stem)\n    var manSrc = path.resolve(folder, man)\n    var manDest = path.join(manRoot, 'man' + sxn, bn)\n\n    return linkIfExists(manSrc, manDest, getLinkOpts(opts, gtop && folder))\n  })\n}\n"]}
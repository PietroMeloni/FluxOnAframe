{"version":3,"sources":["../../../../../node_modules/npm/node_modules/npm-lifecycle/index.js"],"names":["exports","module","lifecycle","makeEnv","_incorrectWorkingDirectory","spawn","require","path","Stream","fs","chain","uidNumber","umask","which","byline","resolveFrom","DEFAULT_NODE_GYP_PATH","__dirname","hookStatCache","Map","PATH","process","platform","Object","keys","env","forEach","e","match","logid","pkg","stage","_id","hookStat","dir","cb","hook","join","cachedStatError","get","undefined","stat","statError","set","setImmediate","wd","opts","Promise","resolve","reject","_data","Error","log","info","scripts","ignorePrepublish","prepublish","validWd","name","er","indexOf","unsafePerm","warn","npm_lifecycle_event","npm_node_execpath","NODE","execPath","npm_execpath","main","filename","INIT_CWD","cwd","npm_config_node_gyp","TMPDIR","lifecycle_","lastIndexOf","length","pathArr","p","split","acc","shift","pp","unshift","shouldPrependCurrentNodeDirToPATH","push","dirname","Path","packageLifecycle","hasOwnProperty","ignoreScripts","npm_lifecycle_script","silly","done","force","failOk","message","runPackageLifecycle","runHookLifecycle","cfgsetting","scriptsPrependNodePath","isDifferentNodeInPath","isWindows","foundExecPath","sync","basename","pathExt","realpathSync","toUpperCase","hasWarned","d","st","isDirectory","cmd","note","runCmd","running","queue","dequeue","r","apply","pause","unsafe","user","group","level","clearProgress","console","showProgress","verbose","runCmd_","uid","gid","cb_","arguments","resume","nextTick","conf","stdio","sh","shFlag","customShell","scriptShell","comspec","windowsVerbatimArguments","proc","on","procError","code","signal","kill","pid","errno","stdout","data","toString","stderr","once","procKill","procInterupt","sep","slice","pkgid","script","pkgname","removeListener","exit","prefix","i","production","NODE_ENV","defineProperty","value","enumerable","nodeOptions","NODE_OPTIONS","charAt","envKey","replace","JSON","stringify","ex","version","String","pkgConfig","pkgVerConfig","namePref","verPref","config","Array","isArray","k","substr"],"mappings":"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","file":"index.js","sourcesContent":["'use strict'\n\nexports = module.exports = lifecycle\nexports.makeEnv = makeEnv\nexports._incorrectWorkingDirectory = _incorrectWorkingDirectory\n\nconst spawn = require('./lib/spawn')\nconst path = require('path')\nconst Stream = require('stream').Stream\nconst fs = require('graceful-fs')\nconst chain = require('slide').chain\nconst uidNumber = require('uid-number')\nconst umask = require('umask')\nconst which = require('which')\nconst byline = require('byline')\nconst resolveFrom = require('resolve-from')\n\nconst DEFAULT_NODE_GYP_PATH = resolveFrom(__dirname, 'node-gyp/bin/node-gyp')\nconst hookStatCache = new Map()\n\nlet PATH = 'PATH'\n\n// windows calls it's path 'Path' usually, but this is not guaranteed.\nif (process.platform === 'win32') {\n  PATH = 'Path'\n  Object.keys(process.env).forEach(function (e) {\n    if (e.match(/^PATH$/i)) {\n      PATH = e\n    }\n  })\n}\n\nfunction logid (pkg, stage) {\n  return pkg._id + '~' + stage + ':'\n}\n\nfunction hookStat (dir, stage, cb) {\n  const hook = path.join(dir, '.hooks', stage)\n  const cachedStatError = hookStatCache.get(hook)\n\n  if (cachedStatError === undefined) {\n    return fs.stat(hook, function (statError) {\n      hookStatCache.set(hook, statError)\n      cb(statError)\n    })\n  }\n\n  return setImmediate(() => cb(cachedStatError))\n}\n\nfunction lifecycle (pkg, stage, wd, opts) {\n  return new Promise((resolve, reject) => {\n    while (pkg && pkg._data) pkg = pkg._data\n    if (!pkg) return reject(new Error('Invalid package data'))\n\n    opts.log.info('lifecycle', logid(pkg, stage), pkg._id)\n    if (!pkg.scripts) pkg.scripts = {}\n\n    if (stage === 'prepublish' && opts.ignorePrepublish) {\n      opts.log.info('lifecycle', logid(pkg, stage), 'ignored because ignore-prepublish is set to true', pkg._id)\n      delete pkg.scripts.prepublish\n    }\n\n    hookStat(opts.dir, stage, function (statError) {\n      // makeEnv is a slow operation. This guard clause prevents makeEnv being called\n      // and avoids a ton of unnecessary work, and results in a major perf boost.\n      if (!pkg.scripts[stage] && statError) return resolve()\n\n      validWd(wd || path.resolve(opts.dir, pkg.name), function (er, wd) {\n        if (er) return reject(er)\n\n        if ((wd.indexOf(opts.dir) !== 0 || _incorrectWorkingDirectory(wd, pkg)) &&\n            !opts.unsafePerm && pkg.scripts[stage]) {\n          opts.log.warn('lifecycle', logid(pkg, stage), 'cannot run in wd', pkg._id, pkg.scripts[stage], `(wd=${wd})`)\n          return resolve()\n        }\n\n        // set the env variables, then run scripts as a child process.\n        var env = makeEnv(pkg, opts)\n        env.npm_lifecycle_event = stage\n        env.npm_node_execpath = env.NODE = env.NODE || process.execPath\n        env.npm_execpath = require.main.filename\n        env.INIT_CWD = process.cwd()\n        env.npm_config_node_gyp = env.npm_config_node_gyp || DEFAULT_NODE_GYP_PATH\n\n        // 'nobody' typically doesn't have permission to write to /tmp\n        // even if it's never used, sh freaks out.\n        if (!opts.unsafePerm) env.TMPDIR = wd\n\n        lifecycle_(pkg, stage, wd, opts, env, (er) => {\n          if (er) return reject(er)\n          return resolve()\n        })\n      })\n    })\n  })\n}\n\nfunction _incorrectWorkingDirectory (wd, pkg) {\n  return wd.lastIndexOf(pkg.name) !== wd.length - pkg.name.length\n}\n\nfunction lifecycle_ (pkg, stage, wd, opts, env, cb) {\n  var pathArr = []\n  var p = wd.split(/[\\\\/]node_modules[\\\\/]/)\n  var acc = path.resolve(p.shift())\n\n  p.forEach(function (pp) {\n    pathArr.unshift(path.join(acc, 'node_modules', '.bin'))\n    acc = path.join(acc, 'node_modules', pp)\n  })\n  pathArr.unshift(path.join(acc, 'node_modules', '.bin'))\n\n  // we also unshift the bundled node-gyp-bin folder so that\n  // the bundled one will be used for installing things.\n  pathArr.unshift(path.join(__dirname, 'node-gyp-bin'))\n\n  if (shouldPrependCurrentNodeDirToPATH(opts)) {\n    // prefer current node interpreter in child scripts\n    pathArr.push(path.dirname(process.execPath))\n  }\n\n  if (env[PATH]) pathArr.push(env[PATH])\n  env[PATH] = pathArr.join(process.platform === 'win32' ? ';' : ':')\n  if (process.platform === 'win32') {\n    env.path = env.PATH = env.Path = env[PATH]\n  }\n\n  var packageLifecycle = pkg.scripts && pkg.scripts.hasOwnProperty(stage)\n\n  if (opts.ignoreScripts) {\n    opts.log.info('lifecycle', logid(pkg, stage), 'ignored because ignore-scripts is set to true', pkg._id)\n    packageLifecycle = false\n  } else if (packageLifecycle) {\n    // define this here so it's available to all scripts.\n    env.npm_lifecycle_script = pkg.scripts[stage]\n  } else {\n    opts.log.silly('lifecycle', logid(pkg, stage), 'no script for ' + stage + ', continuing')\n  }\n\n  function done (er) {\n    if (er) {\n      if (opts.force) {\n        opts.log.info('lifecycle', logid(pkg, stage), 'forced, continuing', er)\n        er = null\n      } else if (opts.failOk) {\n        opts.log.warn('lifecycle', logid(pkg, stage), 'continuing anyway', er.message)\n        er = null\n      }\n    }\n    cb(er)\n  }\n\n  chain(\n    [\n      packageLifecycle && [runPackageLifecycle, pkg, stage, env, wd, opts],\n      [runHookLifecycle, pkg, stage, env, wd, opts]\n    ],\n    done\n  )\n}\n\nfunction shouldPrependCurrentNodeDirToPATH (opts) {\n  const cfgsetting = opts.scriptsPrependNodePath\n  if (cfgsetting === false) return false\n  if (cfgsetting === true) return true\n\n  var isDifferentNodeInPath\n\n  var isWindows = process.platform === 'win32'\n  var foundExecPath\n  try {\n    foundExecPath = which.sync(path.basename(process.execPath), {pathExt: isWindows ? ';' : ':'})\n    // Apply `fs.realpath()` here to avoid false positives when `node` is a symlinked executable.\n    isDifferentNodeInPath = fs.realpathSync(process.execPath).toUpperCase() !==\n        fs.realpathSync(foundExecPath).toUpperCase()\n  } catch (e) {\n    isDifferentNodeInPath = true\n  }\n\n  if (cfgsetting === 'warn-only') {\n    if (isDifferentNodeInPath && !shouldPrependCurrentNodeDirToPATH.hasWarned) {\n      if (foundExecPath) {\n        opts.log.warn('lifecycle', 'The node binary used for scripts is', foundExecPath, 'but npm is using', process.execPath, 'itself. Use the `--scripts-prepend-node-path` option to include the path for the node binary npm was executed with.')\n      } else {\n        opts.log.warn('lifecycle', 'npm is using', process.execPath, 'but there is no node binary in the current PATH. Use the `--scripts-prepend-node-path` option to include the path for the node binary npm was executed with.')\n      }\n      shouldPrependCurrentNodeDirToPATH.hasWarned = true\n    }\n\n    return false\n  }\n\n  return isDifferentNodeInPath\n}\n\nfunction validWd (d, cb) {\n  fs.stat(d, function (er, st) {\n    if (er || !st.isDirectory()) {\n      var p = path.dirname(d)\n      if (p === d) {\n        return cb(new Error('Could not find suitable wd'))\n      }\n      return validWd(p, cb)\n    }\n    return cb(null, d)\n  })\n}\n\nfunction runPackageLifecycle (pkg, stage, env, wd, opts, cb) {\n  // run package lifecycle scripts in the package root, or the nearest parent.\n  var cmd = env.npm_lifecycle_script\n\n  var note = '\\n> ' + pkg._id + ' ' + stage + ' ' + wd +\n             '\\n> ' + cmd + '\\n'\n  runCmd(note, cmd, pkg, env, stage, wd, opts, cb)\n}\n\nvar running = false\nvar queue = []\nfunction dequeue () {\n  running = false\n  if (queue.length) {\n    var r = queue.shift()\n    runCmd.apply(null, r)\n  }\n}\n\nfunction runCmd (note, cmd, pkg, env, stage, wd, opts, cb) {\n  if (running) {\n    queue.push([note, cmd, pkg, env, stage, wd, opts, cb])\n    return\n  }\n\n  running = true\n  opts.log.pause()\n  var unsafe = opts.unsafePerm\n  var user = unsafe ? null : opts.user\n  var group = unsafe ? null : opts.group\n\n  if (opts.log.level !== 'silent') {\n    opts.log.clearProgress()\n    console.log(note)\n    opts.log.showProgress()\n  }\n  opts.log.verbose('lifecycle', logid(pkg, stage), 'unsafe-perm in lifecycle', unsafe)\n\n  if (process.platform === 'win32') {\n    unsafe = true\n  }\n\n  if (unsafe) {\n    runCmd_(cmd, pkg, env, wd, opts, stage, unsafe, 0, 0, cb)\n  } else {\n    uidNumber(user, group, function (er, uid, gid) {\n      runCmd_(cmd, pkg, env, wd, opts, stage, unsafe, uid, gid, cb)\n    })\n  }\n}\n\nfunction runCmd_ (cmd, pkg, env, wd, opts, stage, unsafe, uid, gid, cb_) {\n  function cb (er) {\n    cb_.apply(null, arguments)\n    opts.log.resume()\n    process.nextTick(dequeue)\n  }\n\n  var conf = {\n    cwd: wd,\n    env: env,\n    stdio: opts.stdio || [ 0, 1, 2 ]\n  }\n\n  if (!unsafe) {\n    conf.uid = uid ^ 0\n    conf.gid = gid ^ 0\n  }\n\n  var sh = 'sh'\n  var shFlag = '-c'\n\n  var customShell = opts.scriptShell\n\n  if (customShell) {\n    sh = customShell\n  } else if (process.platform === 'win32') {\n    sh = process.env.comspec || 'cmd'\n    shFlag = '/d /s /c'\n    conf.windowsVerbatimArguments = true\n  }\n\n  opts.log.verbose('lifecycle', logid(pkg, stage), 'PATH:', env[PATH])\n  opts.log.verbose('lifecycle', logid(pkg, stage), 'CWD:', wd)\n  opts.log.silly('lifecycle', logid(pkg, stage), 'Args:', [shFlag, cmd])\n\n  var proc = spawn(sh, [shFlag, cmd], conf, opts.log)\n\n  proc.on('error', procError)\n  proc.on('close', function (code, signal) {\n    opts.log.silly('lifecycle', logid(pkg, stage), 'Returned: code:', code, ' signal:', signal)\n    if (signal) {\n      process.kill(process.pid, signal)\n    } else if (code) {\n      var er = new Error('Exit status ' + code)\n      er.errno = code\n    }\n    procError(er)\n  })\n  byline(proc.stdout).on('data', function (data) {\n    opts.log.verbose('lifecycle', logid(pkg, stage), 'stdout', data.toString())\n  })\n  byline(proc.stderr).on('data', function (data) {\n    opts.log.verbose('lifecycle', logid(pkg, stage), 'stderr', data.toString())\n  })\n  process.once('SIGTERM', procKill)\n  process.once('SIGINT', procInterupt)\n\n  function procError (er) {\n    if (er) {\n      opts.log.info('lifecycle', logid(pkg, stage), 'Failed to exec ' + stage + ' script')\n      er.message = pkg._id + ' ' + stage + ': `' + cmd + '`\\n' +\n                   er.message\n      if (er.code !== 'EPERM') {\n        er.code = 'ELIFECYCLE'\n      }\n      fs.stat(opts.dir, function (statError, d) {\n        if (statError && statError.code === 'ENOENT' && opts.dir.split(path.sep).slice(-1)[0] === 'node_modules') {\n          opts.log.warn('', 'Local package.json exists, but node_modules missing, did you mean to install?')\n        }\n      })\n      er.pkgid = pkg._id\n      er.stage = stage\n      er.script = cmd\n      er.pkgname = pkg.name\n    }\n    process.removeListener('SIGTERM', procKill)\n    process.removeListener('SIGTERM', procInterupt)\n    process.removeListener('SIGINT', procKill)\n    return cb(er)\n  }\n  function procKill () {\n    proc.kill()\n  }\n  function procInterupt () {\n    proc.kill('SIGINT')\n    proc.on('exit', function () {\n      process.exit()\n    })\n    process.once('SIGINT', procKill)\n  }\n}\n\nfunction runHookLifecycle (pkg, stage, env, wd, opts, cb) {\n  hookStat(opts.dir, stage, function (er) {\n    if (er) return cb()\n    var cmd = path.join(opts.dir, '.hooks', stage)\n    var note = '\\n> ' + pkg._id + ' ' + stage + ' ' + wd +\n               '\\n> ' + cmd\n    runCmd(note, cmd, pkg, env, stage, wd, opts, cb)\n  })\n}\n\nfunction makeEnv (data, opts, prefix, env) {\n  prefix = prefix || 'npm_package_'\n  if (!env) {\n    env = {}\n    for (var i in process.env) {\n      if (!i.match(/^npm_/)) {\n        env[i] = process.env[i]\n      }\n    }\n\n    // express and others respect the NODE_ENV value.\n    if (opts.production) env.NODE_ENV = 'production'\n  } else if (!data.hasOwnProperty('_lifecycleEnv')) {\n    Object.defineProperty(data, '_lifecycleEnv',\n      {\n        value: env,\n        enumerable: false\n      }\n    )\n  }\n\n  if (opts.nodeOptions) env.NODE_OPTIONS = opts.nodeOptions\n\n  for (i in data) {\n    if (i.charAt(0) !== '_') {\n      var envKey = (prefix + i).replace(/[^a-zA-Z0-9_]/g, '_')\n      if (i === 'readme') {\n        continue\n      }\n      if (data[i] && typeof data[i] === 'object') {\n        try {\n          // quick and dirty detection for cyclical structures\n          JSON.stringify(data[i])\n          makeEnv(data[i], opts, envKey + '_', env)\n        } catch (ex) {\n          // usually these are package objects.\n          // just get the path and basic details.\n          var d = data[i]\n          makeEnv(\n            { name: d.name, version: d.version, path: d.path },\n            opts,\n            envKey + '_',\n            env\n          )\n        }\n      } else {\n        env[envKey] = String(data[i])\n        env[envKey] = env[envKey].indexOf('\\n') !== -1\n          ? JSON.stringify(env[envKey])\n          : env[envKey]\n      }\n    }\n  }\n\n  if (prefix !== 'npm_package_') return env\n\n  prefix = 'npm_config_'\n  var pkgConfig = {}\n  var pkgVerConfig = {}\n  var namePref = data.name + ':'\n  var verPref = data.name + '@' + data.version + ':'\n\n  Object.keys(opts.config).forEach(function (i) {\n    // in some rare cases (e.g. working with nerf darts), there are segmented\n    // \"private\" (underscore-prefixed) config names -- don't export\n    if ((i.charAt(0) === '_' && i.indexOf('_' + namePref) !== 0) || i.match(/:_/)) {\n      return\n    }\n    var value = opts.config[i]\n    if (value instanceof Stream || Array.isArray(value)) return\n    if (i.match(/umask/)) value = umask.toString(value)\n    if (!value) value = ''\n    else if (typeof value === 'number') value = '' + value\n    else if (typeof value !== 'string') value = JSON.stringify(value)\n\n    value = value.indexOf('\\n') !== -1\n      ? JSON.stringify(value)\n      : value\n    i = i.replace(/^_+/, '')\n    var k\n    if (i.indexOf(namePref) === 0) {\n      k = i.substr(namePref.length).replace(/[^a-zA-Z0-9_]/g, '_')\n      pkgConfig[k] = value\n    } else if (i.indexOf(verPref) === 0) {\n      k = i.substr(verPref.length).replace(/[^a-zA-Z0-9_]/g, '_')\n      pkgVerConfig[k] = value\n    }\n    var envKey = (prefix + i).replace(/[^a-zA-Z0-9_]/g, '_')\n    env[envKey] = value\n  })\n\n  prefix = 'npm_package_config_'\n  ;[pkgConfig, pkgVerConfig].forEach(function (conf) {\n    for (var i in conf) {\n      var envKey = (prefix + i)\n      env[envKey] = conf[i]\n    }\n  })\n\n  return env\n}\n"]}
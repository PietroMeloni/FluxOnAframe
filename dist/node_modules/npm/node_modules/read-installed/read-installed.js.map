{"version":3,"sources":["../../../../../node_modules/npm/node_modules/read-installed/read-installed.js"],"names":["fs","require","er","path","asyncMap","semver","readJson","url","util","extend","debug","readdir","ANY","module","exports","readInstalled","folder","opts","cb","depth","Infinity","Math","max","log","dev","realpathSeen","findUnmetSeen","readInstalled_","obj","resolveInheritance","root","unmarkExtraneous","parent","name","reqver","installed","real","link","resolve","i","filter","f","charAt","next","data","copy","lstat","st","realpath","rp","isSymbolicLink","errState","called","dependencies","forEach","invalid","realName","_dependencies","version","validRange","satisfies","extraneous","realPath","pkg","rv","devDependencies","installedData","dep","optionalDependencies","Object","keys","riSeen","indexOf","push","findUnmet","deps","d","found","findDep","peerDeps","peerDependencies","dependency","r","peerInvalid","k","_id","Array","isArray","map","o"],"mappings":";;;;AACA;AACA;AACA;;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAoFA,IAAI;AACF,MAAIA,KAAKC,QAAQ,aAAR,CAAT;AACD,CAFD,CAEE,OAAOC,EAAP,EAAW;AACX,MAAIF,KAAKC,QAAQ,IAAR,CAAT;AACD;;AAED,IAAIE,OAAOF,QAAQ,MAAR,CAAX;AACA,IAAIG,WAAWH,QAAQ,OAAR,EAAiBG,QAAhC;AACA,IAAIC,SAASJ,QAAQ,QAAR,CAAb;AACA,IAAIK,WAAWL,QAAQ,mBAAR,CAAf;AACA,IAAIM,MAAMN,QAAQ,KAAR,CAAV;AACA,IAAIO,OAAOP,QAAQ,MAAR,CAAX;AACA,IAAIQ,SAASR,QAAQ,aAAR,CAAb;;AAEA,IAAIS,QAAQT,QAAQ,UAAR,EAAoB,gBAApB,CAAZ;;AAEA,IAAIU,UAAUV,QAAQ,wBAAR,CAAd;;AAEA;AACA;AACA,IAAIW,MAAM,EAAV;;AAEAC,OAAOC,OAAP,GAAiBC,aAAjB;;AAEA,SAASA,aAAT,CAAwBC,MAAxB,EAAgCC,IAAhC,EAAsCC,EAAtC,EAA0C;AACxC,MAAI,OAAOD,IAAP,KAAgB,UAApB,EAAgC;AAC9BC,SAAKD,IAAL;AACAA,WAAO,EAAP;AACD,GAHD,MAGO;AACLA,WAAOR,OAAO,EAAP,EAAWQ,IAAX,CAAP;AACD;;AAED,MAAI,OAAOA,KAAKE,KAAZ,KAAsB,QAA1B,EACEF,KAAKE,KAAL,GAAaC,QAAb;;AAEFH,OAAKE,KAAL,GAAaE,KAAKC,GAAL,CAAS,CAAT,EAAYL,KAAKE,KAAjB,CAAb;;AAEA,MAAI,OAAOF,KAAKM,GAAZ,KAAoB,UAAxB,EACEN,KAAKM,GAAL,GAAW,YAAY,CAAE,CAAzB;;AAEFN,OAAKO,GAAL,GAAW,CAAC,CAACP,KAAKO,GAAlB;AACAP,OAAKQ,YAAL,GAAoB,EAApB;AACAR,OAAKS,aAAL,GAAqB,EAArB;;AAGAC,iBAAeX,MAAf,EAAuB,IAAvB,EAA6B,IAA7B,EAAmC,IAAnC,EAAyC,CAAzC,EAA4CC,IAA5C,EAAkD,UAAUf,EAAV,EAAc0B,GAAd,EAAmB;AACnE,QAAI1B,EAAJ,EAAQ,OAAOgB,GAAGhB,EAAH,CAAP;AACR;AACA;AACA2B,uBAAmBD,GAAnB,EAAwBX,IAAxB;AACAW,QAAIE,IAAJ,GAAW,IAAX;AACAC,qBAAiBH,GAAjB,EAAsBX,IAAtB;AACAC,OAAG,IAAH,EAASU,GAAT;AACD,GARD;AASD;;AAED,SAASD,cAAT,CAAyBX,MAAzB,EAAiCgB,MAAjC,EAAyCC,IAAzC,EAA+CC,MAA/C,EAAuDf,KAAvD,EAA8DF,IAA9D,EAAoEC,EAApE,EAAwE;AACtE,MAAIiB,SAAJ;AAAA,MACIP,GADJ;AAAA,MAEIQ,IAFJ;AAAA,MAGIC,IAHJ;AAAA,MAIIZ,eAAeR,KAAKQ,YAJxB;;AAMAd,UAAQR,KAAKmC,OAAL,CAAatB,MAAb,EAAqB,cAArB,CAAR,EAA8C,UAAUd,EAAV,EAAcqC,CAAd,EAAiB;AAC7D;AACA,QAAIrC,EAAJ,EAAQqC,IAAI,EAAJ;AACRJ,gBAAYI,EAAEC,MAAF,CAAS,UAAUC,CAAV,EAAa;AAAE,aAAOA,EAAEC,MAAF,CAAS,CAAT,MAAgB,GAAvB;AAA4B,KAApD,CAAZ;AACAC;AACD,GALD;;AAOArC,WAASH,KAAKmC,OAAL,CAAatB,MAAb,EAAqB,cAArB,CAAT,EAA+C,UAAUd,EAAV,EAAc0C,IAAd,EAAoB;AACjEhB,UAAMiB,KAAKD,IAAL,CAAN;;AAEA,QAAI,CAACZ,MAAL,EAAa;AACXJ,YAAMA,OAAO,IAAb;AACA1B,WAAK,IAAL;AACD;AACD,WAAOyC,KAAKzC,EAAL,CAAP;AACD,GARD;;AAUAF,KAAG8C,KAAH,CAAS9B,MAAT,EAAiB,UAAUd,EAAV,EAAc6C,EAAd,EAAkB;AACjC,QAAI7C,EAAJ,EAAQ;AACN,UAAI,CAAC8B,MAAL,EAAaI,OAAO,IAAP;AACb,aAAOO,KAAKzC,EAAL,CAAP;AACD;AACDF,OAAGgD,QAAH,CAAYhC,MAAZ,EAAoB,UAAUd,EAAV,EAAc+C,EAAd,EAAkB;AACpCvC,YAAM,mBAAN,EAA2BM,MAA3B,EAAmCiC,EAAnC;AACAb,aAAOa,EAAP;AACA,UAAIF,GAAGG,cAAH,EAAJ,EAAyBb,OAAOY,EAAP;AACzBN,WAAKzC,EAAL;AACD,KALD;AAMD,GAXD;;AAaA,MAAIiD,WAAW,IAAf;AAAA,MACIC,SAAS,KADb;AAEA,WAAST,IAAT,CAAezC,EAAf,EAAmB;AACjB,QAAIiD,QAAJ,EAAc;AACd,QAAIjD,EAAJ,EAAQ;AACNiD,iBAAWjD,EAAX;AACA,aAAOgB,GAAG,IAAH,EAAS,EAAT,CAAP;AACD;AACDR,UAAM,MAAN,EAAcyB,SAAd,EAAyBP,eAAcA,GAAd,yCAAcA,GAAd,EAAzB,EAA4CK,IAA5C,EAAkDG,IAAlD;AACA,QAAI,CAACD,SAAD,IAAc,CAACP,GAAf,IAAsB,CAACQ,IAAvB,IAA+BgB,MAAnC,EAA2C;AAC3CA,aAAS,IAAT;AACA,QAAI3B,aAAaW,IAAb,CAAJ,EAAwB,OAAOlB,GAAG,IAAH,EAASO,aAAaW,IAAb,CAAT,CAAP;AACxB,QAAIR,QAAQ,IAAZ,EAAkB;AAChBA,YAAM,EAACyB,cAAa,EAAd,EAAkBlD,MAAKa,MAAvB,EAAN;AACAmB,gBAAUmB,OAAV,CAAkB,UAAUf,CAAV,EAAa;AAAEX,YAAIyB,YAAJ,CAAiBd,CAAjB,IAAsB3B,GAAtB;AAA2B,OAA5D;AACD;AACD,QAAIqB,QAAQL,IAAIK,IAAJ,KAAaA,IAAzB,EAA+BL,IAAI2B,OAAJ,GAAc,IAAd;AAC/B3B,QAAI4B,QAAJ,GAAevB,QAAQL,IAAIK,IAA3B;AACAL,QAAIyB,YAAJ,GAAmBzB,IAAIyB,YAAJ,IAAoB,EAAvC;;AAEA;AACAzB,QAAI6B,aAAJ,GAAoBZ,KAAKjB,IAAIyB,YAAT,CAApB;;AAEA,QAAInB,WAAWtB,GAAf,EAAoB;AAClB;AACA;AACA;AACA;AACAsB,eAASN,IAAI8B,OAAb;AACD;;AAED;AACA,QAAIxB,UACG7B,OAAOsD,UAAP,CAAkBzB,MAAlB,EAA0B,IAA1B,CADH,IAEG,CAAC7B,OAAOuD,SAAP,CAAiBhC,IAAI8B,OAArB,EAA8BxB,MAA9B,EAAsC,IAAtC,CAFR,EAEqD;AACnDN,UAAI2B,OAAJ,GAAc,IAAd;AACD;;AAED;AACA;AACA;AACA;AACA3B,QAAIiC,UAAJ,GAAiB,IAAjB;;AAEAjC,QAAIzB,IAAJ,GAAWyB,IAAIzB,IAAJ,IAAYa,MAAvB;AACAY,QAAIkC,QAAJ,GAAe1B,IAAf;AACAR,QAAIS,IAAJ,GAAWA,IAAX;AACA,QAAIL,UAAU,CAACJ,IAAIS,IAAnB,EAAyBT,IAAII,MAAJ,GAAaA,MAAb;AACzBP,iBAAaW,IAAb,IAAqBR,GAArB;AACAA,QAAIT,KAAJ,GAAYA,KAAZ;AACA;AACAf,aAAS+B,SAAT,EAAoB,UAAU4B,GAAV,EAAe7C,EAAf,EAAmB;AACrC,UAAI8C,KAAKpC,IAAIyB,YAAJ,CAAiBU,GAAjB,CAAT;AACA,UAAI,CAACC,EAAD,IAAOpC,IAAIqC,eAAX,IAA8BhD,KAAKO,GAAvC,EACEwC,KAAKpC,IAAIqC,eAAJ,CAAoBF,GAApB,CAAL;;AAEF,UAAI5C,QAAQF,KAAKE,KAAjB,EAAwB;AACtBS,YAAIyB,YAAJ,GAAmB,EAAnB;AACA,eAAOnC,GAAG,IAAH,EAASU,GAAT,CAAP;AACD;;AAEDD,qBAAgBxB,KAAKmC,OAAL,CAAatB,MAAb,EAAqB,kBAAgB+C,GAArC,CAAhB,EACgBnC,GADhB,EACqBmC,GADrB,EAC0BnC,IAAIyB,YAAJ,CAAiBU,GAAjB,CAD1B,EACiD5C,QAAQ,CADzD,EAC4DF,IAD5D,EAEgBC,EAFhB;AAID,KAdD,EAcG,UAAUhB,EAAV,EAAcgE,aAAd,EAA6B;AAC9B,UAAIhE,EAAJ,EAAQ,OAAOgB,GAAGhB,EAAH,CAAP;AACRgE,oBAAcZ,OAAd,CAAsB,UAAUa,GAAV,EAAe;AACnCvC,YAAIyB,YAAJ,CAAiBc,IAAIX,QAArB,IAAiCW,GAAjC;AACD,OAFD;;AAIA;AACA;AACA,UAAIvC,IAAIwC,oBAAR,EAA8B;AAC5BC,eAAOC,IAAP,CAAY1C,IAAIwC,oBAAhB,EAAsCd,OAAtC,CAA8C,UAAUa,GAAV,EAAe;AAC3D,cAAI,OAAOvC,IAAIyB,YAAJ,CAAiBc,GAAjB,CAAP,KAAiC,QAArC,EAA+C;AAC7C,mBAAOvC,IAAIyB,YAAJ,CAAiBc,GAAjB,CAAP;AACD;AACF,SAJD;AAKD;AACD,aAAOjD,GAAG,IAAH,EAASU,GAAT,CAAP;AACD,KA9BD;AA+BD;AACF;;AAED;AACA,IAAI2C,SAAS,EAAb;AACA,SAAS1C,kBAAT,CAA6BD,GAA7B,EAAkCX,IAAlC,EAAwC;AACtC,MAAI,QAAOW,GAAP,yCAAOA,GAAP,OAAe,QAAnB,EAA6B;AAC7B,MAAI2C,OAAOC,OAAP,CAAe5C,GAAf,MAAwB,CAAC,CAA7B,EAAgC;AAChC2C,SAAOE,IAAP,CAAY7C,GAAZ;AACA,MAAI,QAAOA,IAAIyB,YAAX,MAA4B,QAAhC,EAA0C;AACxCzB,QAAIyB,YAAJ,GAAmB,EAAnB;AACD;AACDgB,SAAOC,IAAP,CAAY1C,IAAIyB,YAAhB,EAA8BC,OAA9B,CAAsC,UAAUa,GAAV,EAAe;AACnDO,cAAU9C,IAAIyB,YAAJ,CAAiBc,GAAjB,CAAV,EAAiClD,IAAjC;AACD,GAFD;AAGAoD,SAAOC,IAAP,CAAY1C,IAAIyB,YAAhB,EAA8BC,OAA9B,CAAsC,UAAUa,GAAV,EAAe;AACnD,QAAI,QAAOvC,IAAIyB,YAAJ,CAAiBc,GAAjB,CAAP,MAAiC,QAArC,EAA+C;AAC7CtC,yBAAmBD,IAAIyB,YAAJ,CAAiBc,GAAjB,CAAnB,EAA0ClD,IAA1C;AACD,KAFD,MAEO;AACLP,YAAM,qBAAN,EAA6BkB,IAAIK,IAAjC,EAAuCkC,GAAvC,EAA4CvC,IAAIyB,YAAJ,CAAiBc,GAAjB,CAA5C;AACD;AACF,GAND;AAOAO,YAAU9C,GAAV,EAAeX,IAAf;AACD;;AAED;AACA;AACA,SAASyD,SAAT,CAAoB9C,GAApB,EAAyBX,IAAzB,EAA+B;AAC7B,MAAIS,gBAAgBT,KAAKS,aAAzB;AACA,MAAIA,cAAc8C,OAAd,CAAsB5C,GAAtB,MAA+B,CAAC,CAApC,EAAuC;AACvCF,gBAAc+C,IAAd,CAAmB7C,GAAnB;AACAlB,QAAM,2BAAN,EAAmCkB,IAAII,MAAJ,IAAcJ,IAAII,MAAJ,CAAWC,IAA5D,EAAkEL,IAAIK,IAAJ,IAAYL,GAA9E;AACA,MAAI+C,OAAO/C,IAAIyB,YAAJ,GAAmBzB,IAAIyB,YAAJ,IAAoB,EAAlD;;AAEA3C,QAAMiE,IAAN;AACAN,SAAOC,IAAP,CAAYK,IAAZ,EACGnC,MADH,CACU,UAAUoC,CAAV,EAAa;AAAE,WAAO,OAAOD,KAAKC,CAAL,CAAP,KAAmB,QAA1B;AAAoC,GAD7D,EAEGtB,OAFH,CAEW,UAAUsB,CAAV,EAAa;AACpB,QAAIC,QAAQC,QAAQlD,GAAR,EAAagD,CAAb,CAAZ;AACAlE,UAAM,gBAAN,EAAwBkE,CAAxB,EAA2BC,SAASA,MAAM5C,IAAf,IAAuB4C,KAAlD;AACA;AACA,QAAI,OAAOF,KAAKC,CAAL,CAAP,KAAmB,QAAnB,IACAvE,OAAOsD,UAAP,CAAkBgB,KAAKC,CAAL,CAAlB,EAA2B,IAA3B,CADA,IAEAC,KAFA,IAGA,CAACxE,OAAOuD,SAAP,CAAiBiB,MAAMnB,OAAvB,EAAgCiB,KAAKC,CAAL,CAAhC,EAAyC,IAAzC,CAHL,EAGqD;AACnD;AACA3D,WAAKM,GAAL,CAAU,kBAAV,EACUK,IAAIzB,IAAJ,GAAW,YAAX,GAAwByE,CAAxB,GAA0B,IAA1B,GAA+BD,KAAKC,CAAL,CAA/B,GACA,mBADA,GAEAC,MAAM1E,IAFN,GAEW,sBAFX,GAEkC0E,MAAMnB,OAHlD;AAIAmB,YAAMtB,OAAN,GAAgB,IAAhB;AACD;AACD,QAAIsB,KAAJ,EAAW;AACTF,WAAKC,CAAL,IAAUC,KAAV;AACD;AACF,GApBH;;AAsBA,MAAIE,WAAWnD,IAAIoD,gBAAJ,GAAuBpD,IAAIoD,gBAAJ,IAAwB,EAA9D;AACAX,SAAOC,IAAP,CAAYS,QAAZ,EAAsBzB,OAAtB,CAA8B,UAAUsB,CAAV,EAAa;AACzC,QAAIK,UAAJ;;AAEA,QAAI,CAACrD,IAAII,MAAT,EAAiB;AACfiD,mBAAarD,IAAIyB,YAAJ,CAAiBuB,CAAjB,CAAb;;AAEA;AACA,UAAI,CAACK,UAAL,EAAiB;AACfrD,YAAIyB,YAAJ,CAAiBuB,CAAjB,IAAsBG,SAASH,CAAT,CAAtB;AACD;AACF,KAPD,MAOO;AACL,UAAIM,IAAItD,IAAII,MAAZ;AACA,aAAOkD,KAAK,CAACD,UAAb,EAAyB;AACvBA,qBAAaC,EAAE7B,YAAF,IAAkB6B,EAAE7B,YAAF,CAAeuB,CAAf,CAA/B;AACAM,YAAIA,EAAE7C,IAAF,GAAS,IAAT,GAAgB6C,EAAElD,MAAtB;AACD;AACF;;AAED,QAAI,CAACiD,UAAL,EAAiB;AACf;AACArD,UAAIyB,YAAJ,CAAiBuB,CAAjB,IAAsBG,SAASH,CAAT,CAAtB;AACD,KAHD,MAGO,IAAI,CAACvE,OAAOuD,SAAP,CAAiBqB,WAAWvB,OAA5B,EAAqCqB,SAASH,CAAT,CAArC,EAAkD,IAAlD,CAAL,EAA8D;AACnEK,iBAAWE,WAAX,GAAyB,IAAzB;AACD;AACF,GAxBD;;AA0BA,SAAOvD,GAAP;AACD;;AAED,SAASG,gBAAT,CAA2BH,GAA3B,EAAgCX,IAAhC,EAAsC;AACpC;AACA;AACA;AACA;;AAEAW,MAAIiC,UAAJ,GAAiB,KAAjB;;AAEA,MAAIc,OAAO/C,IAAI6B,aAAJ,IAAqB,EAAhC;AACA,MAAIxC,KAAKO,GAAL,IAAYI,IAAIqC,eAAhB,KAAoCrC,IAAIE,IAAJ,IAAYF,IAAIS,IAApD,CAAJ,EAA+D;AAC7DgC,WAAOC,IAAP,CAAY1C,IAAIqC,eAAhB,EAAiCX,OAAjC,CAAyC,UAAU8B,CAAV,EAAa;AACpDT,WAAKS,CAAL,IAAUxD,IAAIqC,eAAJ,CAAoBmB,CAApB,CAAV;AACD,KAFD;AAGD;;AAED,MAAIxD,IAAIoD,gBAAR,EAA0B;AACxBX,WAAOC,IAAP,CAAY1C,IAAIoD,gBAAhB,EAAkC1B,OAAlC,CAA0C,UAAU8B,CAAV,EAAa;AACrDT,WAAKS,CAAL,IAAUxD,IAAIoD,gBAAJ,CAAqBI,CAArB,CAAV;AACD,KAFD;AAGD;;AAED1E,QAAM,gBAAN,EAAwBkB,IAAIyD,GAA5B,EAAiCV,IAAjC;AACAN,SAAOC,IAAP,CAAYK,IAAZ,EAAkBrB,OAAlB,CAA0B,UAAUsB,CAAV,EAAa;AACrC,QAAIT,MAAMW,QAAQlD,GAAR,EAAagD,CAAb,CAAV;AACA,QAAIT,OAAOA,IAAIN,UAAf,EAA2B;AACzB9B,uBAAiBoC,GAAjB,EAAsBlD,IAAtB;AACD;AACF,GALD;AAMD;;AAED;AACA;AACA,SAAS6D,OAAT,CAAkBlD,GAAlB,EAAuBgD,CAAvB,EAA0B;AACxB,MAAIM,IAAItD,GAAR;AAAA,MACIiD,QAAQ,IADZ;AAEA,SAAOK,KAAK,CAACL,KAAb,EAAoB;AAClB;AACA;AACA;AACA,QAAI,QAAOK,EAAE7B,YAAF,CAAeuB,CAAf,CAAP,MAA6B,QAAjC,EAA2C;AACzCC,cAAQK,EAAE7B,YAAF,CAAeuB,CAAf,CAAR;AACD;AACD,QAAI,CAACC,KAAD,IAAUK,EAAE1B,QAAF,KAAeoB,CAA7B,EAAgCC,QAAQK,CAAR;AAChCA,QAAIA,EAAE7C,IAAF,GAAS,IAAT,GAAgB6C,EAAElD,MAAtB;AACD;AACD,SAAO6C,KAAP;AACD;;AAED,SAAShC,IAAT,CAAejB,GAAf,EAAoB;AAClB,MAAI,CAACA,GAAD,IAAQ,QAAOA,GAAP,yCAAOA,GAAP,OAAe,QAA3B,EAAqC,OAAOA,GAAP;AACrC,MAAI0D,MAAMC,OAAN,CAAc3D,GAAd,CAAJ,EAAwB,OAAOA,IAAI4D,GAAJ,CAAQ3C,IAAR,CAAP;;AAExB,MAAI4C,IAAI,EAAR;AACA,OAAK,IAAIlD,CAAT,IAAcX,GAAd;AAAmB6D,MAAElD,CAAF,IAAOM,KAAKjB,IAAIW,CAAJ,CAAL,CAAP;AAAnB,GACA,OAAOkD,CAAP;AACD","file":"read-installed.js","sourcesContent":["\n// Walk through the file-system \"database\" of installed\n// packages, and create a data object related to the\n// installed versions of each package.\n\n/*\nThis will traverse through all node_modules folders,\nresolving the dependencies object to the object corresponding to\nthe package that meets that dep, or just the version/range if\nunmet.\n\nAssuming that you had this folder structure:\n\n/path/to\n+-- package.json { name = \"root\" }\n`-- node_modules\n    +-- foo {bar, baz, asdf}\n    | +-- node_modules\n    |   +-- bar { baz }\n    |   `-- baz\n    `-- asdf\n\nwhere \"foo\" depends on bar, baz, and asdf, bar depends on baz,\nand bar and baz are bundled with foo, whereas \"asdf\" is at\nthe higher level (sibling to foo), you'd get this object structure:\n\n{ <package.json data>\n, path: \"/path/to\"\n, parent: null\n, dependencies:\n  { foo :\n    { version: \"1.2.3\"\n    , path: \"/path/to/node_modules/foo\"\n    , parent: <Circular: root>\n    , dependencies:\n      { bar:\n        { parent: <Circular: foo>\n        , path: \"/path/to/node_modules/foo/node_modules/bar\"\n        , version: \"2.3.4\"\n        , dependencies: { baz: <Circular: foo.dependencies.baz> }\n        }\n      , baz: { ... }\n      , asdf: <Circular: asdf>\n      }\n    }\n  , asdf: { ... }\n  }\n}\n\nUnmet deps are left as strings.\nExtraneous deps are marked with extraneous:true\ndeps that don't meet a requirement are marked with invalid:true\ndeps that don't meet a peer requirement are marked with peerInvalid:true\n\nto READ(packagefolder, parentobj, name, reqver)\nobj = read package.json\ninstalled = ./node_modules/*\nif parentobj is null, and no package.json\n  obj = {dependencies:{<installed>:ANY}}\ndeps = Object.keys(obj.dependencies)\nobj.path = packagefolder\nobj.parent = parentobj\nif name, && obj.name !== name, obj.invalid = true\nif reqver, && obj.version !satisfies reqver, obj.invalid = true\nif !reqver && parentobj, obj.extraneous = true\nfor each folder in installed\n  obj.dependencies[folder] = READ(packagefolder+node_modules+folder,\n                                  obj, folder, obj.dependencies[folder])\n# walk tree to find unmet deps\nfor each dep in obj.dependencies not in installed\n  r = obj.parent\n  while r\n    if r.dependencies[dep]\n      if r.dependencies[dep].verion !satisfies obj.dependencies[dep]\n        WARN\n        r.dependencies[dep].invalid = true\n      obj.dependencies[dep] = r.dependencies[dep]\n      r = null\n    else r = r.parent\nreturn obj\n\n\nTODO:\n1. Find unmet deps in parent directories, searching as node does up\nas far as the left-most node_modules folder.\n2. Ignore anything in node_modules that isn't a package folder.\n\n*/\n\ntry {\n  var fs = require(\"graceful-fs\")\n} catch (er) {\n  var fs = require(\"fs\")\n}\n\nvar path = require(\"path\")\nvar asyncMap = require(\"slide\").asyncMap\nvar semver = require(\"semver\")\nvar readJson = require(\"read-package-json\")\nvar url = require(\"url\")\nvar util = require(\"util\")\nvar extend = require(\"util-extend\")\n\nvar debug = require(\"debuglog\")(\"read-installed\")\n\nvar readdir = require(\"readdir-scoped-modules\")\n\n// Sentinel catch-all version constraint used when a dependency is not\n// listed in the package.json file.\nvar ANY = {}\n\nmodule.exports = readInstalled\n\nfunction readInstalled (folder, opts, cb) {\n  if (typeof opts === 'function') {\n    cb = opts\n    opts = {}\n  } else {\n    opts = extend({}, opts)\n  }\n\n  if (typeof opts.depth !== 'number')\n    opts.depth = Infinity\n\n  opts.depth = Math.max(0, opts.depth)\n\n  if (typeof opts.log !== 'function')\n    opts.log = function () {}\n\n  opts.dev = !!opts.dev\n  opts.realpathSeen = {}\n  opts.findUnmetSeen = []\n\n\n  readInstalled_(folder, null, null, null, 0, opts, function (er, obj) {\n    if (er) return cb(er)\n    // now obj has all the installed things, where they're installed\n    // figure out the inheritance links, now that the object is built.\n    resolveInheritance(obj, opts)\n    obj.root = true\n    unmarkExtraneous(obj, opts)\n    cb(null, obj)\n  })\n}\n\nfunction readInstalled_ (folder, parent, name, reqver, depth, opts, cb) {\n  var installed\n    , obj\n    , real\n    , link\n    , realpathSeen = opts.realpathSeen\n\n  readdir(path.resolve(folder, \"node_modules\"), function (er, i) {\n    // error indicates that nothing is installed here\n    if (er) i = []\n    installed = i.filter(function (f) { return f.charAt(0) !== \".\" })\n    next()\n  })\n\n  readJson(path.resolve(folder, \"package.json\"), function (er, data) {\n    obj = copy(data)\n\n    if (!parent) {\n      obj = obj || true\n      er = null\n    }\n    return next(er)\n  })\n\n  fs.lstat(folder, function (er, st) {\n    if (er) {\n      if (!parent) real = true\n      return next(er)\n    }\n    fs.realpath(folder, function (er, rp) {\n      debug(\"realpath(%j) = %j\", folder, rp)\n      real = rp\n      if (st.isSymbolicLink()) link = rp\n      next(er)\n    })\n  })\n\n  var errState = null\n    , called = false\n  function next (er) {\n    if (errState) return\n    if (er) {\n      errState = er\n      return cb(null, [])\n    }\n    debug('next', installed, obj && typeof obj, name, real)\n    if (!installed || !obj || !real || called) return\n    called = true\n    if (realpathSeen[real]) return cb(null, realpathSeen[real])\n    if (obj === true) {\n      obj = {dependencies:{}, path:folder}\n      installed.forEach(function (i) { obj.dependencies[i] = ANY })\n    }\n    if (name && obj.name !== name) obj.invalid = true\n    obj.realName = name || obj.name\n    obj.dependencies = obj.dependencies || {}\n\n    // At this point, figure out what dependencies we NEED to get met\n    obj._dependencies = copy(obj.dependencies)\n\n    if (reqver === ANY) {\n      // We were unable to determine the required version of this\n      // dependency from the package.json file, but we now know its actual\n      // version, so treat that version as the required version to avoid\n      // marking the dependency as invalid below. See #40.\n      reqver = obj.version;\n    }\n\n    // \"foo\":\"http://blah\" and \"foo\":\"latest\" are always presumed valid\n    if (reqver\n        && semver.validRange(reqver, true)\n        && !semver.satisfies(obj.version, reqver, true)) {\n      obj.invalid = true\n    }\n\n    // Mark as extraneous at this point.\n    // This will be un-marked in unmarkExtraneous, where we mark as\n    // not-extraneous everything that is required in some way from\n    // the root object.\n    obj.extraneous = true\n\n    obj.path = obj.path || folder\n    obj.realPath = real\n    obj.link = link\n    if (parent && !obj.link) obj.parent = parent\n    realpathSeen[real] = obj\n    obj.depth = depth\n    //if (depth >= opts.depth) return cb(null, obj)\n    asyncMap(installed, function (pkg, cb) {\n      var rv = obj.dependencies[pkg]\n      if (!rv && obj.devDependencies && opts.dev)\n        rv = obj.devDependencies[pkg]\n\n      if (depth > opts.depth) {\n        obj.dependencies = {}\n        return cb(null, obj)\n      }\n\n      readInstalled_( path.resolve(folder, \"node_modules/\"+pkg)\n                    , obj, pkg, obj.dependencies[pkg], depth + 1, opts\n                    , cb )\n\n    }, function (er, installedData) {\n      if (er) return cb(er)\n      installedData.forEach(function (dep) {\n        obj.dependencies[dep.realName] = dep\n      })\n\n      // any strings here are unmet things.  however, if it's\n      // optional, then that's fine, so just delete it.\n      if (obj.optionalDependencies) {\n        Object.keys(obj.optionalDependencies).forEach(function (dep) {\n          if (typeof obj.dependencies[dep] === \"string\") {\n            delete obj.dependencies[dep]\n          }\n        })\n      }\n      return cb(null, obj)\n    })\n  }\n}\n\n// starting from a root object, call findUnmet on each layer of children\nvar riSeen = []\nfunction resolveInheritance (obj, opts) {\n  if (typeof obj !== \"object\") return\n  if (riSeen.indexOf(obj) !== -1) return\n  riSeen.push(obj)\n  if (typeof obj.dependencies !== \"object\") {\n    obj.dependencies = {}\n  }\n  Object.keys(obj.dependencies).forEach(function (dep) {\n    findUnmet(obj.dependencies[dep], opts)\n  })\n  Object.keys(obj.dependencies).forEach(function (dep) {\n    if (typeof obj.dependencies[dep] === \"object\") {\n      resolveInheritance(obj.dependencies[dep], opts)\n    } else {\n      debug(\"unmet dep! %s %s@%s\", obj.name, dep, obj.dependencies[dep])\n    }\n  })\n  findUnmet(obj, opts)\n}\n\n// find unmet deps by walking up the tree object.\n// No I/O\nfunction findUnmet (obj, opts) {\n  var findUnmetSeen = opts.findUnmetSeen\n  if (findUnmetSeen.indexOf(obj) !== -1) return\n  findUnmetSeen.push(obj)\n  debug(\"find unmet parent=%s obj=\", obj.parent && obj.parent.name, obj.name || obj)\n  var deps = obj.dependencies = obj.dependencies || {}\n\n  debug(deps)\n  Object.keys(deps)\n    .filter(function (d) { return typeof deps[d] === \"string\" })\n    .forEach(function (d) {\n      var found = findDep(obj, d)\n      debug(\"finding dep %j\", d, found && found.name || found)\n      // \"foo\":\"http://blah\" and \"foo\":\"latest\" are always presumed valid\n      if (typeof deps[d] === \"string\" &&\n          semver.validRange(deps[d], true) &&\n          found &&\n          !semver.satisfies(found.version, deps[d], true)) {\n        // the bad thing will happen\n        opts.log( \"unmet dependency\"\n                , obj.path + \" requires \"+d+\"@'\"+deps[d]\n                + \"' but will load\\n\"\n                + found.path+\",\\nwhich is version \"+found.version )\n        found.invalid = true\n      }\n      if (found) {\n        deps[d] = found\n      }\n    })\n\n  var peerDeps = obj.peerDependencies = obj.peerDependencies || {}\n  Object.keys(peerDeps).forEach(function (d) {\n    var dependency\n\n    if (!obj.parent) {\n      dependency = obj.dependencies[d]\n\n      // read it as a missing dep\n      if (!dependency) {\n        obj.dependencies[d] = peerDeps[d]\n      }\n    } else {\n      var r = obj.parent\n      while (r && !dependency) {\n        dependency = r.dependencies && r.dependencies[d]\n        r = r.link ? null : r.parent\n      }\n    }\n\n    if (!dependency) {\n      // mark as a missing dep!\n      obj.dependencies[d] = peerDeps[d]\n    } else if (!semver.satisfies(dependency.version, peerDeps[d], true)) {\n      dependency.peerInvalid = true\n    }\n  })\n\n  return obj\n}\n\nfunction unmarkExtraneous (obj, opts) {\n  // Mark all non-required deps as extraneous.\n  // start from the root object and mark as non-extraneous all modules\n  // that haven't been previously flagged as extraneous then propagate\n  // to all their dependencies\n\n  obj.extraneous = false\n\n  var deps = obj._dependencies || []\n  if (opts.dev && obj.devDependencies && (obj.root || obj.link)) {\n    Object.keys(obj.devDependencies).forEach(function (k) {\n      deps[k] = obj.devDependencies[k]\n    })\n  }\n\n  if (obj.peerDependencies) {\n    Object.keys(obj.peerDependencies).forEach(function (k) {\n      deps[k] = obj.peerDependencies[k]\n    })\n  }\n\n  debug(\"not extraneous\", obj._id, deps)\n  Object.keys(deps).forEach(function (d) {\n    var dep = findDep(obj, d)\n    if (dep && dep.extraneous) {\n      unmarkExtraneous(dep, opts)\n    }\n  })\n}\n\n// Find the one that will actually be loaded by require()\n// so we can make sure it's valid etc.\nfunction findDep (obj, d) {\n  var r = obj\n    , found = null\n  while (r && !found) {\n    // if r is a valid choice, then use that.\n    // kinda weird if a pkg depends on itself, but after the first\n    // iteration of this loop, it indicates a dep cycle.\n    if (typeof r.dependencies[d] === \"object\") {\n      found = r.dependencies[d]\n    }\n    if (!found && r.realName === d) found = r\n    r = r.link ? null : r.parent\n  }\n  return found\n}\n\nfunction copy (obj) {\n  if (!obj || typeof obj !== 'object') return obj\n  if (Array.isArray(obj)) return obj.map(copy)\n\n  var o = {}\n  for (var i in obj) o[i] = copy(obj[i])\n  return o\n}\n"]}
{"version":3,"sources":["../../../../../node_modules/npm/node_modules/lockfile/lockfile.js"],"names":["fs","require","wx","process","version","match","c","O_TRUNC","O_CREAT","O_WRONLY","O_EXCL","os","exports","filetime","platform","debug","util","debuglog","test","env","NODE_DEBUG","msg","format","apply","arguments","console","error","pid","locks","hasOwnProperty","obj","prop","Object","prototype","call","onExit","keys","forEach","unlockSync","on","H","er","l","listeners","filter","h","length","e","removeListener","unlock","path","cb","unlink","unlinkEr","unlinkSync","check","opts","open","fd","code","stale","close","fstat","st","er2","age","Date","now","getTime","checkSync","wait","Error","openSync","closeSync","fstatSync","req","lock","start","retries","orig","retryWait","setTimeout","retry","notStale","maybeStale","originalEr","hasStaleLock","stat","statEr","link","end","Math","min","pollPeriod","timer","poll","lockSync","retryThrow","statSync","ct","ceil","newRT"],"mappings":"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","file":"lockfile.js","sourcesContent":["var fs = require('fs')\n\nvar wx = 'wx'\nif (process.version.match(/^v0\\.[0-6]/)) {\n  var c = require('constants')\n  wx = c.O_TRUNC | c.O_CREAT | c.O_WRONLY | c.O_EXCL\n}\n\nvar os = require('os')\nexports.filetime = 'ctime'\nif (os.platform() == \"win32\") {\n  exports.filetime = 'mtime'\n}\n\nvar debug\nvar util = require('util')\nif (util.debuglog)\n  debug = util.debuglog('LOCKFILE')\nelse if (/\\blockfile\\b/i.test(process.env.NODE_DEBUG))\n  debug = function() {\n    var msg = util.format.apply(util, arguments)\n    console.error('LOCKFILE %d %s', process.pid, msg)\n  }\nelse\n  debug = function() {}\n\nvar locks = {}\n\nfunction hasOwnProperty (obj, prop) {\n  return Object.prototype.hasOwnProperty.call(obj, prop)\n}\n\nvar onExit = require('signal-exit')\nonExit(function () {\n  debug('exit listener')\n  // cleanup\n  Object.keys(locks).forEach(exports.unlockSync)\n})\n\n// XXX https://github.com/joyent/node/issues/3555\n// Remove when node 0.8 is deprecated.\nif (/^v0\\.[0-8]\\./.test(process.version)) {\n  debug('uncaughtException, version = %s', process.version)\n  process.on('uncaughtException', function H (er) {\n    debug('uncaughtException')\n    var l = process.listeners('uncaughtException').filter(function (h) {\n      return h !== H\n    })\n    if (!l.length) {\n      // cleanup\n      try { Object.keys(locks).forEach(exports.unlockSync) } catch (e) {}\n      process.removeListener('uncaughtException', H)\n      throw er\n    }\n  })\n}\n\nexports.unlock = function (path, cb) {\n  debug('unlock', path)\n  // best-effort.  unlocking an already-unlocked lock is a noop\n  delete locks[path]\n  fs.unlink(path, function (unlinkEr) { cb && cb() })\n}\n\nexports.unlockSync = function (path) {\n  debug('unlockSync', path)\n  // best-effort.  unlocking an already-unlocked lock is a noop\n  try { fs.unlinkSync(path) } catch (er) {}\n  delete locks[path]\n}\n\n\n// if the file can be opened in readonly mode, then it's there.\n// if the error is something other than ENOENT, then it's not.\nexports.check = function (path, opts, cb) {\n  if (typeof opts === 'function') cb = opts, opts = {}\n  debug('check', path, opts)\n  fs.open(path, 'r', function (er, fd) {\n    if (er) {\n      if (er.code !== 'ENOENT') return cb(er)\n      return cb(null, false)\n    }\n\n    if (!opts.stale) {\n      return fs.close(fd, function (er) {\n        return cb(er, true)\n      })\n    }\n\n    fs.fstat(fd, function (er, st) {\n      if (er) return fs.close(fd, function (er2) {\n        return cb(er)\n      })\n\n      fs.close(fd, function (er) {\n        var age = Date.now() - st[exports.filetime].getTime()\n        return cb(er, age <= opts.stale)\n      })\n    })\n  })\n}\n\nexports.checkSync = function (path, opts) {\n  opts = opts || {}\n  debug('checkSync', path, opts)\n  if (opts.wait) {\n    throw new Error('opts.wait not supported sync for obvious reasons')\n  }\n\n  try {\n    var fd = fs.openSync(path, 'r')\n  } catch (er) {\n    if (er.code !== 'ENOENT') throw er\n    return false\n  }\n\n  if (!opts.stale) {\n    try { fs.closeSync(fd) } catch (er) {}\n    return true\n  }\n\n  // file exists.  however, might be stale\n  if (opts.stale) {\n    try {\n      var st = fs.fstatSync(fd)\n    } finally {\n      fs.closeSync(fd)\n    }\n    var age = Date.now() - st[exports.filetime].getTime()\n    return (age <= opts.stale)\n  }\n}\n\n\n\nvar req = 1\nexports.lock = function (path, opts, cb) {\n  if (typeof opts === 'function') cb = opts, opts = {}\n  opts.req = opts.req || req++\n  debug('lock', path, opts)\n  opts.start = opts.start || Date.now()\n\n  if (typeof opts.retries === 'number' && opts.retries > 0) {\n    debug('has retries', opts.retries)\n    var retries = opts.retries\n    opts.retries = 0\n    cb = (function (orig) { return function cb (er, fd) {\n      debug('retry-mutated callback')\n      retries -= 1\n      if (!er || retries < 0) return orig(er, fd)\n\n      debug('lock retry', path, opts)\n\n      if (opts.retryWait) setTimeout(retry, opts.retryWait)\n      else retry()\n\n      function retry () {\n        opts.start = Date.now()\n        debug('retrying', opts.start)\n        exports.lock(path, opts, cb)\n      }\n    }})(cb)\n  }\n\n  // try to engage the lock.\n  // if this succeeds, then we're in business.\n  fs.open(path, wx, function (er, fd) {\n    if (!er) {\n      debug('locked', path, fd)\n      locks[path] = fd\n      return fs.close(fd, function () {\n        return cb()\n      })\n    }\n\n    debug('failed to acquire lock', er)\n\n    // something other than \"currently locked\"\n    // maybe eperm or something.\n    if (er.code !== 'EEXIST') {\n      debug('not EEXIST error', er)\n      return cb(er)\n    }\n\n    // someone's got this one.  see if it's valid.\n    if (!opts.stale) return notStale(er, path, opts, cb)\n\n    return maybeStale(er, path, opts, false, cb)\n  })\n  debug('lock return')\n}\n\n\n// Staleness checking algorithm\n// 1. acquire $lock, fail\n// 2. stat $lock, find that it is stale\n// 3. acquire $lock.STALE\n// 4. stat $lock, assert that it is still stale\n// 5. unlink $lock\n// 6. link $lock.STALE $lock\n// 7. unlink $lock.STALE\n// On any failure, clean up whatever we've done, and raise the error.\nfunction maybeStale (originalEr, path, opts, hasStaleLock, cb) {\n  fs.stat(path, function (statEr, st) {\n    if (statEr) {\n      if (statEr.code === 'ENOENT') {\n        // expired already!\n        opts.stale = false\n        debug('lock stale enoent retry', path, opts)\n        exports.lock(path, opts, cb)\n        return\n      }\n      return cb(statEr)\n    }\n\n    var age = Date.now() - st[exports.filetime].getTime()\n    if (age <= opts.stale) return notStale(originalEr, path, opts, cb)\n\n    debug('lock stale', path, opts)\n    if (hasStaleLock) {\n      exports.unlock(path, function (er) {\n        if (er) return cb(er)\n        debug('lock stale retry', path, opts)\n        fs.link(path + '.STALE', path, function (er) {\n          fs.unlink(path + '.STALE', function () {\n            // best effort.  if the unlink fails, oh well.\n            cb(er)\n          })\n        })\n      })\n    } else {\n      debug('acquire .STALE file lock', opts)\n      exports.lock(path + '.STALE', opts, function (er) {\n        if (er) return cb(er)\n        maybeStale(originalEr, path, opts, true, cb)\n      })\n    }\n  })\n}\n\nfunction notStale (er, path, opts, cb) {\n  debug('notStale', path, opts)\n\n  // if we can't wait, then just call it a failure\n  if (typeof opts.wait !== 'number' || opts.wait <= 0) {\n    debug('notStale, wait is not a number')\n    return cb(er)\n  }\n\n  // poll for some ms for the lock to clear\n  var now = Date.now()\n  var start = opts.start || now\n  var end = start + opts.wait\n\n  if (end <= now)\n    return cb(er)\n\n  debug('now=%d, wait until %d (delta=%d)', start, end, end-start)\n  var wait = Math.min(end - start, opts.pollPeriod || 100)\n  var timer = setTimeout(poll, wait)\n\n  function poll () {\n    debug('notStale, polling', path, opts)\n    exports.lock(path, opts, cb)\n  }\n}\n\nexports.lockSync = function (path, opts) {\n  opts = opts || {}\n  opts.req = opts.req || req++\n  debug('lockSync', path, opts)\n  if (opts.wait || opts.retryWait) {\n    throw new Error('opts.wait not supported sync for obvious reasons')\n  }\n\n  try {\n    var fd = fs.openSync(path, wx)\n    locks[path] = fd\n    try { fs.closeSync(fd) } catch (er) {}\n    debug('locked sync!', path, fd)\n    return\n  } catch (er) {\n    if (er.code !== 'EEXIST') return retryThrow(path, opts, er)\n\n    if (opts.stale) {\n      var st = fs.statSync(path)\n      var ct = st[exports.filetime].getTime()\n      if (!(ct % 1000) && (opts.stale % 1000)) {\n        // probably don't have subsecond resolution.\n        // round up the staleness indicator.\n        // Yes, this will be wrong 1/1000 times on platforms\n        // with subsecond stat precision, but that's acceptable\n        // in exchange for not mistakenly removing locks on\n        // most other systems.\n        opts.stale = 1000 * Math.ceil(opts.stale / 1000)\n      }\n      var age = Date.now() - ct\n      if (age > opts.stale) {\n        debug('lockSync stale', path, opts, age)\n        exports.unlockSync(path)\n        return exports.lockSync(path, opts)\n      }\n    }\n\n    // failed to lock!\n    debug('failed to lock', path, opts, er)\n    return retryThrow(path, opts, er)\n  }\n}\n\nfunction retryThrow (path, opts, er) {\n  if (typeof opts.retries === 'number' && opts.retries > 0) {\n    var newRT = opts.retries - 1\n    debug('retryThrow', path, opts, newRT)\n    opts.retries = newRT\n    return exports.lockSync(path, opts)\n  }\n  throw er\n}\n\n"]}
{"version":3,"sources":["../../../../../../node_modules/npm/node_modules/lockfile/test/basic.js"],"names":["test","require","lockFile","path","fs","touch","filetime","t","unlockSync","er","end","gotlocks","N","delay","overhead","wait","lock","ifError","pass","setTimeout","unlock","i","check","locked","notOk","ok","checkSync","lockSync","child","resolve","node","process","execPath","spawn","on","sync","time","Date","now","opts","stale","opens","_open","open","mode","cb","Error","code","nextTick","bind","retries","equal","retryWait","_openSync","openSync","interval","setInterval","opt","pollInterval","fail","clearInterval"],"mappings":"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","file":"basic.js","sourcesContent":["var test = require('tap').test\nvar lockFile = require('../lockfile.js')\nvar path = require('path')\nvar fs = require('fs')\nvar touch = require('touch')\n\n// On Unix systems, it uses ctime by default for staleness checks, since it's\n// the most reliable.  However, because this test artificially sets some locks\n// to an earlier time to simulate staleness, we use mtime here.\nlockFile.filetime = 'mtime'\n\ntest('setup', function (t) {\n  try { lockFile.unlockSync('basic-lock') } catch (er) {}\n  try { lockFile.unlockSync('sync-lock') } catch (er) {}\n  try { lockFile.unlockSync('never-forget') } catch (er) {}\n  try { lockFile.unlockSync('stale-lock') } catch (er) {}\n  try { lockFile.unlockSync('watch-lock') } catch (er) {}\n  try { lockFile.unlockSync('retry-lock') } catch (er) {}\n  try { lockFile.unlockSync('contentious-lock') } catch (er) {}\n  try { lockFile.unlockSync('stale-wait-lock') } catch (er) {}\n  try { lockFile.unlockSync('stale-windows-lock') } catch (er) {}\n  t.end()\n})\n\ntest('lock contention', function (t) {\n  var gotlocks = 0;\n  var N = 200\n  var delay = 10\n  // allow for some time for each lock acquisition and release.\n  // note that raising N higher will mean that the overhead\n  // increases, because we're creating more and more watchers.\n  // irl, you should never have several hundred contenders for a\n  // single lock, so this situation is somewhat pathological.\n  var overhead = 200\n  var wait = N * overhead + delay\n\n  // first make it locked, so that everyone has to wait\n  lockFile.lock('contentious-lock', function(er, lock) {\n    t.ifError(er, 'acquiring starter')\n    if (er) throw er;\n    t.pass('acquired starter lock')\n    setTimeout(function() {\n      lockFile.unlock('contentious-lock', function (er) {\n        t.ifError(er, 'unlocking starter')\n        if (er) throw er\n        t.pass('unlocked starter')\n      })\n    }, delay)\n  })\n\n  for (var i=0; i < N; i++)\n    lockFile.lock('contentious-lock', { wait: wait }, function(er, lock) {\n      if (er) throw er;\n      lockFile.unlock('contentious-lock', function(er) {\n        if (er) throw er\n        gotlocks++\n        t.pass('locked and unlocked #' + gotlocks)\n        if (gotlocks === N) {\n          t.pass('got all locks')\n          t.end()\n        }\n      })\n    })\n})\n\ntest('basic test', function (t) {\n  lockFile.check('basic-lock', function (er, locked) {\n    if (er) throw er\n    t.notOk(locked)\n    lockFile.lock('basic-lock', function (er) {\n      if (er) throw er\n      lockFile.lock('basic-lock', function (er) {\n        t.ok(er)\n        lockFile.check('basic-lock', function (er, locked) {\n          if (er) throw er\n          t.ok(locked)\n          lockFile.unlock('basic-lock', function (er) {\n            if (er) throw er\n            lockFile.check('basic-lock', function (er, locked) {\n              if (er) throw er\n              t.notOk(locked)\n              t.end()\n            })\n          })\n        })\n      })\n    })\n  })\n})\n\ntest('sync test', function (t) {\n  var locked\n  locked = lockFile.checkSync('sync-lock')\n  t.notOk(locked)\n  lockFile.lockSync('sync-lock')\n  locked = lockFile.checkSync('sync-lock')\n  t.ok(locked)\n  lockFile.unlockSync('sync-lock')\n  locked = lockFile.checkSync('sync-lock')\n  t.notOk(locked)\n  t.end()\n})\n\ntest('exit cleanup test', function (t) {\n  var child = require.resolve('./fixtures/child.js')\n  var node = process.execPath\n  var spawn = require('child_process').spawn\n  spawn(node, [child]).on('exit', function () {\n    setTimeout(function () {\n      var locked = lockFile.checkSync('never-forget')\n      t.notOk(locked)\n      t.end()\n    }, 100)\n  })\n})\n\ntest('error exit cleanup test', function (t) {\n  var child = require.resolve('./fixtures/bad-child.js')\n  var node = process.execPath\n  var spawn = require('child_process').spawn\n  spawn(node, [child]).on('exit', function () {\n    setTimeout(function () {\n      var locked = lockFile.checkSync('never-forget')\n      t.notOk(locked)\n      t.end()\n    }, 100)\n  })\n})\n\n\ntest('staleness test', function (t) {\n  lockFile.lock('stale-lock', function (er) {\n    if (er) throw er\n\n    // simulate 2s old\n    touch.sync('stale-lock', { time: new Date(Date.now() - 2000) })\n\n    var opts = { stale: 1 }\n    lockFile.check('stale-lock', opts, function (er, locked) {\n      if (er) throw er\n      t.notOk(locked)\n      lockFile.lock('stale-lock', opts, function (er) {\n        if (er) throw er\n        lockFile.unlock('stale-lock', function (er) {\n          if (er) throw er\n          t.end()\n        })\n      })\n    })\n  })\n})\n\ntest('staleness sync test', function (t) {\n  var opts = { stale: 1 }\n  lockFile.lockSync('stale-lock')\n  // simulate 2s old\n  touch.sync('stale-lock', { time: new Date(Date.now() - 2000) })\n  var locked\n  locked = lockFile.checkSync('stale-lock', opts)\n  t.notOk(locked)\n  lockFile.lockSync('stale-lock', opts)\n  lockFile.unlockSync('stale-lock')\n  t.end()\n})\n\ntest('retries', function (t) {\n  // next 5 opens will fail.\n  var opens = 5\n  fs._open = fs.open\n  fs.open = function (path, mode, cb) {\n    if (--opens === 0) {\n      fs.open = fs._open\n      return fs.open(path, mode, cb)\n    }\n    var er = new Error('bogus')\n    // to be, or not to be, that is the question.\n    er.code = opens % 2 ? 'EEXIST' : 'ENOENT'\n    process.nextTick(cb.bind(null, er))\n  }\n\n  lockFile.lock('retry-lock', { retries: opens }, function (er) {\n    if (er) throw er\n    t.equal(opens, 0)\n    lockFile.unlockSync('retry-lock')\n    t.end()\n  })\n})\n\ntest('retryWait', function (t) {\n  // next 5 opens will fail.\n  var opens = 5\n  fs._open = fs.open\n  fs.open = function (path, mode, cb) {\n    if (--opens === 0) {\n      fs.open = fs._open\n      return fs.open(path, mode, cb)\n    }\n    var er = new Error('bogus')\n    // to be, or not to be, that is the question.\n    er.code = opens % 2 ? 'EEXIST' : 'ENOENT'\n    process.nextTick(cb.bind(null, er))\n  }\n\n  var opts = { retries: opens, retryWait: 100 }\n  lockFile.lock('retry-lock', opts, function (er) {\n    if (er) throw er\n    t.equal(opens, 0)\n    lockFile.unlockSync('retry-lock')\n    t.end()\n  })\n})\n\ntest('retry sync', function (t) {\n  // next 5 opens will fail.\n  var opens = 5\n  fs._openSync = fs.openSync\n  fs.openSync = function (path, mode) {\n    if (--opens === 0) {\n      fs.openSync = fs._openSync\n      return fs.openSync(path, mode)\n    }\n    var er = new Error('bogus')\n    // to be, or not to be, that is the question.\n    er.code = opens % 2 ? 'EEXIST' : 'ENOENT'\n    throw er\n  }\n\n  var opts = { retries: opens }\n  lockFile.lockSync('retry-lock', opts)\n  t.equal(opens, 0)\n  lockFile.unlockSync('retry-lock')\n  t.end()\n})\n\ntest('wait and stale together', function (t) {\n  // first locker.\n  var interval\n  lockFile.lock('stale-wait-lock', function(er) {\n    // keep refreshing the lock, so we keep it forever\n    interval = setInterval(function() {\n      touch.sync('stale-wait-lock')\n    }, 10)\n\n    // try to get another lock.  this must fail!\n    var opt = { stale: 1000, wait: 2000, pollInterval: 1000 }\n    lockFile.lock('stale-wait-lock', opt, function (er) {\n      if (!er)\n        t.fail('got second lock?  that unpossible!')\n      else\n        t.pass('second lock failed, as i have foreseen it')\n      clearInterval(interval)\n      t.end()\n    })\n  })\n})\n\n\ntest('stale windows file tunneling test', function (t) {\n  // for windows only\n  // nt file system tunneling feature will make file creation time not updated\n  var opts = { stale: 1000 }\n  lockFile.lockSync('stale-windows-lock')\n  touch.sync('stale-windows-lock', { time: new Date(Date.now() - 3000) })\n\n  var locked\n  lockFile.unlockSync('stale-windows-lock')\n  lockFile.lockSync('stale-windows-lock', opts)\n  locked = lockFile.checkSync('stale-windows-lock', opts)\n  t.ok(locked, \"should be locked and not stale\")\n  lockFile.lock('stale-windows-lock', opts, function (er) {\n    if (!er)\n      t.fail('got second lock?  impossible, windows file tunneling problem!')\n    else\n      t.pass('second lock failed, windows file tunneling problem fixed')\n    t.end()\n  })\n})\n\n\ntest('cleanup', function (t) {\n  try { lockFile.unlockSync('basic-lock') } catch (er) {}\n  try { lockFile.unlockSync('sync-lock') } catch (er) {}\n  try { lockFile.unlockSync('never-forget') } catch (er) {}\n  try { lockFile.unlockSync('stale-lock') } catch (er) {}\n  try { lockFile.unlockSync('watch-lock') } catch (er) {}\n  try { lockFile.unlockSync('retry-lock') } catch (er) {}\n  try { lockFile.unlockSync('contentious-lock') } catch (er) {}\n  try { lockFile.unlockSync('stale-wait-lock') } catch (er) {}\n  try { lockFile.unlockSync('stale-windows-lock') } catch (er) {}\n  t.end()\n})\n\n"]}
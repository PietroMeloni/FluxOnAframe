{"version":3,"sources":["../../../../../../node_modules/npm/node_modules/sntp/lib/index.js"],"names":["Dgram","require","Dns","Hoek","internals","exports","time","options","callback","arguments","length","settings","clone","host","port","resolveReference","timeoutId","sent","finish","err","result","clearTimeout","socket","removeAllListeners","once","ignore","close","createSocket","on","buffer","rinfo","received","Date","now","message","NtpMessage","isValid","Error","originateTimestamp","T1","T2","receiveTimestamp","T3","transmitTimestamp","T4","d","t","receivedLocally","stratum","reverse","referenceId","domains","referenceHost","timeout","setTimeout","Buffer","i","fromMsecs","send","bytes","li","leapIndicator","vn","version","mode","pollInterval","Math","round","pow","precision","rootDelay","rootDispersion","String","fromCharCode","referenceTimestamp","toMsecs","offset","seconds","fraction","ts","floor","last","expires","clockSyncRefresh","process","nextTick","intervalId","start","setInterval","stop","clearInterval","isLive"],"mappings":"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","file":"index.js","sourcesContent":["// Load modules\n\nvar Dgram = require('dgram');\nvar Dns = require('dns');\nvar Hoek = require('hoek');\n\n\n// Declare internals\n\nvar internals = {};\n\n\nexports.time = function (options, callback) {\n\n    if (arguments.length !== 2) {\n        callback = arguments[0];\n        options = {};\n    }\n\n    var settings = Hoek.clone(options);\n    settings.host = settings.host || 'pool.ntp.org';\n    settings.port = settings.port || 123;\n    settings.resolveReference = settings.resolveReference || false;\n\n    // Declare variables used by callback\n\n    var timeoutId = 0;\n    var sent = 0;\n\n    // Ensure callback is only called once\n\n    var finish = function (err, result) {\n\n        if (timeoutId) {\n            clearTimeout(timeoutId);\n            timeoutId = 0;\n        }\n\n        socket.removeAllListeners();\n        socket.once('error', internals.ignore);\n        socket.close();\n        return callback(err, result);\n    };\n\n    finish = Hoek.once(finish);\n\n    // Create UDP socket\n\n    var socket = Dgram.createSocket('udp4');\n\n    socket.once('error', function (err) {\n\n        return finish(err);\n    });\n\n    // Listen to incoming messages\n\n    socket.on('message', function (buffer, rinfo) {\n\n        var received = Date.now();\n\n        var message = new internals.NtpMessage(buffer);\n        if (!message.isValid) {\n            return finish(new Error('Invalid server response'), message);\n        }\n\n        if (message.originateTimestamp !== sent) {\n            return finish(new Error('Wrong originate timestamp'), message);\n        }\n\n        // Timestamp Name          ID   When Generated\n        // ------------------------------------------------------------\n        // Originate Timestamp     T1   time request sent by client\n        // Receive Timestamp       T2   time request received by server\n        // Transmit Timestamp      T3   time reply sent by server\n        // Destination Timestamp   T4   time reply received by client\n        //\n        // The roundtrip delay d and system clock offset t are defined as:\n        //\n        // d = (T4 - T1) - (T3 - T2)     t = ((T2 - T1) + (T3 - T4)) / 2\n\n        var T1 = message.originateTimestamp;\n        var T2 = message.receiveTimestamp;\n        var T3 = message.transmitTimestamp;\n        var T4 = received;\n\n        message.d = (T4 - T1) - (T3 - T2);\n        message.t = ((T2 - T1) + (T3 - T4)) / 2;\n        message.receivedLocally = received;\n\n        if (!settings.resolveReference ||\n            message.stratum !== 'secondary') {\n\n            return finish(null, message);\n        }\n\n        // Resolve reference IP address\n\n        Dns.reverse(message.referenceId, function (err, domains) {\n\n            if (/* $lab:coverage:off$ */ !err /* $lab:coverage:on$ */) {\n                message.referenceHost = domains[0];\n            }\n\n            return finish(null, message);\n        });\n    });\n\n    // Set timeout\n\n    if (settings.timeout) {\n        timeoutId = setTimeout(function () {\n\n            timeoutId = 0;\n            return finish(new Error('Timeout'));\n        }, settings.timeout);\n    }\n\n    // Construct NTP message\n\n    var message = new Buffer(48);\n    for (var i = 0; i < 48; i++) {                      // Zero message\n        message[i] = 0;\n    }\n\n    message[0] = (0 << 6) + (4 << 3) + (3 << 0)         // Set version number to 4 and Mode to 3 (client)\n    sent = Date.now();\n    internals.fromMsecs(sent, message, 40);               // Set transmit timestamp (returns as originate)\n\n    // Send NTP request\n\n    socket.send(message, 0, message.length, settings.port, settings.host, function (err, bytes) {\n\n        if (err ||\n            bytes !== 48) {\n\n            return finish(err || new Error('Could not send entire message'));\n        }\n    });\n};\n\n\ninternals.NtpMessage = function (buffer) {\n\n    this.isValid = false;\n\n    // Validate\n\n    if (buffer.length !== 48) {\n        return;\n    }\n\n    // Leap indicator\n\n    var li = (buffer[0] >> 6);\n    switch (li) {\n        case 0: this.leapIndicator = 'no-warning'; break;\n        case 1: this.leapIndicator = 'last-minute-61'; break;\n        case 2: this.leapIndicator = 'last-minute-59'; break;\n        case 3: this.leapIndicator = 'alarm'; break;\n    }\n\n    // Version\n\n    var vn = ((buffer[0] & 0x38) >> 3);\n    this.version = vn;\n\n    // Mode\n\n    var mode = (buffer[0] & 0x7);\n    switch (mode) {\n        case 1: this.mode = 'symmetric-active'; break;\n        case 2: this.mode = 'symmetric-passive'; break;\n        case 3: this.mode = 'client'; break;\n        case 4: this.mode = 'server'; break;\n        case 5: this.mode = 'broadcast'; break;\n        case 0:\n        case 6:\n        case 7: this.mode = 'reserved'; break;\n    }\n\n    // Stratum\n\n    var stratum = buffer[1];\n    if (stratum === 0) {\n        this.stratum = 'death';\n    }\n    else if (stratum === 1) {\n        this.stratum = 'primary';\n    }\n    else if (stratum <= 15) {\n        this.stratum = 'secondary';\n    }\n    else {\n        this.stratum = 'reserved';\n    }\n\n    // Poll interval (msec)\n\n    this.pollInterval = Math.round(Math.pow(2, buffer[2])) * 1000;\n\n    // Precision (msecs)\n\n    this.precision = Math.pow(2, buffer[3]) * 1000;\n\n    // Root delay (msecs)\n\n    var rootDelay = 256 * (256 * (256 * buffer[4] + buffer[5]) + buffer[6]) + buffer[7];\n    this.rootDelay = 1000 * (rootDelay / 0x10000);\n\n    // Root dispersion (msecs)\n\n    this.rootDispersion = ((buffer[8] << 8) + buffer[9] + ((buffer[10] << 8) + buffer[11]) / Math.pow(2, 16)) * 1000;\n\n    // Reference identifier\n\n    this.referenceId = '';\n    switch (this.stratum) {\n        case 'death':\n        case 'primary':\n            this.referenceId = String.fromCharCode(buffer[12]) + String.fromCharCode(buffer[13]) + String.fromCharCode(buffer[14]) + String.fromCharCode(buffer[15]);\n            break;\n        case 'secondary':\n            this.referenceId = '' + buffer[12] + '.' + buffer[13] + '.' + buffer[14] + '.' + buffer[15];\n            break;\n    }\n\n    // Reference timestamp\n\n    this.referenceTimestamp = internals.toMsecs(buffer, 16);\n\n    // Originate timestamp\n\n    this.originateTimestamp = internals.toMsecs(buffer, 24);\n\n    // Receive timestamp\n\n    this.receiveTimestamp = internals.toMsecs(buffer, 32);\n\n    // Transmit timestamp\n\n    this.transmitTimestamp = internals.toMsecs(buffer, 40);\n\n    // Validate\n\n    if (this.version === 4 &&\n        this.stratum !== 'reserved' &&\n        this.mode === 'server' &&\n        this.originateTimestamp &&\n        this.receiveTimestamp &&\n        this.transmitTimestamp) {\n\n        this.isValid = true;\n    }\n\n    return this;\n};\n\n\ninternals.toMsecs = function (buffer, offset) {\n\n    var seconds = 0;\n    var fraction = 0;\n\n    for (var i = 0; i < 4; ++i) {\n        seconds = (seconds * 256) + buffer[offset + i];\n    }\n\n    for (i = 4; i < 8; ++i) {\n        fraction = (fraction * 256) + buffer[offset + i];\n    }\n\n    return ((seconds - 2208988800 + (fraction / Math.pow(2, 32))) * 1000);\n};\n\n\ninternals.fromMsecs = function (ts, buffer, offset) {\n\n    var seconds = Math.floor(ts / 1000) + 2208988800;\n    var fraction = Math.round((ts % 1000) / 1000 * Math.pow(2, 32));\n\n    buffer[offset + 0] = (seconds & 0xFF000000) >> 24;\n    buffer[offset + 1] = (seconds & 0x00FF0000) >> 16;\n    buffer[offset + 2] = (seconds & 0x0000FF00) >> 8;\n    buffer[offset + 3] = (seconds & 0x000000FF);\n\n    buffer[offset + 4] = (fraction & 0xFF000000) >> 24;\n    buffer[offset + 5] = (fraction & 0x00FF0000) >> 16;\n    buffer[offset + 6] = (fraction & 0x0000FF00) >> 8;\n    buffer[offset + 7] = (fraction & 0x000000FF);\n};\n\n\n// Offset singleton\n\ninternals.last = {\n    offset: 0,\n    expires: 0,\n    host: '',\n    port: 0\n};\n\n\nexports.offset = function (options, callback) {\n\n    if (arguments.length !== 2) {\n        callback = arguments[0];\n        options = {};\n    }\n\n    var now = Date.now();\n    var clockSyncRefresh = options.clockSyncRefresh || 24 * 60 * 60 * 1000;                    // Daily\n\n    if (internals.last.offset &&\n        internals.last.host === options.host &&\n        internals.last.port === options.port &&\n        now < internals.last.expires) {\n\n        process.nextTick(function () {\n\n            callback(null, internals.last.offset);\n        });\n\n        return;\n    }\n\n    exports.time(options, function (err, time) {\n\n        if (err) {\n            return callback(err, 0);\n        }\n\n        internals.last = {\n            offset: Math.round(time.t),\n            expires: now + clockSyncRefresh,\n            host: options.host,\n            port: options.port\n        };\n\n        return callback(null, internals.last.offset);\n    });\n};\n\n\n// Now singleton\n\ninternals.now = {\n    intervalId: 0\n};\n\n\nexports.start = function (options, callback) {\n\n    if (arguments.length !== 2) {\n        callback = arguments[0];\n        options = {};\n    }\n\n    if (internals.now.intervalId) {\n        process.nextTick(function () {\n\n            callback();\n        });\n\n        return;\n    }\n\n    exports.offset(options, function (err, offset) {\n\n        internals.now.intervalId = setInterval(function () {\n\n            exports.offset(options, function () { });\n        }, options.clockSyncRefresh || 24 * 60 * 60 * 1000);                                // Daily\n\n        return callback();\n    });\n};\n\n\nexports.stop = function () {\n\n    if (!internals.now.intervalId) {\n        return;\n    }\n\n    clearInterval(internals.now.intervalId);\n    internals.now.intervalId = 0;\n};\n\n\nexports.isLive = function () {\n\n    return !!internals.now.intervalId;\n};\n\n\nexports.now = function () {\n\n    var now = Date.now();\n    if (!exports.isLive() ||\n        now >= internals.last.expires) {\n\n        return now;\n    }\n\n    return now + internals.last.offset;\n};\n\n\ninternals.ignore = function () {\n\n};\n"]}
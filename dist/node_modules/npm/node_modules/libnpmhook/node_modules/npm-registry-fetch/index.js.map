{"version":3,"sources":["../../../../../../../node_modules/npm/node_modules/libnpmhook/node_modules/npm-registry-fetch/index.js"],"names":["Buffer","require","checkResponse","config","getAuth","fetch","npa","qs","url","module","exports","regFetch","uri","opts","registry","get","pickRegistry","parse","protocol","trim","replace","startTime","Date","now","headers","getHeaders","body","bodyIsStream","pipe","isBuffer","JSON","stringify","q","parsed","search","query","Object","assign","format","agent","algorithms","cache","getCacheMode","cacheManager","ca","cert","integrity","key","localAddress","maxSockets","memoize","method","noProxy","Promise","proxy","referer","retry","retries","factor","minTimeout","maxTimeout","strictSSL","timeout","uid","gid","then","res","json","fetchJSON","spec","scope","process","env","auth","shouldAuth","alwaysAuth","host","token","authorization","username","password","encoded","from","toString","_auth","otp"],"mappings":"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","file":"index.js","sourcesContent":["'use strict'\n\nconst Buffer = require('safe-buffer').Buffer\n\nconst checkResponse = require('./check-response.js')\nconst config = require('./config.js')\nconst getAuth = require('./auth.js')\nconst fetch = require('make-fetch-happen')\nconst npa = require('npm-package-arg')\nconst qs = require('querystring')\nconst url = require('url')\n\nmodule.exports = regFetch\nfunction regFetch (uri, opts) {\n  opts = config(opts)\n  const registry = (\n    (opts.get('spec') && pickRegistry(opts.get('spec'), opts)) ||\n    opts.get('registry') ||\n    'https://registry.npmjs.org/'\n  )\n  uri = url.parse(uri).protocol\n    ? uri\n    : `${\n      registry.trim().replace(/\\/?$/g, '')\n    }/${\n      uri.trim().replace(/^\\//, '')\n    }`\n  // through that takes into account the scope, the prefix of `uri`, etc\n  const startTime = Date.now()\n  const headers = getHeaders(registry, uri, opts)\n  let body = opts.get('body')\n  const bodyIsStream = body &&\n    typeof body === 'object' &&\n    typeof body.pipe === 'function'\n  if (body && !bodyIsStream && typeof body !== 'string' && !Buffer.isBuffer(body)) {\n    headers['content-type'] = headers['content-type'] || 'application/json'\n    body = JSON.stringify(body)\n  } else if (body && !headers['content-type']) {\n    headers['content-type'] = 'application/octet-stream'\n  }\n  if (opts.get('query')) {\n    let q = opts.get('query')\n    if (typeof q === 'string') {\n      q = qs.parse(q)\n    }\n    const parsed = url.parse(uri)\n    parsed.search = '?' + qs.stringify(\n      parsed.query\n        ? Object.assign(qs.parse(parsed.query), q)\n        : q\n    )\n    uri = url.format(parsed)\n  }\n  return fetch(uri, {\n    agent: opts.get('agent'),\n    algorithms: opts.get('algorithms'),\n    body,\n    cache: getCacheMode(opts),\n    cacheManager: opts.get('cache'),\n    ca: opts.get('ca'),\n    cert: opts.get('cert'),\n    headers,\n    integrity: opts.get('integrity'),\n    key: opts.get('key'),\n    localAddress: opts.get('local-address'),\n    maxSockets: opts.get('maxsockets'),\n    memoize: opts.get('memoize'),\n    method: opts.get('method') || 'GET',\n    noProxy: opts.get('no-proxy') || opts.get('noproxy'),\n    Promise: opts.get('Promise'),\n    proxy: opts.get('https-proxy') || opts.get('proxy'),\n    referer: opts.get('refer'),\n    retry: opts.get('retry') || {\n      retries: opts.get('fetch-retries'),\n      factor: opts.get('fetch-retry-factor'),\n      minTimeout: opts.get('fetch-retry-mintimeout'),\n      maxTimeout: opts.get('fetch-retry-maxtimeout')\n    },\n    strictSSL: !!opts.get('strict-ssl'),\n    timeout: opts.get('timeout'),\n    uid: opts.get('uid'),\n    gid: opts.get('gid')\n  }).then(res => checkResponse(\n    opts.get('method') || 'GET', res, registry, startTime, opts\n  ))\n}\n\nmodule.exports.json = fetchJSON\nfunction fetchJSON (uri, opts) {\n  return regFetch(uri, opts).then(res => res.json())\n}\n\nmodule.exports.pickRegistry = pickRegistry\nfunction pickRegistry (spec, opts) {\n  spec = npa(spec)\n  opts = config(opts)\n  let registry = spec.scope &&\n    opts.get(spec.scope.replace(/^@?/, '@') + ':registry')\n\n  if (!registry && opts.get('scope')) {\n    registry = opts.get(\n      opts.get('scope').replace(/^@?/, '@') + ':registry'\n    )\n  }\n\n  if (!registry) {\n    registry = opts.get('registry') || 'https://registry.npmjs.org/'\n  }\n\n  return registry\n}\n\nfunction getCacheMode (opts) {\n  return opts.get('offline')\n    ? 'only-if-cached'\n    : opts.get('prefer-offline')\n      ? 'force-cache'\n      : opts.get('prefer-online')\n        ? 'no-cache'\n        : 'default'\n}\n\nfunction getHeaders (registry, uri, opts) {\n  const headers = Object.assign({\n    'npm-in-ci': !!(\n      opts.get('is-from-ci') ||\n      process.env['CI'] === 'true' ||\n      process.env['TDDIUM'] ||\n      process.env['JENKINS_URL'] ||\n      process.env['bamboo.buildKey'] ||\n      process.env['GO_PIPELINE_NAME']\n    ),\n    'npm-scope': opts.get('project-scope'),\n    'npm-session': opts.get('npm-session'),\n    'user-agent': opts.get('user-agent'),\n    'referer': opts.get('refer')\n  }, opts.get('headers'))\n\n  const auth = getAuth(registry, opts)\n  // If a tarball is hosted on a different place than the manifest, only send\n  // credentials on `alwaysAuth`\n  const shouldAuth = (\n    auth.alwaysAuth ||\n    url.parse(uri).host === url.parse(registry).host\n  )\n  if (shouldAuth && auth.token) {\n    headers.authorization = `Bearer ${auth.token}`\n  } else if (shouldAuth && auth.username && auth.password) {\n    const encoded = Buffer.from(\n      `${auth.username}:${auth.password}`, 'utf8'\n    ).toString('base64')\n    headers.authorization = `Basic ${encoded}`\n  } else if (shouldAuth && auth._auth) {\n    headers.authorization = `Basic ${auth._auth}`\n  }\n  if (shouldAuth && auth.otp) {\n    headers['npm-otp'] = auth.otp\n  }\n  return headers\n}\n"]}
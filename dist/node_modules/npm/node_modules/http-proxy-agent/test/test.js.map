{"version":3,"sources":["../../../../../../node_modules/npm/node_modules/http-proxy-agent/test/test.js"],"names":["fs","require","url","http","https","assert","Proxy","HttpProxyAgent","describe","server","serverPort","proxy","proxyPort","sslProxy","sslProxyPort","before","done","listen","address","port","createServer","options","key","readFileSync","__dirname","cert","after","once","close","it","throws","agent","equal","host","opts","parse","secureProxy","protocol","req","res","end","JSON","stringify","headers","process","env","HTTP_PROXY","http_proxy","get","data","setEncoding","on","b","HTTPS_PROXY","https_proxy","rejectUnauthorized","authenticate","fn","proxyUri","statusCode","proxyOpts","auth","err","code","abort","callback","setTimeout"],"mappings":"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","file":"test.js","sourcesContent":["\n/**\n * Module dependencies.\n */\n\nvar fs = require('fs');\nvar url = require('url');\nvar http = require('http');\nvar https = require('https');\nvar assert = require('assert');\nvar Proxy = require('proxy');\nvar HttpProxyAgent = require('../');\n\ndescribe('HttpProxyAgent', function () {\n\n  var server;\n  var serverPort;\n\n  var proxy;\n  var proxyPort;\n\n  var sslProxy;\n  var sslProxyPort;\n\n  before(function (done) {\n    // setup HTTP proxy server\n    proxy = Proxy();\n    proxy.listen(function () {\n      proxyPort = proxy.address().port;\n      done();\n    });\n  });\n\n  before(function (done) {\n    // setup target HTTP server\n    server = http.createServer();\n    server.listen(function () {\n      serverPort = server.address().port;\n      done();\n    });\n  });\n\n  before(function (done) {\n    // setup SSL HTTP proxy server\n    var options = {\n      key: fs.readFileSync(__dirname + '/ssl-cert-snakeoil.key'),\n      cert: fs.readFileSync(__dirname + '/ssl-cert-snakeoil.pem')\n    };\n    sslProxy = Proxy(https.createServer(options));\n    sslProxy.listen(function () {\n      sslProxyPort = sslProxy.address().port;\n      done();\n    });\n  });\n\n  // shut down test HTTP server\n  after(function (done) {\n    proxy.once('close', function () { done(); });\n    proxy.close();\n  });\n\n  after(function (done) {\n    server.once('close', function () { done(); });\n    server.close();\n  });\n\n  after(function (done) {\n    sslProxy.once('close', function () { done(); });\n    sslProxy.close();\n  });\n\n  describe('constructor', function () {\n    it('should throw an Error if no \"proxy\" argument is given', function () {\n      assert.throws(function () {\n        new HttpProxyAgent();\n      });\n    });\n    it('should accept a \"string\" proxy argument', function () {\n      var agent = new HttpProxyAgent('http://127.0.0.1:' + proxyPort);\n      assert.equal('127.0.0.1', agent.proxy.host);\n      assert.equal(proxyPort, agent.proxy.port);\n    });\n    it('should accept a `url.parse()` result object argument', function () {\n      var opts = url.parse('http://127.0.0.1:' + proxyPort);\n      var agent = new HttpProxyAgent(opts);\n      assert.equal('127.0.0.1', agent.proxy.host);\n      assert.equal(proxyPort, agent.proxy.port);\n    });\n    describe('secureProxy', function () {\n      it('should default to `false`', function () {\n        var agent = new HttpProxyAgent({ port: proxyPort });\n        assert.equal(false, agent.secureProxy);\n      });\n      it('should be `false` when \"http:\" protocol is used', function () {\n        var agent = new HttpProxyAgent({ port: proxyPort, protocol: 'http:' });\n        assert.equal(false, agent.secureProxy);\n      });\n      it('should be `true` when \"https:\" protocol is used', function () {\n        var agent = new HttpProxyAgent({ port: proxyPort, protocol: 'https:' });\n        assert.equal(true, agent.secureProxy);\n      });\n      it('should be `true` when \"https\" protocol is used', function () {\n        var agent = new HttpProxyAgent({ port: proxyPort, protocol: 'https' });\n        assert.equal(true, agent.secureProxy);\n      });\n    });\n  });\n\n  describe('\"http\" module', function () {\n    it('should work over an HTTP proxy', function (done) {\n      // set HTTP \"request\" event handler for this test\n      server.once('request', function (req, res) {\n        res.end(JSON.stringify(req.headers));\n      });\n\n      var proxy = process.env.HTTP_PROXY || process.env.http_proxy || 'http://127.0.0.1:' + proxyPort;\n      var agent = new HttpProxyAgent(proxy);\n\n      var opts = url.parse('http://127.0.0.1:' + serverPort);\n      opts.agent = agent;\n\n      http.get(opts, function (res) {\n        var data = '';\n        res.setEncoding('utf8');\n        res.on('data', function (b) {\n          data += b;\n        });\n        res.on('end', function () {\n          data = JSON.parse(data);\n          assert.equal('127.0.0.1:' + serverPort, data.host);\n          assert('via' in data);\n          done();\n        });\n      });\n    });\n    it('should work over an HTTPS proxy', function (done) {\n      // set HTTP \"request\" event handler for this test\n      server.once('request', function (req, res) {\n        res.end(JSON.stringify(req.headers));\n      });\n\n      var proxy = process.env.HTTPS_PROXY || process.env.https_proxy || 'https://127.0.0.1:' + sslProxyPort;\n      proxy = url.parse(proxy);\n      proxy.rejectUnauthorized = false;\n      var agent = new HttpProxyAgent(proxy);\n      assert.equal(true, agent.secureProxy);\n\n      var opts = url.parse('http://127.0.0.1:' + serverPort);\n      opts.agent = agent;\n\n      http.get(opts, function (res) {\n        var data = '';\n        res.setEncoding('utf8');\n        res.on('data', function (b) {\n          data += b;\n        });\n        res.on('end', function () {\n          data = JSON.parse(data);\n          assert.equal('127.0.0.1:' + serverPort, data.host);\n          assert('via' in data);\n          done();\n        });\n      });\n    });\n    it('should proxy the query string of the request path', function (done) {\n      // set HTTP \"request\" event handler for this test\n      server.once('request', function (req, res) {\n        res.end(JSON.stringify({\n          url: req.url\n        }));\n      });\n\n      var proxy = process.env.HTTP_PROXY || process.env.http_proxy || 'http://127.0.0.1:' + proxyPort;\n      var agent = new HttpProxyAgent(proxy);\n\n      var opts = url.parse('http://127.0.0.1:' + serverPort + '/test?foo=bar&1=2');\n      opts.agent = agent;\n\n      http.get(opts, function (res) {\n        var data = '';\n        res.setEncoding('utf8');\n        res.on('data', function (b) {\n          data += b;\n        });\n        res.on('end', function () {\n          data = JSON.parse(data);\n          assert.equal('/test?foo=bar&1=2', data.url);\n          done();\n        });\n      });\n    });\n    it('should receive the 407 authorization code on the `http.ClientResponse`', function (done) {\n      // set a proxy authentication function for this test\n      proxy.authenticate = function (req, fn) {\n        // reject all requests\n        fn(null, false);\n      };\n\n      var proxyUri = process.env.HTTP_PROXY || process.env.http_proxy || 'http://127.0.0.1:' + proxyPort;\n      var agent = new HttpProxyAgent(proxyUri);\n\n      var opts = {};\n      // `host` and `port` don't really matter since the proxy will reject anyways\n      opts.host = '127.0.0.1';\n      opts.port = 80;\n      opts.agent = agent;\n\n      http.get(opts, function (res) {\n        assert.equal(407, res.statusCode);\n        assert('proxy-authenticate' in res.headers);\n        delete proxy.authenticate;\n        done();\n      });\n    });\n    it('should send the \"Proxy-Authorization\" request header', function (done) {\n      // set a proxy authentication function for this test\n      proxy.authenticate = function (req, fn) {\n        // username:password is \"foo:bar\"\n        fn(null, req.headers['proxy-authorization'] == 'Basic Zm9vOmJhcg==');\n      };\n\n      // set HTTP \"request\" event handler for this test\n      server.once('request', function (req, res) {\n        res.end(JSON.stringify(req.headers));\n      });\n\n      var proxyUri = process.env.HTTP_PROXY || process.env.http_proxy || 'http://127.0.0.1:' + proxyPort;\n      var proxyOpts = url.parse(proxyUri);\n      proxyOpts.auth = 'foo:bar';\n      var agent = new HttpProxyAgent(proxyOpts);\n\n      var opts = url.parse('http://127.0.0.1:' + serverPort);\n      opts.agent = agent;\n\n      http.get(opts, function (res) {\n        var data = '';\n        res.setEncoding('utf8');\n        res.on('data', function (b) {\n          data += b;\n        });\n        res.on('end', function () {\n          data = JSON.parse(data);\n          assert.equal('127.0.0.1:' + serverPort, data.host);\n          assert('via' in data);\n          delete proxy.authenticate;\n          done();\n        });\n      });\n    });\n    it('should emit an \"error\" event on the `http.ClientRequest` if the proxy does not exist', function (done) {\n      // port 4 is a reserved, but \"unassigned\" port\n      var proxyUri = 'http://127.0.0.1:4';\n      var agent = new HttpProxyAgent(proxyUri);\n\n      var opts = url.parse('http://nodejs.org');\n      opts.agent = agent;\n\n      var req = http.get(opts);\n      req.once('error', function (err) {\n        assert.equal('ECONNREFUSED', err.code);\n        req.abort();\n        done();\n      });\n    });\n    it('should work after the first tick of the `http.ClientRequest` instance', function (done) {\n      // set HTTP \"request\" event handler for this test\n      server.once('request', function (req, res) {\n        res.end(JSON.stringify(req.url));\n      });\n\n      var proxy = process.env.HTTP_PROXY || process.env.http_proxy || 'http://127.0.0.1:' + proxyPort;\n      var agent = new HttpProxyAgent(proxy);\n\n      var opts = url.parse('http://127.0.0.1:' + serverPort + '/test');\n      opts.agent = agent;\n\n      // defer the \"connect()\" function logic, since calling .end() before the\n      // \"socket\" event can cause weirdness since the HTTP header will have been\n      // cached and the HttpProxyAgent `req.path` patches won't be respected\n      var callback = agent.callback;\n      agent.callback = function (req, opts, fn) {\n        setTimeout(function () {\n          agent.callback = callback;\n          agent.callback(req, opts, fn);\n        }, 10);\n      };\n\n      http.get(opts, function (res) {\n        var data = '';\n        res.setEncoding('utf8');\n        res.on('data', function (b) {\n          data += b;\n        });\n        res.on('end', function () {\n          data = JSON.parse(data);\n          assert.equal('/test', data);\n          done();\n        });\n      });\n    });\n  });\n\n});\n"]}